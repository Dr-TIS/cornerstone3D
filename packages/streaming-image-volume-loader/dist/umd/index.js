/*! For license information please see index.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/core"),require("gl-matrix")):"function"==typeof define&&define.amd?define(["@cornerstonejs/core","gl-matrix"],t):"object"==typeof exports?exports.cornerstoneStreamingImageVolumeLoader=t(require("@cornerstonejs/core"),require("gl-matrix")):e.cornerstoneStreamingImageVolumeLoader=t(e.cornerstone3D,e.window)}(self,(function(e,t){return function(){var r={953:function(t){"use strict";t.exports=e},976:function(e){"use strict";e.exports=t},609:function(e,t,r){var n=r(425).default;function a(){"use strict";e.exports=a=function(){return t},e.exports.__esModule=!0,e.exports.default=e.exports;var t={},r=Object.prototype,o=r.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},s="function"==typeof Symbol?Symbol:{},c=s.iterator||"@@iterator",u=s.asyncIterator||"@@asyncIterator",l=s.toStringTag||"@@toStringTag";function f(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{f({},"")}catch(e){f=function(e,t,r){return e[t]=r}}function m(e,t,r,n){var a=t&&t.prototype instanceof h?t:h,o=Object.create(a.prototype),s=new L(n||[]);return i(o,"_invoke",{value:S(e,r,s)}),o}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=m;var g={};function h(){}function p(){}function v(){}var y={};f(y,c,(function(){return this}));var I=Object.getPrototypeOf,b=I&&I(I(O([])));b&&b!==r&&o.call(b,c)&&(y=b);var w=v.prototype=h.prototype=Object.create(y);function P(e){["next","throw","return"].forEach((function(t){f(e,t,(function(e){return this._invoke(t,e)}))}))}function x(e,t){function r(a,i,s,c){var u=d(e[a],e,i);if("throw"!==u.type){var l=u.arg,f=l.value;return f&&"object"==n(f)&&o.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,s,c)}),(function(e){r("throw",e,s,c)})):t.resolve(f).then((function(e){l.value=e,s(l)}),(function(e){return r("throw",e,s,c)}))}c(u.arg)}var a;i(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,a){r(e,n,t,a)}))}return a=a?a.then(o,o):o()}})}function S(e,t,r){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(r.method=a,r.arg=o;;){var i=r.delegate;if(i){var s=E(i,r);if(s){if(s===g)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=d(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===g)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function E(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=void 0,E(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=d(n,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,g;var o=a.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,g):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,g)}function D(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function _(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function L(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(D,this),this.reset(!0)}function O(e){if(e){var t=e[c];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,n=function t(){for(;++r<e.length;)if(o.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return n.next=n}}return{next:T}}function T(){return{value:void 0,done:!0}}return p.prototype=v,i(w,"constructor",{value:v,configurable:!0}),i(v,"constructor",{value:p,configurable:!0}),p.displayName=f(v,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,f(e,l,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},P(x.prototype),f(x.prototype,u,(function(){return this})),t.AsyncIterator=x,t.async=function(e,r,n,a,o){void 0===o&&(o=Promise);var i=new x(m(e,r,n,a),o);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},P(w),f(w,l,"Generator"),f(w,c,(function(){return this})),f(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=O,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(_),!e)for(var t in this)"t"===t.charAt(0)&&o.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,n){return i.type="throw",i.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n],i=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var s=o.call(a,"catchLoc"),c=o.call(a,"finallyLoc");if(s&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&o.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var a=n;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),_(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var a=n.arg;_(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:O(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),g}},t}e.exports=a,e.exports.__esModule=!0,e.exports.default=e.exports},425:function(e){function t(r){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(r)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},841:function(e,t,r){var n=r(609)();e.exports=n;try{regeneratorRuntime=n}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=n:Function("r","regeneratorRuntime = r")(n)}}},n={};function a(e){var t=n[e];if(void 0!==t)return t.exports;var o=n[e]={exports:{}};return r[e](o,o.exports,a),o.exports}a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,{a:t}),t},a.d=function(e,t){for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};return function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function t(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||function(t,r){if(t){if("string"==typeof t)return e(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,r):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t,r,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,a)}function n(e){return function(){var t=this,n=arguments;return new Promise((function(a,o){var i=e.apply(t,n);function s(e){r(i,a,o,s,c,"next",e)}function c(e){r(i,a,o,s,c,"throw",e)}s(void 0)}))}}a.r(o),a.d(o,{StreamingDynamicImageVolume:function(){return U},StreamingImageVolume:function(){return T},cornerstoneStreamingDynamicImageVolumeLoader:function(){return N},cornerstoneStreamingImageVolumeLoader:function(){return A},helpers:function(){return q}});var i=a(841),s=a.n(i),c=a(953),u=a(976);function l(e){var t,r=e[0],n=c.metaData.get("imagePixelModule",r),a=n.pixelRepresentation,o=n.bitsAllocated,i=n.bitsStored,s=n.highBit,u=n.photometricInterpretation,l=n.samplesPerPixel,f=[],m=c.metaData.get("voiLutModule",r);if(m){var d=m.windowWidth,g=m.windowCenter;if(t=null==m?void 0:m.voiLUTFunction,Array.isArray(d))for(var h=0;h<d.length;h++)f.push({windowWidth:d[h],windowCenter:g[h]});else f.push({windowWidth:d,windowCenter:g})}else f.push({windowWidth:void 0,windowCenter:void 0});var p=c.metaData.get("generalSeriesModule",r),v=p.modality,y=p.seriesInstanceUID,I=c.metaData.get("imagePlaneModule",r);return{BitsAllocated:o,BitsStored:i,SamplesPerPixel:l,HighBit:s,PhotometricInterpretation:u,PixelRepresentation:a,Modality:v,ImageOrientationPatient:I.imageOrientationPatient,PixelSpacing:I.pixelSpacing,FrameOfReferenceUID:I.frameOfReferenceUID,Columns:I.columns,Rows:I.rows,voiLut:f,VOILUTFunction:t,SeriesInstanceUID:y}}function f(e,t){var r,n,a=c.metaData.get("imagePlaneModule",e[0]).imagePositionPatient,o=u.vec3.create(),i="wadouri"===e[0].split(":")[0];function s(e){var r=c.metaData.get("imagePlaneModule",e).imagePositionPatient,n=u.vec3.create();return u.vec3.sub(n,a,r),u.vec3.dot(n,t)}if(u.vec3.set(o,a[0],a[1],a[2]),i){var l=[e[0],e[Math.floor(e.length/2)]];r=e,s(l[0])-s(l[1])<0&&r.reverse();var f=c.metaData.get("imagePlaneModule",l[1]);if(!f)throw new Error("Incomplete metadata required for volume construction.");var m=u.vec3.create();u.vec3.sub(m,a,f.imagePositionPatient);var d=u.vec3.dot(m,t);n=Math.abs(d)/Math.floor(e.length/2)}else{var g=e.map((function(e){return{distance:s(e),imageId:e}}));g.sort((function(e,t){return t.distance-e.distance})),r=g.map((function(e){return e.imageId}));var h=g.length;n=Math.abs(g[h-1].distance-g[0].distance)/(h-1)}var p=c.metaData.get("imagePlaneModule",r[0]),v=p.imagePositionPatient,y=p.sliceThickness,I=(0,c.getConfiguration)().rendering.strictZSpacingForVolumeViewport;return 0!==n||I||(y?(console.log("Could not calculate zSpacing. Using sliceThickness"),n=y):(console.log("Could not calculate zSpacing. The VolumeViewport visualization is compromised. Setting zSpacing to 1 to render"),n=1)),{zSpacing:n,origin:v,sortedImageIds:r}}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function g(e){var t=function(e,t){if("object"!==d(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,"string");if("object"!==d(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===d(t)?t:String(t)}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,g(n.key),n)}}function p(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function v(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(e,t){return y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},y(e,t)}function I(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&y(e,t)}function b(e,t){if(t&&("object"===d(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function P(e,t,r){return(t=g(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var x=function(e){var t=function(e){for(var t=(0,c.getRenderingEngines)(),r=[],n=0;n<t.length;n++){var a=t[n],o=c.utilities.getViewportsWithVolumeId(e,a.id);o.length&&r.push({renderingEngine:a,viewportIds:o.map((function(e){return e.id}))})}return r}(e);t&&t.length&&t.forEach((function(e){var t=e.renderingEngine,r=e.viewportIds;t.hasBeenDestroyed||t.renderViewports(r)}))};function S(e,t){var r=e.length,n=t.rescaleSlope,a=t.rescaleIntercept,o=t.suvbw;if("PT"===t.modality&&"number"==typeof o)for(var i=0;i<r;i++)e[i]=o*(e[i]*n+a);else for(var s=0;s<r;s++)e[s]=e[s]*n+a;return e}function E(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function D(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?E(Object(r),!0).forEach((function(t){P(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):E(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var _=c.Enums.RequestType.Prefetch,L=c.utilities.getMinMax,O=function(e){I(a,e);var t,r,n=(t=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,n=w(t);if(r){var a=w(this).constructor;e=Reflect.construct(n,arguments,a)}else e=n.apply(this,arguments);return b(this,e)});function a(e,t){var r;return m(this,a),P(v(r=n.call(this,e)),"framesLoaded",0),P(v(r),"framesProcessed",0),P(v(r),"numFrames",void 0),P(v(r),"cornerstoneImageMetaData",null),P(v(r),"loadStatus",void 0),P(v(r),"cancelLoading",(function(){var e=v(r).loadStatus;e&&e.loading&&(e.loading=!1,e.cancelled=!0,r.clearLoadCallbacks(),c.imageLoadPoolManager.filterRequests((function(e){return e.additionalDetails.volumeId!==r.volumeId})))})),P(v(r),"load",(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5,n=v(r),a=n.imageIds,o=n.loadStatus,i=n.numFrames;if(!0!==o.loading){var s=r.loadStatus.loaded,c=a.length;s?e&&e({success:!0,framesLoaded:c,framesProcessed:c,numFrames:i,totalNumFrames:c}):(e&&r.loadStatus.callbacks.push(e),r._prefetchImageIds(t))}else console.log("loadVolume: Loading is already in progress for ".concat(r.volumeId))})),P(v(r),"getImageIdsRequests",(function(e,t,n){var a,o=v(r).loadStatus,i=o.cachedFrames,s=v(r),u=s.vtkOpenGLTexture,l=s.imageData,f=s.metadata,m=s.volumeId,d=f.FrameOfReferenceUID,g=t.buffer,h=e.length,p=t.length/h,y=g.byteLength/h;if(t instanceof Uint8Array)a="Uint8Array";else if(t instanceof Float32Array)a="Float32Array";else if(t instanceof Uint16Array)a="Uint16Array";else{if(!(t instanceof Int16Array))throw new Error("Unsupported array type");a="Int16Array"}var I,b,w=r.imageIds.length,P=!0;function S(e){if(P&&(e.framesProcessed>b||e.framesProcessed===e.totalNumFrames)&&(b+=I,x(m)),e.framesProcessed===e.totalNumFrames){o.callbacks.forEach((function(t){return t(e)}));var t={FrameOfReferenceUID:d,volumeId:m};(0,c.triggerEvent)(c.eventTarget,c.Enums.Events.IMAGE_VOLUME_LOADING_COMPLETED,t)}}P&&(b=I=.02*w);var E=function(e,t,n){var a=r._imageIdIndexToFrameIndex(t);i[t]=!0,r.framesLoaded++,r.framesProcessed++,u.setUpdatedFrame(a),l.modified();var s={FrameOfReferenceUID:d,imageVolume:e};(0,c.triggerEvent)(c.eventTarget,c.Enums.Events.IMAGE_VOLUME_MODIFIED,s),r.framesProcessed===w?(o.loaded=!0,o.loading=!1,S({success:!0,imageIdIndex:t,imageId:n,framesLoaded:r.framesLoaded,framesProcessed:r.framesProcessed,numFrames:h,totalNumFrames:w}),o.callbacks=[]):S({success:!0,imageIdIndex:t,imageId:n,framesLoaded:r.framesLoaded,framesProcessed:r.framesProcessed,numFrames:h,totalNumFrames:w})};function D(e,t,r){this.framesProcessed++,this.framesProcessed===w?(o.loaded=!0,o.loading=!1,S({success:!1,imageId:r,imageIdIndex:t,error:e,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,numFrames:h,totalNumFrames:w}),o.callbacks=[]):S({success:!1,imageId:r,imageIdIndex:t,error:e,framesLoaded:this.framesLoaded,framesProcessed:this.framesProcessed,numFrames:h,totalNumFrames:w});var n={error:e,imageIdIndex:t,imageId:r};(0,c.triggerEvent)(c.eventTarget,c.Enums.Events.IMAGE_LOAD_ERROR,n)}var L=e.map((function(e,s){var u=r.getImageIdIndex(e);if(i[u])return r.framesLoaded++,void r.framesProcessed++;var l=c.metaData.get("modalityLutModule",e)||{},f=c.metaData.get("generalSeriesModule",e)||{},m={rescaleSlope:l.rescaleSlope,rescaleIntercept:l.rescaleIntercept,modality:f.modality};if("PT"===m.modality){var d=c.metaData.get("scalingModule",e);d&&(r._addScalingToVolume(d),m.suvbw=d.suvbw)}var h="number"==typeof m.rescaleSlope&&"number"==typeof m.rescaleIntercept;return r.isPreScaled=h,{callLoadImage:function(e,n,a){return c.imageLoader.loadImage(e,a).then((function(i){!function(e,t,r){if(e.buffer instanceof ArrayBuffer){var n=r.targetBuffer.offset,a=r.targetBuffer.length,o=t.pixelData?t.pixelData:t.getPixelData();try{if(e instanceof Float32Array){var i=new Float32Array(o);if(i.length!==a)throw"Error pixelData length does not match frame length";e.set(i,n/4)}if(e instanceof Int16Array){var s=new Int16Array(o);if(s.length!==a)throw"Error pixelData length does not match frame length";e.set(s,n/2)}if(e instanceof Uint16Array){var c=new Uint16Array(o);if(c.length!==a)throw"Error pixelData length does not match frame length";e.set(c,n/2)}if(e instanceof Uint8Array){var u=new Uint8Array(o);if(u.length!==a)throw"Error pixelData length does not match frame length";e.set(u,n/1)}}catch(e){console.error(e)}}}(t,i,a),function(e,n,a){var i=r._imageIdIndexToFrameIndex(e),s=c.cache.getCachedImageBasedOnImageURI(n),u=c.cache.getVolumeContainingImageId(n);if(o.cancelled)console.warn("volume load cancelled, returning for imageIdIndex: ",e);else{if(!(null!=s&&s.image||u&&u.volume!==v(r)))return E(v(r),e,n);var l=!!s,f=s||u.volume;r.handleImageComingFromCache(f,l,a,t,i,g,E,e,n,D)}}(n,e,m)}),(function(t){D.call(v(r),t,n,e)}))},imageId:e,imageIdIndex:u,options:{targetBuffer:{arrayBuffer:g instanceof ArrayBuffer?void 0:g,offset:s*y,length:p,type:a},skipCreateImage:!0,preScale:{enabled:!0,scalingParameters:m}},priority:n,requestType:_,additionalDetails:{volumeId:r.volumeId}}}));return L})),r.imageIds=t.imageIds,r.loadStatus=t.loadStatus,r.numFrames=r._getNumFrames(),r._createCornerstoneImageMetaData(),r}return p(a,[{key:"_getNumFrames",value:function(){var e=this.imageIds,t=this.scalarData,r=this.isDynamicVolume()?t.length:1;return e.length/r}},{key:"_getScalarDataLength",value:function(){var e=this.scalarData;return this.isDynamicVolume()?e[0].length:e.length}},{key:"_createCornerstoneImageMetaData",value:function(){var e=this.numFrames;if(0!==e){var t=this.sizeInBytes/e,r=this._getScalarDataLength()/this.numVoxels,n=this.dimensions[0]*this.dimensions[1]*r,a=this.metadata,o=a.PhotometricInterpretation,i=a.voiLut,s=a.VOILUTFunction,c=[],u=[];i&&i.length&&(c=i.map((function(e){return e.windowCenter})),u=i.map((function(e){return e.windowWidth})));var l=r>1;this.cornerstoneImageMetaData={bytesPerImage:t,numComponents:r,pixelsPerImage:n,windowCenter:c,windowWidth:u,color:l,rgba:!1,spacing:this.spacing,dimensions:this.dimensions,photometricInterpretation:o,voiLUTFunction:s,invert:"MONOCHROME1"===o}}}},{key:"_imageIdIndexToFrameIndex",value:function(e){return e%this.numFrames}},{key:"getScalarDataArrays",value:function(){return this.isDynamicVolume()?this.scalarData:[this.scalarData]}},{key:"_getScalarDataByImageIdIndex",value:function(e){if(e<0||e>=this.imageIds.length)throw new Error("imageIdIndex out of range");return this.getScalarDataArrays()[Math.floor(e/this.numFrames)]}},{key:"invalidateVolume",value:function(e){for(var t=this.imageData,r=this.vtkOpenGLTexture,n=this.numFrames,a=0;a<n;a++)r.setUpdatedFrame(a);t.modified(),e&&x(this.volumeId)}},{key:"clearLoadCallbacks",value:function(){this.loadStatus.callbacks=[]}},{key:"handleImageComingFromCache",value:function(e,t,r,n,a,o,i,s,c,u){var l=this;(t?e.imageLoadObject:e.convertToCornerstoneImage(c,s)).promise.then((function(e){var t=l._scaleIfNecessary(e,r),u=l.cornerstoneImageMetaData,f=u.pixelsPerImage,m=u.bytesPerImage,d=n.constructor,g=m*a,h=m/f;n.BYTES_PER_ELEMENT!==h&&(g*=n.BYTES_PER_ELEMENT/h),new d(o,g,f).set(t),i(l,s,c)})).catch((function(e){u.call(l,e,s,c)}))}},{key:"getImageLoadRequests",value:function(e){throw new Error("Abstract method")}},{key:"_prefetchImageIds",value:function(e){var t=this;this.loadStatus.loading=!0,this.getImageLoadRequests(e).reverse().forEach((function(e){if(e){var r=e.callLoadImage,n=e.imageId,a=e.imageIdIndex,o=e.options,i=e.priority,s=e.requestType,u=e.additionalDetails;c.imageLoadPoolManager.addRequest(r.bind(t,n,a,o),s,u,i)}}))}},{key:"_scaleIfNecessary",value:function(e,t){var r,n=null===(r=e.preScale)||void 0===r?void 0:r.scaled,a=!t||!t.rescaleIntercept||!t.rescaleSlope;if(!n&&a)return e.getPixelData().slice(0);if(!n&&t&&void 0!==t.rescaleIntercept&&void 0!==t.rescaleSlope)return S(e.getPixelData().slice(0),t);var o=t.rescaleSlope,i=t.rescaleIntercept,s=t.suvbw,c=e.preScale.scalingParameters,u=c.rescaleSlope,l=c.rescaleIntercept,f=c.suvbw;if(o===u&&i===l&&s===f)return e.getPixelData();var m=s/f,d=o/u,g=i-l*d;return S(e.getPixelData().slice(0),D(D({},t),{},{rescaleSlope:d,rescaleIntercept:g,suvbw:m}))}},{key:"_addScalingToVolume",value:function(e){if(!this.scaling){var t=e.suvbw,r=e.suvlbm,n=e.suvbsa,a={};r&&(a.suvbwToSuvlbm=r/t),n&&(a.suvbwToSuvbsa=n/t),t&&(a.suvbw=t),this.scaling={PT:a}}}},{key:"_removeFromCache",value:function(){c.cache.removeVolumeLoadObject(this.volumeId)}},{key:"getCornerstoneImage",value:function(e,t){var r=this.imageIds,n=this._imageIdIndexToFrameIndex(t),a=this.cornerstoneImageMetaData,o=a.bytesPerImage,i=a.pixelsPerImage,s=a.windowCenter,u=a.windowWidth,l=a.numComponents,f=a.color,m=a.dimensions,d=a.spacing,g=a.invert,h=a.voiLUTFunction,p=a.photometricInterpretation,v=this._getScalarDataByImageIdIndex(t),y=v.buffer,I=v.constructor,b=o/i,w=o*n;v.BYTES_PER_ELEMENT!==b&&(w*=v.BYTES_PER_ELEMENT/b);var P=new I(i),x=new I(y,w,i);P.set(x);var S=r[t],E=c.metaData.get("modalityLutModule",S)||{},D=L(P);return{imageId:e,intercept:E.rescaleIntercept?E.rescaleIntercept:0,windowCenter:s,windowWidth:u,voiLUTFunction:h,color:f,rgba:!1,numComps:l,rows:m[1],columns:m[0],sizeInBytes:P.byteLength,getPixelData:function(){return P},minPixelValue:D.min,maxPixelValue:D.max,slope:E.rescaleSlope?E.rescaleSlope:1,getCanvas:void 0,height:m[0],width:m[1],columnPixelSpacing:d[0],rowPixelSpacing:d[1],invert:g,photometricInterpretation:p}}},{key:"convertToCornerstoneImage",value:function(e,t){return this.getCornerstoneImageLoadObject(e,t)}},{key:"getCornerstoneImageLoadObject",value:function(e,t){var r=this.getCornerstoneImage(e,t);return{promise:Promise.resolve(r)}}},{key:"getCornerstoneImages",value:function(){var e=this;return this.imageIds.map((function(t,r){return e.getCornerstoneImage(t,r)}))}},{key:"_convertToImages",value:function(){for(var e=this.sizeInBytes,t=this.imageIds.length,r=this.cornerstoneImageMetaData.bytesPerImage,n=c.cache.decacheIfNecessaryUntilBytesAvailable(e,this.imageIds),a=0;a<t;a++){var o=this.imageIds[a];n-=r;var i=this.convertToCornerstoneImage(o,a);if(c.cache.getImageLoadObject(o)||c.cache.putImageLoadObject(o,i).catch((function(e){console.error(e)})),n<=r)break}this._removeFromCache()}},{key:"decache",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this._removeFromCache():this._convertToImages()}}]),a}(c.ImageVolume);var T=function(e){I(a,e);var t,r,n=(t=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,n=w(t);if(r){var a=w(this).constructor;e=Reflect.construct(n,arguments,a)}else e=n.apply(this,arguments);return b(this,e)});function a(e,t){var r;return m(this,a),P(v(r=n.call(this,e,t)),"getImageLoadRequests",(function(e){var t=v(r).imageIds,n=r.scalarData;return r.getImageIdsRequests(t,n,e)})),r}return p(a,[{key:"getScalarData",value:function(){return this.scalarData}}]),a}(O),k=c.utilities.createUint8SharedArray,F=c.utilities.createFloat32SharedArray,R=c.utilities.createUint16SharedArray,j=c.utilities.createInt16SharedArray,A=function(e,r){if(!r||!r.imageIds||!r.imageIds.length)throw new Error("ImageIds must be provided to create a streaming image volume");var a=(0,c.getConfiguration)().rendering,o=a.useNorm16Texture,i=a.preferSizeOverAccuracy,m=o||i;function d(){return(d=n(s().mark((function a(){var o,i,d,g,h,p,v,y,I,b,w,P,x,S,E,D,_,L,O,A,C,M,B,V,U,N,q,G,z,W,Y,H,Z,X;return s().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:if("wadouri"!==r.imageIds[0].split(":")[0]){a.next=5;break}return o=[Math.floor(r.imageIds.length/2),r.imageIds.length-1],i=[0,o[0],o[1]],a.next=5,Promise.all(i.map((function(t){return new Promise((function(a,o){var i=r.imageIds[t];c.imageLoadPoolManager.addRequest(n(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c.imageLoader.loadImage(i).then((function(){console.log("Prefetched imageId: ".concat(i)),a(!0)})).catch((function(e){o(e)}));case 1:case"end":return e.stop()}}),e)}))),c.Enums.RequestType.Prefetch,{volumeId:e},1)}))}))).catch(console.error);case 5:d=r.imageIds,g=l(d),h=Math.floor(d.length/2),p=d[h],v=c.utilities.getScalingParameters(p),y=v.rescaleIntercept<0||v.rescaleSlope<0,I=g.BitsAllocated,b=g.PixelRepresentation,w=g.PhotometricInterpretation,P=g.ImageOrientationPatient,x=g.PixelSpacing,S=g.Columns,E=g.Rows,D=u.vec3.fromValues(P[0],P[1],P[2]),_=u.vec3.fromValues(P[3],P[4],P[5]),L=u.vec3.create(),u.vec3.cross(L,D,_),O=f(d,L),A=O.zSpacing,C=O.origin,M=O.sortedImageIds,B=d.length,V=[x[1],x[0],A],U=[S,E,B],N=[].concat(t(D),t(_),t(L)),q=1===b,G="RGB"===w?3:1,z=(0,c.getShouldUseSharedArrayBuffer)(),W=U[0]*U[1]*U[2],Y=function(e){if(!c.cache.isCacheable(e))throw new Error(c.Enums.Events.CACHE_SIZE_EXCEEDED);c.cache.decacheIfNecessaryUntilBytesAvailable(e)},a.t0=I,a.next=8===a.t0?29:16===a.t0?35:24===a.t0?52:56;break;case 29:if(!q){a.next=31;break}throw new Error("8 Bit signed images are not yet supported by this plugin.");case 31:case 52:return Y(Z=W*G),H=z?k(W*G):new Uint8Array(W*G),a.abrupt("break",56);case 35:if(m){a.next=39;break}return Z=4*W,H=z?F(W):new Float32Array(W),a.abrupt("break",56);case 39:if(Z=2*W,!q&&!y){a.next=44;break}return Y(Z),H=z?j(W):new Int16Array(W),a.abrupt("break",56);case 44:if(q||y){a.next=48;break}return Y(Z),H=z?R(W):new Uint16Array(W),a.abrupt("break",56);case 48:return Y(Z=4*W),H=z?F(W):new Float32Array(W),a.abrupt("break",56);case 56:return X=new T({volumeId:e,metadata:g,dimensions:U,spacing:V,origin:C,direction:N,scalarData:H,sizeInBytes:Z},{imageIds:M,loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}}),a.abrupt("return",X);case 58:case"end":return a.stop()}}),a)})))).apply(this,arguments)}var g=function(){return d.apply(this,arguments)}();return{promise:g,decache:function(){g.then((function(e){e.destroy(),e=null}))},cancel:function(){g.then((function(e){e.cancelLoading()}))}}};function C(e){var t,r=e.map((function(e){var t=c.metaData.get("petImageModule",e),r=(null!=t?t:{}).frameReferenceTime;return{imageId:e,frameReferenceTime:void 0===r?0:r}})),n=(t="frameReferenceTime",r.reduce((function(e,r){return(e[r[t]]=e[r[t]]||[]).push(r),e}),{}));return Object.keys(n).map(Number.parseFloat).sort((function(e,t){return e-t})).map((function(e){return n[e].map((function(e){return e.imageId}))}))}var M=function(e){for(var t=[C],r=function(){var r=t[n](e);if(!r||r.length<=1)return"continue";var a=r[0].length;return r.every((function(e){return e.length===a}))?{v:r}:void 0},n=0;n<t.length;n++){var a=r();if("continue"!==a&&"object"===d(a))return a.v}return[e]},B=c.utilities.createUint8SharedArray,V=c.utilities.createFloat32SharedArray;var U=function(e){I(a,e);var t,r,n=(t=a,r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,n=w(t);if(r){var a=w(this).constructor;e=Reflect.construct(n,arguments,a)}else e=n.apply(this,arguments);return b(this,e)});function a(e,t){var r;return m(this,a),a._ensureValidData(e,t),P(v(r=n.call(this,e,t)),"_numTimePoints",void 0),P(v(r),"_timePoints",void 0),P(v(r),"_timePointIndex",0),P(v(r),"_getTimePointRequests",(function(e,t){var n=e.imageIds,a=e.scalarData;return r.getImageIdsRequests(n,a,t)})),P(v(r),"_getTimePointsRequests",(function(e){var t=r._getTimePointsToLoad(),n=[];return t.forEach((function(t){var a=r._getTimePointRequests(t,e);n=n.concat(a)})),n})),P(v(r),"getImageLoadRequests",(function(e){return r._getTimePointsRequests(e).reverse()})),r._numTimePoints=r.scalarData.length,r._timePoints=r._getTimePointsData(),r}return p(a,[{key:"_getTimePointsData",value:function(){for(var e=this.imageIds,t=this.scalarData,r=this.numFrames,n=t.length,a=[],o=0;o<n;o++){var i=o*r,s=i+r;a.push({imageIds:e.slice(i,s),scalarData:t[o]})}return a}},{key:"_getTimePointsToLoad",value:function(){for(var e=this._timePoints,t=this._timePointIndex,r=[e[t]],n=t-1,a=t+1;n>=0||a<e.length;)n>=0&&r.push(e[n--]),a<e.length&&r.push(e[a++]);return r}},{key:"isDynamicVolume",value:function(){return!0}},{key:"timePointIndex",get:function(){return this._timePointIndex},set:function(e){if(e<0||e>=this.numTimePoints)throw new Error("Invalid timePointIndex (".concat(e,")"));if(this._timePointIndex!==e){var t=this.imageData;this._timePointIndex=e,t.getPointData().setActiveScalars("timePoint-".concat(e)),this.invalidateVolume(!0)}}},{key:"numTimePoints",get:function(){return this._numTimePoints}},{key:"getScalarData",value:function(){return this.scalarData[this._timePointIndex]}}],[{key:"_ensureValidData",value:function(e,t){var r=t.imageIds,n=e.scalarData;if(r.length%n.length!=0)throw new Error("Number of imageIds is not a multiple of ".concat(n.length))}}]),a}(O);var N=function(e,r){if(!r||!r.imageIds||!r.imageIds.length)throw new Error("ImageIds must be provided to create a 4D streaming image volume");var n,a=(n=r.imageIds,M(n).map((function(e){return function(e){var r=l(e),n=r.BitsAllocated,a=r.PixelRepresentation,o=r.PhotometricInterpretation,i=r.ImageOrientationPatient,s=r.PixelSpacing,m=r.Columns,d=r.Rows,g=u.vec3.fromValues(i[0],i[1],i[2]),h=u.vec3.fromValues(i[3],i[4],i[5]),p=u.vec3.create();u.vec3.cross(p,g,h);var v=f(e,p),y=v.zSpacing,I=v.origin,b=v.sortedImageIds,w=e.length,P=[s[1],s[0],y],x=[m,d,w],S=[].concat(t(g),t(h),t(p)),E=1===a,D=1;"RGB"===o&&(D=3);var _,L=(16===n?4:1)*x[0]*x[1]*x[2]*D;if(!c.cache.isCacheable(L))throw new Error(c.Enums.Events.CACHE_SIZE_EXCEEDED);switch(c.cache.decacheIfNecessaryUntilBytesAvailable(L),n){case 8:if(E)throw new Error("8 Bit signed images are not yet supported by this plugin.");_=B(x[0]*x[1]*x[2]);break;case 16:_=V(x[0]*x[1]*x[2]);break;case 24:_=B(x[0]*x[1]*x[2]*D)}return{metadata:r,sortedImageIds:b,dimensions:x,spacing:P,origin:I,direction:S,scalarData:_,sizeInBytes:L}}(e)}))),o=a[0],i=o.metadata,s=o.dimensions,m=o.spacing,d=o.origin,g=o.direction,h=o.sizeInBytes,p=[],v=[];a.forEach((function(e){p.push(e.sortedImageIds),v.push(e.scalarData)}));var y=new U({volumeId:e,metadata:i,dimensions:s,spacing:m,origin:d,direction:g,scalarData:v,sizeInBytes:h},{imageIds:p.flat(),loadStatus:{loaded:!1,loading:!1,cancelled:!1,cachedFrames:[],callbacks:[]}});return{promise:Promise.resolve(y),decache:function(){y.destroy(),y=null},cancel:function(){y.cancelLoading()}}},q={getDynamicVolumeInfo:function(e){var t=M(e);return{isDynamicVolume:t.length>1,timePoints:t}}}}(),o}()}));
//# sourceMappingURL=index.js.map