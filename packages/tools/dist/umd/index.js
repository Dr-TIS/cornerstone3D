/*! For license information please see index.js.LICENSE.txt */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("@cornerstonejs/core"),require("@kitware/vtk.js/Common/DataModel/PiecewiseFunction"),require("@kitware/vtk.js/Rendering/Core/ColorTransferFunction"),require("@kitware/vtk.js/Common/Core/CellArray"),require("@kitware/vtk.js/Common/Core/Points"),require("@kitware/vtk.js/Common/DataModel/PolyData"),require("@kitware/vtk.js/Common/Core/DataArray"),require("@kitware/vtk.js/Filters/General/AppendPolyData"),require("@kitware/vtk.js/Rendering/Core/Actor"),require("@kitware/vtk.js/Rendering/Core/Mapper"),require("gl-matrix"),require("@kitware/vtk.js/Common/Core/Math"),require("@kitware/vtk.js/Common/Core/MatrixBuilder")):"function"==typeof define&&define.amd?define(["@cornerstonejs/core","@kitware/vtk.js/Common/DataModel/PiecewiseFunction","@kitware/vtk.js/Rendering/Core/ColorTransferFunction","@kitware/vtk.js/Common/Core/CellArray","@kitware/vtk.js/Common/Core/Points","@kitware/vtk.js/Common/DataModel/PolyData","@kitware/vtk.js/Common/Core/DataArray","@kitware/vtk.js/Filters/General/AppendPolyData","@kitware/vtk.js/Rendering/Core/Actor","@kitware/vtk.js/Rendering/Core/Mapper","gl-matrix","@kitware/vtk.js/Common/Core/Math","@kitware/vtk.js/Common/Core/MatrixBuilder"],t):"object"==typeof exports?exports.cornerstoneTools3D=t(require("@cornerstonejs/core"),require("@kitware/vtk.js/Common/DataModel/PiecewiseFunction"),require("@kitware/vtk.js/Rendering/Core/ColorTransferFunction"),require("@kitware/vtk.js/Common/Core/CellArray"),require("@kitware/vtk.js/Common/Core/Points"),require("@kitware/vtk.js/Common/DataModel/PolyData"),require("@kitware/vtk.js/Common/Core/DataArray"),require("@kitware/vtk.js/Filters/General/AppendPolyData"),require("@kitware/vtk.js/Rendering/Core/Actor"),require("@kitware/vtk.js/Rendering/Core/Mapper"),require("gl-matrix"),require("@kitware/vtk.js/Common/Core/Math"),require("@kitware/vtk.js/Common/Core/MatrixBuilder")):e.cornerstoneTools3D=t(e.cornerstone3D,e["@kitware/vtk.js/Common/DataModel/PiecewiseFunction"],e["@kitware/vtk.js/Rendering/Core/ColorTransferFunction"],e["@kitware/vtk.js/Common/Core/CellArray"],e["@kitware/vtk.js/Common/Core/Points"],e["@kitware/vtk.js/Common/DataModel/PolyData"],e["@kitware/vtk.js/Common/Core/DataArray"],e["@kitware/vtk.js/Filters/General/AppendPolyData"],e["@kitware/vtk.js/Rendering/Core/Actor"],e["@kitware/vtk.js/Rendering/Core/Mapper"],e.window,e["@kitware/vtk.js/Common/Core/Math"],e["@kitware/vtk.js/Common/Core/MatrixBuilder"])}(self,(function(e,t,n,r,o,a,i,l,c,s,d,u,v){return function(){var f={907:function(e,t,n){e=n.nmd(e);var r="__lodash_hash_undefined__",o=9007199254740991,a="[object Arguments]",i="[object Boolean]",l="[object Date]",c="[object Function]",s="[object GeneratorFunction]",d="[object Map]",u="[object Number]",v="[object Object]",f="[object Promise]",g="[object RegExp]",h="[object Set]",p="[object String]",m="[object Symbol]",w="[object WeakMap]",E="[object ArrayBuffer]",y="[object DataView]",I="[object Float32Array]",b="[object Float64Array]",C="[object Int8Array]",T="[object Int16Array]",_="[object Int32Array]",D="[object Uint8Array]",O="[object Uint8ClampedArray]",S="[object Uint16Array]",x="[object Uint32Array]",M=/\w*$/,k=/^\[object .+?Constructor\]$/,R=/^(?:0|[1-9]\d*)$/,P={};P[a]=P["[object Array]"]=P[E]=P[y]=P[i]=P[l]=P[I]=P[b]=P[C]=P[T]=P[_]=P[d]=P[u]=P[v]=P[g]=P[h]=P[p]=P[m]=P[D]=P[O]=P[S]=P[x]=!0,P["[object Error]"]=P[c]=P[w]=!1;var N="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,A="object"==typeof self&&self&&self.Object===Object&&self,L=N||A||Function("return this")(),U=t&&!t.nodeType&&t,V=U&&e&&!e.nodeType&&e,B=V&&V.exports===U;function j(e,t){return e.set(t[0],t[1]),e}function H(e,t){return e.add(t),e}function W(e,t,n,r){var o=-1,a=e?e.length:0;for(r&&a&&(n=e[++o]);++o<a;)n=t(n,e[o],o,e);return n}function F(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}function G(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}function q(e,t){return function(n){return e(t(n))}}function z(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}var K,Y=Array.prototype,J=Function.prototype,$=Object.prototype,Z=L["__core-js_shared__"],X=(K=/[^.]+$/.exec(Z&&Z.keys&&Z.keys.IE_PROTO||""))?"Symbol(src)_1."+K:"",Q=J.toString,ee=$.hasOwnProperty,te=$.toString,ne=RegExp("^"+Q.call(ee).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),re=B?L.Buffer:void 0,oe=L.Symbol,ae=L.Uint8Array,ie=q(Object.getPrototypeOf,Object),le=Object.create,ce=$.propertyIsEnumerable,se=Y.splice,de=Object.getOwnPropertySymbols,ue=re?re.isBuffer:void 0,ve=q(Object.keys,Object),fe=Le(L,"DataView"),ge=Le(L,"Map"),he=Le(L,"Promise"),pe=Le(L,"Set"),me=Le(L,"WeakMap"),we=Le(Object,"create"),Ee=He(fe),ye=He(ge),Ie=He(he),be=He(pe),Ce=He(me),Te=oe?oe.prototype:void 0,_e=Te?Te.valueOf:void 0;function De(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Oe(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function Se(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function xe(e){this.__data__=new Oe(e)}function Me(e,t,n){var r=e[t];ee.call(e,t)&&We(r,n)&&(void 0!==n||t in e)||(e[t]=n)}function ke(e,t){for(var n=e.length;n--;)if(We(e[n][0],t))return n;return-1}function Re(e,t,n,r,o,f,w){var k;if(r&&(k=f?r(e,o,f,w):r(e)),void 0!==k)return k;if(!Ke(e))return e;var R=Fe(e);if(R){if(k=function(e){var t=e.length,n=e.constructor(t);return t&&"string"==typeof e[0]&&ee.call(e,"index")&&(n.index=e.index,n.input=e.input),n}(e),!t)return function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}(e,k)}else{var N=Ve(e),A=N==c||N==s;if(qe(e))return function(e,t){if(t)return e.slice();var n=new e.constructor(e.length);return e.copy(n),n}(e,t);if(N==v||N==a||A&&!f){if(F(e))return f?e:{};if(k=function(e){return"function"!=typeof e.constructor||je(e)?{}:Ke(t=ie(e))?le(t):{};var t}(A?{}:e),!t)return function(e,t){return Ne(e,Ue(e),t)}(e,function(e,t){return e&&Ne(t,Ye(t),e)}(k,e))}else{if(!P[N])return f?e:{};k=function(e,t,n,r){var o,a=e.constructor;switch(t){case E:return Pe(e);case i:case l:return new a(+e);case y:return function(e,t){var n=t?Pe(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.byteLength)}(e,r);case I:case b:case C:case T:case _:case D:case O:case S:case x:return function(e,t){var n=t?Pe(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}(e,r);case d:return function(e,t,n){return W(t?n(G(e),!0):G(e),j,new e.constructor)}(e,r,n);case u:case p:return new a(e);case g:return function(e){var t=new e.constructor(e.source,M.exec(e));return t.lastIndex=e.lastIndex,t}(e);case h:return function(e,t,n){return W(t?n(z(e),!0):z(e),H,new e.constructor)}(e,r,n);case m:return o=e,_e?Object(_e.call(o)):{}}}(e,N,Re,t)}}w||(w=new xe);var L=w.get(e);if(L)return L;if(w.set(e,k),!R)var U=n?function(e){return function(e,t,n){var r=t(e);return Fe(e)?r:function(e,t){for(var n=-1,r=t.length,o=e.length;++n<r;)e[o+n]=t[n];return e}(r,n(e))}(e,Ye,Ue)}(e):Ye(e);return function(e,t){for(var n=-1,r=e?e.length:0;++n<r&&!1!==t(e[n],n););}(U||e,(function(o,a){U&&(o=e[a=o]),Me(k,a,Re(o,t,n,r,a,e,w))})),k}function Pe(e){var t=new e.constructor(e.byteLength);return new ae(t).set(new ae(e)),t}function Ne(e,t,n,r){n||(n={});for(var o=-1,a=t.length;++o<a;){var i=t[o],l=r?r(n[i],e[i],i,n,e):void 0;Me(n,i,void 0===l?e[i]:l)}return n}function Ae(e,t){var n,r,o=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function Le(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){return!(!Ke(e)||(t=e,X&&X in t))&&(ze(e)||F(e)?ne:k).test(He(e));var t}(n)?n:void 0}De.prototype.clear=function(){this.__data__=we?we(null):{}},De.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},De.prototype.get=function(e){var t=this.__data__;if(we){var n=t[e];return n===r?void 0:n}return ee.call(t,e)?t[e]:void 0},De.prototype.has=function(e){var t=this.__data__;return we?void 0!==t[e]:ee.call(t,e)},De.prototype.set=function(e,t){return this.__data__[e]=we&&void 0===t?r:t,this},Oe.prototype.clear=function(){this.__data__=[]},Oe.prototype.delete=function(e){var t=this.__data__,n=ke(t,e);return!(n<0||(n==t.length-1?t.pop():se.call(t,n,1),0))},Oe.prototype.get=function(e){var t=this.__data__,n=ke(t,e);return n<0?void 0:t[n][1]},Oe.prototype.has=function(e){return ke(this.__data__,e)>-1},Oe.prototype.set=function(e,t){var n=this.__data__,r=ke(n,e);return r<0?n.push([e,t]):n[r][1]=t,this},Se.prototype.clear=function(){this.__data__={hash:new De,map:new(ge||Oe),string:new De}},Se.prototype.delete=function(e){return Ae(this,e).delete(e)},Se.prototype.get=function(e){return Ae(this,e).get(e)},Se.prototype.has=function(e){return Ae(this,e).has(e)},Se.prototype.set=function(e,t){return Ae(this,e).set(e,t),this},xe.prototype.clear=function(){this.__data__=new Oe},xe.prototype.delete=function(e){return this.__data__.delete(e)},xe.prototype.get=function(e){return this.__data__.get(e)},xe.prototype.has=function(e){return this.__data__.has(e)},xe.prototype.set=function(e,t){var n=this.__data__;if(n instanceof Oe){var r=n.__data__;if(!ge||r.length<199)return r.push([e,t]),this;n=this.__data__=new Se(r)}return n.set(e,t),this};var Ue=de?q(de,Object):function(){return[]},Ve=function(e){return te.call(e)};function Be(e,t){return!!(t=null==t?o:t)&&("number"==typeof e||R.test(e))&&e>-1&&e%1==0&&e<t}function je(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||$)}function He(e){if(null!=e){try{return Q.call(e)}catch(e){}try{return e+""}catch(e){}}return""}function We(e,t){return e===t||e!=e&&t!=t}(fe&&Ve(new fe(new ArrayBuffer(1)))!=y||ge&&Ve(new ge)!=d||he&&Ve(he.resolve())!=f||pe&&Ve(new pe)!=h||me&&Ve(new me)!=w)&&(Ve=function(e){var t=te.call(e),n=t==v?e.constructor:void 0,r=n?He(n):void 0;if(r)switch(r){case Ee:return y;case ye:return d;case Ie:return f;case be:return h;case Ce:return w}return t});var Fe=Array.isArray;function Ge(e){return null!=e&&function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=o}(e.length)&&!ze(e)}var qe=ue||function(){return!1};function ze(e){var t=Ke(e)?te.call(e):"";return t==c||t==s}function Ke(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function Ye(e){return Ge(e)?function(e,t){var n=Fe(e)||function(e){return function(e){return function(e){return!!e&&"object"==typeof e}(e)&&Ge(e)}(e)&&ee.call(e,"callee")&&(!ce.call(e,"callee")||te.call(e)==a)}(e)?function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}(e.length,String):[],r=n.length,o=!!r;for(var i in e)!t&&!ee.call(e,i)||o&&("length"==i||Be(i,r))||n.push(i);return n}(e):function(e){if(!je(e))return ve(e);var t=[];for(var n in Object(e))ee.call(e,n)&&"constructor"!=n&&t.push(n);return t}(e)}e.exports=function(e){return Re(e,!0,!0)}},485:function(e,t,n){var r,o="__lodash_hash_undefined__",a=1/0,i="[object Function]",l="[object GeneratorFunction]",c="[object Symbol]",s=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,d=/^\w*$/,u=/^\./,v=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,f=/\\(\\)?/g,g=/^\[object .+?Constructor\]$/,h="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,p="object"==typeof self&&self&&self.Object===Object&&self,m=h||p||Function("return this")(),w=Array.prototype,E=Function.prototype,y=Object.prototype,I=m["__core-js_shared__"],b=(r=/[^.]+$/.exec(I&&I.keys&&I.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"",C=E.toString,T=y.hasOwnProperty,_=y.toString,D=RegExp("^"+C.call(T).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),O=m.Symbol,S=w.splice,x=V(m,"Map"),M=V(Object,"create"),k=O?O.prototype:void 0,R=k?k.toString:void 0;function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function N(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function A(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}function L(e,t){for(var n,r,o=e.length;o--;)if((n=e[o][0])===(r=t)||n!=n&&r!=r)return o;return-1}function U(e,t){var n,r,o=e.__data__;return("string"==(r=typeof(n=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==n:null===n)?o["string"==typeof t?"string":"hash"]:o.map}function V(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return function(e){if(!F(e)||b&&b in e)return!1;var t=function(e){var t=F(e)?_.call(e):"";return t==i||t==l}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?D:g;return t.test(function(e){if(null!=e){try{return C.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}(n)?n:void 0}P.prototype.clear=function(){this.__data__=M?M(null):{}},P.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},P.prototype.get=function(e){var t=this.__data__;if(M){var n=t[e];return n===o?void 0:n}return T.call(t,e)?t[e]:void 0},P.prototype.has=function(e){var t=this.__data__;return M?void 0!==t[e]:T.call(t,e)},P.prototype.set=function(e,t){return this.__data__[e]=M&&void 0===t?o:t,this},N.prototype.clear=function(){this.__data__=[]},N.prototype.delete=function(e){var t=this.__data__,n=L(t,e);return!(n<0||(n==t.length-1?t.pop():S.call(t,n,1),0))},N.prototype.get=function(e){var t=this.__data__,n=L(t,e);return n<0?void 0:t[n][1]},N.prototype.has=function(e){return L(this.__data__,e)>-1},N.prototype.set=function(e,t){var n=this.__data__,r=L(n,e);return r<0?n.push([e,t]):n[r][1]=t,this},A.prototype.clear=function(){this.__data__={hash:new P,map:new(x||N),string:new P}},A.prototype.delete=function(e){return U(this,e).delete(e)},A.prototype.get=function(e){return U(this,e).get(e)},A.prototype.has=function(e){return U(this,e).has(e)},A.prototype.set=function(e,t){return U(this,e).set(e,t),this};var B=H((function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(G(e))return R?R.call(e):"";var t=e+"";return"0"==t&&1/e==-a?"-0":t}(t);var n=[];return u.test(e)&&n.push(""),e.replace(v,(function(e,t,r,o){n.push(r?o.replace(f,"$1"):t||e)})),n}));function j(e){if("string"==typeof e||G(e))return e;var t=e+"";return"0"==t&&1/e==-a?"-0":t}function H(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var r=arguments,o=t?t.apply(this,r):r[0],a=n.cache;if(a.has(o))return a.get(o);var i=e.apply(this,r);return n.cache=a.set(o,i),i};return n.cache=new(H.Cache||A),n}H.Cache=A;var W=Array.isArray;function F(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function G(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&_.call(e)==c}e.exports=function(e,t,n){var r=null==e?void 0:function(e,t){var n;t=function(e,t){if(W(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!G(e))||d.test(e)||!s.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:W(n=t)?n:B(n);for(var r=0,o=t.length;null!=e&&r<o;)e=e[j(t[r++])];return r&&r==o?e:void 0}(e,t);return void 0===r?n:r}},396:function(e){"use strict";e.exports=r},785:function(e){"use strict";e.exports=i},807:function(e){"use strict";e.exports=u},847:function(e){"use strict";e.exports=v},348:function(e){"use strict";e.exports=o},441:function(e){"use strict";e.exports=t},70:function(e){"use strict";e.exports=a},127:function(e){"use strict";e.exports=l},474:function(e){"use strict";e.exports=c},795:function(e){"use strict";e.exports=n},610:function(e){"use strict";e.exports=s},953:function(t){"use strict";t.exports=e},976:function(e){"use strict";e.exports=d},609:function(e,t,n){var r=n(425).default;function o(){"use strict";e.exports=o=function(){return t},e.exports.__esModule=!0,e.exports.default=e.exports;var t={},n=Object.prototype,a=n.hasOwnProperty,i=Object.defineProperty||function(e,t,n){e[t]=n.value},l="function"==typeof Symbol?Symbol:{},c=l.iterator||"@@iterator",s=l.asyncIterator||"@@asyncIterator",d=l.toStringTag||"@@toStringTag";function u(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,n){return e[t]=n}}function v(e,t,n,r){var o=t&&t.prototype instanceof h?t:h,a=Object.create(o.prototype),l=new S(r||[]);return i(a,"_invoke",{value:T(e,n,l)}),a}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=v;var g={};function h(){}function p(){}function m(){}var w={};u(w,c,(function(){return this}));var E=Object.getPrototypeOf,y=E&&E(E(x([])));y&&y!==n&&a.call(y,c)&&(w=y);var I=m.prototype=h.prototype=Object.create(w);function b(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function C(e,t){function n(o,i,l,c){var s=f(e[o],e,i);if("throw"!==s.type){var d=s.arg,u=d.value;return u&&"object"==r(u)&&a.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,l,c)}),(function(e){n("throw",e,l,c)})):t.resolve(u).then((function(e){d.value=e,l(d)}),(function(e){return n("throw",e,l,c)}))}c(s.arg)}var o;i(this,"_invoke",{value:function(e,r){function a(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(a,a):a()}})}function T(e,t,n){var r="suspendedStart";return function(o,a){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===o)throw a;return{value:void 0,done:!0}}for(n.method=o,n.arg=a;;){var i=n.delegate;if(i){var l=_(i,n);if(l){if(l===g)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=f(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===g)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}function _(e,t){var n=t.method,r=e.iterator[n];if(void 0===r)return t.delegate=null,"throw"===n&&e.iterator.return&&(t.method="return",t.arg=void 0,_(e,t),"throw"===t.method)||"return"!==n&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var o=f(r,e.iterator,t.arg);if("throw"===o.type)return t.method="throw",t.arg=o.arg,t.delegate=null,g;var a=o.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,g):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,g)}function D(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(D,this),this.reset(!0)}function x(e){if(e){var t=e[c];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(a.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return r.next=r}}return{next:M}}function M(){return{value:void 0,done:!0}}return p.prototype=m,i(I,"constructor",{value:m,configurable:!0}),i(m,"constructor",{value:p,configurable:!0}),p.displayName=u(m,d,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,d,"GeneratorFunction")),e.prototype=Object.create(I),e},t.awrap=function(e){return{__await:e}},b(C.prototype),u(C.prototype,s,(function(){return this})),t.AsyncIterator=C,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new C(v(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(I),u(I,d,"Generator"),u(I,c,(function(){return this})),u(I,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=x,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var l=a.call(o,"catchLoc"),c=a.call(o,"finallyLoc");if(l&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&a.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;O(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:x(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),g}},t}e.exports=o,e.exports.__esModule=!0,e.exports.default=e.exports},425:function(e){function t(n){return e.exports=t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,t(n)}e.exports=t,e.exports.__esModule=!0,e.exports.default=e.exports},841:function(e,t,n){var r=n(609)();e.exports=r;try{regeneratorRuntime=r}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=r:Function("r","regeneratorRuntime = r")(r)}}},g={};function h(e){var t=g[e];if(void 0!==t)return t.exports;var n=g[e]={id:e,loaded:!1,exports:{}};return f[e](n,n.exports,h),n.loaded=!0,n.exports}h.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return h.d(t,{a:t}),t},h.d=function(e,t){for(var n in t)h.o(t,n)&&!h.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},h.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),h.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},h.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},h.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e};var p={};return function(){"use strict";h.r(p),h.d(p,{AngleTool:function(){return bg},AnnotationTool:function(){return Fs},ArrowAnnotateTool:function(){return yg},BaseTool:function(){return xa},BidirectionalTool:function(){return pg},BrushTool:function(){return Is},CONSTANTS:function(){return u},CircleROITool:function(){return fg},CircleScissorsTool:function(){return Hg},CobbAngleTool:function(){return _g},CrosshairsTool:function(){return tg},DragProbeTool:function(){return Of},EllipticalROITool:function(){return cg},Enums:function(){return z},LengthTool:function(){return zf},MIPJumpToClickTool:function(){return Ff},MagnifyTool:function(){return Sg},PaintFillTool:function(){return Kg},PanTool:function(){return yf},PlanarFreehandROITool:function(){return Hv},PlanarRotateTool:function(){return Lf},ProbeTool:function(){return _f},RectangleROIStartEndThresholdTool:function(){return dd},RectangleROIThresholdTool:function(){return ld},RectangleROITool:function(){return ad},RectangleScissorsTool:function(){return Bg},ReferenceCursors:function(){return Mg},ReferenceLines:function(){return og},ReferenceLinesTool:function(){return og},ScaleOverlayTool:function(){return Pg},SegmentationDisplayTool:function(){return Pi},SphereScissorsTool:function(){return Fg},StackScrollMouseWheelTool:function(){return Vf},StackScrollTool:function(){return Pf},Synchronizer:function(){return ol},SynchronizerManager:function(){return c},ToolGroupManager:function(){return d},TrackballRotateTool:function(){return bf},Types:function(){return H},VolumeRotateMouseWheelTool:function(){return Hf},WindowLevelTool:function(){return xf},ZoomTool:function(){return kf},addTool:function(){return Zi},annotation:function(){return F},cancelActiveManipulations:function(){return el},cursors:function(){return j},destroy:function(){return Yi},drawing:function(){return f},init:function(){return Ki},removeTool:function(){return Xi},segmentation:function(){return q},state:function(){return Fe},synchronizers:function(){return v},utilities:function(){return B}});var e={};h.r(e),h.d(e,{checkAndDefineIsLockedProperty:function(){return de},getAnnotationsLocked:function(){return le},getAnnotationsLockedCount:function(){return se},isAnnotationLocked:function(){return ce},setAnnotationLocked:function(){return ae},unlockAllAnnotations:function(){return ie}});var t={};h.r(t),h.d(t,{deselectAnnotation:function(){return we},getAnnotationsSelected:function(){return Ee},getAnnotationsSelectedByToolName:function(){return ye},getAnnotationsSelectedCount:function(){return be},isAnnotationSelected:function(){return Ie},setAnnotationSelected:function(){return me}});var n={};h.r(n),h.d(n,{checkAndDefineIsVisibleProperty:function(){return Me},isAnnotationVisible:function(){return xe},setAnnotationVisibility:function(){return Oe},showAllAnnotations:function(){return Se}});var r={};h.r(r),h.d(r,{addAnnotation:function(){return Qe},getAnnotation:function(){return nt},getAnnotationManager:function(){return Je},getAnnotations:function(){return Xe},getNumberOfAnnotations:function(){return et},removeAllAnnotations:function(){return rt},removeAnnotation:function(){return tt},resetAnnotationManager:function(){return Ze},setAnnotationManager:function(){return $e}});var o={};h.r(o),h.d(o,{triggerSegmentationDataModified:function(){return Tt},triggerSegmentationModified:function(){return Ct},triggerSegmentationRemoved:function(){return yt},triggerSegmentationRepresentationModified:function(){return bt},triggerSegmentationRepresentationRemoved:function(){return It}});var a={};h.r(a),h.d(a,{addColorLUT:function(){return Jt},addSegmentation:function(){return kt},addSegmentationRepresentation:function(){return Ht},getAllSegmentationRepresentations:function(){return Pt},getColorLUT:function(){return Yt},getDefaultSegmentationStateManager:function(){return St},getGlobalConfig:function(){return Wt},getSegmentSpecificRepresentationConfig:function(){return Bt},getSegmentation:function(){return xt},getSegmentationRepresentationByUID:function(){return Gt},getSegmentationRepresentationSpecificConfig:function(){return Vt},getSegmentationRepresentations:function(){return Rt},getSegmentations:function(){return Mt},getToolGroupIdsWithSegmentation:function(){return Nt},getToolGroupSpecificConfig:function(){return At},removeColorLUT:function(){return Kt},removeSegmentation:function(){return qt},removeSegmentationRepresentation:function(){return zt},setGlobalConfig:function(){return Ft},setSegmentSpecificRepresentationConfig:function(){return jt},setSegmentationRepresentationSpecificConfig:function(){return Ut},setToolGroupSpecificConfig:function(){return Lt}});var i={};h.r(i),h.d(i,{copyPoints:function(){return Yn},copyPointsList:function(){return Kn},getDeltaDistance:function(){return Gn},getDeltaDistanceBetweenIPoints:function(){return zn},getDeltaPoints:function(){return Fn},getDeltaRotation:function(){return qn},getMeanPoints:function(){return Jn},getMeanTouchPoints:function(){return $n}});var l={};h.r(l),h.d(l,{getSegmentationVisibility:function(){return _a},setSegmentVisibility:function(){return Oa},setSegmentationVisibility:function(){return Ta},setSegmentsVisibility:function(){return Da}});var c={};h.r(c),h.d(c,{createSynchronizer:function(){return al},destroy:function(){return il},destroySynchronizer:function(){return sl},getAllSynchronizers:function(){return cl},getSynchronizer:function(){return ll},getSynchronizersForViewport:function(){return ea}});var s={};h.r(s),h.d(s,{hideElementCursor:function(){return Kl},initElementCursor:function(){return Gl},resetElementCursor:function(){return zl},setElementCursor:function(){return ql}});var d={};h.r(d),h.d(d,{createToolGroup:function(){return ec},destroy:function(){return qi},destroyToolGroup:function(){return Fi},getAllToolGroups:function(){return tc},getToolGroup:function(){return ia},getToolGroupForViewport:function(){return Ur},getToolGroupsWithToolName:function(){return Ke}});var u={};h.r(u),h.d(u,{COLOR_LUT:function(){return ct}});var v={};h.r(v),h.d(v,{createCameraPositionSynchronizer:function(){return oc},createStackImageSynchronizer:function(){return Ic},createVOISynchronizer:function(){return ic},createZoomPanSynchronizer:function(){return sc}});var f={};h.r(f),h.d(f,{draw:function(){return Lr},drawArrow:function(){return Uc},drawCircle:function(){return _c},drawEllipse:function(){return Dc},drawHandles:function(){return Oc},drawLine:function(){return Sc},drawLinkedTextBox:function(){return Ac},drawPolyline:function(){return Mc},drawRect:function(){return Lc},drawTextBox:function(){return Pc}});var g={};h.r(g),h.d(g,{getActiveSegmentationRepresentation:function(){return ss},setActiveSegmentationRepresentation:function(){return ds}});var m={};h.r(m),h.d(m,{getLockedSegments:function(){return fs},isSegmentIndexLocked:function(){return us},setSegmentIndexLocked:function(){return vs}});var w={};h.r(w),h.d(w,{getActiveSegmentIndex:function(){return hs},setActiveSegmentIndex:function(){return gs}});var E={};h.r(E),h.d(E,{addColorLUT:function(){return ps},getColorForSegmentIndex:function(){return ws},setColorForSegmentIndex:function(){return Es},setColorLUT:function(){return ms}});var y={};h.r(y),h.d(y,{createLabelmapVolumeForViewport:function(){return yd},createMergedLabelmapForIndex:function(){return md},floodFill:function(){return Td},getBrushSizeForToolGroup:function(){return Dd},getBrushThresholdForToolGroup:function(){return Sd},getDefaultRepresentationConfig:function(){return Ed},isValidRepresentationConfig:function(){return wd},rectangleROIThresholdVolumeByRange:function(){return pd},setBrushSizeForToolGroup:function(){return _d},setBrushThresholdForToolGroup:function(){return Od},thresholdSegmentationByRange:function(){return xd},thresholdVolumeByRange:function(){return _s},triggerSegmentationRender:function(){return Ui}});var I={};h.r(I),h.d(I,{getTextBoxCoordsCanvas:function(){return Qs}});var b={};h.r(b),h.d(b,{findClosestPoint:function(){return Nc},liangBarksyClip:function(){return Nd}});var C={};h.r(C),h.d(C,{getCanvasEllipseCorners:function(){return es},pointInEllipse:function(){return ts}});var T={};h.r(T),h.d(T,{distanceToPoint:function(){return Zs},distanceToPointSquared:function(){return $s},intersectLine:function(){return Ld}});var _={};h.r(_),h.d(_,{distanceToPoint:function(){return Xs}});var D={};h.r(D),h.d(D,{addCanvasPointsToArray:function(){return zd},calculateAreaOfPoints:function(){return Yd},getClosestIntersectionWithPolyline:function(){return Vd},getFirstIntersectionWithPolyline:function(){return Ud},getSubPixelSpacingAndXYDirections:function(){return Gd},pointCanProjectOnLine:function(){return Kd},pointsAreWithinCloseContourProximity:function(){return qd}});var O={};h.r(O),h.d(O,{distanceToPoint:function(){return Jd}});var S={};h.r(S),h.d(S,{ellipse:function(){return C},lineSegment:function(){return T},point:function(){return O},polyline:function(){return D},rectangle:function(){return _},vec2:function(){return b}});var x={};h.r(x),h.d(x,{default:function(){return eu},filterAnnotationsForDisplay:function(){return Us},filterAnnotationsWithinSlice:function(){return Ls},getPointInLineOfSightWithCriteria:function(){return Xd},getWorldWidthAndHeightFromCorners:function(){return ed}});var M={};h.r(M),h.d(M,{filterViewportsWithFrameOfReferenceUID:function(){return Ds},filterViewportsWithParallelNormals:function(){return Rs},filterViewportsWithToolEnabled:function(){return Ms},getViewportIdsWithToolToRender:function(){return Ps}});var k={};h.r(k),h.d(k,{getOrientationStringLPS:function(){return tu},invertOrientationStringLPS:function(){return nu}});var R={};h.r(R),h.d(R,{Events:function(){return ou},addToolState:function(){return iu},getToolState:function(){return lu},playClip:function(){return vu},stopClip:function(){return fu}});var P={};h.r(P),h.d(P,{extend2DBoundingBoxInViewAxis:function(){return ud},getBoundingBoxAroundShape:function(){return Yc}});var N={};h.r(N),h.d(N,{default:function(){return Fv},interpolateAnnotation:function(){return Wv}});var A={};h.r(A),h.d(A,{getBoundsIJKFromRectangleAnnotations:function(){return vd}});var L={};h.r(L),h.d(L,{disable:function(){return rf},enable:function(){return nf},getConfiguration:function(){return of},setConfiguration:function(){return af}});var U={};h.r(U),h.d(U,{isViewportPreScaled:function(){return nd},jumpToSlice:function(){return pc},jumpToWorld:function(){return lf}});var V={};h.r(V),h.d(V,{generateImageFromTimeData:function(){return sf},getDataInTime:function(){return cf}});var B={};h.r(B),h.d(B,{boundingBox:function(){return P},calibrateImageSpacing:function(){return zc},cine:function(){return R},clip:function(){return uc},debounce:function(){return Fc},drawing:function(){return I},dynamicVolume:function(){return V},getAnnotationNearPoint:function(){return Bc},getAnnotationNearPointOnEnabledElement:function(){return jc},isObject:function(){return Wc},jumpToSlice:function(){return pc},math:function(){return S},orientation:function(){return k},planar:function(){return x},planarFreehandROITool:function(){return N},pointInShapeCallback:function(){return Kc},pointInSurroundingSphereCallback:function(){return $c},rectangleROITool:function(){return A},roundNumber:function(){return Zc},scroll:function(){return vc},segmentation:function(){return y},stackPrefetch:function(){return L},throttle:function(){return Gc},touch:function(){return i},triggerAnnotationRender:function(){return qr},triggerAnnotationRenderForViewportIds:function(){return na},triggerEvent:function(){return K.triggerEvent},viewport:function(){return U},viewportFilters:function(){return M}});var j={};h.r(j),h.d(j,{CursorNames:function(){return uf},CursorSVG:function(){return Sl},ImageMouseCursor:function(){return yl},MouseCursor:function(){return gl},SVGMouseCursor:function(){return Vl},elementCursor:function(){return s},registerCursor:function(){return Ml},setCursorForElement:function(){return df}});var H={};h.r(H);var W={};h.r(W),h.d(W,{getFont:function(){return vf},getState:function(){return Vs},style:function(){return Nl}});var F={};h.r(F),h.d(F,{FrameOfReferenceSpecificAnnotationManager:function(){return je},config:function(){return W},locking:function(){return e},selection:function(){return t},state:function(){return r},visibility:function(){return n}});var G={};h.r(G),h.d(G,{color:function(){return E},getGlobalConfig:function(){return ga},getGlobalRepresentationConfig:function(){return pa},getSegmentSpecificConfig:function(){return ba},getSegmentationRepresentationSpecificConfig:function(){return ya},getToolGroupSpecificConfig:function(){return wa},setGlobalConfig:function(){return ha},setGlobalRepresentationConfig:function(){return ma},setSegmentSpecificConfig:function(){return Ca},setSegmentationRepresentationSpecificConfig:function(){return Ia},setToolGroupSpecificConfig:function(){return Ea},visibility:function(){return l}});var q={};h.r(q),h.d(q,{activeSegmentation:function(){return g},addSegmentationRepresentations:function(){return wf},addSegmentations:function(){return gf},config:function(){return G},removeSegmentationsFromToolGroup:function(){return Wi},segmentIndex:function(){return w},segmentLocking:function(){return m},state:function(){return a},triggerSegmentationEvents:function(){return o}});var z={};h.r(z),h.d(z,{AnnotationStyleStates:function(){return El},Events:function(){return J},KeyboardBindings:function(){return ho},MouseBindings:function(){return go},SegmentationRepresentations:function(){return dt},Swipe:function(){return Hn},ToolModes:function(){return qe}});var K=h(953),Y=function(e){return e.TOOL_ACTIVATED="CORNERSTONE_TOOLS_TOOL_ACTIVATED",e.ANNOTATION_ADDED="CORNERSTONE_TOOLS_ANNOTATION_ADDED",e.ANNOTATION_COMPLETED="CORNERSTONE_TOOLS_ANNOTATION_COMPLETED",e.ANNOTATION_MODIFIED="CORNERSTONE_TOOLS_ANNOTATION_MODIFIED",e.ANNOTATION_REMOVED="CORNERSTONE_TOOLS_ANNOTATION_REMOVED",e.ANNOTATION_SELECTION_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_SELECTION_CHANGE",e.ANNOTATION_LOCK_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_LOCK_CHANGE",e.ANNOTATION_VISIBILITY_CHANGE="CORNERSTONE_TOOLS_ANNOTATION_VISIBILITY_CHANGE",e.ANNOTATION_RENDERED="CORNERSTONE_TOOLS_ANNOTATION_RENDERED",e.SEGMENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_MODIFIED",e.SEGMENTATION_RENDERED="CORNERSTONE_TOOLS_SEGMENTATION_RENDERED",e.SEGMENTATION_REPRESENTATION_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_MODIFIED",e.SEGMENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REMOVED",e.SEGMENTATION_REPRESENTATION_REMOVED="CORNERSTONE_TOOLS_SEGMENTATION_REPRESENTATION_REMOVED",e.SEGMENTATION_DATA_MODIFIED="CORNERSTONE_TOOLS_SEGMENTATION_DATA_MODIFIED",e.KEY_DOWN="CORNERSTONE_TOOLS_KEY_DOWN",e.KEY_UP="CORNERSTONE_TOOLS_KEY_UP",e.MOUSE_DOWN="CORNERSTONE_TOOLS_MOUSE_DOWN",e.MOUSE_UP="CORNERSTONE_TOOLS_MOUSE_UP",e.MOUSE_DOWN_ACTIVATE="CORNERSTONE_TOOLS_MOUSE_DOWN_ACTIVATE",e.MOUSE_DRAG="CORNERSTONE_TOOLS_MOUSE_DRAG",e.MOUSE_MOVE="CORNERSTONE_TOOLS_MOUSE_MOVE",e.MOUSE_CLICK="CORNERSTONE_TOOLS_MOUSE_CLICK",e.MOUSE_DOUBLE_CLICK="CORNERSTONE_TOOLS_MOUSE_DOUBLE_CLICK",e.MOUSE_WHEEL="CORNERSTONE_TOOLS_MOUSE_WHEEL",e.TOUCH_START="CORNERSTONE_TOOLS_TOUCH_START",e.TOUCH_START_ACTIVATE="CORNERSTONE_TOOLS_TOUCH_START_ACTIVATE",e.TOUCH_PRESS="CORNERSTONE_TOOLS_TOUCH_PRESS",e.TOUCH_DRAG="CORNERSTONE_TOOLS_TOUCH_DRAG",e.TOUCH_END="CORNERSTONE_TOOLS_TOUCH_END",e.TOUCH_TAP="CORNERSTONE_TOOLS_TAP",e.TOUCH_SWIPE="CORNERSTONE_TOOLS_SWIPE",e}(Y||{}),J=Y;function $(e){return $="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$(e)}function Z(e){var t=function(e,t){if("object"!==$(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,"string");if("object"!==$(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"===$(t)?t:String(t)}function X(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Z(r.key),r)}}function Q(e,t,n){return t&&X(e.prototype,t),n&&X(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function te(e,t,n){return(t=Z(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ne=h(907),re=h.n(ne),oe=new Set;function ae(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=ue();e&&(t?function(e,t,n){t.has(e)||(t.add(e),n.added.push(e))}(e,oe,n):ve(e,oe,n)),fe(n,oe)}function ie(){var e=ue();!function(e,t){e.forEach((function(n){ve(n,e,t)}))}(oe,e),fe(e,oe)}function le(){return Array.from(oe)}function ce(e){return oe.has(e)}function se(){return oe.size}function de(e){if(e){var t=!!e.isLocked;(function(e){var t=Object.getOwnPropertyDescriptor(e,"isLocked");return t?t.configurable&&(t.set!==ge||t.get!==he):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isLocked",{configurable:!1,enumerable:!0,set:ge,get:he}),ae(e,t)}}function ue(){return Object.freeze({added:[],removed:[],locked:[]})}function ve(e,t,n){t.delete(e)&&n.removed.push(e)}function fe(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((function(t){e.locked.push(t)})),(0,K.triggerEvent)(K.eventTarget,J.ANNOTATION_LOCK_CHANGE,e))}function ge(e){ae(this,e)}function he(){return ce(this)}var pe=new Set;function me(e){arguments.length>1&&void 0!==arguments[1]&&!arguments[1]?we(e):function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=Ce();t||Te(pe,n),e&&!pe.has(e)&&(pe.add(e),n.added.push(e)),_e(n,pe)}(e,arguments.length>2&&void 0!==arguments[2]&&arguments[2])}function we(e){var t=Ce();e?pe.delete(e)&&t.removed.push(e):Te(pe,t),_e(t,pe)}function Ee(){return Array.from(pe)}function ye(e){return Ee().filter((function(t){return nt(t).metadata.toolName===e}))}function Ie(e){return pe.has(e)}function be(){return pe.size}function Ce(){return Object.freeze({added:[],removed:[],selection:[]})}function Te(e,t){e.forEach((function(n){e.delete(n)&&t.removed.push(n)}))}function _e(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach((function(t){e.selection.push(t)})),(0,K.triggerEvent)(K.eventTarget,J.ANNOTATION_SELECTION_CHANGE,e))}var De=new Set;function Oe(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=ke();e&&(t?Re(e,De,n):function(e,t,n){t.has(e)||(t.add(e),Ie(e)&&we(e),n.lastHidden.push(e))}(e,De,n)),Pe(n)}function Se(){var e=ke();De.forEach((function(t){Re(t,De,e)})),Pe(e)}function xe(e){if(nt(e))return!De.has(e)}function Me(e){if(e){var t,n=null===(t=e.isVisible)||void 0===t||t;(function(e){var t=Object.getOwnPropertyDescriptor(e,"isVisible");return t?t.configurable&&(t.set!==Ne||t.get!==Ae):Object.isExtensible(e)})(e)&&Object.defineProperty(e,"isVisible",{configurable:!1,enumerable:!0,set:Ne,get:Ae}),Oe(e.annotationUID,n)}}function ke(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function Re(e,t,n){t.delete(e)&&n.lastVisible.push(e)}function Pe(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(De.forEach((function(t){e.hidden.push(t)})),(0,K.triggerEvent)(K.eventTarget,J.ANNOTATION_VISIBILITY_CHANGE,e))}function Ne(e){Oe(this.annotationUID,e)}function Ae(){return xe(this.annotationUID)}function Le(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ue(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ue(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}function Ue(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ve=Q((function e(t){var n=this;ee(this,e),te(this,"annotations",void 0),te(this,"uid",void 0),te(this,"getGroupKey",(function(e){if("string"==typeof e)return e;var t=e,n=(0,K.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID})),te(this,"_imageVolumeModifiedHandler",(function(e){var t=e.detail.FrameOfReferenceUID,r=n.annotations[t];r&&Object.keys(r).forEach((function(e){r[e].forEach((function(e){void 0!==e.invalidated&&(e.invalidated=!0)}))}))})),te(this,"getFramesOfReference",(function(){return Object.keys(n.annotations)})),te(this,"getAnnotations",(function(e,t){var r=n.annotations;return r[e]?t?r[e][t]:r[e]:[]})),te(this,"getAnnotation",(function(e){var t=n.annotations;for(var r in t){var o=t[r];for(var a in o){var i,l=Le(o[a]);try{for(l.s();!(i=l.n()).done;){var c=i.value;if(e===c.annotationUID)return c}}catch(e){l.e(e)}finally{l.f()}}}})),te(this,"getNumberOfAnnotations",(function(e,t){var r=n.getAnnotations(e,t);if(!r.length)return 0;if(t)return r.length;var o=0;for(var a in r)o+=r[a].length;return o})),te(this,"addAnnotation",(function(e,t){var r=e.metadata,o=r.FrameOfReferenceUID,a=r.toolName;t=t||o;var i=n.annotations,l=i[t];l||(i[t]={},l=i[t]);var c=l[a];c||(l[a]=[],c=l[a]),c.push(e),de(e),Me(e)})),te(this,"removeAnnotation",(function(e){var t=n.annotations;for(var r in t){var o=t[r];for(var a in o){var i=o[a],l=i.findIndex((function(t){return t.annotationUID===e}));-1!==l&&(i.splice(l,1),0===i.length&&delete o[a])}0===Object.keys(o).length&&delete t[r]}})),te(this,"removeAnnotations",(function(e,t){var r=n.annotations;r[e]&&(t?delete r[e][t]:delete r[e])})),te(this,"saveAnnotations",(function(e,t){var r=n.annotations;if(e&&t){var o=r[e];if(!o)return;var a=o[t];return re()(a)}if(e){var i=r[e];return re()(i)}return re()(r)})),te(this,"restoreAnnotations",(function(e,t,r){var o=n.annotations;if(t&&r){var a=o[t];a||(o[t]={},a=o[t]),a[r]=e}else t?o[t]=e:n.annotations=re()(e)})),te(this,"getNumberOfAllAnnotations",(function(){var e=0,t=n.annotations;for(var r in t){var o=t[r];for(var a in o)e+=o[a].length}return e})),te(this,"removeAllAnnotations",(function(){n.annotations={}})),t||(t=K.utilities.uuidv4()),this.annotations={},this.uid=t,K.eventTarget.addEventListener(K.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)})),Be=new Ve("DEFAULT"),je=Ve,He={},We={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:He,enabledElements:[],handleRadius:6},Fe={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:He,enabledElements:[],handleRadius:6};var Ge=function(e){return e.Active="Active",e.Passive="Passive",e.Enabled="Enabled",e.Disabled="Disabled",e}(Ge||{}),qe=Ge,ze=[qe.Active,qe.Passive,qe.Enabled],Ke=function(e){return Fe.toolGroups.filter((function(t){for(var n=t.toolOptions,r=Object.keys(n),o=0;o<r.length;o++)if(e===r[o]&&n[e]&&ze.includes(n[e].mode))return!0;return!1}))},Ye=Be;function Je(){return Ye}function $e(e){Ye=e}function Ze(){Ye=Be}function Xe(e,t){var n=Je(),r=n.getGroupKey(t);return n.getAnnotations(r,e)}function Qe(e,t){void 0===e.annotationUID&&(e.annotationUID=K.utilities.uuidv4());var n=Je(),r=n.getGroupKey(t);return n.addAnnotation(e,r),t instanceof HTMLDivElement?function(e,t){var n=(0,K.getEnabledElement)(t),r=n.renderingEngine,o=n.viewportId,a=J.ANNOTATION_ADDED,i={annotation:e,viewportId:o,renderingEngineId:r.id};(0,K.triggerEvent)(K.eventTarget,a,i)}(e,t):function(e){var t=e.metadata.toolName,n=Ke(t);if(n.length){var r=[];if(n.forEach((function(t){t.viewportsInfo.forEach((function(t){var n=t.renderingEngineId,o=t.viewportId,a=(0,K.getEnabledElementByIds)(o,n).FrameOfReferenceUID;e.metadata.FrameOfReferenceUID===a&&r.push(t)}))})),r.length){var o=J.ANNOTATION_ADDED;r.forEach((function(t){var n=t.renderingEngineId,r=t.viewportId,a={annotation:e,viewportId:r,renderingEngineId:n};(0,K.triggerEvent)(K.eventTarget,o,a)}))}}}(e),e.annotationUID}function et(e,t){var n=Je(),r=n.getGroupKey(t);return n.getNumberOfAnnotations(r,e)}function tt(e){var t=Je(),n=t.getAnnotation(e);if(n){t.removeAnnotation(e);var r=J.ANNOTATION_REMOVED,o={annotation:n,annotationManagerUID:t.uid};(0,K.triggerEvent)(K.eventTarget,r,o)}}function nt(e){return Je().getAnnotation(e)}function rt(){Je().removeAllAnnotations()}function ot(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function at(e,t){if(e){if("string"==typeof e)return ot(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ot(e,t):void 0}}function it(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,l=[],c=!0,s=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(l.push(r.value),l.length!==t);c=!0);}catch(e){s=!0,o=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(s)throw o}}return l}}(e,t)||at(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var lt,ct=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]],st=function(e){return e.Labelmap="LABELMAP",e.Contour="CONTOUR",e}(st||{}),dt=st,ut={renderOutline:!0,outlineWidthActive:2,outlineWidthInactive:2,outlineOpacity:1,outlineOpacityInactive:.85,renderFill:!0,fillAlpha:1,fillAlphaInactive:0},vt={renderOutline:!0,outlineWidthActive:3,outlineWidthInactive:2,renderFill:!0,renderFillInactive:!0,fillAlpha:.7,fillAlphaInactive:.65,outlineOpacity:1,outlineOpacityInactive:.85},ft=function(){return vt};function gt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ht(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?gt(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var pt=ft(),mt=ut,wt={colorLUT:[],segmentations:[],globalConfig:{renderInactiveSegmentations:!0,representations:(lt={},te(lt,dt.Labelmap,pt),te(lt,dt.Contour,mt),lt)},toolGroups:{}},Et=new(function(){function e(t){ee(this,e),te(this,"state",void 0),te(this,"uid",void 0),t||(t=K.utilities.uuidv4()),this.state=re()(wt),this.uid=t}return Q(e,[{key:"getState",value:function(){return this.state}},{key:"getToolGroups",value:function(){return Object.keys(this.state.toolGroups)}},{key:"getColorLUT",value:function(e){return this.state.colorLUT[e]}},{key:"resetState",value:function(){this.state=re()(wt)}},{key:"getSegmentation",value:function(e){return this.state.segmentations.find((function(t){return t.segmentationId===e}))}},{key:"addSegmentation",value:function(e){if(this._initDefaultColorLUTIfNecessary(),this.getSegmentation(e.segmentationId))throw new Error("Segmentation with id ".concat(e.segmentationId," already exists"));this.state.segmentations.push(e)}},{key:"getSegmentationRepresentations",value:function(e){var t=this.state.toolGroups[e];if(t)return t.segmentationRepresentations}},{key:"getAllSegmentationRepresentations",value:function(){var e={};return Object.entries(this.state.toolGroups).forEach((function(t){var n=it(t,2),r=n[0],o=n[1];e[r]=o.segmentationRepresentations})),e}},{key:"addSegmentationRepresentation",value:function(e,t){this.state.toolGroups[e]||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{}}),this.state.toolGroups[e].segmentationRepresentations.push(t),this._handleActiveSegmentation(e,t)}},{key:"getGlobalConfig",value:function(){return this.state.globalConfig}},{key:"setGlobalConfig",value:function(e){this.state.globalConfig=e}},{key:"getSegmentationRepresentationByUID",value:function(e,t){return this.getSegmentationRepresentations(e).find((function(e){return e.segmentationRepresentationUID===t}))}},{key:"removeSegmentation",value:function(e){this.state.segmentations=this.state.segmentations.filter((function(t){return t.segmentationId!==e}))}},{key:"removeSegmentationRepresentation",value:function(e,t){var n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error("No viewport specific segmentation state found for viewport ".concat(e));var r=n.findIndex((function(e){return e.segmentationRepresentationUID===t}));-1===r&&console.warn("No viewport specific segmentation state data found for viewport ".concat(e," and segmentation data UID ").concat(t));var o=n[r];n.splice(r,1),this._handleActiveSegmentation(e,o)}},{key:"setActiveSegmentationRepresentation",value:function(e,t){var n=this.getSegmentationRepresentations(e);if(!n||!n.length)throw new Error("No segmentation data found for toolGroupId: ".concat(e));var r=n.find((function(e){return e.segmentationRepresentationUID===t}));if(!r)throw new Error("No segmentation data found for segmentation data UID ".concat(t));r.active=!0,this._handleActiveSegmentation(e,r)}},{key:"getToolGroupSpecificConfig",value:function(e){var t=this.state.toolGroups[e];if(t)return t.config}},{key:"getSegmentationRepresentationSpecificConfig",value:function(e,t){var n=this.getSegmentationRepresentationByUID(e,t);if(n)return n.segmentationRepresentationSpecificConfig}},{key:"setSegmentationRepresentationSpecificConfig",value:function(e,t,n){var r=this.getSegmentationRepresentationByUID(e,t);r&&(r.segmentationRepresentationSpecificConfig=n)}},{key:"getSegmentSpecificConfig",value:function(e,t,n){var r=this.getSegmentationRepresentationByUID(e,t);if(r)return r.segmentSpecificConfig[n]}},{key:"setSegmentSpecificConfig",value:function(e,t,n){var r=this.getSegmentationRepresentationByUID(e,t);r&&(r.segmentSpecificConfig=n)}},{key:"setSegmentationRepresentationConfig",value:function(e,t){var n=this.state.toolGroups[e];n||(this.state.toolGroups[e]={segmentationRepresentations:[],config:{renderInactiveSegmentations:!0,representations:{}}},n=this.state.toolGroups[e]),n.config=ht(ht({},n.config),t)}},{key:"addColorLUT",value:function(e,t){this.state.colorLUT[t]&&console.log("Color LUT table already exists, overwriting"),this.state.colorLUT[t]=e}},{key:"removeColorLUT",value:function(e){delete this.state.colorLUT[e]}},{key:"_handleActiveSegmentation",value:function(e,t){var n=this.getSegmentationRepresentations(e);0!==n.length&&(1!==n.length&&0!==n.filter((function(e){return e.active})).length?t.active&&n.forEach((function(e){e.segmentationRepresentationUID!==t.segmentationRepresentationUID&&(e.active=!1)})):n[0].active=!0)}},{key:"_initDefaultColorLUTIfNecessary",value:function(){0!==this.state.colorLUT.length&&this.state.colorLUT[0]||this.addColorLUT(ct,0)}}]),e}())("DEFAULT");function yt(e){var t={segmentationId:e};(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_REMOVED,t)}function It(e,t){var n={toolGroupId:e,segmentationRepresentationUID:t};(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_REPRESENTATION_REMOVED,n)}function bt(e,t){var n={toolGroupId:e,segmentationRepresentationUID:t};t?(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_REPRESENTATION_MODIFIED,n):(Rt(e)||[]).forEach((function(t){var n=t.segmentationRepresentationUID,r={toolGroupId:e,segmentationRepresentationUID:n};(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_REPRESENTATION_MODIFIED,r)}))}function Ct(e){(e?[e]:Mt().map((function(e){return e.segmentationId}))).forEach((function(e){var t={segmentationId:e};(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_MODIFIED,t)}))}function Tt(e,t){var n={segmentationId:e,modifiedSlicesToUse:t};(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_DATA_MODIFIED,n)}function _t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Dt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?_t(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Ot=function(e){var t=e.segmentationId,n=e.representation;return{segmentationId:t,cachedStats:{},segmentLabels:{},label:null,segmentsLocked:new Set,type:n.type,activeSegmentIndex:1,representationData:te({},n.type,Dt({},n.data))}};function St(){return Et}function xt(e){return St().getSegmentation(e)}function Mt(){return St().getState().segmentations}function kt(e,t){var n=St(),r=Ot(e);n.addSegmentation(r),t||Ct(r.segmentationId)}function Rt(e){return St().getSegmentationRepresentations(e)}function Pt(){return St().getAllSegmentationRepresentations()}function Nt(e){if(!e)throw new Error("getToolGroupIdsWithSegmentation: segmentationId is empty");var t=St(),n=t.getState(),r=Object.keys(n.toolGroups),o=[];return r.forEach((function(n){t.getSegmentationRepresentations(n).forEach((function(t){t.segmentationId===e&&o.push(n)}))})),o}function At(e){return St().getToolGroupSpecificConfig(e)}function Lt(e,t,n){St().setSegmentationRepresentationConfig(e,t),n||bt(e)}function Ut(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];St().setSegmentationRepresentationSpecificConfig(e,t,n),r||bt(e,t)}function Vt(e,t){return St().getSegmentationRepresentationSpecificConfig(e,t)}function Bt(e,t,n){return St().getSegmentSpecificConfig(e,t,n)}function jt(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];St().setSegmentSpecificConfig(e,t,n),r||bt(e,t)}function Ht(e,t,n){St().addSegmentationRepresentation(e,t),n||bt(e,t.segmentationRepresentationUID)}function Wt(){return St().getGlobalConfig()}function Ft(e,t){St().setGlobalConfig(e),t||Ct()}function Gt(e,t){return St().getSegmentationRepresentationByUID(e,t)}function qt(e){St().removeSegmentation(e),yt(e)}function zt(e,t){St().removeSegmentationRepresentation(e,t),It(e,t)}function Kt(e){St().removeColorLUT(e)}function Yt(e){return St().getColorLUT(e)}function Jt(e,t){St().addColorLUT(e,t)}function $t(e,t){var n=t||e.currentTarget,r=(0,K.getEnabledElement)(n).viewport,o=function(e){return[e.clientX,e.clientY]}(e),a=function(e){return[e.pageX,e.pageY]}(e),i=function(e,t){var n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,a);return{page:a,client:o,canvas:i,world:r.canvasToWorld(i)}}var Zt=function(e){var t=e.currentTarget,n=(0,K.getEnabledElement)(t),r=n.viewportId,o=n.renderingEngineId,a=$t(e,t),i={event:e,eventName:J.MOUSE_DOUBLE_CLICK,viewportId:r,renderingEngineId:o,camera:{},element:t,startPoints:a,lastPoints:a,currentPoints:a,deltaPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}};!(0,K.triggerEvent)(t,J.MOUSE_DOUBLE_CLICK,i)&&(e.stopImmediatePropagation(),e.preventDefault())},Xt=J.MOUSE_MOVE,Qt=function(e){var t=e.currentTarget,n=(0,K.getEnabledElement)(t),r={renderingEngineId:n.renderingEngineId,viewportId:n.viewportId,camera:{},element:t,currentPoints:$t(e),eventName:Xt,event:e};(0,K.triggerEvent)(t,Xt,r)},en=J.MOUSE_DOWN,tn=J.MOUSE_DOWN_ACTIVATE,nn=J.MOUSE_CLICK,rn=J.MOUSE_UP,on=J.MOUSE_DRAG,an=3,ln={mouseButton:void 0,element:null,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},cn={mouseButton:void 0,renderingEngineId:void 0,viewportId:void 0,isClickEvent:!0,clickDelay:200,element:null,preventClickTimeout:null,startPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},lastPoints:{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]}},sn={doubleClickTimeout:null,mouseDownEvent:null,mouseUpEvent:null,ignoreDoubleClick:!1};function dn(e){var t=$t(e,cn.element),n=En(cn.element,cn.lastPoints),r=yn(t,n);if(sn.doubleClickTimeout){if(!fn(r.canvas))return;hn()}var o={event:e,eventName:on,mouseButton:cn.mouseButton,renderingEngineId:cn.renderingEngineId,viewportId:cn.viewportId,camera:{},element:cn.element,startPoints:wn(cn.startPoints),lastPoints:wn(n),currentPoints:t,deltaPoints:r};(0,K.triggerEvent)(cn.element,on,o),cn.lastPoints=wn(t)}function un(e){if(clearTimeout(cn.preventClickTimeout),sn.doubleClickTimeout)sn.mouseUpEvent?mn():(sn.mouseUpEvent=e,cn.element.addEventListener("mousemove",vn));else{var t=cn.isClickEvent?nn:rn,n=$t(e,cn.element),r=yn(n,cn.lastPoints),o={event:e,eventName:t,mouseButton:cn.mouseButton,element:cn.element,renderingEngineId:cn.renderingEngineId,viewportId:cn.viewportId,camera:{},startPoints:wn(cn.startPoints),lastPoints:wn(cn.lastPoints),currentPoints:n,deltaPoints:r};(0,K.triggerEvent)(o.element,t,o),mn()}document.removeEventListener("mousemove",dn)}function vn(e){fn(yn($t(e,cn.element),En(cn.element,cn.lastPoints)).canvas)&&(hn(),Qt(e))}function fn(e){return Math.abs(e[0])+Math.abs(e[1])>an}function gn(){cn.isClickEvent=!1}function hn(){sn.ignoreDoubleClick=!0;var e,t,n,r=sn.mouseDownEvent,o=sn.mouseUpEvent;pn(),e=r,t=yn(cn.startPoints,cn.startPoints),n={event:e,eventName:en,element:cn.element,mouseButton:cn.mouseButton,renderingEngineId:cn.renderingEngineId,viewportId:cn.viewportId,camera:{},startPoints:cn.startPoints,lastPoints:cn.startPoints,currentPoints:cn.startPoints,deltaPoints:t},cn.lastPoints=wn(n.lastPoints),(0,K.triggerEvent)(n.element,en,n)&&(0,K.triggerEvent)(n.element,tn,n),o&&un(o)}function pn(){sn.doubleClickTimeout&&(clearTimeout(sn.doubleClickTimeout),sn.doubleClickTimeout=null),sn.mouseDownEvent=null,sn.mouseUpEvent=null}function mn(){var e,t;document.removeEventListener("mouseup",un),null===(e=cn.element)||void 0===e||e.removeEventListener("mousemove",vn),null===(t=cn.element)||void 0===t||t.addEventListener("mousemove",Qt),pn(),cn=JSON.parse(JSON.stringify(ln))}function wn(e){return JSON.parse(JSON.stringify(e))}function En(e,t){var n=(0,K.getEnabledElement)(e).viewport.canvasToWorld(t.canvas);return{page:t.page,client:t.client,canvas:t.canvas,world:n}}function yn(e,t){return{page:In(e.page,t.page),client:In(e.client,t.client),canvas:In(e.canvas,t.canvas),world:(n=e.world,r=t.world,[n[0]-r[0],n[1]-r[1],n[2]-r[2]])};var n,r}function In(e,t){return[e[0]-t[0],e[1]-t[1]]}function bn(e){sn.ignoreDoubleClick?(sn.ignoreDoubleClick=!1,e.stopImmediatePropagation(),e.preventDefault()):mn()}var Cn=function(e){if(sn.doubleClickTimeout){if(e.buttons===sn.mouseDownEvent.buttons)return;return sn.mouseDownEvent=e,void hn()}sn.doubleClickTimeout=setTimeout(hn,1===e.buttons?400:150),sn.mouseDownEvent=e,sn.ignoreDoubleClick=!1,cn.element=e.currentTarget,cn.mouseButton=e.buttons;var t=(0,K.getEnabledElement)(cn.element),n=t.renderingEngineId,r=t.viewportId;cn.renderingEngineId=n,cn.viewportId=r,cn.preventClickTimeout=setTimeout(gn,cn.clickDelay),cn.element.removeEventListener("mousemove",Qt);var o=$t(e,cn.element);cn.startPoints=wn(o),cn.lastPoints=wn(o),document.addEventListener("mouseup",un),document.addEventListener("mousemove",dn)};function Tn(e){e.removeEventListener("dblclick",Zt),e.removeEventListener("mousedown",Cn),e.removeEventListener("mousemove",Qt),e.removeEventListener("dblclick",bn,{capture:!0})}var _n={enable:function(e){Tn(e),e.addEventListener("dblclick",Zt),e.addEventListener("mousedown",Cn),e.addEventListener("mousemove",Qt),e.addEventListener("dblclick",bn,{capture:!0})},disable:Tn},Dn=function(e){var t=e.currentTarget,n=(0,K.getEnabledElement)(t),r=n.renderingEngineId,o=n.viewportId;if(!(e.deltaY>-1&&e.deltaY<1)){e.preventDefault();var a=function(e){var t=0,n=0,r=0,o=0;return"detail"in e&&(n=e.detail),"wheelDelta"in e&&(n=-e.wheelDelta/120),"wheelDeltaY"in e&&(n=-e.wheelDeltaY/120),"wheelDeltaX"in e&&(t=-e.wheelDeltaX/120),r=10*t,o=10*n,"deltaY"in e&&(o=e.deltaY),"deltaX"in e&&(r=e.deltaX),(r||o)&&e.deltaMode&&(1===e.deltaMode?(r*=40,o*=40):(r*=800,o*=800)),r&&!t&&(t=r<1?-1:1),o&&!n&&(n=o<1?-1:1),{spinX:t,spinY:n,pixelX:r,pixelY:o}}(e),i=a.spinX,l=a.spinY,c=a.pixelX,s=a.pixelY,d=l<0?-1:1,u={event:e,eventName:J.MOUSE_WHEEL,renderingEngineId:r,viewportId:o,element:t,camera:{},detail:e,wheel:{spinX:i,spinY:l,pixelX:c,pixelY:s,direction:d},points:$t(e)};(0,K.triggerEvent)(t,J.MOUSE_WHEEL,u)}};function On(e){e.removeEventListener("wheel",Dn)}var Sn,xn,Mn={enable:function(e){On(e),e.addEventListener("wheel",Dn,{passive:!1})},disable:On},kn={mouse:0,touch:1};function Rn(e,t){var n=Date.now();if(e!==Sn){if(n-xn<=2e3)return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;Sn=e}xn=n}var Pn=Rn.bind(null,kn.mouse),Nn=Rn.bind(null,kn.touch);function An(e,t,n){var r=n?Pn:Nn;t.forEach((function(t){e.addEventListener(t,r,{passive:!1})}))}function Ln(e,t,n){var r=n?Pn:Nn;t.forEach((function(t){e.removeEventListener(t,r)}))}var Un=["mousedown","mouseup","mousemove"],Vn=["touchstart","touchend"];function Bn(e){Ln(e,Un,kn.mouse),Ln(e,Vn,kn.touch)}var jn={enable:function(e){Bn(e),An(e,Un,kn.mouse),An(e,Vn,kn.touch)},disable:Bn},Hn=function(e){return e.UP="UP",e.DOWN="DOWN",e.LEFT="LEFT",e.RIGHT="RIGHT",e}(Hn||{});function Wn(e,t){var n=t||e.currentTarget,r="touchend"===e.type?e.changedTouches:e.touches;return Object.keys(r).map((function(e){var t=function(e){return[e.clientX,e.clientY]}(r[e]),o=function(e){return[e.pageX,e.pageY]}(r[e]),a=function(e,t){var n=e.getBoundingClientRect();return[t[0]-n.left-window.pageXOffset,t[1]-n.top-window.pageYOffset]}(n,o);return{page:o,client:t,canvas:a,world:(0,K.getEnabledElement)(n).viewport.canvasToWorld(a),touch:{identifier:e,radiusX:r[e].radiusX,radiusY:r[e].radiusY,force:r[e].force,rotationAngle:r[e].rotationAngle}}}))}function Fn(e,t){var n,r,o=Jn(e),a=Jn(t);return{page:Zn(o.page,a.page),client:Zn(o.client,a.client),canvas:Zn(o.canvas,a.canvas),world:(n=o.world,r=a.world,[n[0]-r[0],n[1]-r[1],n[2]-r[2]])}}function Gn(e,t){var n=Jn(e),r=Jn(t);return{page:Qn(n.page,r.page),client:Qn(n.client,r.client),canvas:Qn(n.canvas,r.canvas),world:er(n.world,r.world)}}function qn(e,t){}function zn(e,t){var n=Xn(e),r=Xn(t);return{page:n.page-r.page,client:n.client-r.client,canvas:n.canvas-r.canvas,world:n.world-r.world}}function Kn(e){return JSON.parse(JSON.stringify(e))}function Yn(e){return JSON.parse(JSON.stringify(e))}function Jn(e){return e.reduce((function(t,n){return{page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function $n(e){return e.reduce((function(t,n){return{page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function Zn(e,t){return[e[0]-t[0],e[1]-t[1]]}function Xn(e){for(var t=[],n=0;n<e.length;n++)for(var r=0;r<e.length;r++)n<r&&t.push({page:Qn(e[n].page,e[r].page),client:Qn(e[n].client,e[r].client),canvas:Qn(e[n].canvas,e[r].canvas),world:er(e[n].world,e[r].world)});return t.reduce((function(e,n){return{page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length}}),{page:0,client:0,canvas:0,world:0})}function Qn(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function er(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}function tr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function nr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?tr(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):tr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var rr=K.Settings.getRuntimeSettings(),or=J.TOUCH_START,ar=J.TOUCH_START_ACTIVATE,ir=J.TOUCH_PRESS,lr=J.TOUCH_DRAG,cr=J.TOUCH_END,sr=J.TOUCH_TAP,dr=J.TOUCH_SWIPE,ur={page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]},vr={page:0,client:0,canvas:0,world:0},fr={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[nr(nr({},ur),{},{touch:null})],lastPointsList:[nr(nr({},ur),{},{touch:null})],isTouchStart:!1,startTime:null,pressTimeout:null,pressDelay:700,pressMaxDistance:5,accumulatedDistance:vr,swipeDistanceThreshold:48,swiped:!1,swipeToleranceMs:300},gr={renderingEngineId:void 0,viewportId:void 0,element:null,startPointsList:[nr(nr({},ur),{},{touch:null})],taps:0,tapTimeout:null,tapMaxDistance:24,tapToleranceMs:300},hr=JSON.parse(JSON.stringify(fr)),pr=JSON.parse(JSON.stringify(gr));function mr(e,t,n){return rr.get("debug")&&("CORNERSTONE_TOOLS_TOUCH_DRAG"===t?console.debug(t):console.debug(t,n)),(0,K.triggerEvent)(e,t,n)}function wr(e){var t=Wn(e,hr.element),n=yr(hr.element,hr.lastPointsList),r=t.length===n.length?Fn(t,n):ur,o=t.length===n.length?zn(t,n):vr,a=t.length===n.length?Gn(t,hr.lastPointsList):vr;hr.accumulatedDistance={page:hr.accumulatedDistance.page+a.page,client:hr.accumulatedDistance.client+a.client,canvas:hr.accumulatedDistance.canvas+a.canvas,world:hr.accumulatedDistance.world+a.world};var i={event:e,eventName:lr,renderingEngineId:hr.renderingEngineId,viewportId:hr.viewportId,camera:{},element:hr.element,startPoints:$n(hr.startPointsList),lastPoints:$n(n),currentPoints:$n(t),startPointsList:Kn(hr.startPointsList),lastPointsList:Kn(n),currentPointsList:t,deltaPoints:r,deltaDistance:o};mr(hr.element,lr,i),function(e,t){var n=(new Date).getTime(),r=hr.startTime.getTime();if(!(hr.swiped||n-r>hr.swipeToleranceMs)){var o=it(t.canvas,2),a=o[0],i=o[1],l={event:e,eventName:dr,renderingEngineId:hr.renderingEngineId,viewportId:hr.viewportId,camera:{},element:hr.element,swipe:null};Math.abs(a)>hr.swipeDistanceThreshold&&(l.swipe=a>0?Hn.RIGHT:Hn.LEFT,mr(l.element,dr,l),hr.swiped=!0),Math.abs(i)>hr.swipeDistanceThreshold&&(l.swipe=i>0?Hn.DOWN:Hn.UP,mr(l.element,dr,l),hr.swiped=!0)}}(e,r),hr.lastPointsList=Kn(t)}function Er(e){clearTimeout(hr.pressTimeout);var t=Wn(e,hr.element),n=yr(hr.element,hr.lastPointsList),r=t.length===n.length?Fn(t,n):Fn(t,t),o=t.length===n.length?zn(t,n):zn(t,t),a={event:e,eventName:cr,element:hr.element,renderingEngineId:hr.renderingEngineId,viewportId:hr.viewportId,camera:{},startPointsList:Kn(hr.startPointsList),lastPointsList:Kn(n),currentPointsList:t,startPoints:$n(hr.startPointsList),lastPoints:$n(n),currentPoints:$n(t),deltaPoints:r,deltaDistance:o};mr(a.element,cr,a),function(e){if(!((new Date).getTime()-hr.startTime.getTime()>pr.tapToleranceMs||(0===pr.taps&&(pr.element=hr.element,pr.renderingEngineId=hr.renderingEngineId,pr.viewportId=hr.viewportId,pr.startPointsList=hr.startPointsList),pr.taps>0&&(pr.element!=hr.element||pr.renderingEngineId!=hr.renderingEngineId||pr.viewportId!=hr.viewportId)))){var t=Wn(e,pr.element);Gn(t,pr.startPointsList).canvas>pr.tapMaxDistance||(clearTimeout(pr.tapTimeout),pr.taps+=1,pr.tapTimeout=setTimeout((function(){var n={event:e,eventName:sr,element:pr.element,renderingEngineId:pr.renderingEngineId,viewportId:pr.viewportId,camera:{},currentPointsList:t,currentPoints:$n(t),taps:pr.taps};mr(n.element,sr,n),pr=JSON.parse(JSON.stringify(gr))}),pr.tapToleranceMs))}}(e),hr=JSON.parse(JSON.stringify(fr)),document.removeEventListener("touchmove",wr),document.removeEventListener("touchend",Er)}function yr(e,t){var n=(0,K.getEnabledElement)(e).viewport;return t.map((function(e){var t=n.canvasToWorld(e.canvas);return{page:e.page,client:e.client,canvas:e.canvas,world:t,touch:e.touch}}))}var Ir=function(e){hr.element=e.currentTarget;var t=(0,K.getEnabledElement)(hr.element),n=t.renderingEngineId,r=t.viewportId;hr.renderingEngineId=n,hr.viewportId=r,hr.isTouchStart||(clearTimeout(hr.pressTimeout),hr.pressTimeout=setTimeout((function(){return function(e){if(!(hr.accumulatedDistance.canvas>hr.pressMaxDistance)){var t={event:e,eventName:ir,renderingEngineId:hr.renderingEngineId,viewportId:hr.viewportId,camera:{},element:hr.element,startPointsList:Kn(hr.startPointsList),lastPointsList:Kn(hr.lastPointsList),startPoints:Yn($n(hr.startPointsList)),lastPoints:Yn($n(hr.lastPointsList))};mr(t.element,ir,t)}}(e)}),hr.pressDelay),function(e){hr.isTouchStart=!0,hr.startTime=new Date;var t=Wn(e,hr.element),n=$n(t),r=ur,o=vr,a={event:e,eventName:or,element:hr.element,renderingEngineId:hr.renderingEngineId,viewportId:hr.viewportId,camera:{},startPointsList:t,lastPointsList:t,currentPointsList:t,startPoints:n,lastPoints:n,currentPoints:n,deltaPoints:r,deltaDistance:o};hr.startPointsList=Kn(a.startPointsList),hr.lastPointsList=Kn(a.lastPointsList),mr(a.element,or,a)&&mr(a.element,ar,a)}(e),document.addEventListener("touchmove",wr),document.addEventListener("touchend",Er))};function br(e){jn.disable(e),e.removeEventListener("touchstart",Ir)}var Cr={enable:function(e){br(e),jn.enable(e),e.addEventListener("touchstart",Ir,{passive:!1})},disable:br},Tr={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null},_r={renderingEngineId:void 0,viewportId:void 0,key:void 0,keyCode:void 0,element:null};function Dr(e){_r.element=e.currentTarget;var t=(0,K.getEnabledElement)(_r.element),n=t.renderingEngineId,r=t.viewportId;_r.renderingEngineId=n,_r.viewportId=r,_r.key=e.key,_r.keyCode=e.keyCode,e.preventDefault();var o={renderingEngineId:_r.renderingEngineId,viewportId:_r.viewportId,element:_r.element,key:_r.key,keyCode:_r.keyCode};(0,K.triggerEvent)(o.element,J.KEY_DOWN,o),document.addEventListener("keyup",Or),_r.element.removeEventListener("keydown",Dr)}function Or(e){var t={renderingEngineId:_r.renderingEngineId,viewportId:_r.viewportId,element:_r.element,key:_r.key,keyCode:_r.keyCode};document.removeEventListener("keyup",Or),_r.element.addEventListener("keydown",Dr),_r=re()(Tr),(0,K.triggerEvent)(t.element,J.KEY_UP,t)}var Sr=Dr;function xr(e){e.removeEventListener("keydown",Sr)}var Mr={enable:function(e){xr(e),e.addEventListener("keydown",Sr)},disable:xr,getModifierKey:function(){return _r.keyCode}};function kr(e){return function(e){if(Array.isArray(e))return ot(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||at(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Rr(e,t){if(Fe.svgNodeCache[e])return Fe.svgNodeCache[e][t]?Fe.svgNodeCache[e][t].domRef:void 0}function Pr(e,t,n,r){if(!Fe.svgNodeCache[t])return null;Fe.svgNodeCache[t][r]={touched:!0,domRef:n},e.appendChild(n)}function Nr(e,t){Fe.svgNodeCache[e]&&Fe.svgNodeCache[e][t]&&(Fe.svgNodeCache[e][t].touched=!0)}function Ar(e,t){Fe.svgNodeCache[t]&&Object.keys(Fe.svgNodeCache[t]).forEach((function(n){var r=Fe.svgNodeCache[t][n];!r.touched&&r.domRef&&(e.removeChild(r.domRef),delete Fe.svgNodeCache[t][n])}))}var Lr=function(e,t){var n=function(e){var t=(0,K.getEnabledElement)(e),n=t.viewportId,r=t.renderingEngineId,o="".concat(n,":").concat(r),a=function(e){var t=".".concat("viewport-element");return e.querySelector(t).querySelector(".svg-layer")}(e);return Object.keys(Fe.svgNodeCache[o]).forEach((function(e){Fe.svgNodeCache[o][e].touched=!1})),{svgLayerElement:a,svgNodeCacheForCanvas:Fe.svgNodeCache,getSvgNode:Rr.bind(this,o),appendNode:Pr.bind(this,a,o),setNodeTouched:Nr.bind(this,o),clearUntouched:Ar.bind(this,a,o)}}(e);t(n),n.clearUntouched()},Ur=function(e,t){var n=Fe.toolGroups.filter((function(n){return n.viewportsInfo.some((function(n){return n.renderingEngineId===t&&(!n.viewportId||n.viewportId===e)}))}));if(n.length){if(n.length>1)throw new Error("Multiple tool groups found for renderingEngineId: ".concat(t," and viewportId: ").concat(e,". You should only\n      have one tool group per viewport in a renderingEngine."));return n[0]}};function Vr(e,t){var n=(0,K.getEnabledElement)(e),r=n.renderingEngineId,o=n.viewportId,a=Ur(o,r);if(!a)return[];for(var i=[],l=Object.keys(a.toolOptions),c=0;c<l.length;c++){var s=l[c],d=a.toolOptions[s];if(d&&t.includes(d.mode)){var u=a.getToolInstance(s);i.push(u)}}return i}function Br(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var jr=qe.Active,Hr=qe.Passive,Wr=qe.Enabled,Fr=function(){function e(){var t=this;ee(this,e),te(this,"hasBeenDestroyed",void 0),te(this,"_needsRender",new Set),te(this,"_animationFrameSet",!1),te(this,"_animationFrameHandle",null),te(this,"_viewportElements",void 0),te(this,"_renderFlaggedViewports",(function(){t._throwIfDestroyed();for(var e=Array.from(t._viewportElements.values()),n=0;n<e.length;n++){var r=e[n];if(t._needsRender.has(r)&&(t._triggerRender(r),t._needsRender.delete(r),0===t._needsRender.size))return t._animationFrameSet=!1,void(t._animationFrameHandle=null)}})),this._viewportElements=new Map}return Q(e,[{key:"addViewportElement",value:function(e,t){this._viewportElements.set(e,t)}},{key:"removeViewportElement",value:function(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}},{key:"renderViewport",value:function(e){this._setViewportsToBeRenderedNextFrame([e])}},{key:"_throwIfDestroyed",value:function(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}},{key:"_setAllViewportsToBeRenderedNextFrame",value:function(){var e=this;kr(this._viewportElements.values()).forEach((function(t){e._needsRender.add(t)})),this._renderFlaggedViewports()}},{key:"_setViewportsToBeRenderedNextFrame",value:function(e){var t=this,n=kr(this._viewportElements.values());e.forEach((function(e){-1!==n.indexOf(e)&&t._needsRender.add(e)})),this._render()}},{key:"_render",value:function(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}},{key:"_triggerRender",value:function(e){var t=(0,K.getEnabledElement)(e);if(t)if((0,K.getRenderingEngine)(t.renderingEngineId)){var n=Vr(e,[jr,Hr,Wr]),r=t.renderingEngineId,o=t.viewportId,a={element:e,renderingEngineId:r,viewportId:o};Lr(e,(function(r){var o=!1;n.forEach((function(e){if(e.renderAnnotation){var n=e.renderAnnotation(t,r);o=o||n}})),o&&(0,K.triggerEvent)(e,J.ANNOTATION_RENDERED,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Br(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Br(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},a))}))}else console.warn("rendering Engine has been destroyed");else console.warn("Element has been disabled")}},{key:"_reset",value:function(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}}]),e}(),Gr=new Fr,qr=function(e){Gr.renderViewport(e)},zr=function(e){qr(e.detail.element)},Kr={enable:function(e){e.addEventListener(K.Enums.Events.IMAGE_RENDERED,zr)},disable:function(e){e.removeEventListener(K.Enums.Events.IMAGE_RENDERED,zr)}};function Yr(e,t,n){var r=e.detail,o=r.renderingEngineId,a=r.viewportId,i=Ur(a,o);if(!i)return[];for(var l=[],c=Object.keys(i.toolOptions),s=0;s<c.length;s++){var d=c[s],u=i.toolOptions[d],v=null!=n&&u.bindings.length&&u.bindings.some((function(e){return e.mouseButton===n}));if(t.includes(u.mode)&&(!n||v)){var f=i.getToolInstance(d);l.push(f)}}return l}var Jr=qe.Active,$r=qe.Passive,Zr=qe.Enabled,Xr=function(e){Yr(e,[Jr,$r,Zr]).forEach((function(t){t.onCameraModified&&t.onCameraModified(e)}))},Qr={enable:function(e){e.addEventListener(K.Enums.Events.CAMERA_MODIFIED,Xr)},disable:function(e){e.removeEventListener(K.Enums.Events.CAMERA_MODIFIED,Xr)}},eo=qe.Active,to=qe.Passive,no=qe.Enabled,ro=function(e){Yr(e,[eo,to,no]).forEach((function(t){t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)}))},oo={enable:function(e){e.addEventListener(K.Enums.Events.IMAGE_SPACING_CALIBRATED,ro)},disable:function(e){e.removeEventListener(K.Enums.Events.IMAGE_SPACING_CALIBRATED,ro)}},ao=qe.Active;function io(e,t,n){if(Fe.isInteractingWithTool)return!1;var r,o=n.detail,a=o.renderingEngineId,i=o.viewportId,l=Ur(i,a);if(!l)return!1;for(var c=Object.keys(l.toolOptions),s=0;s<c.length;s++){var d=c[s],u=l.toolOptions[d],v=l.getToolInstance(d);if(u.mode===ao&&"function"==typeof v[t]){r=l.getToolInstance(d);break}}r&&r[t](n)}var lo=io.bind(null,"Mouse","mouseClickCallback");function co(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function so(e,t,n){var r="touch"===(arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse")?36:6,o=[];return t.forEach((function(t){var a,i=t.tool,l=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return co(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?co(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(t.annotations);try{for(l.s();!(a=l.n()).done;){var c=a.value;if(!c.isLocked&&c.isVisible){var s=i.getHandleNearImagePoint(e,c,n,r);if(s){o.push({tool:i,annotation:c,handle:s});break}}}}catch(e){l.e(e)}finally{l.f()}})),o}function uo(e,t){for(var n=[],r=0;r<t.length;r++){var o,a=t[r];if(a){var i=Xe(a.constructor.toolName,e);null!==(o=i)&&void 0!==o&&o.length&&("function"==typeof a.filterInteractableAnnotationsForElement&&(i=a.filterInteractableAnnotationsForElement(e,i)),i.length>0&&n.push({tool:a,annotations:i}))}else console.warn("undefined tool in filterToolsWithAnnotationsForElement")}return n}function vo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function fo(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"mouse",o="touch"===r?36:6,a=[];return t.forEach((function(t){var i,l=t.tool,c=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return vo(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?vo(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(t.annotations);try{for(c.s();!(i=c.n()).done;){var s=i.value;if(!s.isLocked&&s.isVisible&&l.isPointNearTool(e,s,n,o,r)){a.push({tool:l,annotation:s});break}}}catch(e){c.e(e)}finally{c.f()}})),a}var go=function(e){return e[e.Primary=1]="Primary",e[e.Secondary=2]="Secondary",e[e.Primary_And_Secondary=3]="Primary_And_Secondary",e[e.Auxiliary=4]="Auxiliary",e[e.Primary_And_Auxiliary=5]="Primary_And_Auxiliary",e[e.Secondary_And_Auxiliary=6]="Secondary_And_Auxiliary",e[e.Primary_And_Secondary_And_Auxiliary=7]="Primary_And_Secondary_And_Auxiliary",e[e.Fourth_Button=8]="Fourth_Button",e[e.Fifth_Button=16]="Fifth_Button",e}(go||{}),ho=function(e){return e[e.Shift=16]="Shift",e[e.Ctrl=17]="Ctrl",e[e.Alt=18]="Alt",e[e.Meta=91]="Meta",e[e.ShiftCtrl=1617]="ShiftCtrl",e[e.ShiftAlt=1618]="ShiftAlt",e[e.ShiftMeta=1691]="ShiftMeta",e[e.CtrlAlt=1718]="CtrlAlt",e[e.CtrlMeta=1791]="CtrlMeta",e[e.AltMeta=1891]="AltMeta",e}(ho||{}),po=function(e){return e.shiftKey?e.ctrlKey?ho.ShiftCtrl:e.altKey?ho.ShiftAlt:e.metaKey?ho.ShiftMeta:ho.Shift:e.ctrlKey?e.altKey?ho.CtrlAlt:e.metaKey?ho.CtrlMeta:ho.Ctrl:e.altKey?e.metaKey&&ho.AltMeta||ho.Alt:e.metaKey?ho.Meta:void 0},mo=qe.Active;function wo(e){var t=e.detail,n=t.renderingEngineId,r=t.viewportId,o=e.detail.event,a=po(o)||Mr.getModifierKey(),i=Ur(r,n);if(!i)return null;for(var l=Object.keys(i.toolOptions),c=i.getDefaultMousePrimary(),s=0;s<l.length;s++){var d=l[s],u=i.toolOptions[d],v=u.bindings.length&&u.bindings.some((function(e){return e.mouseButton===(o?o.buttons:c)&&e.modifierKey===a}));if(u.mode===mo&&v)return i.getToolInstance(d)}}var Eo=qe.Active,yo=qe.Passive;function Io(e){if(!Fe.isInteractingWithTool){var t=wo(e);if(t&&"function"==typeof t.preMouseDownCallback&&t.preMouseDownCallback(e))return;var n=1===e.detail.event.buttons,r=Yr(e,[Eo],e.detail.event.buttons),o=n?Yr(e,[yo]):void 0,a=[].concat(kr(r||[]),kr(o||[])),i=e.detail,l=i.element,c=uo(l,a),s=i.currentPoints.canvas,d=so(l,c,s,"mouse"),u=!!e.detail.event.shiftKey;if(d.length>0){var v=bo(d),f=v.tool,g=v.annotation,h=v.handle;return Co(g.annotationUID,u),void f.handleSelectedCallback(e,g,h,"Mouse")}var p=fo(l,c,s,"mouse");if(p.length>0){var m=bo(p),w=m.tool,E=m.annotation;return Co(E.annotationUID,u),void w.toolSelectedCallback(e,E,"Mouse")}if(t&&"function"==typeof t.postMouseDownCallback&&t.postMouseDownCallback(e))return}}function bo(e){return e.length>1&&e.find((function(e){return!ce(e.annotation)&&xe(e.annotation.annotationUID)}))||e[0]}function Co(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?Ie(e)?me(e,!1):me(e,!0,!0):me(e,!0,!1)}function To(e){if(!Fe.isInteractingWithTool){var t=wo(e);t&&(Fe.isMultiPartToolActive||t.addNewAnnotation&&me(t.addNewAnnotation(e,"mouse").annotationUID))}}var _o=io.bind(null,"Mouse","doubleClickCallback");function Do(e){if(!Fe.isInteractingWithTool){var t=wo(e);!t||"function"!=typeof t.mouseDragCallback||t.mouseDragCallback(e)}}function Oo(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var So=qe.Active,xo=qe.Passive;function Mo(e){if(!Fe.isInteractingWithTool&&!Fe.isMultiPartToolActive){var t,n=Yr(e,[So,xo]),r=e.detail.element,o=uo(r,n),a=n.filter((function(e){return!o.some((function(t){return t.tool.getToolName()===e.getToolName()}))})),i=!1,l=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Oo(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Oo(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(l.s();!(t=l.n()).done;){var c=t.value,s=c.tool,d=c.annotations;"function"==typeof s.mouseMoveCallback&&(i=s.mouseMoveCallback(e,d)||i)}}catch(e){l.e(e)}finally{l.f()}a.forEach((function(t){"function"==typeof t.mouseMoveCallback&&t.mouseMoveCallback(e)})),!0===i&&qr(r)}}var ko=io.bind(null,"Mouse","mouseUpCallback"),Ro=io.bind(null,"MouseWheel","mouseWheelCallback"),Po={enable:function(e){e.addEventListener(J.MOUSE_CLICK,lo),e.addEventListener(J.MOUSE_DOWN,Io),e.addEventListener(J.MOUSE_DOWN_ACTIVATE,To),e.addEventListener(J.MOUSE_DOUBLE_CLICK,_o),e.addEventListener(J.MOUSE_DRAG,Do),e.addEventListener(J.MOUSE_MOVE,Mo),e.addEventListener(J.MOUSE_UP,ko),e.addEventListener(J.MOUSE_WHEEL,Ro)},disable:function(e){e.removeEventListener(J.MOUSE_CLICK,lo),e.removeEventListener(J.MOUSE_DOWN,Io),e.removeEventListener(J.MOUSE_DOWN_ACTIVATE,To),e.removeEventListener(J.MOUSE_DOUBLE_CLICK,_o),e.removeEventListener(J.MOUSE_DRAG,Do),e.removeEventListener(J.MOUSE_MOVE,Mo),e.removeEventListener(J.MOUSE_UP,ko),e.removeEventListener(J.MOUSE_WHEEL,Ro)}},No=qe.Active;function Ao(e){var t=e.detail,n=t.renderingEngineId,r=t.viewportId,o=cn.mouseButton,a=Mr.getModifierKey(),i=Ur(r,n);if(!i)return null;for(var l=Object.keys(i.toolOptions),c=i.getDefaultMousePrimary(),s=0;s<l.length;s++){var d=l[s],u=i.toolOptions[d],v=u.bindings.length&&u.bindings.some((function(e){return e.mouseButton===(null!=o?o:c)&&e.modifierKey===a}));if(u.mode===No&&v)return i.getToolInstance(d)}}function Lo(e){var t=Ao(e);if(t){var n=e.detail,r=n.renderingEngineId,o=n.viewportId,a=Ur(o,r),i=t.getToolName();Object.keys(a.toolOptions).includes(i)&&a.setViewportsCursorByToolName(i)}}function Uo(e){var t=Ao(e);if(t){var n=e.detail,r=n.renderingEngineId,o=n.viewportId,a=Ur(o,r);_r.keyCode=void 0;var i=t.getToolName();Object.keys(a.toolOptions).includes(i)&&a.setViewportsCursorByToolName(i)}}var Vo={enable:function(e){e.addEventListener(J.KEY_DOWN,Lo),e.addEventListener(J.KEY_UP,Uo)},disable:function(e){e.removeEventListener(J.KEY_DOWN,Lo),e.removeEventListener(J.KEY_UP,Uo)}},Bo=qe.Active;function jo(e){var t=e.detail,n=t.renderingEngineId,r=t.viewportId,o=e.detail.event,a=Ur(r,n);if(!a)return null;for(var i=Object.keys(a.toolOptions),l=Object.keys(o.touches).length,c=po(o)||Mr.getModifierKey(),s=a.getDefaultMousePrimary(),d=0;d<i.length;d++){var u=i[d],v=a.toolOptions[u],f=v.bindings.length&&v.bindings.some((function(e){return(e.numTouchPoints===l||1===l&&e.mouseButton===s)&&e.modifierKey===c}));if(v.mode===Bo&&f)return a.getToolInstance(u)}}function Ho(e,t,n){var r=e.detail,o=r.renderingEngineId,a=r.viewportId,i=Ur(a,o);if(!i)return[];for(var l=[],c=Object.keys(i.toolOptions),s=0;s<c.length;s++){var d=c[s],u=i.toolOptions[d],v=null!=n&&u.bindings.length&&u.bindings.some((function(e){return e.numTouchPoints===n}));if(t.includes(u.mode)&&(!n||v)){var f=i.getToolInstance(d);l.push(f)}}return l}var Wo=qe.Active,Fo=qe.Passive;function Go(e){if(!Fe.isInteractingWithTool){var t=jo(e);if(t&&"function"==typeof t.preTouchStartCallback&&t.preTouchStartCallback(e))return;var n=1===Object.keys(e.detail.event.touches).length,r=Ho(e,[Wo],Object.keys(e.detail.event.touches).length),o=n?Ho(e,[Fo]):void 0,a=[].concat(kr(r||[]),kr(o||[]),[t]),i=e.detail,l=i.element,c=uo(l,a),s=i.currentPoints.canvas,d=so(l,c,s,"touch");if(d.length>0){var u=qo(d),v=u.tool,f=u.annotation,g=u.handle;return zo(f.annotationUID,!1),void v.handleSelectedCallback(e,f,g,"Touch")}var h=fo(l,c,s,"touch");if(h.length>0){var p=qo(h),m=p.tool,w=p.annotation;return zo(w.annotationUID,!1),void m.toolSelectedCallback(e,w,"Touch")}if(t&&"function"==typeof t.postTouchStartCallback&&t.postTouchStartCallback(e))return}}function qo(e){return e.length>1&&e.find((function(e){return!ce(e.annotation)&&xe(e.annotation.annotationUID)}))||e[0]}function zo(e){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?Ie(e)?me(e,!1):me(e,!0,!0):me(e,!0,!1)}function Ko(e){if(!Fe.isInteractingWithTool){var t=jo(e);t&&(Fe.isMultiPartToolActive||t.addNewAnnotation&&me(t.addNewAnnotation(e,"touch").annotationUID))}}function Yo(e){if(!Fe.isInteractingWithTool){var t=jo(e);!t||"function"!=typeof t.touchDragCallback||t.touchDragCallback(e)}}var Jo=io.bind(null,"Touch","touchEndCallback"),$o=io.bind(null,"Touch","touchTapCallback"),Zo=io.bind(null,"Touch","touchPressCallback"),Xo={enable:function(e){e.addEventListener(J.TOUCH_START,Go),e.addEventListener(J.TOUCH_START_ACTIVATE,Ko),e.addEventListener(J.TOUCH_DRAG,Yo),e.addEventListener(J.TOUCH_END,Jo),e.addEventListener(J.TOUCH_TAP,$o),e.addEventListener(J.TOUCH_PRESS,Zo)},disable:function(e){e.removeEventListener(J.TOUCH_START,Go),e.removeEventListener(J.TOUCH_START_ACTIVATE,Ko),e.removeEventListener(J.TOUCH_DRAG,Yo),e.removeEventListener(J.TOUCH_END,Jo),e.removeEventListener(J.TOUCH_PRESS,Zo)}};function Qo(e){var t,n=e.detail,r=n.element,o=n.viewportId,a=function(e){var t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),r="svg-layer-".concat(e);n.classList.add("svg-layer"),n.setAttribute("id",r),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";var o=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),i=document.createElementNS(t,"feOffset"),l=document.createElementNS(t,"feColorMatrix"),c=document.createElementNS(t,"feBlend");return a.setAttribute("id","shadow-".concat(r)),a.setAttribute("filterUnits","userSpaceOnUse"),i.setAttribute("result","offOut"),i.setAttribute("in","SourceGraphic"),i.setAttribute("dx","0.5"),i.setAttribute("dy","0.5"),l.setAttribute("result","matrixOut"),l.setAttribute("in","offOut"),l.setAttribute("in2","matrix"),l.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),c.setAttribute("in","SourceGraphic"),c.setAttribute("in2","matrixOut"),c.setAttribute("mode","normal"),a.appendChild(i),a.appendChild(l),a.appendChild(c),o.appendChild(a),n.appendChild(o),n}(o);!function(e){var t=e.dataset,n=t.viewportUid,r=t.renderingEngineUid,o="".concat(n,":").concat(r);Fe.svgNodeCache[o]={}}(r),t=a,r.querySelector("div.viewport-element").appendChild(t),Gr.addViewportElement(o,r),_n.enable(r),Mn.enable(r),Cr.enable(r),Mr.enable(r),Kr.enable(r),Qr.enable(r),oo.enable(r),Po.enable(r),Vo.enable(r),Xo.enable(r),Fe.enabledElements.push(r)}var ea=function(e,t){var n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(var r=0;r<Fe.synchronizers.length;r++){var o=Fe.synchronizers[r],a=!o.isDisabled(),i=o.hasSourceViewport(t,e),l=o.hasTargetViewport(t,e);a&&(i||l)&&n.push(o)}return n},ta=function(e){var t=e.detail,n=t.element,r=t.viewportId;!function(e){var t=e.dataset,n=t.viewportUid,r=t.renderingEngineUid,o="".concat(n,":").concat(r);delete Fe.svgNodeCache[o]}(n),function(e){var t=e.querySelector("div.".concat("viewport-element")),n=t.querySelector("svg");n&&t.removeChild(n)}(n),Gr.removeViewportElement(r,n),_n.disable(n),Mn.disable(n),Cr.disable(n),Mr.disable(n),Kr.disable(n),Qr.disable(n),oo.disable(n),Po.disable(n),Vo.disable(n),Xo.disable(n),function(e){var t=(0,K.getEnabledElement)(e);ea(t.viewportId,t.renderingEngineId).forEach((function(e){e.remove(t)}))}(n),function(e){var t=(0,K.getEnabledElement)(e),n=t.renderingEngineId,r=t.viewportId,o=Ur(r,n);o&&o.removeViewports(n,r)}(n),function(e){var t=Fe.enabledElements.findIndex((function(t){return t===e}));t>-1&&Fe.enabledElements.splice(t,1)}(n)},na=function(e,t){t.length&&t.forEach((function(t){var n=e.getViewport(t).element;qr(n)}))},ra=function(e){var t=e.detail,n=t.viewportId,r=t.renderingEngineId,o=(0,K.getRenderingEngine)(r);na(o,[n])},oa=function(e){e.detail.removed.length&&(0,K.getRenderingEngines)().forEach((function(e){var t=e.getViewports().map((function(e){return e.id}));na(e,t)}))},aa=function(e){var t=e.detail.segmentationId;Nt(t).forEach((function(e){Rt(e).forEach((function(n){n.segmentationId===t&&bt(e,n.segmentationRepresentationUID)}))}))},ia=function(e){return Fe.toolGroups.find((function(t){return t.id===e}))};function la(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ca(e,t){return ca=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ca(e,t)}function sa(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ca(e,t)}function da(e,t){if(t&&("object"===$(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return la(e)}function ua(e){return ua=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},ua(e)}function va(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function fa(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?va(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):va(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ga(){return Wt()}function ha(e){Ft(e)}function pa(e){return ga().representations[e]}function ma(e,t){var n=ga();ha(fa(fa({},n),{},{representations:fa(fa({},n.representations),{},te({},e,fa(fa({},n.representations[e]),t)))}))}function wa(e){return At(e)}function Ea(e,t){Lt(e,t)}function ya(e,t){return Vt(e,t)}function Ia(e,t,n){Ut(e,t,n)}function ba(e,t,n){return Bt(e,t,n)}function Ca(e,t,n){jt(e,t,n)}function Ta(e,t,n){var r=Rt(e);if(r){var o=r.find((function(e){return e.segmentationRepresentationUID===t}));if(o){var a=o.segmentsHidden,i=function(e){var t=xt(e);if(t.type===dt.Labelmap){for(var n=K.cache.getVolume(e).getScalarData(),r={},o=0;o<n.length;o++){var a=n[o];0===a||r[a]||(r[a]=!0)}return Object.keys(r).map((function(e){return parseInt(e,10)}))}if(t.type===dt.Contour){var i,l=null===(i=t.representationData.CONTOUR)||void 0===i?void 0:i.geometryIds;if(!l)throw new Error("No geometryIds found for segmentationId ".concat(e));return l.map((function(e){return K.cache.getGeometry(e).data.getSegmentIndex()}))}}(o.segmentationId);n?a.clear():i.forEach((function(e){a.add(e)})),bt(e,o.segmentationRepresentationUID)}}}function _a(e,t){var n=Rt(e).find((function(e){return e.segmentationRepresentationUID===t}));if(n)return 0===n.segmentsHidden.size}function Da(e,t,n,r){var o=Gt(e,t);o&&(n.forEach((function(e){r?o.segmentsHidden.delete(e):o.segmentsHidden.add(e)})),bt(e,t))}function Oa(e,t,n,r){var o=Gt(e,t);o&&(r?o.segmentsHidden.delete(n):o.segmentsHidden.add(n),bt(e,t))}var Sa=function(){function e(t,n){ee(this,e),te(this,"supportedInteractionTypes",void 0),te(this,"configuration",void 0),te(this,"toolGroupId",void 0),te(this,"mode",void 0);var r=K.utilities.deepMerge(n,t),o=r.configuration,a=void 0===o?{}:o,i=r.supportedInteractionTypes,l=r.toolGroupId;a.strategies||(a.strategies={},a.defaultStrategy=void 0,a.activeStrategy=void 0,a.strategyOptions={}),this.toolGroupId=l,this.supportedInteractionTypes=i||[],this.configuration=Object.assign({},a),this.mode=qe.Disabled}return Q(e,[{key:"getToolName",value:function(){return this.constructor.toolName}},{key:"applyActiveStrategy",value:function(e,t){var n=this.configuration;return n.strategies[n.activeStrategy].call(this,e,t)}},{key:"setConfiguration",value:function(e){this.configuration=K.utilities.deepMerge(this.configuration,e)}},{key:"setActiveStrategy",value:function(e){this.setConfiguration({activeStrategy:e})}},{key:"getTargetVolumeId",value:function(e){var t;if(this.configuration.volumeId)return this.configuration.volumeId;var n=e.getActors();return n?null===(t=n.find((function(e){return"vtkVolume"===e.actor.getClassName()})))||void 0===t?void 0:t.uid:void 0}},{key:"getTargetIdImage",value:function(e,t){if(e.startsWith("imageId:")){var n=e.split("imageId:")[1],r=K.utilities.imageIdToURI(n),o=K.utilities.getViewportsWithImageURI(r,t.id);if(!o||!o.length)return;if(!(o=o.filter((function(e){return e.getCurrentImageId()===n})))||!o.length)return;return o[0].getImageData()}if(e.startsWith("volumeId:")){var a=e.split("volumeId:")[1],i=K.utilities.getViewportsWithVolumeId(a,t.id);if(!i||!i.length)return;return i[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}},{key:"getTargetId",value:function(e){if(e instanceof K.StackViewport)return"imageId:".concat(e.getCurrentImageId());if(e instanceof K.BaseVolumeViewport)return"volumeId:".concat(this.getTargetVolumeId(e));throw new Error("getTargetId: viewport must be a StackViewport or VolumeViewport")}}]),e}();te(Sa,"toolName",void 0),Sa.toolName="BaseTool";var xa=Sa;function Ma(e,t,n,r,o,a,i){try{var l=e[a](i),c=l.value}catch(e){return void n(e)}l.done?t(c):Promise.resolve(c).then(r,o)}function ka(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){Ma(a,r,o,i,l,"next",e)}function l(e){Ma(a,r,o,i,l,"throw",e)}i(void 0)}))}}var Ra=h(841),Pa=h.n(Ra),Na=h(785),Aa=h.n(Na),La=h(127),Ua=h.n(La),Va=h(474),Ba=h.n(Va),ja=h(610),Ha=h.n(ja),Wa=h(396),Fa=h.n(Wa),Ga=h(348),qa=h.n(Ga),za=h(70),Ka=h.n(za);function Ya(e,t,n){var r,o,a=null===(r=e.segmentSpecificConfig)||void 0===r?void 0:r[t];return a||(a=null===(o=e.segmentSpecificConfig)||void 0===o?void 0:o[n]),a?a.CONTOUR:null}var Ja=new Map;function $a(e){return Ja.get(e)}function Za(e,t){Ja.set(e,t)}function Xa(e,t,n,r,o){var a=n.segmentationRepresentationUID,i=n.segmentsHidden,l=Ua().newInstance(),c=new Map,s=new Map;t.forEach((function(e){var t=K.cache.getGeometry(e);if(t){var r=t.data.getSegmentIndex();!function(e){if(!e)throw new Error("No contours found for geometryId ".concat(e.id));var t=e.id;if(e.type!==K.Enums.GeometryType.CONTOUR)throw new Error("Geometry type ".concat(e.type," not supported for rendering."));e.data||console.warn("No contours found for geometryId ".concat(t,". Skipping render."))}(t);for(var o=Ya(n,e,r),a=t.data,d=function(e){var t=[],n=qa().newInstance(),r=Fa().newInstance(),o=0;e.getContours().forEach((function(e){var n=e.getPoints(),a=e.getFlatPointsArray(),i=e.getType(),l=n.map((function(e,t){return t+o}));i===K.Enums.ContourType.CLOSED_PLANAR&&l.push(l[0]);var c=Float32Array.from(a);t.push.apply(t,kr(c)),r.insertNextCell(kr(l)),o+=n.length})),n.setData(t,3);var a=Ka().newInstance();return a.setPoints(n),a.setLines(r),a}(a),u=a.getColor(),v=d.getPoints().getNumberOfPoints(),f=Aa().newInstance({size:4*v,numberOfComponents:4,dataType:"Uint8Array"}),g=0;g<v;++g)f.setTuple(g,[].concat(kr(u),[255]));d.getPointData().setScalars(f),o&&s.set(r,o),c.set(r,[].concat(kr(u),[i.has(r)?0:255])),0===r?l.setInputData(d):l.addInputData(d)}else console.warn("No geometry found for geometryId ".concat(e,". Skipping render."))}));var d=l.getOutputData(),u=r.representations.CONTOUR.outlineWidthActive,v=Ha().newInstance();v.setInputData(d);var f=Ba().newInstance();f.setMapper(v),f.getProperty().setLineWidth(u),Za(a,Object.assign({},$a(a),{segmentsHidden:new Set(i),segmentSpecificMap:s,outlineWidthActive:u})),f.setForceOpaque(!0),e.addActor({uid:o,actor:f}),e.resetCamera(),e.render()}function Qa(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ei(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ei(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}function ei(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ti(e,t,n,r,o){var a=n.segmentationRepresentationUID,i=n.segmentsHidden,l=r.representations.CONTOUR,c=$a(a),s=e.getActor(o);if(s){var d=s.actor,u=l.outlineWidthActive;(null==c?void 0:c.outlineWidthActive)!==u&&(d.getProperty().setLineWidth(u),Za(a,Object.assign({},c,{outlineWidthActive:u})));var v,f=d.getMapper(),g=f.getLookupTable(),h=[],p=[],m=Qa(i);try{for(m.s();!(v=m.n()).done;){var w=v.value;c.segmentsHidden.has(w)||h.push(w)}}catch(e){m.e(e)}finally{m.f()}var E,y=Qa(c.segmentsHidden);try{for(y.s();!(E=y.n()).done;){var I=E.value;i.has(I)||p.push(I)}}catch(e){y.e(e)}finally{y.f()}var b=Array.from(c.segmentsHidden).filter((function(e){return!p.includes(e)})).concat(h),C=t.reduce((function(e,t){var r=K.cache.getGeometry(t).data,o=r.getSegmentIndex(),a=Ya(n,t,o);return e.contourSets.push(r),e.segmentSpecificConfigs[o]=null!=a?a:{},e}),{contourSets:[],segmentSpecificConfigs:{}}),T=C.contourSets,_=C.segmentSpecificConfigs,D=[].concat(kr(b),p),O=Object.values(_).some((function(e){return Object.keys(e).length>0})),S=!1;if(D.length||O){var x=f.getInputData(),M=x.getPointData().getScalars().getData(),k=0;T.forEach((function(e){var t,n=e.getSegmentIndex(),r=e.getTotalNumberOfPoints();if(D.includes(n)||null!==(t=_[n])&&void 0!==t&&t.fillAlpha){var o=e.getColor(),a=b.includes(n)?0:255,i=_[n];void 0!==i.fillAlpha&&(a=255*i.fillAlpha);for(var l=0;l<r;++l)M[k+4*l]=o[0],M[k+4*l+1]=o[1],M[k+4*l+2]=o[2],M[k+4*l+3]=a;S=!0}k+=4*r})),S&&x.modified(),Za(a,Object.assign({},c,{segmentsHidden:new Set(i)})),f.setLookupTable(g)}e.render()}else console.warn("No contour actor found for actorUID ".concat(o,". Skipping render."))}function ni(e,t,n,r){var o=n.segmentationRepresentationUID,a="CONTOUR_".concat(o);(e.getActor(a)?ti:Xa)(e,t,n,r,a)}var ri=function(e,t){var n=(0,K.getEnabledElement)(e).viewport,r=n.getActors().map((function(e){var n=e.uid;return n.includes(t)?n:void 0})).filter(Boolean);n.removeActors(r)};function oi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ai(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?oi(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):oi(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function ii(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function li(){return(li=ka(Pa().mark((function e(t,n,r){var o,a,i,l,c,s;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.segmentationId,a=K.utilities.uuidv4(),i=new Set,l={segmentationId:o,segmentationRepresentationUID:a,type:dt.Contour,segmentsHidden:i,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{}},r&&(c=wa(t),s=K.utilities.deepMerge(c,r),Ea(t,{renderInactiveSegmentations:s.renderInactiveSegmentations||!0,representations:ai({},s.representations)})),Ht(t,l),e.abrupt("return",a);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ci(){return(ci=ka(Pa().mark((function e(t,n,r){var o,a,i,l;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=n.segmentationId,a=xt(o),i=a.representationData[dt.Contour],null!=(l=i.geometryIds)&&l.length||console.warn("No contours found for segmentationId ".concat(o,". Skipping render.")),ni(t,l,n,r);case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var si={render:function(e,t,n){return ci.apply(this,arguments)},addSegmentationRepresentation:function(e,t,n){return li.apply(this,arguments)},removeSegmentationRepresentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){var n=ia(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));var r,o=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ii(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ii(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(n.viewportsInfo);try{for(o.s();!(r=o.n()).done;){var a=r.value,i=a.viewportId,l=a.renderingEngineId,c=(0,K.getEnabledElementByIds)(i,l);ri(c.viewport.element,t)}}catch(e){o.e(e)}finally{o.f()}})(e,t),zt(e,t),function(e){Ja.delete(e)}(t),n&&ia(e).getViewportsInfo().forEach((function(e){var t=e.viewportId,n=e.renderingEngineId;(0,K.getEnabledElementByIds)(t,n).viewport.render()}))}},di=h(441),ui=h.n(di),vi=h(795),fi=h.n(vi);function gi(){return(gi=ka(Pa().mark((function e(t,n,r){var o,a,i,l,c;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=(0,K.getEnabledElement)(t),a=o.renderingEngine,i=o.viewport,l=i.id,c=[{volumeId:n,actorUID:r,visibility:!0,blendMode:K.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND}],e.next=9,(0,K.addVolumesToViewports)(a,c,[l],!1,!0);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var hi=function(e,t,n){return gi.apply(this,arguments)},pi=function(e,t){(0,K.getEnabledElement)(e).viewport.removeVolumeActors([t])};function mi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function wi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Ei(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wi(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wi(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var yi=255,Ii=new Map;function bi(){return(bi=ka(Pa().mark((function e(t,n,r){var o,a,i,l,c,s,d,u;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=n.segmentationId,a=K.utilities.uuidv4(),i=new Set,l=fi().newInstance(),(c=ui().newInstance()).addPoint(0,0),s={segmentationId:o,segmentationRepresentationUID:a,type:dt.Labelmap,segmentsHidden:i,colorLUTIndex:0,active:!0,segmentationRepresentationSpecificConfig:{},segmentSpecificConfig:{},config:{cfun:l,ofun:c}},r&&(d=wa(t),u=K.utilities.deepMerge(d,r),Ea(t,{renderInactiveSegmentations:u.renderInactiveSegmentations||!0,representations:Ei({},u.representations)})),Ht(t,s),e.abrupt("return",a);case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ci(e,t){if(!t)return!0;var n=e.getDefaultActor();if(!n)return!1;var r=n.uid,o=K.cache.getVolume(r);if(o){var a=K.cache.getVolume(t);if(a&&o.metadata.FrameOfReferenceUID===a.metadata.FrameOfReferenceUID)return!0}return!1}function Ti(){return(Ti=ka(Pa().mark((function e(t,n,r){var o,a,i,l,c,s,d,u,v,f,g,h,p,m,w,E;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=n.colorLUTIndex,a=n.active,i=n.segmentationId,l=n.segmentationRepresentationUID,c=n.segmentsHidden,s=n.config,d=xt(i),u=d.representationData[dt.Labelmap],v=u.volumeId,K.cache.getVolume(v)){e.next=7;break}throw new Error("No Labelmap found for volumeId: ".concat(v));case 7:if(Ci(t,null==u?void 0:u.referencedVolumeId)){e.next=9;break}return e.abrupt("return");case 9:if(f=t.getActor(l)){e.next=16;break}return g=xt(i),h=g.representationData[dt.Labelmap].volumeId,e.next=15,Si(t,h,l);case 15:f=t.getActor(l);case 16:if(f){e.next=18;break}return e.abrupt("return");case 18:m=(p=s).cfun,w=p.ofun,E=r.renderInactiveSegmentations,_i(t.id,f,m,w,o,r.representations[dt.Labelmap],n,a,E,c);case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function _i(e,t,n,r,o,a,i,l,c,s){for(var d=i.segmentSpecificConfig,u=i.segmentationRepresentationSpecificConfig[dt.Labelmap],v=Yt(o),f=Math.min(256,v.length),g=t.actor,h=t.uid,p=Di(a,u,l),m=p.outlineWidth,w=p.renderOutline,E=p.outlineOpacity,y=0;y<f;y++){var I,b=y,C=v[b],T=Di(a,u,l,null===(I=d[b])||void 0===I?void 0:I[dt.Labelmap]),_=T.fillAlpha,D=T.outlineWidth,O=T.renderFill,S=Oi(e,h,b,{fillAlpha:_,renderFill:O,renderOutline:T.renderOutline,segmentColor:C,outlineWidth:D,segmentsHidden:s}),x=S.forceOpacityUpdate;if(S.forceColorUpdate&&n.addRGBPoint(b,C[0]/yi,C[1]/yi,C[2]/yi),x)if(O){var M=s.has(b)?0:C[3]/255*_;r.removePoint(b),r.addPointLong(b,M,.5,1)}else r.addPointLong(b,.01,.5,1)}g.getProperty().setRGBTransferFunction(0,n),r.setClamping(!1),g.getProperty().setScalarOpacity(0,r),g.getProperty().setInterpolationTypeToNearest(),g.getProperty().setUseLabelOutline(w),g.getProperty().setLabelOutlineOpacity(E),g.getProperty().setLabelOutlineThickness(m);var k=l||c;g.setVisibility(k)}function Di(e,t,n,r){var o=r||{},a=Ei(Ei(Ei({},e),t),o);return{fillAlpha:n?a.fillAlpha:a.fillAlphaInactive,outlineWidth:n?a.outlineWidthActive:a.outlineWidthInactive,renderFill:n?a.renderFill:a.renderFillInactive,renderOutline:a.renderOutline,outlineOpacity:n?a.outlineOpacity:a.outlineOpacityInactive}}function Oi(e,t,n,r){var o=r.fillAlpha,a=r.renderFill,i=r.renderOutline,l=r.segmentColor,c=r.outlineWidth,s=r.segmentsHidden,d="".concat(e,"-").concat(t,"-").concat(n),u=Ii.get(d);if(!u)return Ii.set(d,{fillAlpha:o,renderFill:a,renderOutline:i,outlineWidth:c,segmentColor:l,segmentsHidden:new Set(s)}),{forceOpacityUpdate:!0,forceColorUpdate:!0};var v=u.fillAlpha,f=u.renderFill,g=u.renderOutline,h=u.outlineWidth,p=u.segmentColor,m=u.segmentsHidden,w=p[0]!==l[0]||p[1]!==l[1]||p[2]!==l[2],E=p[3]!==l[3]||v!==o||f!==a||g!==i||h!==c||m.has(n)!==s.has(n);return Ii.set(d,{fillAlpha:o,renderFill:a,renderOutline:i,outlineWidth:c,segmentColor:l.slice(),segmentsHidden:new Set(s)}),{forceOpacityUpdate:E,forceColorUpdate:w}}function Si(e,t,n){return xi.apply(this,arguments)}function xi(){return(xi=ka(Pa().mark((function e(t,n,r){return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,hi(t.element,n,r);case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Mi={render:function(e,t,n){return Ti.apply(this,arguments)},addSegmentationRepresentation:function(e,t,n){return bi.apply(this,arguments)},removeSegmentationRepresentation:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(function(e,t){var n=ia(e);if(void 0===n)throw new Error("ToolGroup with ToolGroupId ".concat(e," does not exist"));var r,o=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return mi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?mi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(n.viewportsInfo);try{for(o.s();!(r=o.n()).done;){var a=r.value,i=a.viewportId,l=a.renderingEngineId,c=(0,K.getEnabledElementByIds)(i,l);pi(c.viewport.element,t)}}catch(e){o.e(e)}finally{o.f()}})(e,t),zt(e,t),n&&ia(e).getViewportsInfo().forEach((function(e){var t=e.viewportId,n=e.renderingEngineId;(0,K.getEnabledElementByIds)(t,n).viewport.render()}))}};function ki(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ri=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{}};return ee(this,o),te(la(e=r.call(this,t,n)),"renderSegmentation",(function(t){var n=ia(t);if(n){var r=Rt(t);if(r&&0!==r.length){var o=n.viewportsInfo.map((function(e){var t=e.renderingEngineId,n=e.viewportId,r=(0,K.getEnabledElementByIds)(n,t);if(r)return r.viewport})),a=r.map((function(n){var r,a=e._getMergedRepresentationsConfig(t),i=[],l=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ki(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ki(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(l.s();!(r=l.n()).done;){var c=r.value;n.type==dt.Labelmap?i.push(Mi.render(c,n,a)):n.type==dt.Contour&&i.push(si.render(c,n,a))}}catch(e){l.e(e)}finally{l.f()}return i}));Promise.allSettled(a).then((function(){o.forEach((function(e){e.render()}))}))}}})),e}return Q(o,[{key:"onSetToolEnabled",value:function(){var e=this.toolGroupId,t=Rt(e);t&&0!==t.length&&t.forEach((function(t){Ta(e,t.segmentationRepresentationUID,!0)}))}},{key:"onSetToolDisabled",value:function(){var e=this.toolGroupId,t=Rt(e);t&&0!==t.length&&t.forEach((function(t){Ta(e,t.segmentationRepresentationUID,!1)}))}},{key:"_getMergedRepresentationsConfig",value:function(e){var t=wa(e),n=ga();return K.utilities.deepMerge(n,t)}}]),o}(xa);te(Ri,"toolName",void 0),Ri.toolName="SegmentationDisplay";var Pi=Ri;function Ni(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}var Ai=function(){function e(){var t=this;ee(this,e),te(this,"_needsRender",new Set),te(this,"_animationFrameSet",!1),te(this,"_animationFrameHandle",null),te(this,"hasBeenDestroyed",void 0),te(this,"_renderFlaggedToolGroups",(function(){t._throwIfDestroyed();for(var e=0,n=Array.from(t._needsRender.values());e<n.length;e++){var r=n[e];if(t._triggerRender(r),t._needsRender.delete(r),0===t._needsRender.size)return t._animationFrameSet=!1,void(t._animationFrameHandle=null)}}))}return Q(e,[{key:"removeToolGroup",value:function(e){this._needsRender.delete(e),0===this._needsRender.size&&this._reset()}},{key:"renderToolGroupSegmentations",value:function(e){this._setToolGroupSegmentationToBeRenderedNextFrame([e])}},{key:"_throwIfDestroyed",value:function(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}},{key:"_setToolGroupSegmentationToBeRenderedNextFrame",value:function(e){var t=this;e.forEach((function(e){t._needsRender.add(e)})),this._render()}},{key:"_render",value:function(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedToolGroups),this._animationFrameSet=!0)}},{key:"_triggerRender",value:function(e){var t=ia(e);if(t){var n=t.viewportsInfo,r=[];n.forEach((function(e){var t=e.viewportId,n=e.renderingEngineId,o=(0,K.getRenderingEngine)(n);o?r.push(o.getViewport(t)):console.warn("rendering Engine has been destroyed")}));var o=t.getToolInstance(Pi.toolName);o?(r.forEach((function(e){e.element.addEventListener(K.Enums.Events.IMAGE_RENDERED,a)})),o.renderSegmentation(e)):console.warn("No segmentation tool found inside",e)}else console.warn("No tool group found with toolGroupId: ".concat(e));function a(e){var t=e.detail,n=t.element,r=t.viewportId,o=t.renderingEngineId;n.removeEventListener(K.Enums.Events.IMAGE_RENDERED,a);var i=Ur(r,o);if(i){var l={toolGroupId:i.id,viewportId:r};(0,K.triggerEvent)(K.eventTarget,J.SEGMENTATION_RENDERED,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ni(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ni(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},l))}else console.warn("toolGroup has been destroyed")}}},{key:"_reset",value:function(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}}]),e}(),Li=new Ai;function Ui(e){Li.renderToolGroupSegmentations(e)}var Vi=Ui,Bi=function(e){var t=e.detail,n=t.segmentationId,r=t.modifiedSlicesToUse,o=xt(n),a=o.representationData,i=o.type;if(i!==dt.Labelmap)throw new Error("onSegmentationDataModified: representationType ".concat(i," not supported yet"));var l=K.cache.getVolume(a[i].volumeId);if(l){var c,s=l.imageData,d=l.vtkOpenGLTexture;if(r&&Array.isArray(r))c=r;else{var u=s.getDimensions()[2];c=kr(Array(u).keys())}c.forEach((function(e){d.setUpdatedFrame(e)})),s.modified(),Nt(n).forEach((function(e){Vi(e)}))}else console.warn("segmentation not found in cache")},ji=function(e){var t=e.detail.toolGroupId;Vi(t)},Hi=function(e){var t=e.detail,n=t.toolGroupId;t.segmentationRepresentationUID,Vi(n)},Wi=function(e,t,n){var r=Rt(e);if(r&&0!==r.length){var o=r.map((function(e){return e.segmentationRepresentationUID})),a=t;if(a){var i=t.filter((function(e){return!o.includes(e)}));if(i.length>0)throw new Error("The following segmentationRepresentationUIDs are not part of the toolGroup: ".concat(JSON.stringify(i)))}else a=o;a.forEach((function(t){!function(e,t,n){var r=Gt(e,t).type;if(r===dt.Labelmap)Mi.removeSegmentationRepresentation(e,t,n);else{if(r!==dt.Contour)throw new Error("The representation ".concat(r," is not supported yet"));si.removeSegmentationRepresentation(e,t,n)}}(e,t,n)}))}},Fi=function(e){var t=Fe.toolGroups.findIndex((function(t){return t.id===e}));t>-1&&(Li.removeToolGroup(e),Wi(e),Fe.toolGroups.splice(t,1))};function Gi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var qi=function(){var e,t=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Gi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Gi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(kr(Fe.toolGroups));try{for(t.s();!(e=t.n()).done;){var n=e.value;Fi(n.id)}}catch(e){t.e(e)}finally{t.f()}Fe.toolGroups=[]},zi=!1;function Ki(){zi||(function(){Ji();var e=K.Enums.Events.ELEMENT_ENABLED,t=K.Enums.Events.ELEMENT_DISABLED;K.eventTarget.addEventListener(e,Qo),K.eventTarget.addEventListener(t,ta)}(),$i(),K.eventTarget.addEventListener(J.ANNOTATION_MODIFIED,ra),K.eventTarget.addEventListener(J.ANNOTATION_SELECTION_CHANGE,oa),K.eventTarget.addEventListener(J.ANNOTATION_SELECTION_CHANGE,oa),K.eventTarget.addEventListener(J.SEGMENTATION_MODIFIED,aa),K.eventTarget.addEventListener(J.SEGMENTATION_DATA_MODIFIED,Bi),K.eventTarget.addEventListener(J.SEGMENTATION_REPRESENTATION_MODIFIED,ji),K.eventTarget.addEventListener(J.SEGMENTATION_REPRESENTATION_REMOVED,Hi),zi=!0)}function Yi(){Ji(),$i(),qi(),He={},Fe=re()(We);var e=Je(),t=St();e.restoreAnnotations({}),t.resetState(),zi=!1}function Ji(){var e=K.Enums.Events.ELEMENT_ENABLED,t=K.Enums.Events.ELEMENT_DISABLED;K.eventTarget.removeEventListener(e,Qo),K.eventTarget.removeEventListener(t,ta)}function $i(){K.eventTarget.removeEventListener(J.ANNOTATION_MODIFIED,ra),K.eventTarget.removeEventListener(J.ANNOTATION_SELECTION_CHANGE,oa),K.eventTarget.removeEventListener(J.ANNOTATION_SELECTION_CHANGE,oa),K.eventTarget.removeEventListener(J.SEGMENTATION_MODIFIED,aa),K.eventTarget.removeEventListener(J.SEGMENTATION_DATA_MODIFIED,Bi),K.eventTarget.removeEventListener(J.SEGMENTATION_REPRESENTATION_MODIFIED,ji),K.eventTarget.removeEventListener(J.SEGMENTATION_REPRESENTATION_REMOVED,Hi)}function Zi(e){var t=e.toolName,n=void 0!==Fe.tools[t];if(!t)throw new Error("No Tool Found for the ToolClass ".concat(e.name));if(n)throw new Error("".concat(t," has already been added globally"));Fe.tools[t]={toolClass:e}}function Xi(e){var t=e.toolName;if(!t)throw new Error("No tool found for: ".concat(e.name));if(void 0===!Fe.tools[t])throw new Error("".concat(t," cannot be removed because it has not been added"));delete Fe.tools[t]}function Qi(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function el(e){var t,n=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Qi(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Qi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(uo(e,Vr(e,[qe.Active,qe.Passive])));try{for(n.s();!(t=n.n()).done;){var r=t.value.tool.cancel(e);if(r)return r}}catch(e){n.e(e)}finally{n.f()}}var tl=function(){function e(t,n,r,o){var a=this;ee(this,e),te(this,"_enabled",void 0),te(this,"_eventName",void 0),te(this,"_eventHandler",void 0),te(this,"_ignoreFiredEvents",void 0),te(this,"_sourceViewports",void 0),te(this,"_targetViewports",void 0),te(this,"_viewportOptions",{}),te(this,"_options",void 0),te(this,"id",void 0),te(this,"_onEvent",(function(e){if(!0!==a._ignoreFiredEvents&&a._targetViewports.length){var t=(0,K.getEnabledElement)(e.currentTarget);if(t){var n=t.renderingEngineId,r=t.viewportId;a._sourceViewports.find((function(e){return e.viewportId===r}))&&a.fireEvent({renderingEngineId:n,viewportId:r},e)}}})),this._enabled=!0,this._eventName=n,this._eventHandler=r,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=o||{},this.id=t}return Q(e,[{key:"isDisabled",value:function(){return!this._enabled||!this._hasSourceElements()}},{key:"setOptions",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this._viewportOptions[e]=t}},{key:"getOptions",value:function(e){return this._viewportOptions[e]}},{key:"add",value:function(e){this.addTarget(e),this.addSource(e)}},{key:"addSource",value:function(e){if(!rl(this._sourceViewports,e)){var t=e.renderingEngineId,n=e.viewportId;(0,K.getRenderingEngine)(t).getViewport(n).element.addEventListener(this._eventName,this._onEvent.bind(this)),this._updateDisableHandlers(),this._sourceViewports.push(e)}}},{key:"addTarget",value:function(e){rl(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}},{key:"getSourceViewports",value:function(){return this._sourceViewports}},{key:"getTargetViewports",value:function(){return this._targetViewports}},{key:"destroy",value:function(){var e=this;this._sourceViewports.forEach((function(t){return e.removeSource(t)})),this._targetViewports.forEach((function(t){return e.removeTarget(t)}))}},{key:"remove",value:function(e){this.removeTarget(e),this.removeSource(e)}},{key:"removeSource",value:function(e){var t=nl(this._sourceViewports,e);if(-1!==t){var n=function(e){var t=(0,K.getRenderingEngine)(e.renderingEngineId);if(!t)throw new Error("No RenderingEngine for Id: ".concat(e.renderingEngineId));return t.getViewport(e.viewportId).element}(e);this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._updateDisableHandlers()}}},{key:"removeTarget",value:function(e){var t=nl(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}},{key:"hasSourceViewport",value:function(e,t){return rl(this._sourceViewports,{renderingEngineId:e,viewportId:t})}},{key:"hasTargetViewport",value:function(e,t){return rl(this._targetViewports,{renderingEngineId:e,viewportId:t})}},{key:"fireEvent",value:function(e,t){if(!this.isDisabled()&&!this._ignoreFiredEvents){this._ignoreFiredEvents=!0;try{for(var n=0;n<this._targetViewports.length;n++){var r=this._targetViewports[n];e.viewportId===r.viewportId||this._eventHandler(this,e,r,t,this._options)}}catch(e){console.warn("Synchronizer, for: ".concat(this._eventName),e)}finally{this._ignoreFiredEvents=!1}}}},{key:"_hasSourceElements",value:function(){return 0!==this._sourceViewports.length}},{key:"_updateDisableHandlers",value:function(){var e=function(e,t){for(var n=[],r=e.concat(t),o=function(){var e=r[a];n.some((function(t){return e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId}))||n.push(e)},a=0;a<r.length;a++)o();return n}(this._sourceViewports,this._targetViewports),t=this.remove,n=function(e){t(e.detail.element)};e.forEach((function(e){var t=(0,K.getRenderingEngine)(e.renderingEngineId).getViewport(e.viewportId);if(t){var r=t.element;r.removeEventListener(K.Enums.Events.ELEMENT_DISABLED,n),r.addEventListener(K.Enums.Events.ELEMENT_DISABLED,n)}}))}}]),e}();function nl(e,t){return e.findIndex((function(e){return t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId}))}function rl(e,t){return e.some((function(e){return e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId}))}var ol=tl,al=function(e,t,n,r){if(Fe.synchronizers.some((function(t){return t.id===e})))throw new Error("Synchronizer with id '".concat(e,"' already exists."));var o=new ol(e,t,n,r);return Fe.synchronizers.push(o),o},il=function(){for(;Fe.synchronizers.length>0;)Fe.synchronizers.pop().destroy()},ll=function(e){return Fe.synchronizers.find((function(t){return t.id===e}))},cl=function(){return Fe.synchronizers},sl=function(e){var t=Fe.synchronizers.findIndex((function(t){return t.id===e}));t>-1&&(Fe.synchronizers[t].destroy(),Fe.synchronizers.splice(t,1))},dl=h(485),ul=h.n(dl),vl=Symbol("DefinedCursors"),fl=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]),gl=function(){function e(t,n){ee(this,e),te(this,"name",void 0),te(this,"fallback",void 0),this.name=t+"",this.fallback=n}return Q(e,[{key:"getName",value:function(){return this.name+""}},{key:"addFallbackStyleProperty",value:function(t){var n=this.fallback;return n instanceof e?"".concat(t,", ").concat(n.getStyleProperty()):t+""}},{key:"getStyleProperty",value:function(){return this.addFallbackStyleProperty(this.name)+""}}],[{key:"getDefinedCursor",value:function(t){var n=hl(e,vl),r=n.get(t);return r instanceof e?r:fl.has(t)?(r=new e(t),n.set(t,r),r):void 0}},{key:"setDefinedCursor",value:function(t,n){return n instanceof e&&(hl(e,vl).set(t,n),!0)}}]),e}();function hl(e,t){var n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}var pl=fl.values();function ml(){return ml="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ua(e)););return e}(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(arguments.length<3?e:n):o.value}},ml.apply(this,arguments)}var wl=function(e){return e.Default="",e.Highlighted="Highlighted",e.Selected="Selected",e.Locked="Locked",e}(wl||{}),El=wl;var yl=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(e,t,n,a,i){var l;return ee(this,o),te(la(l=r.call(this,a||o.getUniqueInstanceName("image-cursor"),i)),"url",void 0),te(la(l),"x",void 0),te(la(l),"y",void 0),l.url=e,l.x=Number(t)||0,l.y=Number(n)||0,l}return Q(o,[{key:"getStyleProperty",value:function(){var e=this.url,t=this.x,n=this.y,r="url('".concat(e,"')");return t>=0&&n>=0&&(t>0||n>0)&&(r+=" ".concat(t," ").concat(n)),this.addFallbackStyleProperty(r)}}],[{key:"getUniqueInstanceName",value:function(e){return"".concat(e,"-").concat(K.utilities.getRuntimeId(o))}}]),o}(gl),Il={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},bl={x:127,y:60},Cl='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',Tl='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',_l='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',Dl='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',Ol='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',Sl={Angle:xl(Il,{iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:xl(Il,{iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:xl(Il,{iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:xl(Il,{iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:xl(Il,{iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:xl(Il,{iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:xl(Il,{iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:xl(Il,{iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:xl(Il,{iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Probe:xl(Il,{iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:xl(Il,{iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),TextMarker:xl(Il,{iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:xl(Il,{iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:xl(Il,{iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:xl(Il,{iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:xl(Il,{iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:xl(Il,{iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:xl(Il,{iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:xl(Il,{iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:xl(Il,{iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:xl(Il,{iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:xl(Il,{iconContent:"".concat(_l," ").concat(Cl),viewBox:bl}),SegmentationFreeHandFillInside:xl(Il,{iconContent:"".concat(_l," ").concat(Tl),viewBox:bl}),SegmentationFreeHandEraseOutside:xl(Il,{iconContent:"".concat(_l," ").concat(Cl),viewBox:bl}),SegmentationFreeHandFillOutside:xl(Il,{iconContent:"".concat(_l," ").concat(Tl),viewBox:bl}),SegmentationRectangleEraseInside:xl(Il,{iconContent:"".concat(Dl," ").concat(Cl),viewBox:bl}),RectangleScissor:xl(Il,{iconContent:"".concat(Dl," ").concat(Tl),viewBox:bl}),"RectangleScissor.FILL_INSIDE":xl(Il,{iconContent:"".concat(Dl," ").concat(Tl),viewBox:bl}),"RectangleScissor.FILL_OUTSIDE":xl(Il,{iconContent:"".concat(Dl," ").concat(Tl),viewBox:bl}),"RectangleScissor.ERASE_OUTSIDE":xl(Il,{iconContent:"".concat(Dl," ").concat(Cl),viewBox:bl}),"RectangleScissor.ERASE_INSIDE":xl(Il,{iconContent:"".concat(Dl," ").concat(Cl),viewBox:bl}),CircleScissor:xl(Il,{iconContent:"".concat(Ol," ").concat(Tl),viewBox:bl}),"CircleScissor.FILL_INSIDE":xl(Il,{iconContent:"".concat(Ol," ").concat(Tl),viewBox:bl}),"CircleScissor.ERASE_OUTSIDE":xl(Il,{iconContent:"".concat(Ol," ").concat(Cl),viewBox:bl}),"CircleScissor.FILL_OUTSIDE":xl(Il,{iconContent:"".concat(Ol," ").concat(Tl),viewBox:bl})};function xl(e,t){return Object.assign(Object.create(e),t)}function Ml(e,t,n){Sl[e]=xl(Il,{iconContent:t,viewBox:n})}var kl=Object.keys(Sl);function Rl(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Pl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Rl(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Rl(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var Nl=new(function(){function e(){ee(this,e),te(this,"config",void 0),this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"",shadow:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(255, 255, 0)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0})}return Q(e,[{key:"getAnnotationToolStyles",value:function(e){return this.config.annotations&&this.config.annotations[e]}},{key:"getViewportToolStyles",value:function(e){return this.config.viewports&&this.config.viewports[e]}},{key:"getToolGroupToolStyles",value:function(e){return this.config.toolGroups&&this.config.toolGroups[e]}},{key:"getDefaultToolStyles",value:function(){return this.config.default}},{key:"setAnnotationStyles",value:function(e,t){var n=this.config.annotations;n||(this.config=Pl(Pl({},this.config),{},{annotations:{}}),n=this.config.annotations),n[e]=t}},{key:"setViewportToolStyles",value:function(e,t){var n=this.config.viewports;n||(this.config=Pl(Pl({},this.config),{},{viewports:{}}),n=this.config.viewports),n[e]=t}},{key:"setToolGroupToolStyles",value:function(e,t){var n=this.config.toolGroups;n||(this.config=Pl(Pl({},this.config),{},{toolGroups:{}}),n=this.config.toolGroups),n[e]=t}},{key:"setDefaultToolStyles",value:function(e){this.config.default=e}},{key:"getStyleProperty",value:function(e,t){var n=t.annotationUID,r=t.viewportId,o=t.toolGroupId,a=t.toolName;return this._getToolStyle(e,n,r,o,a)}},{key:"_getToolStyle",value:function(e,t,n,r,o){if(t){var a=this.getAnnotationToolStyles(t);if(a&&a[e])return a[e]}if(n){var i=this.getViewportToolStyles(n);if(i){if(i[o]&&i[o][e])return i[o][e];if(i.global&&i.global[e])return i.global[e]}}if(r){var l=this.getToolGroupToolStyles(r);if(l){if(l[o]&&l[o][e])return l[o][e];if(l.global&&l.global[e])return l.global[e]}}var c=this.getDefaultToolStyles();return c[o]&&c[o][e]?c[o][e]:c.global&&c.global[e]?c.global[e]:void 0}},{key:"_initializeConfig",value:function(e){var t={};for(var n in e)t[n]=e[n];this.config={default:{global:t}}}}]),e}());function Al(e,t,n,r){for(var o=function(e,t,n){var r=["".concat(e)];return t&&r.push("".concat(r[0]).concat(t)),n&&r.push("".concat(r[r.length-1]).concat(n)),r}(e,n,r),a=o.length-1;a>=0;--a){var i=Nl.getStyleProperty(o[a],t);if(void 0!==i)return i}}var Ll=El.Highlighted,Ul=qe.Active,Vl=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(e,t,n,a,i){return ee(this,o),r.call(this,e,t,n,a,i)}return Q(o,null,[{key:"getDefinedCursor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;n||(n=Al("color",{},Ll,Ul));var r=function(e,t,n){return"".concat(t?"pointer":"cursor",":").concat(e,"/").concat(n)}(e,t,n),a=ml(ua(o),"getDefinedCursor",this).call(this,r);if(!a){var i=function(e){return Sl[e]}(e);i&&(a=jl(i,r,t,n,ml(ua(o),"getDefinedCursor",this).call(this,"default")),ml(ua(o),"setDefinedCursor",this).call(this,r,a))}return a}}]),o}(yl);function Bl(e,t){var n=Object(t),r=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,(function(e,t){return r(t)?n[t]+"":""}))}function jl(e,t,n,r,o){var a=e.mousePoint,i=a.x,l=a.y;return new Vl(function(e,t,n){return URL.createObjectURL(function(e,t,n){var r=(t?Wl:Hl)(e,n);return new Blob([r],{type:"image/svg+xml"})}(e,t,n))}(e,n,{color:r}),i,l,t,o)}function Hl(e,t){var n=e.iconContent,r=e.iconSize,o=e.viewBox;return Bl('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(r,'" height="').concat(r,'" viewBox="0 0\n      ').concat(o.x," ").concat(o.y,'">\n      ').concat(n,"\n    </svg>"),t)}function Wl(e,t){var n=e.iconContent,r=e.iconSize,o=e.viewBox,a=e.mousePointerGroupString,i=r/Math.max(o.x,o.y,1),l=16+r;return Bl('\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="'.concat(l,'" height="').concat(l,'" viewBox="0 0 ').concat(l," ").concat(l,'">\n      <g>').concat(a,'</g>\n      <g transform="translate(16, 16) scale(').concat(i,')">').concat(n,"</g>\n    </svg>"),t)}var Fl=Symbol("ElementCursorsMap");function Gl(e,t){Yl(e)[0]=t,ql(e,t)}function ql(e,t){var n=Yl(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof gl?t:gl.getDefinedCursor("auto")).getStyleProperty()}function zl(e){ql(e,Yl(e)[1])}function Kl(e){ql(e,gl.getDefinedCursor("none"))}function Yl(e){var t=Yl[Fl];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(Yl,Fl,{value:t}));var n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}var Jl=qe.Active,$l=qe.Passive,Zl=qe.Enabled,Xl=qe.Disabled,Ql=function(){function e(t){ee(this,e),te(this,"id",void 0),te(this,"viewportsInfo",[]),te(this,"toolOptions",{}),te(this,"_toolInstances",{}),this.id=t}return Q(e,[{key:"getViewportIds",value:function(){return this.viewportsInfo.map((function(e){return e.viewportId}))}},{key:"getViewportsInfo",value:function(){return this.viewportsInfo.slice()}},{key:"getToolInstance",value:function(e){var t=this._toolInstances[e];if(t)return t;console.warn("'".concat(e,"' is not registered with this toolGroup (").concat(this.id,")."))}},{key:"addTool",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Fe.tools[e],r=void 0!==e&&""!==e,o=this.toolOptions[e];if(r)if(n)if(o)console.warn("'".concat(e,"' is already registered for ToolGroup ").concat(this.id,"."));else{var a=new(0,n.toolClass)({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=a}else console.warn("'".concat(e,"' is not registered with the library. You need to use cornerstoneTools.addTool to register it."));else console.warn("Tool with configuration did not produce a toolName: ",t)}},{key:"addToolInstance",value:function(e,t){var n,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=null===(n=Fe.tools[e])||void 0===n?void 0:n.toolClass;if(!o){var a=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){return ee(this,o),r.apply(this,arguments)}return Q(o)}(Fe.tools[t].toolClass);a.toolName=e,o=a,Fe.tools[e]={toolClass:a}}this.addTool(o.toolName,r)}},{key:"addViewport",value:function(e,t){var n=(0,K.getRenderingEngines)();if(!t&&n.length>1)throw new Error("You must specify a renderingEngineId when there are multiple rendering engines.");var r=t||n[0].id;this.viewportsInfo.some((function(t){return t.viewportId===e}))||this.viewportsInfo.push({viewportId:e,renderingEngineId:r});var o=this.getActivePrimaryMouseButtonTool();K.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(o)}},{key:"removeViewports",value:function(e,t){var n=[];if(this.viewportsInfo.forEach((function(r,o){var a=!1;r.renderingEngineId===e&&(a=!0,t&&r.viewportId!==t&&(a=!1)),a&&n.push(o)})),n.length)for(var r=n.length-1;r>=0;r--)this.viewportsInfo.splice(n[r],1)}},{key:"setActiveStrategy",value:function(e,t){var n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn("Tool ".concat(e," not added to toolGroup, can't set tool configuration."))}},{key:"setToolMode",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e?t!==qe.Active?t!==qe.Passive?t!==qe.Enabled?t!==qe.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n):console.warn("setToolMode: toolName must be defined")}},{key:"setToolActive",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._toolInstances[e];if(void 0!==n)if(n){var r=this.toolOptions[e]?this.toolOptions[e].bindings:[],o=t.bindings?t.bindings:[],a={bindings:[].concat(kr(r),kr(o)).reduce((function(e,t){var n=void 0!==t.numTouchPoints,r=void 0!==t.mouseButton;return e.some((function(e){return r=t,(n=e).mouseButton===r.mouseButton&&n.modifierKey===r.modifierKey;var n,r}))||!n&&!r||e.push(t),e}),[]),mode:Jl};this.toolOptions[e]=a,this._toolInstances[e].mode=Jl;var i=K.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&i)this.setViewportsCursorByToolName(e);else if(!this.getActivePrimaryMouseButtonTool()&&i){var l=gl.getDefinedCursor("default");this._setCursorForViewports(l)}"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();var c={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,K.triggerEvent)(K.eventTarget,J.TOOL_ACTIVATED,c)}else console.warn("'".concat(e,"' instance ").concat(n," is not registered with this toolGroup, can't set tool mode."));else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"setToolPassive",value:function(e){var t=this._toolInstances[e];if(void 0!==t){var n=this.getToolOptions(e),r=Object.assign({bindings:n?n.bindings:[]},n,{mode:$l}),o=this.getDefaultMousePrimary();r.bindings=r.bindings.filter((function(e){return e.mouseButton!==o||e.modifierKey}));var a=$l;0!==r.bindings.length&&(a=Jl,r.mode=a),this.toolOptions[e]=r,t.mode=a,"function"==typeof t.onSetToolPassive&&t.onSetToolPassive(),this._renderViewports()}else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"setToolEnabled",value:function(e){var t=this._toolInstances[e];if(void 0!==t){var n={bindings:[],mode:Zl};this.toolOptions[e]=n,t.mode=Zl,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports()}else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"setToolDisabled",value:function(e){var t=this._toolInstances[e];if(void 0!==t){var n={bindings:[],mode:Xl};this.toolOptions[e]=n,t.mode=Xl,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports()}else console.warn("Tool ".concat(e," not added to toolGroup, can't set tool mode."))}},{key:"getToolOptions",value:function(e){var t=this.toolOptions[e];if(void 0!==t)return t}},{key:"getActivePrimaryMouseButtonTool",value:function(){var e=this;return Object.keys(this.toolOptions).find((function(t){var n=e.toolOptions[t];return n.mode===Jl&&e._hasMousePrimaryButtonBinding(n)}))}},{key:"setViewportsCursorByToolName",value:function(e,t){var n=this._getCursor(e,t);this._setCursorForViewports(n)}},{key:"_getCursor",value:function(e,t){var n,r;return t&&(n="".concat(e,".").concat(t),r=Vl.getDefinedCursor(n,!0))?r:(n="".concat(e),(r=Vl.getDefinedCursor(n,!0))?r:(n=e,(r=Vl.getDefinedCursor(n,!0))||gl.getDefinedCursor("default")))}},{key:"_setCursorForViewports",value:function(e){this.viewportsInfo.forEach((function(t){var n=t.renderingEngineId,r=t.viewportId,o=(0,K.getEnabledElementByIds)(r,n);o&&Gl(o.viewport.element,e)}))}},{key:"setToolConfiguration",value:function(e,t,n){return void 0===this._toolInstances[e]?(console.warn("Tool ".concat(e," not present, can't set tool configuration.")),!1):(r=n?t:K.utilities.deepMerge(this._toolInstances[e].configuration,t),this._toolInstances[e].configuration=r,this._renderViewports(),!0);var r}},{key:"getDefaultMousePrimary",value:function(){return go.Primary}},{key:"getToolConfiguration",value:function(e,t){if(void 0!==this._toolInstances[e]){var n=ul()(this._toolInstances[e].configuration,t);return re()(n)}console.warn("Tool ".concat(e," not present, can't set tool configuration."))}},{key:"_hasMousePrimaryButtonBinding",value:function(e){var t,n=this.getDefaultMousePrimary();return null==e||null===(t=e.bindings)||void 0===t?void 0:t.some((function(e){return e.mouseButton===n&&void 0===e.modifierKey}))}},{key:"_renderViewports",value:function(){this.viewportsInfo.forEach((function(e){var t=e.renderingEngineId,n=e.viewportId;(0,K.getRenderingEngine)(t).renderViewport(n)}))}}]),e}(),ec=function(e){if(!Fe.toolGroups.some((function(t){return t.id===e}))){var t=new Ql(e);return Fe.toolGroups.push(t),t}console.warn("'".concat(e,"' already exists."))},tc=function(){return Fe.toolGroups};function nc(e,t,n,r){var o=r.detail.camera,a=(0,K.getRenderingEngine)(n.renderingEngineId);if(!a)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));var i=a.getViewport(n.viewportId);i.setCamera(o),i.render()}var rc=K.Enums.Events.CAMERA_MODIFIED;function oc(e){return al(e,rc,nc)}function ac(e,t,n,r,o){var a=r.detail,i=a.volumeId,l=a.range,c=a.invertStateChanged,s=a.invert,d=(0,K.getRenderingEngine)(n.renderingEngineId);if(!d)throw new Error("Rendering Engine does not exist: ".concat(n.renderingEngineId));var u=d.getViewport(n.viewportId),v={voiRange:l};if(o.syncInvertState&&c&&(v.invert=s),u instanceof K.BaseVolumeViewport)u.setProperties(v,i);else{if(!(u instanceof K.StackViewport))throw new Error("Viewport type not supported.");u.setProperties(v)}u.render()}function ic(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{syncInvertState:!0};return al(e,K.Enums.Events.VOI_MODIFIED,ac,t)}function lc(e,t,n){var r=(0,K.getRenderingEngine)(n.renderingEngineId);if(!r)throw new Error("No RenderingEngine for Id: ".concat(n.renderingEngineId));var o=e.getOptions(n.viewportId),a=r.getViewport(n.viewportId),i=r.getViewport(t.viewportId);if(!1!==(null==o?void 0:o.syncZoom)){var l=i.getZoom();a.setZoom(l)}if(!1!==(null==o?void 0:o.syncPan)){var c=i.getPan();a.setPan(c)}a.render()}var cc=K.Enums.Events.CAMERA_MODIFIED;function sc(e){return al(e,cc,lc)}var dc=h(976);var uc=function(e,t,n){return Math.min(Math.max(t,e),n)};function vc(e,t){if(!(0,K.getEnabledElement)(e.element))throw new Error("Scroll::Viewport is not enabled (it might be disabled)");if(e instanceof K.StackViewport&&0===e.getImageIds().length)throw new Error("Scroll::Stack Viewport has no images");var n=e.type,r=t.volumeId,o=t.delta;if(e instanceof K.StackViewport)e.scroll(o,t.debounceLoading,t.loop);else{if(!(e instanceof K.VolumeViewport))throw new Error("Not implemented for Viewport Type: ".concat(n));!function(e,t,n){var r=K.utilities.getVolumeViewportScrollInfo(e,t),o=r.numScrollSteps,a=r.currentStepIndex,i=r.sliceRangeInfo;if(i){var l=i.sliceRange,c=i.spacingInNormalDirection,s=i.camera,d=s.focalPoint,u=s.viewPlaneNormal,v=s.position,f=K.utilities.snapFocalPointToSlice(d,v,l,u,c,n),g=f.newFocalPoint,h=f.newPosition;e.setCamera({focalPoint:g,position:h}),e.render();var p=a+n;if((p>o||p<0)&&e.getCurrentImageId()){var m={volumeId:t,viewport:e,delta:n,desiredStepIndex:p,currentStepIndex:a,numScrollSteps:o,currentImageId:e.getCurrentImageId()};K.utilities.triggerEvent(K.eventTarget,K.EVENTS.VOLUME_SCROLL_OUT_OF_BOUNDS,m)}}}(e,r,o)}}function fc(){return fc=ka(Pa().mark((function e(t){var n,r,o,a,i,l,c,s,d,u,v=arguments;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=(n=v.length>1&&void 0!==v[1]?v[1]:{}).imageIndex,o=n.debounceLoading,a=n.volumeId,i=(0,K.getEnabledElement)(t)){e.next=5;break}throw new Error("Element has been disabled");case 5:l=i.viewport,c=gc(l,o),s=c.imageIndex,d=c.numberOfSlices,u=hc(d,r),vc(l,{delta:u-s,debounceLoading:o,volumeId:a});case 10:case"end":return e.stop()}}),e)}))),fc.apply(this,arguments)}function gc(e,t){if(e instanceof K.StackViewport)return{numberOfSlices:e.getImageIds().length,imageIndex:t?e.getTargetImageIdIndex():e.getCurrentImageIdIndex()};if(e instanceof K.VolumeViewport)return K.utilities.getImageSliceDataForVolumeViewport(e);throw new Error("Unsupported viewport type")}function hc(e,t){return uc(t,0,e-1)}var pc=function(e){return fc.apply(this,arguments)};function mc(e,t,n){return wc.apply(this,arguments)}function wc(){return(wc=ka(Pa().mark((function e(t,n,r){var o,a,i,l,c,s,d,u,v,f,g,h,p;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=(0,K.getRenderingEngine)(r.renderingEngineId)){e.next=3;break}throw new Error("No RenderingEngine for Id: ".concat(r.renderingEngineId));case 3:if(a=o.getViewport(n.viewportId),i=o.getViewport(r.viewportId),l=a.getFrameOfReferenceUID(),c=i.getFrameOfReferenceUID(),s=a.getCurrentImageId(),d=K.metaData.get("imagePlaneModule",s),u=d.imagePositionPatient,v=i.getImageIds(),t=i,void 0,void 0,void 0,m=a.getCamera().viewPlaneNormal,w=t.getCamera().viewPlaneNormal,E=dc.vec3.dot(m,w),Math.abs(E)>.9){e.next=13;break}return e.abrupt("return");case 13:if(l!==c){e.next=21;break}if(-1===(f=Ec(u,v)).index||i.getCurrentImageIdIndex()===f.index){e.next=19;break}return e.next=18,pc(i.element,{imageIndex:f.index});case 18:return e.abrupt("return");case 19:e.next=29;break;case 21:if(g=K.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",[r.viewportId,n.viewportId])){e.next=24;break}throw new Error("No registration matrix found for sourceViewport: ".concat(n.viewportId," and targetViewport: ").concat(r.viewportId,", viewports with different frameOfReferenceUIDs must have a registration matrix in the registrationMetadataProvider. Use calculateViewportsRegistrationMatrix to calculate the matrix."));case 24:if(h=dc.vec3.transformMat4(dc.vec3.create(),u,g),-1===(p=Ec(h,v)).index||i.getCurrentImageIdIndex()===p.index){e.next=29;break}return e.next=29,pc(i.element,{imageIndex:p.index});case 29:case"end":return e.stop()}var t,m,w,E}),e)})))).apply(this,arguments)}function Ec(e,t){return t.reduce((function(t,n,r){var o=K.metaData.get("imagePlaneModule",n).imagePositionPatient,a=dc.vec3.distance(o,e);return a<t.distance?{distance:a,index:r}:t}),{distance:1/0,index:-1})}var yc=K.Enums.Events.STACK_NEW_IMAGE;function Ic(e){return al(e,yc,mc)}var bc=function(e,t,n){return"".concat(e,"::").concat(t,"::").concat(n)},Cc=function(e,t){Object.keys(e).forEach((function(n){var r=t.getAttribute(n),o=e[n];void 0===o||""===o?t.removeAttribute(n):r!==o&&t.setAttribute(n,o)}))},Tc=function(e,t){Object.keys(e).forEach((function(n){var r=e[n];void 0!==r&&""!==r&&t.setAttribute(n,r)}))},_c=function(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=Object.assign({color:"dodgerblue",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0},a),c=l.color,s=l.fill,d=l.width,u=l.lineWidth,v=l.lineDash,f=u||d,g=bc(t,"circle",n),h=e.getSvgNode(g),p={cx:"".concat(r[0]),cy:"".concat(r[1]),r:"".concat(o),stroke:c,fill:s,"stroke-width":f,"stroke-dasharray":v};if(h)Cc(p,h),e.setNodeTouched(g);else{var m=document.createElementNS("http://www.w3.org/2000/svg","circle");""!==i&&m.setAttribute("data-id",i),Tc(p,m),e.appendNode(m,g)}},Dc=function(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l.color,s=l.width,d=l.lineWidth,u=l.lineDash,v=d||s,f=bc(t,"ellipse",n),g=e.getSvgNode(f),h=Math.abs(r[0]-o[0]),p=Math.abs(r[1]-o[1]),m=[Math.min(r[0],o[0])+h/2,Math.min(r[1],o[1])+p/2],w=h/2,E=p/2,y={cx:"".concat(m[0]),cy:"".concat(m[1]),rx:"".concat(w),ry:"".concat(E),stroke:c,fill:"transparent","stroke-width":v,"stroke-dasharray":u};if(g)Cc(y,g),e.setNodeTouched(f);else{var I=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==i&&I.setAttribute("data-id",i),Tc(y,I),e.appendNode(I,f)}},Oc=function(e,t,n,r){for(var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=Object.assign({color:"dodgerblue",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},o),i=a.color,l=a.handleRadius,c=a.width,s=a.lineWidth,d=a.fill,u=a.type,v=a.opacity,f=s||c,g=0;g<r.length;g++){var h=r[g],p=bc(t,"handle","hg-".concat(n,"-index-").concat(g)),m=void 0;if("circle"===u)m={cx:"".concat(h[0]),cy:"".concat(h[1]),r:l,stroke:i,fill:d,"stroke-width":f,opacity:v};else{if("rect"!==u)throw new Error("Unsupported handle type: ".concat(u));var w=1.5*parseFloat(l),E=h[0]-.5*w,y=h[1]-.5*w;m={x:"".concat(E),y:"".concat(y),width:"".concat(w),height:"".concat(w),stroke:i,fill:d,"stroke-width":f,rx:"".concat(.1*w),opacity:v}}var I=e.getSvgNode(p);if(I)Cc(m,I),e.setNodeTouched(p);else{var b=document.createElementNS("http://www.w3.org/2000/svg",u);Tc(m,b),e.appendNode(b,p)}}};function Sc(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"";if(!(isNaN(r[0])||isNaN(r[1])||isNaN(o[0])||isNaN(o[1]))){var l=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,shadow:void 0},a),c=l.color,s=l.width,d=l.lineWidth,u=l.lineDash,v=l.shadow,f=d||s,g=bc(t,"line",n),h=e.getSvgNode(g),p=v?"filter:url(#shadow-".concat(e.svgLayerElement.id,");"):"",m={x1:"".concat(r[0]),y1:"".concat(r[1]),x2:"".concat(o[0]),y2:"".concat(o[1]),stroke:c,style:p,"stroke-width":f,"stroke-dasharray":u};if(h)Cc(m,h),e.setNodeTouched(g);else{var w=document.createElementNS("http://www.w3.org/2000/svg","line");""!==i&&w.setAttribute("data-id",i),Tc(m,w),e.appendNode(w,g)}}}function xc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Mc(e,t,n,r,o){if(!(r.length<2)){var a,i=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0,connectLastToFirst:!1},o),l=i.color,c=i.width,s=i.lineWidth,d=i.lineDash,u=s||c,v=bc(t,"polyline",n),f=e.getSvgNode(v),g="",h=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return xc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?xc(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(r);try{for(h.s();!(a=h.n()).done;){var p=a.value;g+="".concat(p[0],", ").concat(p[1]," ")}}catch(e){h.e(e)}finally{h.f()}if(o.connectLastToFirst){var m=r[0];g+="".concat(m[0],", ").concat(m[1])}var w={points:g,stroke:l,fill:"none","stroke-width":u,"stroke-dasharray":d};if(f)Cc(w,f),e.setNodeTouched(v);else{var E=document.createElementNS("http://www.w3.org/2000/svg","polyline");Tc(w,E),e.appendNode(E,v)}}}function kc(e){var t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function Rc(e,t){var n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||((n=document.createElementNS("http://www.w3.org/2000/svg","rect")).setAttribute("class","background"),e.insertBefore(n,e.firstChild));var r=e.getBBox(),o={x:"".concat(r.x),y:"".concat(r.y),width:"".concat(r.width),height:"".concat(r.height),fill:t};return Cc(o,n),r}var Pc=function(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=function(e,t,n){var r,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[""],a=arguments.length>4?arguments[4]:void 0,i=arguments.length>5?arguments[5]:void 0,l=i.padding,c=i.color,s=i.fontFamily,d=i.fontSize,u=i.background,v=a[0]+l,f=a[1]+l,g=bc(t,"text",n),h=e.getSvgNode(g);if(h){for(var p=h.querySelector("text"),m=Array.from(p.children),w=0;w<m.length;w++){var E=m[w],y=o[w]||"";E.textContent=y}if(o.length>m.length){for(var I=0;I<o.length-m.length;I++){var b=kc(o[I+m.length]);p.appendChild(b)}h.appendChild(p),e.appendNode(h,g)}var C={fill:c,"font-size":d,"font-family":s},T={transform:"translate(".concat(v," ").concat(f,")")};Cc(C,p),Cc(T,h),r=Rc(h,u),e.setNodeTouched(g)}else{var _=document.createElementNS("http://www.w3.org/2000/svg","g");_.setAttribute("transform","translate(".concat(v," ").concat(f,")"));for(var D=function(e,t){var n=t.color,r=t.fontFamily,o=t.fontSize,a=document.createElementNS("http://www.w3.org/2000/svg","text"),i="filter:url(#shadow-".concat(e.svgLayerElement.id,");"),l="".concat("user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);").concat(i);return a.setAttribute("x","0"),a.setAttribute("y","0"),a.setAttribute("fill",n),a.setAttribute("font-family",r),a.setAttribute("font-size",o),a.setAttribute("style",l),a}(e,i),O=0;O<o.length;O++){var S=kc(o[O]);D.appendChild(S)}_.appendChild(D),e.appendNode(_,g),r=Rc(_,u)}return Object.assign({},r,{x:v,y:f,height:r.height+l,width:r.width+l})}(e,t,n,r,o,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},a));return i};function Nc(e,t){var n=[0,0],r=Number.MAX_SAFE_INTEGER;return e.forEach((function(e){var o,a,i,l,c,s,d,u=(o=e,i=(a=it(t,2))[0],l=a[1],s=(c=it(o,2))[0],d=c[1],Math.sqrt(Math.pow(i-s,2)+Math.pow(l-d,2)));u<r&&(r=u,n=kr(e))})),n}var Ac=function(e,t,n,r,o,a,i){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},c=Object.assign({handleRadius:"6",centering:{x:!1,y:!0}},l),s=Pc(e,t,n,r,o,c);return function(e,t,n,r,o,a){var i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},l=r.length>0?Nc(r,o):o,c=Nc(function(e){var t=e.x,n=e.y,r=e.height,o=e.width,a=o/2,i=r/2;return[[t+a,n],[t,n+i],[t+a,n+r],[t+o,n+i]]}(a),l),s=Object.assign({color:"rgb(255, 255, 0)",lineWidth:"1",lineDash:"2,3"},i);Sc(e,t,"link-".concat(n),l,c,s)}(e,t,n,a,o,s,c),s};function Lc(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},i=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",l=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l.color,s=l.width,d=l.lineWidth,u=l.lineDash,v=d||s,f=bc(t,"rect",n),g=e.getSvgNode(f),h=[Math.min(r[0],o[0]),Math.min(r[1],o[1])],p=Math.abs(r[0]-o[0]),m=Math.abs(r[1]-o[1]),w={x:"".concat(h[0]),y:"".concat(h[1]),width:"".concat(p),height:"".concat(m),stroke:c,fill:"transparent","stroke-width":v,"stroke-dasharray":u};if(g)Cc(w,g),e.setNodeTouched(f);else{var E=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==i&&E.setAttribute("data-id",i),Tc(w,E),e.appendNode(E,f)}}function Uc(e,t,n,r,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};if(!(isNaN(r[0])||isNaN(r[1])||isNaN(o[0])||isNaN(o[1]))){var i=Object.assign({color:"dodgerblue",width:"2",lineWidth:void 0,lineDash:void 0},a),l=i.color,c=i.width,s=i.lineWidth;Sc(e,t,n,r,o,{color:l,width:c,lineWidth:s,lineDash:i.lineDash});var d=Math.atan2(o[1]-r[1],o[0]-r[0]),u={start:[o[0]-10*Math.cos(d-Math.PI/7),o[1]-10*Math.sin(d-Math.PI/7)],end:o},v={start:[o[0]-10*Math.cos(d+Math.PI/7),o[1]-10*Math.sin(d+Math.PI/7)],end:o};Sc(e,t,"2",u.start,u.end,{color:l,width:c,lineWidth:s}),Sc(e,t,"3",v.start,v.end,{color:l,width:c,lineWidth:s})}}function Vc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Bc(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,r=(0,K.getEnabledElement)(e);if(!r)throw new Error("getAnnotationNearPoint: enabledElement not found");return jc(r,t,n)}function jc(e,t,n){var r=e.renderingEngineId,o=e.viewportId,a=Ur(o,r);if(!a)return null;var i=a._toolInstances;for(var l in i){var c=Hc(i[l],e,t,n);if(c)return c}return null}function Hc(e,t,n,r){var o,a=t.viewport,i=Xe(e.constructor.toolName,null==a?void 0:a.element),l=null==a||null===(o=a.getCurrentImageId)||void 0===o?void 0:o.call(a);if(null!=i&&i.length){var c,s=t.viewport.element,d=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Vc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Vc(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(i);try{for(d.s();!(c=d.n()).done;){var u,v=c.value,f=null===(u=v.metadata)||void 0===u?void 0:u.referencedImageId;if(!(l&&f&&l!==f||!e.isPointNearTool)&&(e.isPointNearTool(s,v,n,r,"")||e.getHandleNearImagePoint(s,v,n,r)))return v}}catch(e){d.e(e)}finally{d.f()}}return null}var Wc=function(e){var t=$(e);return null!==e&&("object"===t||"function"===t)},Fc=function(e,t,n){var r,o,a,i,l,c,s=0,d=!1,u=!1,v=!0,f=!t&&0!==t&&"function"==typeof window.requestAnimationFrame;if("function"!=typeof e)throw new TypeError("Expected a function");function g(t){var n=r,a=o;return r=o=void 0,s=t,i=e.apply(a,n)}function h(e,t){return f?window.requestAnimationFrame(e):setTimeout(e,t)}function p(e){var n=e-c;return void 0===c||n>=t||n<0||u&&e-s>=a}function m(){var e=Date.now();if(p(e))return w(e);l=h(m,function(e){var n=e-s,r=t-(e-c);return u?Math.min(r,a-n):r}(e))}function w(e){return l=void 0,v&&r?g(e):(r=o=void 0,i)}function E(){for(var e=Date.now(),n=p(e),a=arguments.length,v=new Array(a),f=0;f<a;f++)v[f]=arguments[f];if(r=v,o=this,c=e,n){if(void 0===l)return function(e){return s=e,l=h(m,t),d?g(e):i}(c);if(u)return l=h(m,t),g(c)}return void 0===l&&(l=h(m,t)),i}return t=Number(t)||0,Wc(n)&&(d=Boolean(n.leading),a=(u="maxWait"in n)?Math.max(Number(n.maxWait)||0,t):a,v="trailing"in n?Boolean(n.trailing):v),E.cancel=function(){void 0!==l&&function(e){if(f)return window.cancelAnimationFrame(e);clearTimeout(e)}(l),s=0,r=c=o=l=void 0},E.flush=function(){return void 0===l?i:w(Date.now())},E.pending=function(){return void 0!==l},E},Gc=function(e,t,n){var r=!0,o=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Wc(n)&&(r="leading"in n?Boolean(n.leading):r,o="trailing"in n?Boolean(n.trailing):o),Fc(e,t,{leading:r,trailing:o,maxWait:t})},qc=K.utilities.calibratedPixelSpacingMetadataProvider;function zc(e,t,n){"number"==typeof n&&(n={type:K.Enums.CalibrationTypes.USER,scale:n}),qc.add(e,n),t.getStackViewports().forEach((function(t){t.getImageIds().includes(e)&&t.calibrateSpacing(e)}))}function Kc(e,t,n,r){var o,a,i,l,c,s,d;d=e.getScalarData?e.getScalarData():e.getPointData().getScalars().getData();var u=e.getDimensions();if(r){var v=it(r,3),f=it(v[0],2);o=f[0],a=f[1];var g=it(v[1],2);i=g[0],l=g[1];var h=it(v[2],2);c=h[0],s=h[1]}else o=0,a=u[0],i=0,l=u[1],c=0,s=u[2];for(var p=dc.vec3.fromValues(o,i,c),m=e.getDirection(),w=m.slice(0,3),E=m.slice(3,6),y=m.slice(6,9),I=it(e.getSpacing(),3),b=I[0],C=I[1],T=I[2],_=e.indexToWorld(p),D=dc.vec3.fromValues(w[0]*b,w[1]*b,w[2]*b),O=dc.vec3.fromValues(E[0]*C,E[1]*C,E[2]*C),S=dc.vec3.fromValues(y[0]*T,y[1]*T,y[2]*T),x=u[0],M=u[0]*u[1],k=c;k<=s;k++)for(var R=i;R<=l;R++)for(var P=o;P<=a;P++){var N=[P,R,k],A=P-o,L=R-i,U=k-c,V=_,B=[V[0]+A*D[0]+L*O[0]+U*S[0],V[1]+A*D[1]+L*O[1]+U*S[1],V[2]+A*D[2]+L*O[2]+U*S[2]];if(t(B,N)){var j=k*M+R*x+P;n({value:d[j],index:j,pointIJK:N,pointLPS:B})}}}var Yc=function(e,t){var n=1/0,r=0,o=1/0,a=0,i=1/0,l=0;if(e.forEach((function(e){n=Math.min(e[0],n),r=Math.max(e[0],r),o=Math.min(e[1],o),a=Math.max(e[1],a),i=Math.min(e[2],i),l=Math.max(e[2],l)})),n=Math.floor(n),r=Math.floor(r),o=Math.floor(o),a=Math.floor(a),i=Math.floor(i),l=Math.floor(l),t){var c=it(t,3),s=c[0],d=c[1],u=c[2];n=Math.max(0,n),r=Math.min(s-1,r),o=Math.max(0,o),a=Math.min(d-1,a),i=Math.max(0,i),l=Math.min(u-1,l)}return[[n,r],[o,a],[i,l]]},Jc=K.utilities.transformWorldToIndex;function $c(e,t,n,r){var o=function(e,t,n){var r,o=it(e,2),a=o[0],i=o[1],l=dc.vec3.fromValues((a[0]+i[0])/2,(a[1]+i[1])/2,(a[2]+i[2])/2),c=dc.vec3.distance(a,i)/2;if(!n){var s=Jc(t,l),d=t.getSpacing(),u=Math.min.apply(Math,kr(d)),v=Math.ceil(c/u);return{boundsIJK:r=[[s[0]-v,s[0]+v],[s[1]-v,s[1]+v],[s[2]-v,s[2]+v]],centerWorld:l,radiusWorld:c}}return r=function(e,t,n,r,o){var a=it(n,2),i=a[0],l=a[1],c=e.getDimensions(),s=t.getCamera(),d=dc.vec3.fromValues(s.viewUp[0],s.viewUp[1],s.viewUp[2]),u=dc.vec3.fromValues(s.viewPlaneNormal[0],s.viewPlaneNormal[1],s.viewPlaneNormal[2]),v=dc.vec3.create();dc.vec3.cross(v,d,u);var f=dc.vec3.create(),g=dc.vec3.create();dc.vec3.scaleAndAdd(f,l,u,o),dc.vec3.scaleAndAdd(g,i,u,-o),dc.vec3.scaleAndAdd(f,f,v,-o),dc.vec3.scaleAndAdd(g,g,v,o);var h=[Jc(e,f),Jc(e,g)];return Yc(h,c)}(t,n,e,0,c),{boundsIJK:r,centerWorld:l,radiusWorld:c}}(t,e,r),a=o.boundsIJK,i={center:o.centerWorld,radius:o.radiusWorld};Kc(e,(function(e){return function(e,t){var n=e.center,r=e.radius;return Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)<=Math.pow(r,2)}(i,e)}),n,a)}var Zc=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(null==e||""===e)return"NaN";if((e=Number(e))<1e-4)return"".concat(e);var n=e>=100?t-2:e>=10?t-1:e>=1?t:e>=.1?t+1:e>=.01?t+2:e>=.001?t+3:t+4;return e.toFixed(n)};function Xc(e,t){!function(e,t){var n=e.viewport,r=t.volume,o=t.segmentsLocked,a=t.segmentIndex,i=t.segmentationId,l=t.points,c=r.imageData,s=r.dimensions,d=r.getScalarData(),u=[];$c(c,[l[0],l[1]],(function(e){var t=e.index,n=e.value;o.includes(n)||(d[t]=a,u.push(t))}),n);var v=s[0]*s[1],f=Math.floor(u[0]/v),g=Math.floor(u[u.length-1]/v);Tt(i,Array.from({length:g-f+1},(function(e,t){return t+f})))}(e,t)}function Qc(e,t){Xc(e,Object.assign({},t,{segmentIndex:0}))}function es(e){var t=it(e,4),n=t[0],r=t[1],o=t[2],a=t[3];return[[o[0],r[1]],[a[0],n[1]]]}function ts(e,t){var n=e.center,r=e.xRadius,o=e.yRadius,a=e.zRadius,i=it(t,3),l=i[0],c=i[1],s=i[2],d=it(n,3),u=d[0],v=d[1],f=d[2],g=0;return 0!==r&&(g+=(l-u)*(l-u)/(r*r)),0!==o&&(g+=(c-v)*(c-v)/(o*o)),0!==a&&(g+=(s-f)*(s-f)/(a*a)),g<=1}var ns=K.utilities.transformWorldToIndex;function rs(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=t.volume,o=t.imageVolume,a=t.points,i=t.segmentsLocked,l=t.segmentIndex,c=t.segmentationId,s=t.strategySpecificConfiguration,d=r.imageData,u=r.dimensions,v=r.getScalarData(),f=e.viewport,g=dc.vec3.fromValues(0,0,0);a.forEach((function(e){dc.vec3.add(g,g,e)})),dc.vec3.scale(g,g,1/a.length);var h,p=it(es(a.map((function(e){return f.worldToCanvas(e)}))),2),m=p[0],w=p[1],E=f.canvasToWorld(m),y=f.canvasToWorld(w),I=[ns(d,E),ns(d,y)],b=Yc(I,u),C={center:g,xRadius:Math.abs(E[0]-y[0])/2,yRadius:Math.abs(E[1]-y[1])/2,zRadius:Math.abs(E[2]-y[2])/2},T=new Set;h=n?function(e){var t=e.value,n=e.index,r=e.pointIJK;i.includes(t)||function(e,t,n){var r=n.THRESHOLD_INSIDE_CIRCLE,o=t.getScalarData()[e],a=r.threshold;return a[0]<=o&&o<=a[1]}(n,o,s)&&(v[n]=l,T.add(r[2]))}:function(e){var t=e.value,n=e.index,r=e.pointIJK;i.includes(t)||(v[n]=l,T.add(r[2]))},Kc(d,(function(e,t){return ts(C,e)}),h,b),Tt(c,Array.from(T))}function os(e,t){rs(e,t,!1)}function as(e,t){var n=t.volume,r=t.imageVolume;if(!K.utilities.isEqual(n.dimensions,r.dimensions)||!K.utilities.isEqual(n.direction,r.direction))throw new Error("Only source data the same dimensions/size/orientation as the segmentation currently supported.");rs(e,t,!0)}function is(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function ls(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?is(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):is(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function cs(e,t){os(e,ls(ls({},t),{},{segmentIndex:0}))}function ss(e){var t=St().getSegmentationRepresentations(e);if(t)return t.find((function(e){return e.active}))}function ds(e,t){St().setActiveSegmentationRepresentation(e,t),bt(e,t)}function us(e,t){var n=xt(e);if(!n)throw new Error("No segmentation state found for ".concat(e));return n.segmentsLocked.has(t)}function vs(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=xt(e);if(!r)throw new Error("No segmentation state found for ".concat(e));var o=r.segmentsLocked;n?o.add(t):o.delete(t),Ct(e)}function fs(e){var t=xt(e);if(!t)throw new Error("No segmentation state found for ".concat(e));var n=t.segmentsLocked;return Array.from(n)}function gs(e,t){var n=xt(e);(null==n?void 0:n.activeSegmentIndex)!==t&&(n.activeSegmentIndex=t,Ct(e))}function hs(e){var t=xt(e);if(t)return t.activeSegmentIndex}function ps(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");K.utilities.isEqual(e[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),e.unshift([0,0,0,0])),Jt(e,t)}function ms(e,t,n){var r=Gt(e,t);if(!r)throw new Error("setColorLUT: could not find segmentation representation with UID ".concat(t));if(!Yt(n))throw new Error("setColorLUT: could not find colorLUT with index ".concat(n));r.colorLUTIndex=n,bt(e,t)}function ws(e,t,n){var r=Gt(e,t);if(!r)throw new Error("segmentation representation with UID ".concat(t," does not exist for tool group ").concat(e));return Yt(r.colorLUTIndex)[n]}function Es(e,t,n,r){for(var o=ws(e,t,n),a=0;a<r.length;a++)o[a]=r[a];bt(e,t)}var ys=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:os,THRESHOLD_INSIDE_CIRCLE:as,ERASE_INSIDE_CIRCLE:cs,FILL_INSIDE_SPHERE:Xc,ERASE_INSIDE_SPHERE:Qc},strategySpecificConfiguration:{THRESHOLD_INSIDE_CIRCLE:{threshold:[-150,-70]}},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25}};return ee(this,o),te(la(e=r.call(this,t,n)),"_editData",void 0),te(la(e),"_hoverData",void 0),te(la(e),"onSetToolPassive",(function(){e.disableCursor()})),te(la(e),"onSetToolEnabled",(function(){e.disableCursor()})),te(la(e),"onSetToolDisabled",(function(){e.disableCursor()})),te(la(e),"preMouseDownCallback",(function(t){var n=t.detail.element,r=(0,K.getEnabledElement)(n),o=r.viewport,a=r.renderingEngine;if(o instanceof K.StackViewport)throw new Error("Not implemented yet");var i=ss(e.toolGroupId);if(!i)throw new Error("No active segmentation detected, create one before using the brush tool");var l=i.segmentationId,c=i.type,s=fs(l),d=xt(l).representationData[c].volumeId,u=K.cache.getVolume(d),v=o.getActors()[0].uid,f=K.cache.getVolume(v),g=[o.id];return e._editData={segmentation:u,imageVolume:f,segmentsLocked:s},e._activateDraw(n),Kl(n),t.preventDefault(),na(a,g),!0})),te(la(e),"mouseMoveCallback",(function(t){e.mode===qe.Active&&e.updateCursor(t)})),te(la(e),"_dragCallback",(function(t){var n=t.detail.element,r=(0,K.getEnabledElement)(n),o=r.renderingEngine,a=e._editData,i=a.imageVolume,l=a.segmentation,c=a.segmentsLocked;e.updateCursor(t);var s=e._hoverData,d=s.segmentIndex,u=s.segmentationId,v=s.segmentationRepresentationUID,f=s.brushCursor,g=s.viewportIdsToRender,h=f.data,p=f.metadata,m=p.viewPlaneNormal,w=p.viewUp;na(o,g);var E={points:h.handles.points,volume:l,imageVolume:i,segmentIndex:d,segmentsLocked:c,viewPlaneNormal:m,toolGroupId:e.toolGroupId,segmentationId:u,segmentationRepresentationUID:v,viewUp:w,strategySpecificConfiguration:e.configuration.strategySpecificConfiguration};e.applyActiveStrategy(r,E)})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e._editData,o=r.imageVolume,a=r.segmentation,i=r.segmentsLocked,l=e._hoverData,c=l.segmentIndex,s=l.segmentationId,d=l.segmentationRepresentationUID,u=l.brushCursor,v=u.data,f=u.metadata,g=f.viewPlaneNormal,h=f.viewUp;e._deactivateDraw(n),zl(n);var p=(0,K.getEnabledElement)(n),m=p.viewport;if(e._editData=null,e.updateCursor(t),m instanceof K.StackViewport)throw new Error("Not implemented yet");var w={points:v.handles.points,volume:a,imageVolume:o,segmentIndex:c,segmentsLocked:i,viewPlaneNormal:g,toolGroupId:e.toolGroupId,segmentationId:s,segmentationRepresentationUID:d,viewUp:h,strategySpecificConfiguration:e.configuration.strategySpecificConfiguration};e.applyActiveStrategy(p,w)})),te(la(e),"_activateDraw",(function(t){t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback)})),e}return Q(o,[{key:"disableCursor",value:function(){this._hoverData=void 0}},{key:"updateCursor",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints.canvas,o=(0,K.getEnabledElement)(n),a=o.renderingEngine,i=o.viewport,l=i.getCamera(),c=l.viewPlaneNormal,s=l.viewUp,d=this.toolGroupId,u=ss(d);if(u){var v=u.segmentationRepresentationUID,f=u.segmentationId,g=hs(f),h=ws(d,v,g),p=[i.id],m={metadata:{viewPlaneNormal:kr(c),viewUp:kr(s),FrameOfReferenceUID:i.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:h},data:{}};this._hoverData={brushCursor:m,centerCanvas:r,segmentIndex:g,segmentationId:f,segmentationRepresentationUID:v,segmentColor:h,viewportIdsToRender:p},this._calculateCursor(n,r),na(a,p)}else console.warn("No active segmentation detected, create one before using the brush tool")}},{key:"_calculateCursor",value:function(e,t){var n=(0,K.getEnabledElement)(e).viewport.canvasToWorld,r=this.configuration.brushSize,o=[t[0],t[1]+r],a=[t[0],t[1]-r],i=[t[0]-r,t[1]],l=[t[0]+r,t[1]],c=this._hoverData.brushCursor.data;void 0===c.handles&&(c.handles={}),c.handles.points=[n(o),n(a),n(i),n(l)],c.invalidated=!1}},{key:"invalidateBrushCursor",value:function(){void 0!==this._hoverData&&(this._hoverData.brushCursor.data.invalidated=!0)}},{key:"renderAnnotation",value:function(e,t){if(this._hoverData){var n=e.viewport;if(this._hoverData.viewportIdsToRender.includes(n.id)){var r=this._hoverData.brushCursor;if(!0===r.data.invalidated){var o=this._hoverData.centerCanvas,a=n.element;this._calculateCursor(a,o)}var i=r.metadata,l=i.brushCursorUID,c=r.data.handles.points.map((function(e){return n.worldToCanvas(e)})),s=c[0],d=c[1],u=[Math.floor((s[0]+d[0])/2),Math.floor((s[1]+d[1])/2)],v=Math.abs(s[1]-Math.floor((s[1]+d[1])/2)),f="rgb(".concat(i.segmentColor.slice(0,3),")");n.getRenderingEngine()?_c(t,l,"0",u,v,{color:f}):console.warn("Rendering Engine has been destroyed")}}}}]),o}(xa);te(ys,"toolName",void 0),ys.toolName="Brush";var Is=ys;function bs(e){var t=ia(e);if(void 0!==t){var n=t._toolInstances;if(Object.keys(n).length)return Object.values(n).filter((function(e){return e instanceof Is}))}}function Cs(e,t,n,r){for(var o=[],a=0;a<2;a++)for(var i=0;i<2;i++)for(var l=0;l<2;l++){var c=r;c[0]=c[0]+(2*a-1)*n[0]/2,c[1]=c[1]+(2*i-1)*n[1]/2,c[2]=c[2]+(2*l-1)*n[2]/2,o.push(c)}var s=o.map((function(t){return K.utilities.transformWorldToIndex(e,t)}));return Yc(s,t)}function Ts(e,t){for(var n=e.spacing,r=(e.imageData,e.getScalarData()),o=[],a=0,i=0;i<t.length;i++){var l=t[i].volume,c=l.imageData,s=l.spacing,d=l.dimensions,u=t[i].volume.getScalarData().length;u===r.length&&(h=s,p=n,JSON.stringify(h)===JSON.stringify(p))&&(a=i);var v=c.getPointData().getScalars().getData(),f=t[i].lower,g=t[i].upper;o.push({imageData:c,referenceValues:v,lower:f,upper:g,spacing:s,dimensions:d,volumeSize:u})}var h,p;return{volumeInfoList:o,baseVolumeIdx:a}}var _s=function(e,t,n){var r=e.imageData,o=e.getScalarData(),a=n.overwrite,i=n.boundsIJK,l=(null==n?void 0:n.overlapType)||0;if(a)for(var c=0;c<o.length;c++)o[c]=0;var s,d,u,v=Ts(e,t),f=v.baseVolumeIdx,g=v.volumeInfoList,h=function(e,t,n){var r=e.imageData,o=e.dimensions,a=e.lower,i=e.upper,c=Cs(r,o,t,n);d=0,s=0,u={lower:a,upper:i};var v=!1;return Kc(r,(function(){return!0}),(function(e){var t=e.value;d+=1,t>=u.lower&&t<=u.upper&&(s+=1)}),c),0===l?v=s>0:1==l&&(v=s===d),v},p=function(e,t){var n=e.imageData,r=e.referenceValues,o=e.lower,a=e.upper,i=r[n.computeOffsetIndex(t)];return!(i<=o||i>=a)};return Kc(r,(function(){return!0}),(function(e){for(var t=e.index,n=e.pointIJK,r=e.pointLPS,a=g.length>0,i=0;i<g.length&&(a=g[i].volumeSize===o.length?p(g[i],n):h(g[i],g[f].spacing,r));i++);a&&(o[t]=1)}),i),Tt(e.volumeId),e};function Ds(e,t){for(var n=e.length,r=[],o=0;o<n;o++){var a=e[o];a.getFrameOfReferenceUID()===t&&r.push(a)}return r}var Os=qe.Active,Ss=qe.Passive,xs=qe.Enabled;function Ms(e,t){for(var n=e.length,r=[],o=0;o<n;o++){var a=e[o],i=Ur(a.id,a.renderingEngineId);i&&ks(i,t)&&r.push(a)}return r}function ks(e,t){var n=e.toolOptions[t];if(!n)return!1;var r=n.mode;return r===Os||r===Ss||r===xs}var Rs=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.999;return e.filter((function(e){var r=e.getCamera();return Math.abs(dc.vec3.dot(r.viewPlaneNormal,t.viewPlaneNormal))>n}))};function Ps(e,t){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=(0,K.getEnabledElement)(e),o=r.renderingEngine,a=r.FrameOfReferenceUID,i=o.getViewports();i=Ms(i=Ds(i,a),t);var l=o.getViewport(r.viewportId);return n&&(i=Rs(i,l.getCamera())),i.map((function(e){return e.id}))}function Ns(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var As=1-K.CONSTANTS.EPSILON;function Ls(e,t,n){var r=t.viewPlaneNormal,o=e.filter((function(e){var t=e.metadata.viewPlaneNormal;if(!t){var n=e.metadata.referencedImageId,o=K.metaData.get("imagePlaneModule",n).imageOrientationPatient,a=dc.vec3.fromValues(o[0],o[1],o[2]),i=dc.vec3.fromValues(o[3],o[4],o[5]);t=dc.vec3.create(),dc.vec3.cross(t,a,i),e.metadata.viewPlaneNormal=t}var l=Math.abs(dc.vec3.dot(r,t))>As;return t&&l}));if(!o.length)return[];var a,i=n/2,l=t.focalPoint,c=[],s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Ns(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ns(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(s.s();!(a=s.n()).done;){var d=a.value,u=d.data.handles.points[0];if(d.isVisible){var v=dc.vec3.create();dc.vec3.sub(v,l,u);var f=dc.vec3.dot(v,r);Math.abs(f)<i&&c.push(d)}}}catch(e){s.e(e)}finally{s.f()}return c}function Us(e,t){if(e instanceof K.StackViewport){var n=e.getCurrentImageId(),r=n.indexOf(":"),o=n.substring(r+1);return t.filter((function(e){if(!e.isVisible)return!1;var t=e.metadata.referencedImageId;if(void 0===t)return!1;var n=t.indexOf(":");return t.substring(n+1)===o}))}if(e instanceof K.VolumeViewport){var a=e.getCamera();return Ls(t,a,K.utilities.getTargetVolumeAndSpacingInNormalDir(e,a).spacingInNormalDirection)}throw new Error("Viewport Type ".concat(e.type," not supported"))}var Vs=function(e){if(e){if(e.data&&e.highlighted)return El.Highlighted;if(Ie(e.annotationUID))return El.Selected;if(ce(e))return El.Locked}return El.Default};var Bs=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e;ee(this,o);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return te(la(e=r.call.apply(r,[this].concat(n))),"onImageSpacingCalibrated",(function(t){var n=t.detail,r=n.element,o=n.imageId,a=K.utilities.imageIdToURI(o),i=Je();i.getFramesOfReference().forEach((function(t){var n=i.getAnnotations(t)[e.getToolName()];n&&n.length&&(n.forEach((function(e){K.utilities.imageIdToURI(e.metadata.referencedImageId)===a&&(e.invalidated=!0,e.data.cachedStats={})})),qr(r))}))})),e}return Q(o,[{key:"filterInteractableAnnotationsForElement",value:function(e,t){if(t&&t.length)return Us((0,K.getEnabledElement)(e).viewport,t)}},{key:"getReferencedImageId",value:function(e,t,n,r){var o,a=this.getTargetId(e);if(e instanceof K.StackViewport)o=a.split("imageId:")[1];else{var i=a.split("volumeId:")[1],l=K.cache.getVolume(i);o=K.utilities.getClosestImageId(l,t,n)}return o}},{key:"getStyle",value:function(e,t,n){return Al(e,t,Vs(n),this.mode)}}]),o}(xa);te(Bs,"toolName",void 0),Bs.toolName="AnnotationDisplayTool";var js=Bs;function Hs(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Ws=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e;ee(this,o);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return te(la(e=r.call.apply(r,[this].concat(n))),"mouseMoveCallback",(function(t,n){if(!n)return!1;var r,o=t.detail,a=o.element,i=o.currentPoints.canvas,l=!1,c=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Hs(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Hs(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(n);try{for(c.s();!(r=c.n()).done;){var s=r.value;if(!ce(s)&&xe(s.annotationUID)){var d=s.data,u=d.handles?d.handles.activeHandleIndex:void 0,v=e._imagePointNearToolOrHandle(a,s,i,6),f=v&&!s.highlighted,g=!v&&s.highlighted;f||g?(s.highlighted=!s.highlighted,l=!0):d.handles&&d.handles.activeHandleIndex!==u&&(l=!0)}}}catch(e){c.e(e)}finally{c.f()}return l})),e}return Q(o,[{key:"getHandleNearImagePoint",value:function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=t.data,i=a.handles,l=i.points,c=i.textBox,s=c.worldBoundingBox;if(s){var d={topLeft:o.worldToCanvas(s.topLeft),topRight:o.worldToCanvas(s.topRight),bottomLeft:o.worldToCanvas(s.bottomLeft),bottomRight:o.worldToCanvas(s.bottomRight)};if(n[0]>=d.topLeft[0]&&n[0]<=d.bottomRight[0]&&n[1]>=d.topLeft[1]&&n[1]<=d.bottomRight[1])return a.handles.activeHandleIndex=null,c}for(var u=0;u<l.length;u++){var v=l[u],f=o.worldToCanvas(v);if(!0==dc.vec2.distance(n,f)<r)return a.handles.activeHandleIndex=u,v}a.handles.activeHandleIndex=null}},{key:"getLinkedTextBoxStyle",value:function(e,t){return{fontFamily:this.getStyle("textBoxFontFamily",e,t),fontSize:this.getStyle("textBoxFontSize",e,t),color:this.getStyle("textBoxColor",e,t),shadow:this.getStyle("textBoxShadow",e,t),background:this.getStyle("textBoxBackground",e,t),lineWidth:this.getStyle("textBoxLinkLineWidth",e,t),lineDash:this.getStyle("textBoxLinkLineDash",e,t)}}},{key:"isSuvScaled",value:function(e,t,n){if(e instanceof K.BaseVolumeViewport){var r,o=t.split("volumeId:")[1];return void 0!==(null===(r=K.cache.getVolume(o).scaling)||void 0===r?void 0:r.PT)}if(e instanceof K.StackViewport){var a=n&&K.metaData.get("scalingModule",n);return"number"==typeof(null==a?void 0:a.suvbw)}throw new Error("Viewport is not a valid type")}},{key:"_imagePointNearToolOrHandle",value:function(e,t,n,r){return!!this.getHandleNearImagePoint(e,t,n,r)||!!this.isPointNearTool(e,t,n,r,"mouse")||void 0}}]),o}(js);te(Ws,"toolName",void 0),Ws.toolName="AnnotationTool";var Fs=Ws,Gs=K.Enums.CalibrationTypes,qs="px",zs=function(e,t){var n=t.calibration,r=t.hasPixelSpacing?"mm":qs;return n&&n.type?n.type===Gs.UNCALIBRATED?qs:n.SequenceOfUltrasoundRegions?"US Region":"".concat(r," ").concat(n.type):r},Ks=function(e,t){var n=t.calibration,r=(t.hasPixelSpacing?"mm":qs)+"";return n&&n.type?n.SequenceOfUltrasoundRegions?"US Region":"".concat(r," ").concat(n.type):r},Ys=function(e){var t;return(null===(t=e.calibration)||void 0===t?void 0:t.scale)||1};function Js(e,t){return(e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])}function $s(e,t,n){var r=Js(e,t);if(0===r)return Js(n,e);var o=((n[0]-e[0])*(t[0]-e[0])+(n[1]-e[1])*(t[1]-e[1]))/r;return Js(n,o<0?e:o>1?t:[e[0]+o*(t[0]-e[0]),e[1]+o*(t[1]-e[1])])}function Zs(e,t,n){if(2!==e.length||2!==t.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt($s(e,t,n))}function Xs(e,t){if(4!==e.length||2!==t.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");var n=it(e,4),r=n[0],o=n[1],a=n[2],i=n[3],l=655535,c=function(e,t,n,r){return{top:[[e,t],[e+n,t]],right:[[e+n,t],[e+n,t+r]],bottom:[[e+n,t+r],[e,t+r]],left:[[e,t+r],[e,t]]}}(r,o,a,i);return Object.keys(c).forEach((function(e){var n=it(c[e],2),r=Zs(n[0],n[1],t);r<l&&(l=r)})),l}function Qs(e){var t,n,r,o,a=(n=[(t=e)[0],t[1]].sort((function(e,t){return e[0]<t[0]?-1:1})),r=[t[0],t[1]].sort((function(e,t){return e[1]<t[1]?-1:1})),o=n[n.length-1],{top:r[0],bottom:r[r.length-1],right:o}),i=(a.top[1]+a.bottom[1])/2;return[a.right[0],i]}function ed(e,t,n,r){var o=dc.vec3.create();dc.vec3.cross(o,t,e);var a=dc.vec3.fromValues.apply(dc.vec3,kr(n)),i=dc.vec3.fromValues.apply(dc.vec3,kr(r)),l=dc.vec3.create();dc.vec3.subtract(l,a,i);var c=dc.vec3.length(l);if(c<1e-4)return{worldWidth:0,worldHeight:0};var s=dc.vec3.dot(l,o)/(c*dc.vec3.length(o));return{worldWidth:Math.sqrt(1-s*s)*c,worldHeight:s*c}}function td(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";var n=K.metaData.get("petSeriesModule",e);return(null==n?void 0:n.units)||"unitless"}(t,n):""}function nd(e,t){if(e instanceof K.BaseVolumeViewport){var n=t.split("volumeId:")[1],r=K.cache.getVolume(n);return!(null==r||!r.scaling)&&Object.keys(r.scaling).length>0}if(e instanceof K.StackViewport){var o=(e.getImageData()||{}).preScale;return!(null==o||!o.scaled)}throw new Error("Viewport is not a valid type")}var rd=K.utilities.transformWorldToIndex,od=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{points:[kr(a),kr(a),kr(a),kr(a)],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},cachedStats:{}}};Qe(g,o);var h=Ps(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(c,h),g})),te(la(e),"isPointNearTool",(function(t,n,r,o){var a=(0,K.getEnabledElement)(t).viewport,i=n.data.handles.points,l=a.worldToCanvas(i[0]),c=a.worldToCanvas(i[3]),s=e._getRectangleImageCoordinates([l,c]),d=[r[0],r[1]];return Xs([s.left,s.top,s.width,s.height],d)<=o})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),Kl(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),t.preventDefault()})),te(la(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l=!1;r.worldPosition?l=!0:i=a.handles.points.findIndex((function(e){return e===r}));var c=Ps(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:c,handleIndex:i,movingTextBox:l},e._activateModify(o),Kl(o);var s=(0,K.getEnabledElement)(o).renderingEngine;na(s,c),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}}})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g,h,p,m,w,E,y,I,b=n.currentPoints,C=(0,K.getEnabledElement)(r).viewport,T=C.worldToCanvas,_=C.canvasToWorld,D=b.world,O=s.handles.points;switch(O[l]=kr(D),l){case 0:case 3:g=T(O[0]),h=[(m=T(O[3]))[0],g[1]],p=[g[0],m[1]],E=_(h),y=_(p),O[1]=E,O[2]=y;break;case 1:case 2:h=T(O[1]),g=[(p=T(O[2]))[0],h[1]],m=[h[0],p[1]],w=_(g),I=_(m),O[0]=w,O[3]=I}a.invalidated=!0}e.editData.hasMoved=!0;var S=(0,K.getEnabledElement)(r).renderingEngine;na(S,i)})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_MOVE,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=c[f],o=r.annotationUID,l=r.data,v=l.handles,g=v.points,h=v.activeHandleIndex,p=g.map((function(e){return i.worldToCanvas(e)}));u.annotationUID=o;var m,w=e.getStyle("lineWidth",u,r),E=e.getStyle("lineDash",u,r),y=e.getStyle("color",u,r),I=i.getCamera(),b=I.viewPlaneNormal,C=I.viewUp,T={isPreScaled:nd(i,s),isSuvScaled:e.isSuvScaled(i,s,r.metadata.referencedImageId)};if(l.cachedStats[s]&&void 0!==l.cachedStats[s].areaUnit){if(r.invalidated&&(e._throttledCalculateCachedStats(r,b,C,d,t,T),i instanceof K.VolumeViewport)){var _=r.metadata.referencedImageId;for(var D in l.cachedStats)D.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=K.utilities.imageIdToURI(_),n=e.hasImageURI(t),r=K.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[D]}}else l.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},e._calculateCachedStats(r,b,C,d,t,T);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};if(!xe(o))return"continue";ce(r)||e.editData||null===h||(m=[p[h]]),m&&Oc(n,o,"0",m,{color:y});var O="".concat(o,"-rect");Lc(n,o,"0",p[0],p[3],{color:y,lineDash:E,lineWidth:w},O),a=!0;var S=e._getTextLines(l,s);if(!S||0===S.length)return"continue";if(!l.handles.textBox.hasMoved){var x=Qs(p);l.handles.textBox.worldPosition=i.canvasToWorld(x)}var M=i.worldToCanvas(l.handles.textBox.worldPosition),k=Ac(n,o,"1",S,M,p,{},e.getLinkedTextBoxStyle(u,r)),R=k.x,P=k.y,N=k.width,A=k.height;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([R,P]),topRight:i.canvasToWorld([R+N,P]),bottomLeft:i.canvasToWorld([R,P+A]),bottomRight:i.canvasToWorld([R+N,P+A])}},f=0;f<c.length;f++){var g=v();if("continue"!==g&&"object"===$(g))return g.v}return a})),te(la(e),"_getRectangleImageCoordinates",(function(e){var t=it(e,2),n=t[0],r=t[1];return{left:Math.min(n[0],r[0]),top:Math.min(n[1],r[1]),width:Math.abs(n[0]-r[0]),height:Math.abs(n[1]-r[1])}})),te(la(e),"_getTextLines",(function(e,t){var n=e.cachedStats[t],r=n.area,o=n.mean,a=n.max,i=n.stdDev,l=n.areaUnit,c=n.modalityUnit;if(void 0!==o){var s=[];return s.push("Area: ".concat(Zc(r)," ").concat(l)),s.push("Mean: ".concat(Zc(o)," ").concat(c)),s.push("Max: ".concat(Zc(a)," ").concat(c)),s.push("Std Dev: ".concat(Zc(i)," ").concat(c)),s}})),te(la(e),"_calculateCachedStats",(function(t,n,r,o,a,i){for(var l=t.data,c=a.viewportId,s=a.renderingEngineId,d=l.handles.points[0],u=l.handles.points[3],v=l.cachedStats,f=Object.keys(v),g=0;g<f.length;g++){var h=f[g],p=e.getTargetIdImage(h,o);if(p){var m=p.dimensions,w=p.imageData,E=p.metadata,y="getScalarData"in p?p.getScalarData():p.scalarData,I=rd(w,d);I[0]=Math.floor(I[0]),I[1]=Math.floor(I[1]),I[2]=Math.floor(I[2]);var b=rd(w,u);if(b[0]=Math.floor(b[0]),b[1]=Math.floor(b[1]),b[2]=Math.floor(b[2]),e._isInsideVolume(I,b,m)){e.isHandleOutsideImage=!1;for(var C=Math.min(I[0],b[0]),T=Math.max(I[0],b[0]),_=Math.min(I[1],b[1]),D=Math.max(I[1],b[1]),O=Math.min(I[2],b[2]),S=Math.max(I[2],b[2]),x=ed(n,r,d,u),M=x.worldWidth,k=x.worldHeight,R=Ys(p),P=Math.abs(M*k)/(R*R),N=0,A=0,L=0,U=-1/0,V=m[0],B=m[0]*m[1],j=O;j<=S;j++)for(var H=_;H<=D;H++)for(var W=C;W<=T;W++){var F=y[j*B+H*V+W];F>U&&(U=F),N++,A+=F}A/=N;for(var G=O;G<=S;G++)for(var q=_;q<=D;q++)for(var z=C;z<=T;z++){var Y=y[G*B+q*V+z]-A;L+=Y*Y}L/=N,L=Math.sqrt(L);var $=td(E.Modality,t.metadata.referencedImageId,i);v[h]={Modality:E.Modality,area:P,mean:A,stdDev:L,max:U,areaUnit:Ks(0,p),modalityUnit:$}}else e.isHandleOutsideImage=!0,v[h]={Modality:E.Modality}}}t.invalidated=!1;var Z=J.ANNOTATION_MODIFIED,X={annotation:t,viewportId:c,renderingEngineId:s};return(0,K.triggerEvent)(K.eventTarget,Z,X),v})),te(la(e),"_isInsideVolume",(function(e,t,n){return K.utilities.indexWithinDimensions(e,n)&&K.utilities.indexWithinDimensions(t,n)})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o)}(Fs);te(od,"toolName",void 0),od.toolName="RectangleROI";var ad=od;var id=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s,d,u=l.getCamera(),v=u.viewPlaneNormal,f=u.viewUp,g=e.getTargetId(l);if(l instanceof K.StackViewport)s=g.split("imageId:")[1];else{d=g.split("volumeId:")[1];var h=K.cache.getVolume(d);s=K.utilities.getClosestImageId(h,a,v)}var p=l.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:kr(v),enabledElement:i,viewUp:kr(f),FrameOfReferenceUID:p,referencedImageId:s,toolName:e.getToolName(),volumeId:d},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[kr(a),kr(a),kr(a),kr(a)],activeHandleIndex:null},segmentationId:null}};Qe(m,o);var w=Ps(o,e.getToolName());return e.editData={annotation:m,viewportIdsToRender:w,handleIndex:3,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(c,w),m})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=t.renderingEngineId,c=i.element,s=Xe(e.getToolName(),c);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(c,s))||void 0===o||!o.length)return a;for(var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=0;u<s.length;u++){var v=s[u],f=v.annotationUID,g=v.data.handles,h=g.points,p=g.activeHandleIndex,m=h.map((function(e){return i.worldToCanvas(e)}));d.annotationUID=f;var w=e.getStyle("lineWidth",d,v),E=e.getStyle("lineDash",d,v),y=e.getStyle("color",d,v);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;var I=J.ANNOTATION_MODIFIED,b={annotation:v,viewportId:i.id,renderingEngineId:l};(0,K.triggerEvent)(K.eventTarget,I,b);var C=void 0;xe(f)&&(ce(v)||e.editData||null===p||(C=[m[p]]),C&&Oc(n,f,"0",C,{color:y}),Lc(n,f,"0",m[0],m[3],{color:y,lineDash:E,lineWidth:w}),a=!0)}return a})),e}return Q(o)}(ad);te(id,"toolName",void 0),id.toolName="RectangleROIThreshold";var ld=id;var cd=K.utilities.transformWorldToIndex,sd=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{numSlicesToPropagate:10}};return ee(this,o),te(la(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s,d,u,v=l.getCamera(),f=v.viewPlaneNormal,g=v.viewUp;if(l instanceof K.StackViewport)throw new Error("Stack Viewport Not implemented");if(u=e.getTargetId(l).split("volumeId:")[1],d=K.cache.getVolume(u),!(s=K.utilities.getClosestImageId(d,a,f)))throw new Error("This tool does not work on non-acquisition planes");var h=l.getCurrentImageIdIndex(),p=K.utilities.getSpacingInNormalDirection(d,f),m=e._getEndSliceIndex(d,a,p,f),w=l.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:kr(f),enabledElement:i,viewUp:kr(g),FrameOfReferenceUID:w,referencedImageId:s,toolName:e.getToolName(),volumeId:u,spacingInNormal:p},data:{label:"",startSlice:h,endSlice:m,cachedStats:{projectionPoints:[],projectionPointsImageIds:[s]},handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[kr(a),kr(a),kr(a),kr(a)],activeHandleIndex:null},labelmapUID:null}};e._computeProjectionPoints(E,d),Qe(E,o);var y=Ps(o,e.getToolName());return e.editData={annotation:E,viewportIdsToRender:y,handleIndex:3,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(c,y),E})),te(la(e),"renderAnnotation",(function(t,n){var r=!1,o=t.viewport,a=Xe(e.getToolName(),o.element);if(null==a||!a.length)return r;for(var i=o.getCurrentImageIdIndex(),l={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},c=0;c<a.length;c++){var s=a[c],d=s.annotationUID,u=s.data,v=u.startSlice,f=u.endSlice,g=u.handles,h=g.points,p=g.activeHandleIndex,m=h.map((function(e){return o.worldToCanvas(e)}));l.annotationUID=d;var w=e.getStyle("lineWidth",l,s),E=e.getStyle("lineDash",l,s),y=e.getStyle("color",l,s);if(!(i<Math.min(v,f)||i>Math.max(v,f))){s.invalidated&&e._throttledCalculateCachedStats(s,t);var I=!1;if(i!==v&&i!==f||(I=!0),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),r;var b=void 0;if(xe(d)){ce(s)||e.editData||null===p||!I||(b=[m[p]]),b&&Oc(n,d,"0",b,{color:y});var C=E;I||(C=2),Lc(n,d,"0",m[0],m[3],{color:y,lineDash:C,lineWidth:w}),r=!0}}}return r})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStatsTool,100,{trailing:!0}),e}return Q(o,[{key:"_computeProjectionPoints",value:function(e,t){var n=e.data,r=e.metadata,o=r.viewPlaneNormal,a=r.spacingInNormal,i=t.imageData,l=n.startSlice,c=n.endSlice,s=n.handles.points,d=cd(i,s[0]);if(d[2]!==l)throw new Error("Start slice does not match");var u=dc.vec3.fromValues(d[0],d[1],c),v=dc.vec3.create();i.indexToWorldVec3(d,v);var f=dc.vec3.create();i.indexToWorldVec3(u,f);for(var g=dc.vec3.distance(v,f),h=[],p=function(e){h.push(s.map((function(t){var n=dc.vec3.create();return dc.vec3.scaleAndAdd(n,t,o,e),Array.from(n)})))},m=0;m<g;m+=a)p(m);n.cachedStats.projectionPoints=h;for(var w=[],E=0,y=h;E<y.length;E++){var I=y[E],b=K.utilities.getClosestImageId(t,I[0],o);w.push(b)}n.cachedStats.projectionPointsImageIds=w}},{key:"_calculateCachedStatsTool",value:function(e,t){var n=e.data,r=t.viewportId,o=t.renderingEngineId,a=t.viewport,i=n.cachedStats,l=this.getTargetId(a),c=K.cache.getVolume(l.split("volumeId:")[1]);this._computeProjectionPoints(e,c),e.invalidated=!1;var s=J.ANNOTATION_MODIFIED,d={annotation:e,viewportId:r,renderingEngineId:o};return(0,K.triggerEvent)(K.eventTarget,s,d),i}},{key:"_getEndSliceIndex",value:function(e,t,n,r){var o=this.configuration.numSlicesToPropagate,a=dc.vec3.create();dc.vec3.scaleAndAdd(a,t,r,o*n);for(var i,l=n/2,c=e.imageIds,s=0;s<c.length;s++){var d=c[s],u=K.metaData.get("imagePlaneModule",d).imagePositionPatient,v=dc.vec3.create();dc.vec3.sub(v,a,u);var f=dc.vec3.dot(v,r);Math.abs(f)<l&&(i=s)}return i}}]),o}(ad);te(sd,"toolName",void 0),sd.toolName="RectangleROIStartEndThreshold";var dd=sd,ud=function(e,t){var n=e.findIndex((function(e){var t=it(e,2);return t[0]===t[1]}));if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e},vd=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=[];return e.forEach((function(e){var o,a,i=e.data,l=i.handles.points,c=t.imageData,s=t.dimensions,d=l;if(null!==(o=i.cachedStats)&&void 0!==o&&o.projectionPoints){var u,v=i.cachedStats.projectionPoints;d=(u=[]).concat.apply(u,kr(v))}var f=d.map((function(e){return K.utilities.transformWorldToIndex(c,e)})),g=Yc(f,s);!n.numSlicesToProject||null!==(a=i.cachedStats)&&void 0!==a&&a.projectionPoints||(g=ud(g,n.numSlicesToProject)),r.push(g)})),1===r.length?r[0]:r.reduce((function(e,t){return{iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)}}),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})};function fd(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function gd(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function hd(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?gd(Object(n),!0).forEach((function(t){te(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gd(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var pd=function(e,t,n,r){var o,a=e.map((function(e){return nt(e)}));!function(e){var t,n=[ld.toolName,dd.toolName],r=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return fd(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?fd(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(e);try{for(r.s();!(t=r.n()).done;){var o=t.value.metadata.toolName;if(!n.includes(o))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}catch(e){r.e(e)}finally{r.f()}}(a);for(var i=0;i<n.length;i++)n[i].volume.getScalarData().length!==t.getScalarData().length&&0!==i||(o=vd(a,n[i].volume,r));return _s(t,n,hd(hd({},r),{},{boundsIJK:o}))},md=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"mergedLabelmap";e.forEach((function(t){var n=t.direction,r=t.dimensions,o=t.origin,a=t.spacing;if(!(K.utilities.isEqual(r,e[0].dimensions)&&K.utilities.isEqual(n,e[0].direction)&&K.utilities.isEqual(a,e[0].spacing)&&K.utilities.isEqual(o,e[0].origin)))throw new Error("labelmaps must have the same size and shape")}));var r=e[0],o=new(0,r.getScalarData().constructor)(r.getScalarData().length);e.forEach((function(e){for(var n=e.getScalarData(),r=0;r<n.length;r++)n[r]===t&&(o[r]=t)}));var a={scalarData:o,metadata:r.metadata,spacing:r.spacing,origin:r.origin,direction:r.direction,dimensions:r.dimensions};return K.volumeLoader.createLocalVolume(a,n,!0)};function wd(e,t){if(e===dt.Labelmap)return function(e){return e&&"boolean"==typeof e.renderOutline&&"number"==typeof e.outlineWidthActive&&"number"==typeof e.outlineWidthInactive&&"boolean"==typeof e.renderFill&&"boolean"==typeof e.renderFillInactive&&"number"==typeof e.fillAlpha&&"number"==typeof e.fillAlphaInactive&&"number"==typeof e.outlineOpacity&&"number"==typeof e.outlineOpacityInactive}(t);throw new Error("Unknown representation type: ".concat(e))}function Ed(e){var t=e.type;if(t===dt.Labelmap)return ft();throw new Error("Unknown representation type: ".concat(t))}function yd(e){return Id.apply(this,arguments)}function Id(){return(Id=ka(Pa().mark((function e(t){var n,r,o,a,i,l,c,s,d,u,v,f;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.viewportId,r=t.renderingEngineId,o=t.options,a=t.segmentationId,i=(0,K.getEnabledElementByIds)(n,r)){e.next=5;break}throw new Error("element disabled");case 5:if((l=i.viewport)instanceof K.VolumeViewport){e.next=8;break}throw new Error("Segmentation only supports VolumeViewport");case 8:if(c=l.getDefaultActor(),s=c.uid,void 0===a&&(a="".concat(s,"-based-segmentation-").concat(null!==(d=null==o?void 0:o.volumeId)&&void 0!==d?d:K.utilities.uuidv4().slice(0,8))),!o){e.next=16;break}return u=(0,ne._cloneDeep)(o),e.next=14,K.volumeLoader.createLocalVolume(u,a);case 14:e.next=19;break;case 16:return v=l.getDefaultActor(),f=v.uid,e.next=19,K.volumeLoader.createAndCacheDerivedVolume(f,{volumeId:a});case 19:return e.abrupt("return",a);case 20:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function bd(e,t){return e===t}function Cd(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}var Td=function(e,t){var n,r,o,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=a.onFlood,l=a.onBoundary,c=a.equals||bd,s=a.diagonals||!1,d=p(t),u=function(e){for(var t=[],n=function(e){return e.split("").map((function(e){return parseInt(e,10)-1}))},r=0;r<Math.pow(3,e);r+=1){var o=Cd(r.toString(3),"0",e);t.push(n(o))}return t}(t.length).filter((function(e){var t=function(e){for(var t=0,n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||s)})),v=[],f=[],g={},h={};for(v.push({currentArgs:t});v.length>0;)n=v.pop(),r=void 0,o=void 0,r=n.currentArgs,o=n.previousArgs,!0!==g[r]&&(g[r]=!0,function(e){var t=m(p,[e]);return m(c,[t,d])}(r)?(function(e){f.push(e),i&&i.apply(void 0,kr(e))}(r),function(e){for(var t=0;t<u.length;t+=1){for(var n=u[t],r=e.slice(0),o=0;o<e.length;o+=1)r[o]+=n[o];v.push({currentArgs:r,previousArgs:e})}}(r)):function(e){h[e]=e,l&&l.apply(void 0,kr(e))}(o));return{flooded:f,boundaries:function(){var e=[];for(var t in h)void 0!==h[t]&&e.unshift(h[t]);return e}()};function p(t){return e.apply(void 0,kr(t))}function m(e,t){try{return e.apply(void 0,kr(t))}catch(e){return}}};function _d(e,t){var n=ia(e);if(void 0!==n){bs(e).forEach((function(e){e.configuration.brushSize=t,e.invalidateBrushCursor()}));var r=n.getViewportsInfo(),o=Object.keys(r).map((function(e){return r[e]}));if(o.length){var a=o[0].renderingEngineId,i=n.getViewportIds(),l=(0,K.getRenderingEngine)(a);na(l,i)}}}function Dd(e){var t=ia(e);if(void 0!==t){var n=t._toolInstances;if(Object.keys(n).length){var r=bs(e)[0];if(r)return r.configuration.brushSize}}}function Od(e,t){var n=ia(e);if(void 0!==n){bs(e).forEach((function(e){e.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold=t}));var r=n.getViewportsInfo();if(r.length){var o=r[0].renderingEngineId,a=n.getViewportIds(),i=(0,K.getRenderingEngine)(o);na(i,a)}}}function Sd(e){var t=ia(e);if(void 0!==t){var n=t._toolInstances;if(Object.keys(n).length){var r=bs(e)[0];if(r)return r.configuration.strategySpecificConfiguration.THRESHOLD_INSIDE_CIRCLE.threshold}}}var xd=function(e,t,n,r){var o=e.getScalarData(),a=Ts(e,n),i=a.baseVolumeIdx,l=a.volumeInfoList;return l.forEach((function(e){e.volumeSize===o.length?function(e,t,n){for(var r=n.referenceValues,o=n.lower,a=n.upper,i=0;i<e.length;i++)if(e[i]===t){var l=r[i];e[i]=l>=o&&l<=a?t:0}}(o,t,e):function(e,t,n,r,o,a){for(var i,l,c,s=n.imageData,d=n.lower,u=n.upper,v=n.dimensions,f=0;f<e.length;f++)if(e[f]===t){var g=Cs(s,v,r[o].spacing,r[o].imageData.getPoint(f));i=0,l=0,c={lower:d,upper:u};var h;Kc(s,(function(){return!0}),(function(e){var t=e.value;i+=1,t>=c.lower&&t<=c.upper&&(l+=1)}),g),h=0===a?l>0:l===i,e[f]=h?t:0}}(o,t,e,l,i,r)})),Tt(e.volumeId),e},Md=1e-6,kd=1,Rd=0;function Pd(e,t,n){var r=it(n,2),o=r[0],a=r[1];if(Math.abs(t)<Md)return e<0;var i=e/t;if(t>0){if(i>a)return 0;i>o&&(n[0]=i)}else{if(i<o)return 0;i<a&&(n[1]=i)}return 1}function Nd(e,t,n,r,o){var a=it(e,2),i=a[0],l=a[1],c=it(t,2),s=c[0]-i,d=c[1]-l;if(void 0===r||void 0===o?(r=e,o=t):(r[0]=e[0],r[1]=e[1],o[0]=t[0],o[1]=t[1]),Math.abs(s)<Md&&Math.abs(d)<Md&&i>=n[0]&&i<=n[2]&&l>=n[1]&&l<=n[3])return kd;var u=[0,1];if(Pd(n[0]-i,s,u)&&Pd(i-n[2],-s,u)&&Pd(n[1]-l,d,u)&&Pd(l-n[3],-d,u)){var v=u[0],f=u[1];return f<1&&(o[0]=i+f*s,o[1]=l+f*d),v>0&&(r[0]+=v*s,r[1]+=v*d),kd}return Rd}function Ad(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}function Ld(e,t,n,r){var o=it(e,2),a=o[0],i=o[1],l=it(t,2),c=l[0],s=l[1],d=it(n,2),u=d[0],v=d[1],f=it(r,2),g=f[0],h=f[1],p=s-i,m=a-c,w=c*i-a*s,E=p*u+m*v+w,y=p*g+m*h+w;if(0===E||0===y||Ad(E)!==Ad(y)){var I=h-v,b=u-g,C=g*v-u*h,T=I*a+b*i+C,_=I*c+b*s+C;if(0===T||0===_||Ad(T)!==Ad(_)){var D=p*b-I*m;return[(m*C-b*w)/D,(I*w-p*C)/D]}}}function Ud(e,t,n){var r,o;arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,r=1):(o=e.length-1,r=0);for(var a=r;a<e.length;a++){if(Bd(t,n,e[o],e[a]))return[o,a];o=a}}function Vd(e,t,n){var r,o;arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,r=1):(o=e.length-1,r=0);for(var a=[],i=r;i<e.length;i++){var l=e[o],c=e[i];Bd(t,n,l,c)&&a.push([o,i]),o=i}if(0!==a.length){var s=[];a.forEach((function(n){var r=[e[n[0]],e[n[1]]],o=[(r[0][0]+r[1][0])/2,(r[0][1]+r[1][1])/2];s.push(dc.vec2.distance(o,t))}));var d=Math.min.apply(Math,s);return{segment:a[s.indexOf(d)],distance:d}}}function Bd(e,t,n,r){var o=!1,a=[jd(e,t,n),jd(e,t,r),jd(n,r,e),jd(n,r,t)];return a[0]!==a[1]&&a[2]!==a[3]||((0===a[0]&&Hd(e,n,t)||0===a[1]&&Hd(e,r,t)||0===a[2]&&Hd(n,e,r)||0===a[3]&&Hd(n,t,r))&&(o=!0),o)}function jd(e,t,n){var r=(t[1]-e[1])*(n[0]-t[0])-(t[0]-e[0])*(n[1]-t[1]);return 0===r?0:r>0?1:2}function Hd(e,t,n){return t[0]<=Math.max(e[0],n[0])&&t[0]>=Math.min(e[0],n[0])&&t[1]<=Math.max(e[1],n[1])&&t[1]>=Math.min(e[1],n[1])}function Wd(e,t,n,r){var o=(r[1]-n[1])*(t[0]-e[0])-(r[0]-n[0])*(t[1]-e[1]);if(0!=o){var a=e[1]-n[1],i=e[0]-n[0],l=(r[0]-n[0])*a-(r[1]-n[1])*i,c=(t[0]-e[0])*a-(t[1]-e[1])*i;return a=l/o,i=c/o,[e[0]+a*(t[0]-e[0]),e[1]+a*(t[1]-e[1])]}}var Fd=.001,Gd=function(e,t){var n,r,o;if(e instanceof K.StackViewport){var a=e.getImageData();r=a.direction.slice(0,3),o=a.direction.slice(3,6),n=a.spacing}else{var i=e.getImageData(),l=i.direction,c=i.spacing,s=e.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=l.slice(0,3),f=l.slice(3,6),g=l.slice(6,9),h=dc.vec3.create();dc.vec3.cross(h,u,d);var p,m=Math.abs(dc.vec3.dot(h,v)),w=Math.abs(dc.vec3.dot(h,f)),E=Math.abs(dc.vec3.dot(h,g));if(Math.abs(1-m)<Fd)p=c[0],r=v;else if(Math.abs(1-w)<Fd)p=c[1],r=f;else{if(!(Math.abs(1-E)<Fd))throw new Error("No support yet for oblique plane planar contours");p=c[2],r=g}var y,I=Math.abs(dc.vec3.dot(u,v)),b=Math.abs(dc.vec3.dot(u,f)),C=Math.abs(dc.vec3.dot(u,g));if(Math.abs(1-I)<Fd)y=c[0],o=v;else if(Math.abs(1-b)<Fd)y=c[1],o=f;else{if(!(Math.abs(1-C)<Fd))throw new Error("No support yet for oblique plane planar contours");y=c[2],o=g}n=[p,y]}return{spacing:[n[0]/t,n[1]/t],xDir:r,yDir:o}},qd=function(e,t,n){return dc.vec2.dist(e,t)<n},zd=function(e,t,n,r){var o=r.xDir,a=r.yDir,i=r.spacing,l=(0,K.getEnabledElement)(e).viewport,c=l.canvasToWorld(t[t.length-1]),s=l.canvasToWorld(n),d=dc.vec3.create();dc.vec3.subtract(d,s,c);var u=Math.abs(dc.vec3.dot(d,o)),v=Math.abs(dc.vec3.dot(d,a)),f=Math.max(Math.floor(u/i[0]),Math.floor(v/i[0]));if(f>1){var g=t[t.length-1],h=dc.vec2.dist(g,n),p=dc.vec2.create();dc.vec2.subtract(p,n,g),dc.vec2.set(p,p[0]/h,p[1]/h);for(var m=h/f,w=1;w<=f;w++)t.push([g[0]+m*p[0]*w,g[1]+m*p[1]*w])}else t.push(n);return f},Kd=function(e,t,n,r){var o=[e[0]-t[0],e[1]-t[1]],a=[n[0]-t[0],n[1]-t[1]],i=o[0]*a[0]+o[1]*a[1];if(i<0)return!1;var l=Math.sqrt(a[0]*a[0]+a[1]*a[1]);if(0===l)return!1;var c=i/l,s=[a[0]/l,a[1]/l],d=[s[0]*c,s[1]*c],u=[t[0]+d[0],t[1]+d[1]];return!(dc.vec2.distance(e,u)>r||dc.vec2.distance(t,u)>dc.vec2.distance(t,n))};function Yd(e){for(var t=e.length,n=0,r=t-1,o=0;o<t;o++)n+=(e[r][0]+e[o][0])*(e[r][1]-e[o][1]),r=o;return Math.abs(n/2)}function Jd(e,t){if(2!==(null==e?void 0:e.length)||2!==(null==t?void 0:t.length))throw Error("points should have 2 elements of [x, y]");var n=it(e,2),r=n[0],o=n[1],a=it(t,2),i=a[0],l=a[1];return Math.sqrt(Math.pow(r-i,2)+Math.pow(o-l,2))}var $d=h(807),Zd=h.n($d);function Xd(e,t,n,r){var o,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.25,i=e.getCamera(),l=i.position,c=K.utilities.getTargetVolumeAndSpacingInNormalDir(e,i,n).spacingInNormalDirection*a,s=e.getBounds(),d=s[0],u=s[1],v=[0,0,0],f=[0,0,0];Zd().subtract(t,l,v);for(var g=d;g<=u;g+=c){f=[g,0,0];var h=(g-l[0])/v[0];if(f[1]=h*v[1]+l[1],f[2]=h*v[2]+l[2],Qd(f,s)){var p=r(e.getIntensityFromWorld(f),f);p&&(o=p)}}return o}var Qd=function(e,t){var n=it(t,6),r=n[0],o=n[1],a=n[2],i=n[3],l=n[4],c=n[5];return e[0]>r&&e[0]<o&&e[1]>a&&e[1]<i&&e[2]>l&&e[2]<c},eu={filterAnnotationsWithinSlice:Ls,getWorldWidthAndHeightFromCorners:ed,filterAnnotationsForDisplay:Us,getPointInLineOfSightWithCriteria:Xd};function tu(e){for(var t="",n=e[0]<0?"R":"L",r=e[1]<0?"A":"P",o=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],i=1e-4,l=0;l<3;l++)if(a[0]>i&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>i&&a[1]>a[0]&&a[1]>a[2])t+=r,a[1]=0;else if(a[2]>i&&a[2]>a[0]&&a[2]>a[1])t+=o,a[2]=0;else if(a[0]>i&&a[1]>i&&a[0]===a[1])t+=n+r,a[0]=0,a[1]=0;else if(a[0]>i&&a[2]>i&&a[0]===a[2])t+=n+o,a[0]=0,a[2]=0;else{if(!(a[1]>i&&a[2]>i&&a[1]===a[2]))break;t+=r+o,a[1]=0,a[2]=0}return t}function nu(e){var t=e.replace("H","f");return(t=(t=(t=(t=(t=t.replace("F","h")).replace("R","l")).replace("L","r")).replace("A","p")).replace("P","a")).toUpperCase()}var ru=function(e){return e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED",e}(ru||{}),ou=ru,au={};function iu(e,t){var n=(0,K.getEnabledElement)(e).viewportId;au[n]=t}function lu(e){var t=(0,K.getEnabledElement)(e).viewportId;return au[t]}var cu=K.utilities.triggerEvent,su=!0,du=!0,uu=new Map;function vu(e,t){var n,r,o;if(void 0===e)throw new Error("playClip: element must not be undefined");var a=(0,K.getEnabledElement)(e);if(!a)throw new Error("playClip: element must be a valid Cornerstone enabled element");t.dynamicCineEnabled=null===(n=t.dynamicCineEnabled)||void 0===n||n;var i,l,c,s,d=a.viewport,u=pu(d),v=function(e,t){if(e instanceof K.StackViewport)return function(e){var t=e.getImageIds();return{get numScrollSteps(){return t.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},scroll:function(t){vc(e,{delta:t,debounceLoading:su})}}}(e);if(e instanceof K.VolumeViewport){var n=pu(e);return t.dynamicCineEnabled&&null!=n&&n.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numTimePoints},get currentStepIndex(){return e.timePointIndex},get frameTimeVectorEnabled(){return!1},scroll:function(t){e.timePointIndex+=t}}}(n):function(e,t){var n=t.volumeId,r={viewPlaneNormal:dc.vec3.create(),scrollInfo:null},o=function(){var t=e.getCamera();if(!r.scrollInfo||!dc.vec3.equals(t.viewPlaneNormal,r.viewPlaneNormal)){var o=K.utilities.getVolumeViewportScrollInfo(e,n);r.viewPlaneNormal=t.viewPlaneNormal,r.scrollInfo=o}return r.scrollInfo};return{get numScrollSteps(){return o().numScrollSteps},get currentStepIndex(){return o().currentStepIndex},get frameTimeVectorEnabled(){var n=e.getCamera(),r=t.direction.slice(6,9).map((function(e){return-e})),o=dc.vec3.dot(r,n.viewPlaneNormal);return dc.glMatrix.equals(o,1)},scroll:function(t){o().currentStepIndex+=t,vc(e,{delta:t})}}}(e,n)}throw new Error("Unknown viewport type")}(d,t),f=lu(e),g=t.dynamicCineEnabled&&(null==u?void 0:u.isDynamicVolume());if(g&&hu(e),f?gu(e,g):(f={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:null!==(i=t.frameTimeVector)&&void 0!==i?i:void 0,speed:null!==(l=t.frameTimeVectorSpeedMultiplier)&&void 0!==l?l:1,reverse:null!==(c=t.reverse)&&void 0!==c&&c,loop:null===(s=t.loop)||void 0===s||s},iu(e,f)),f.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(f.framesPerSecond=Number(t.framesPerSecond),f.reverse=f.framesPerSecond<0,f.ignoreFrameTimeVector=!0),!0!==f.ignoreFrameTimeVector&&f.frameTimeVector&&f.frameTimeVector.length===v.numScrollSteps&&v.frameTimeVectorEnabled){var h=function(e,t){var n,r,o,a=0,i=e.length,l=[],c=!1;for(("number"!=typeof t||t<=0)&&(t=1),n=1;n<i;n++)o=Number(e[n])/t|0,l.push(o),1===n?r=o:o!==r&&(c=!0),a+=o;return l.length>0&&(o=c?a/l.length|0:l[0],l.push(o)),{timeouts:l,isTimeVarying:c}}(f.frameTimeVector,f.speed),p=h.timeouts,m=h.isTimeVarying;r=p,o=m}var w=function(){var t=v.numScrollSteps,n=v.currentStepIndex,r=n+(f.reverse?-1:1);if(du||!(r<0||r>=t)){r>=t?r=0:r<0&&(r=t-1);var o=r-n;o&&v.scroll(o)}else{gu(e,g);var a={element:e};cu(e,ou.CLIP_STOPPED,a)}};g&&uu.set(u.volumeId,e),r&&r.length>0&&o?(f.usingFrameTimeVector=!0,f.intervalId=window.setTimeout((function e(){f.intervalId=window.setTimeout(e,r[v.currentStepIndex]),w()}),0)):(f.usingFrameTimeVector=!1,f.intervalId=window.setInterval(w,1e3/Math.abs(f.framesPerSecond)));var E={element:e};cu(e,ou.CLIP_STARTED,E)}function fu(e){gu(e,!0)}function gu(e,t){var n=(0,K.getEnabledElement)(e);if(n){var r,o,a=n.viewport,i=lu(a.element);i&&void 0!==(o=(r=i).intervalId)&&(r.intervalId=void 0,r.usingFrameTimeVector?clearTimeout(o):clearInterval(o)),t&&a instanceof K.BaseVolumeViewport&&hu(e)}}function hu(e){var t=pu((0,K.getEnabledElement)(e).viewport);if(null!=t&&t.isDynamicVolume()){var n=uu.get(t.volumeId);uu.delete(t.volumeId),n&&n!==e&&fu(n)}}function pu(e){var t=function(e){return e.getActors().map((function(e){return K.cache.getVolume(e.uid)})).filter((function(e){return!!e}))}(e),n=t.find((function(e){return e.isDynamicVolume()}));return null!=n?n:t[0]}function mu(e){var t=e.length-1;return function(n){var r=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),o=e[r],a=e[r+1],i=r>0?e[r-1]:2*o-a,l=r<t-1?e[r+2]:2*a-o;return function(e,t,n,r,o){var a=e*e,i=a*e;return((1-3*e+3*a-i)*t+(4-6*a+3*i)*n+(1+3*e+3*a-3*i)*r+i*o)/6}((n-r/t)*t,i,o,a,l)}}function wu(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e(r/(t-1));return n}function Eu(e){return e.length}function yu(){return function(e){if(!(o=e.length))return[];for(var t=-1,n=function(e,t){let n;if(void 0===t)for(const t of e)null!=t&&(n>t||void 0===n&&t>=t)&&(n=t);else{let r=-1;for(let o of e)null!=(o=t(o,++r,e))&&(n>o||void 0===n&&o>=o)&&(n=o)}return n}(e,Eu),r=new Array(n);++t<n;)for(var o,a=-1,i=r[t]=new Array(o);++a<o;)i[a]=e[a][t];return r}(arguments)}function Iu(e,t,n,r){var o,a,i=n-t+1,l=null!==(o=Math.floor(r/100*i))&&void 0!==o?o:1,c=null!==(a=Math.floor(i/l))&&void 0!==a?a:1;if(isNaN(i)||!i||!c)return e;if(i/c<2)return e;var s=Math.max(0,t),d=Math.min(e.length-1,n),u=e.slice(0,s),v=e.slice(d+1,e.length),f=function(e,t){if(!t||0===t.length||t.length===e.length)return e;var n,r=t[t.length-1]-t[0]+1,o=mu(t.map((function(t){return e[t][0]}))),a=mu(t.map((function(t){return e[t][1]})));if(3===(null===(n=e[0])||void 0===n?void 0:n.length)){var i=mu(t.map((function(t){return e[t][2]})));return yu(wu(o,r),wu(a,r),wu(i,r))}return yu(wu(o,r),wu(a,r))}(e,function(e,t){for(var n=[],r=it(t,2),o=r[0],a=r[1],i=a-o+1,l=Math.floor(i/e),c=0,s=Math.round((i-1)/(l-1)*c)+o;s<=a;)n.push(s),c++,s=Math.round((i-1)/(l-1)*c)+o;return n}(c,[s,d]));return[].concat(kr(u),kr(f),kr(v))}function bu(e){var t,n;return!0===(null==e||null===(t=e.interpolation)||void 0===t?void 0:t.interpolateOnAdd)||!0===(null==e||null===(n=e.interpolation)||void 0===n?void 0:n.interpolateOnEdit)}function Cu(e,t,n){return(e+t+n)%t}function Tu(e,t,n,r){var o=it(e,3),a=o[1],i=o[2],l=it(t,3),c=l[1],s=l[2],d=i.length,u=s.length,v=e[0],f=t[0];if(!(i[v]&&s[f]&&i[a]&&s[c]))return[void 0,void 0];for(;v!==a&&f!==c;){if(n(s[f],i[v]))return[v,f];v=Cu(v,d,r),f=Cu(f,u,r)}return[void 0,void 0]}function _u(e,t,n){var r=e.interpolation,o=t;if(r){var a=r.knotsRatioPercentageOnAdd,i=r.knotsRatioPercentageOnEdit,l=r.interpolateOnAdd,c=void 0!==l&&l,s=r.interpolateOnEdit,d=n?i:a;if(n?void 0!==s&&s:c){var u=it(n?function(e,t){var n=function(e,t){for(var n=0;n<e.length;n++)for(var r=0;r<t.length;r++)if(0===Jd(e[n],t[r]))return[n,r]}(e,t)||[],r=it(n,2),o=r[0],a=r[1],i=function(e,t){return!1===function(e,t){return Jd(e,t)<.001}(e,t)},l=it(Tu([Cu(o,e.length,1),o,e],[Cu(a,t.length,1),a,t],i,1),2),c=l[0],s=l[1];return[c,it(Tu([Cu(c,e.length,-1),c,e],[Cu(s,t.length,-1),s,t],i,-1),1)[0]]}(t,n):[0,t.length-1],2),v=u[0],f=u[1];return t[v]&&t[f]?Iu(t,v,f,d):t}}return o}function Du(e,t){var n=e[0],r=e[e.length-1],o=dc.vec2.create();dc.vec2.set(o,r[0]-n[0],r[1]-n[1]),dc.vec2.normalize(o,o);var a=dc.vec2.create(),i=dc.vec2.create();dc.vec2.set(a,-o[1],o[0]),dc.vec2.set(i,o[1],-o[0]);for(var l=[(n[0]+r[0])/2,(n[1]+r[1])/2],c={dist:0,index:null},s=0;s<e.length;s++){var d=e[s],u=dc.vec2.dist(d,l);u>c.dist&&(c.dist=u,c.index=s)}return[e[c.index],l].map(t.canvasToWorld)}var Ou=zd,Su=qd,xu=Ud,Mu=Gd;function ku(e,t,n){this.isDrawing=!0;var r=e.detail,o=r.currentPoints,a=r.element,i=o.canvas,l=(0,K.getEnabledElement)(a).viewport,c=Mu(l,this.configuration.subPixelResolution),s=c.spacing,d=c.xDir,u=c.yDir;this.drawData={canvasPoints:[i],polylineIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:s,xDir:d,yDir:u,movingTextBox:!1},Fe.isInteractingWithTool=!0,a.addEventListener(J.MOUSE_UP,this.mouseUpDrawCallback),a.addEventListener(J.MOUSE_DRAG,this.mouseDragDrawCallback),a.addEventListener(J.MOUSE_CLICK,this.mouseUpDrawCallback),a.addEventListener(J.TOUCH_END,this.mouseUpDrawCallback),a.addEventListener(J.TOUCH_DRAG,this.mouseDragDrawCallback),a.addEventListener(J.TOUCH_TAP,this.mouseUpDrawCallback),Kl(a)}function Ru(e){Fe.isInteractingWithTool=!1,e.removeEventListener(J.MOUSE_UP,this.mouseUpDrawCallback),e.removeEventListener(J.MOUSE_DRAG,this.mouseDragDrawCallback),e.removeEventListener(J.MOUSE_CLICK,this.mouseUpDrawCallback),e.removeEventListener(J.TOUCH_END,this.mouseUpDrawCallback),e.removeEventListener(J.TOUCH_DRAG,this.mouseDragDrawCallback),e.removeEventListener(J.TOUCH_TAP,this.mouseUpDrawCallback),zl(e)}function Pu(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=n.canvas,i=(0,K.getEnabledElement)(r),l=i.renderingEngine,c=i.viewport,s=this.commonData,d=s.annotation,u=s.viewportIdsToRender,v=s.xDir,f=s.yDir,g=s.spacing,h=s.movingTextBox,p=this.drawData,m=p.polylineIndex,w=p.canvasPoints,E=w[w.length-1],y=c.canvasToWorld(E),I=dc.vec3.create();dc.vec3.subtract(I,o,y);var b=Math.abs(dc.vec3.dot(I,v)),C=Math.abs(dc.vec3.dot(I,f));if(!(b<=g[0]&&C<=g[1])){if(h){this.isDrawing=!1;var T=t.deltaPoints.world,_=d.data.handles.textBox,D=_.worldPosition;D[0]+=T[0],D[1]+=T[1],D[2]+=T[2],_.hasMoved=!0}else{var O=this.findCrossingIndexDuringCreate(e);if(void 0!==O)this.applyCreateOnCross(e,O);else{var S=Ou(r,w,a,this.commonData);this.drawData.polylineIndex=m+S}}na(l,u)}}function Nu(e){var t=this.configuration.allowOpenContours,n=this.drawData.canvasPoints,r=n[0],o=n[n.length-1],a=e.detail.element;t&&!Su(r,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(a):this.completeDrawClosedContour(a)}function Au(e){this.removeCrossedLinesOnCompleteDraw();var t=this.drawData.canvasPoints;if(this.haltDrawing(e,t))return!1;var n=this.commonData,r=n.annotation,o=n.viewportIdsToRender,a=(0,K.getEnabledElement)(e),i=a.viewport,l=a.renderingEngine;Ou(e,t,t[0],this.commonData),t.pop();var c=(bu(this.configuration)?_u(this.configuration,t):t).map((function(e){return i.canvasToWorld(e)}));return r.data.polyline=c,r.data.isOpenContour=!1,r.data.handles.textBox.hasMoved||this.triggerAnnotationCompleted(r),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,na(l,o),this.deactivateDraw(e),!0}function Lu(){var e=this.drawData.canvasPoints,t=e.length,n=[e[0],e[t-1]],r=e.slice(0,-1).slice(1),o=xu(r,n[0],n[1],!1);if(o){var a=o[1];this.drawData.canvasPoints=e.splice(0,a)}}function Uu(e){var t=this.drawData.canvasPoints;if(this.haltDrawing(e,t))return!1;var n=this.commonData,r=n.annotation,o=n.viewportIdsToRender,a=(0,K.getEnabledElement)(e),i=a.viewport,l=a.renderingEngine,c=(bu(this.configuration)?_u(this.configuration,t):t).map((function(e){return i.canvasToWorld(e)}));r.data.polyline=c,r.data.isOpenContour=!0;var s=r.data.handles.textBox;return r.data.handles.points=[c[0],c[c.length-1]],r.data.isOpenUShapeContour&&(r.data.openUShapeContourVectorToPeak=Du(t,i)),s.hasMoved||this.triggerAnnotationCompleted(r),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,na(l,o),this.deactivateDraw(e),!0}function Vu(e){var t=e.detail,n=t.currentPoints,r=t.lastPoints,o=n.canvas,a=r.canvas,i=this.drawData.canvasPoints.slice(0,-1),l=xu(i,o,a,!1);if(void 0!==l)return l[0]}function Bu(e,t){var n=e.detail.element,r=this.drawData.canvasPoints,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender;Ou(n,r,r[t],this.commonData),r.pop();for(var l=0;l<t;l++)r.shift();this.completeDrawClosedContour(n)&&this.activateClosedContourEdit(e,a,i)}function ju(e){var t=this.configuration.allowOpenContours,n=this.drawData.canvasPoints,r=n[0],o=n[n.length-1];t&&!Su(r,o,this.configuration.closeContourProximity)?this.completeDrawOpenContour(e):this.completeDrawClosedContour(e)}function Hu(e,t){if(function(e,t){var n=Math.max(3*t,3);return e.length<n}(t,this.configuration.subPixelResolution)){var n=this.commonData,r=n.annotation,o=n.viewportIdsToRender,a=(0,K.getEnabledElement)(e).renderingEngine;return tt(r.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,na(a,o),this.deactivateDraw(e),!0}return!1}var Wu=function(e){e.activateDraw=ku.bind(e),e.deactivateDraw=Ru.bind(e),e.applyCreateOnCross=Bu.bind(e),e.findCrossingIndexDuringCreate=Vu.bind(e),e.completeDrawOpenContour=Uu.bind(e),e.removeCrossedLinesOnCompleteDraw=Lu.bind(e),e.mouseDragDrawCallback=Pu.bind(e),e.mouseUpDrawCallback=Nu.bind(e),e.completeDrawClosedContour=Au.bind(e),e.cancelDrawing=ju.bind(e),e.haltDrawing=Hu.bind(e)},Fu=zd,Gu=Ud;function qu(e,t){var n=e.detail,r=n.element,o=n.currentPoints,a=n.lastPoints,i=o.canvas,l=a.canvas,c=this.editData,s=c.editCanvasPoints,d=c.prevCanvasPoints,u=Gu(d,i,l,t);if(u)this.editData.startCrossingIndex=u[0],this.removePointsUpUntilFirstCrossing(t);else if(d.length>=2)if(s.length>this.configuration.checkCanvasEditFallbackProximity){for(var v=s[0],f=[],g=0;g<d.length;g++){var h=d[g],p=dc.vec2.distance(h,v);f.push({distance:p,index:g})}f.sort((function(e,t){return e.distance-t.distance}));var m=[f[0],f[1]],w=Math.min(m[0].index,m[1].index);this.editData.startCrossingIndex=w}else{var E=dc.vec2.create();dc.vec2.subtract(E,s[1],s[0]),dc.vec2.normalize(E,E);var y=[s[0][0]-6*E[0],s[0][1]-6*E[1]],I=Gu(d,y,s[0],t);if(I){var b=[y];Fu(r,b,s[0],this.commonData),s.unshift.apply(s,b),this.removePointsUpUntilFirstCrossing(t),this.editData.editIndex=s.length-1,this.editData.startCrossingIndex=I[0]}}}function zu(e){for(var t=this.editData,n=t.editCanvasPoints,r=t.prevCanvasPoints,o=0,a=0;a<n.length-1;a++){var i=[n[a],n[a+1]];if(o++,Gu(r,i[0],i[1],e))break}n.splice(0,o),this.editData.editIndex=n.length-1}function Ku(e,t){var n=e.detail,r=n.currentPoints,o=n.lastPoints,a=r.canvas,i=o.canvas,l=this.editData.prevCanvasPoints;return!!Gu(l,a,i,t)}function Yu(e){for(var t=this.editData,n=t.prevCanvasPoints,r=t.editCanvasPoints,o=r.length-1;o>0;o--){var a=[r[o],r[o-1]],i=!!Gu(n,a[0],a[1],e);if(r.pop(),i)break}}function Ju(){var e=this.editData,t=e.editCanvasPoints,n=e.prevCanvasPoints;if(void 0!==e.startCrossingIndex){for(var r=t[t.length-1],o=[],a=0;a<n.length;a++){var i=n[a],l=dc.vec2.distance(i,r);o.push({distance:l,index:a})}o.sort((function(e,t){return e.distance-t.distance}));for(var c=t.slice(0,-1),s=0;s<o.length;s++){var d=o[s].index,u=n[d],v=t[t.length-1];if(!Gu(c,u,v,!1))return d}return-1}}function $u(e){var t=e.detail,n=t.currentPoints,r=t.lastPoints,o=n.canvas,a=r.canvas,i=this.editData.editCanvasPoints,l=i.slice(0,-2),c=Gu(l,o,a,!1);if(c)for(var s=c[0],d=i.length-s,u=0;u<d;u++)i.pop()}var Zu=function(e){e.checkForFirstCrossing=qu.bind(e),e.removePointsUpUntilFirstCrossing=zu.bind(e),e.checkForSecondCrossing=Ku.bind(e),e.findSnapIndex=Ju.bind(e),e.removePointsAfterSecondCrossing=Yu.bind(e),e.checkAndRemoveCrossesOnEditLine=$u.bind(e)},Xu=Gd,Qu=zd,ev=Yd;function tv(e,t,n){this.isEditingClosed=!0;var r=e.detail,o=r.currentPoints,a=r.element,i=o.canvas,l=(0,K.getEnabledElement)(a).viewport,c=t.data.polyline.map(l.worldToCanvas),s=Xu(l,this.configuration.subPixelResolution),d=s.spacing,u=s.xDir,v=s.yDir;this.editData={prevCanvasPoints:c,editCanvasPoints:[i],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:v,movingTextBox:!1},Fe.isInteractingWithTool=!0,a.addEventListener(J.MOUSE_UP,this.mouseUpClosedContourEditCallback),a.addEventListener(J.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(J.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),a.addEventListener(J.TOUCH_END,this.mouseUpClosedContourEditCallback),a.addEventListener(J.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),a.addEventListener(J.TOUCH_TAP,this.mouseUpClosedContourEditCallback),Kl(a)}function nv(e){Fe.isInteractingWithTool=!1,e.removeEventListener(J.MOUSE_UP,this.mouseUpClosedContourEditCallback),e.removeEventListener(J.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(J.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),e.removeEventListener(J.TOUCH_END,this.mouseUpClosedContourEditCallback),e.removeEventListener(J.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),e.removeEventListener(J.TOUCH_TAP,this.mouseUpClosedContourEditCallback),zl(e)}function rv(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=n.canvas,i=(0,K.getEnabledElement)(r),l=i.renderingEngine,c=i.viewport,s=this.commonData,d=s.viewportIdsToRender,u=s.xDir,v=s.yDir,f=s.spacing,g=this.editData,h=g.editIndex,p=g.editCanvasPoints,m=g.startCrossingIndex,w=p[p.length-1],E=c.canvasToWorld(w),y=dc.vec3.create();dc.vec3.subtract(y,o,E);var I=Math.abs(dc.vec3.dot(y,u)),b=Math.abs(dc.vec3.dot(y,v));if(!(I<=f[0]&&b<=f[1])){void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);var C=h+Qu(r,p,a,this.commonData);this.editData.editIndex=C,void 0===m&&p.length>1&&this.checkForFirstCrossing(e,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(e),void 0!==m&&this.checkForSecondCrossing(e,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(e)),na(l,d)):this.finishEditAndStartNewEdit(e)}}function ov(e){var t=e.detail.element,n=(0,K.getEnabledElement)(t),r=n.viewport,o=n.renderingEngine,a=this.commonData,i=a.annotation,l=a.viewportIdsToRender,c=this.editData,s=c.fusedCanvasPoints,d=c.editCanvasPoints,u=s.map((function(e){return r.canvasToWorld(e)}));i.data.polyline=u,i.data.isOpenContour=!1,this.triggerAnnotationModified(i,n);var v=d.pop();this.editData={prevCanvasPoints:s,editCanvasPoints:[v],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0},na(o,l)}function av(e){var t=this.editData,n=t.prevCanvasPoints,r=t.editCanvasPoints,o=t.startCrossingIndex,a=t.snapIndex;if(void 0!==o&&void 0!==a){var i,l,c=e.detail.element,s=kr(r);Qu(c,s,n[a],this.commonData),s.length>r.length&&s.pop(),o>a?(i=a,l=o):(i=o,l=a);for(var d=dc.vec2.distance(n[i],s[0]),u=dc.vec2.distance(n[i],s[s.length-1]),v=dc.vec2.distance(n[l],s[0]),f=dc.vec2.distance(n[l],s[s.length-1]),g=[],h=0;h<i;h++){var p=n[h];g.push([p[0],p[1]])}var m=d+f,w=u+v;if(m<w)for(var E=0;E<s.length;E++){var y=s[E];g.push([y[0],y[1]])}else for(var I=s.length-1;I>=0;I--){var b=s[I];g.push([b[0],b[1]])}for(var C=l;C<n.length;C++){var T=n[C];g.push([T[0],T[1]])}for(var _=[],D=i;D<l;D++){var O=n[D];_.push([O[0],O[1]])}if((m=v+u)<(w=f+d))for(var S=0;S<s.length;S++){var x=s[S];_.push([x[0],x[1]])}else for(var M=s.length-1;M>=0;M--){var k=s[M];_.push([k[0],k[1]])}return ev(g)>ev(_)?g:_}}function iv(e){var t=e.detail.element;this.completeClosedContourEdit(t)}function lv(e){var t=(0,K.getEnabledElement)(e),n=t.viewport,r=t.renderingEngine,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender,l=this.editData,c=l.fusedCanvasPoints,s=l.prevCanvasPoints;if(c){var d=(bu(this.configuration)?_u(this.configuration,c,s):c).map((function(e){return n.canvasToWorld(e)}));a.data.polyline=d,a.data.isOpenContour=!1,a.invalidated=!0,this.triggerAnnotationModified(a,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,na(r,i),this.deactivateClosedContourEdit(e)}function cv(e){this.completeClosedContourEdit(e)}var sv=function(e){e.activateClosedContourEdit=tv.bind(e),e.deactivateClosedContourEdit=nv.bind(e),e.mouseDragClosedContourEditCallback=rv.bind(e),e.mouseUpClosedContourEditCallback=iv.bind(e),e.finishEditAndStartNewEdit=ov.bind(e),e.fuseEditPointsWithClosedContour=av.bind(e),e.cancelClosedContourEdit=cv.bind(e),e.completeClosedContourEdit=lv.bind(e)},dv=zd,uv=Gd;function vv(e,t,n){this.isEditingOpen=!0;var r=e.detail,o=r.currentPoints,a=r.element,i=o.canvas,l=(0,K.getEnabledElement)(a).viewport,c=t.data.polyline.map(l.worldToCanvas),s=uv(l,this.configuration.subPixelResolution),d=s.spacing,u=s.xDir,v=s.yDir;this.editData={prevCanvasPoints:c,editCanvasPoints:[i],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:t,viewportIdsToRender:n,spacing:d,xDir:u,yDir:v,movingTextBox:!1},Fe.isInteractingWithTool=!0,a.addEventListener(J.MOUSE_UP,this.mouseUpOpenContourEditCallback),a.addEventListener(J.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(J.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),a.addEventListener(J.TOUCH_END,this.mouseUpOpenContourEditCallback),a.addEventListener(J.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),a.addEventListener(J.TOUCH_TAP,this.mouseUpOpenContourEditCallback),Kl(a)}function fv(e){Fe.isInteractingWithTool=!1,e.removeEventListener(J.MOUSE_UP,this.mouseUpOpenContourEditCallback),e.removeEventListener(J.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(J.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),e.removeEventListener(J.TOUCH_END,this.mouseUpOpenContourEditCallback),e.removeEventListener(J.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),e.removeEventListener(J.TOUCH_TAP,this.mouseUpOpenContourEditCallback),zl(e)}function gv(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=n.canvas,i=(0,K.getEnabledElement)(r),l=i.renderingEngine,c=i.viewport,s=this.commonData,d=s.viewportIdsToRender,u=s.xDir,v=s.yDir,f=s.spacing,g=this.editData,h=g.editIndex,p=g.editCanvasPoints,m=g.startCrossingIndex,w=p[p.length-1],E=c.canvasToWorld(w),y=dc.vec3.create();dc.vec3.subtract(y,o,E);var I=Math.abs(dc.vec3.dot(y,u)),b=Math.abs(dc.vec3.dot(y,v));if(!(I<=f[0]&&b<=f[1])){void 0!==m&&this.checkAndRemoveCrossesOnEditLine(e);var C=h+dv(r,p,a,this.commonData);this.editData.editIndex=C,void 0===m&&p.length>1&&this.checkForFirstCrossing(e,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(e),void 0!==m&&this.checkForSecondCrossing(e,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(e)):this.checkIfShouldOverwriteAnEnd(e)&&this.openContourEditOverwriteEnd(e),na(l,d)}}function hv(e){var t=e.detail.element,n=(0,K.getEnabledElement)(t),r=n.viewport,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender,l=this.fuseEditPointsForOpenContourEndEdit().map((function(e){return r.canvasToWorld(e)}));a.data.polyline=l,a.data.isOpenContour=!0,a.data.handles.points=[l[0],l[l.length-1]],a.data.handles.activeHandleIndex=1,this.triggerAnnotationModified(a,n),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.deactivateOpenContourEdit(t),this.activateOpenContourEndEdit(e,a,i,null)}function pv(e){var t=e.detail,n=t.currentPoints,r=t.lastPoints,o=n.canvas,a=r.canvas,i=this.editData,l=i.snapIndex,c=i.prevCanvasPoints;if(void 0===i.startCrossingIndex||void 0===l)return!1;if(-1===l)return!0;if(0!==l&&l!==c.length-1)return!1;var s=o,d=a,u=c[l],v=dc.vec2.create(),f=dc.vec2.create();dc.vec2.set(v,s[0]-d[0],s[1]-d[1]),dc.vec2.set(f,s[0]-u[0],s[1]-u[1]);var g=dc.vec2.dot(v,f),h=Math.sqrt(v[0]*v[0]+v[1]*v[1]),p=Math.sqrt(f[0]*f[0]+f[1]*f[1]);return Math.acos(g/(h*p))<Math.PI/2}function mv(){var e=this.editData,t=e.snapIndex,n=e.prevCanvasPoints,r=e.editCanvasPoints,o=e.startCrossingIndex,a=[];if(0===t)for(var i=n.length-1;i>=o;i--){var l=n[i];a.push([l[0],l[1]])}else for(var c=0;c<o;c++){var s=n[c];a.push([s[0],s[1]])}if(dc.vec2.distance(n[o],r[0])<dc.vec2.distance(n[o],r[r.length-1]))for(var d=0;d<r.length;d++){var u=r[d];a.push([u[0],u[1]])}else for(var v=r.length-1;v>=0;v--){var f=r[v];a.push([f[0],f[1]])}return a}function wv(e){var t=this.editData,n=t.prevCanvasPoints,r=t.editCanvasPoints,o=t.startCrossingIndex,a=t.snapIndex;if(void 0!==o&&void 0!==a){var i,l,c=e.detail.element,s=kr(r);dv(c,s,n[a],this.commonData),s.length>r.length&&s.pop(),o>a?(i=a,l=o):(i=o,l=a);for(var d=dc.vec2.distance(n[i],s[0]),u=dc.vec2.distance(n[i],s[s.length-1]),v=dc.vec2.distance(n[l],s[0]),f=dc.vec2.distance(n[l],s[s.length-1]),g=[],h=0;h<i;h++){var p=n[h];g.push([p[0],p[1]])}if(d+f<u+v)for(var m=0;m<s.length;m++){var w=s[m];g.push([w[0],w[1]])}else for(var E=s.length-1;E>=0;E--){var y=s[E];g.push([y[0],y[1]])}for(var I=l;I<n.length;I++){var b=n[I];g.push([b[0],b[1]])}return g}}function Ev(e){var t=e.detail.element,n=(0,K.getEnabledElement)(t),r=n.viewport,o=n.renderingEngine,a=this.commonData,i=a.annotation,l=a.viewportIdsToRender,c=this.editData,s=c.fusedCanvasPoints,d=c.editCanvasPoints,u=s.map((function(e){return r.canvasToWorld(e)}));i.data.polyline=u,i.data.isOpenContour=!0,i.data.handles.points=[u[0],u[u.length-1]],this.triggerAnnotationModified(i,n);var v=d.pop();this.editData={prevCanvasPoints:s,editCanvasPoints:[v],startCrossingIndex:void 0,editIndex:0},na(o,l)}function yv(e){var t=e.detail.element;this.completeOpenContourEdit(t)}function Iv(e){var t=(0,K.getEnabledElement)(e),n=t.viewport,r=t.renderingEngine,o=this.commonData,a=o.annotation,i=o.viewportIdsToRender,l=this.editData,c=l.fusedCanvasPoints,s=l.prevCanvasPoints;if(c){var d=(bu(this.configuration)?_u(this.configuration,c,s):c).map((function(e){return n.canvasToWorld(e)}));a.data.polyline=d,a.data.isOpenContour=!0,a.data.handles.points=[d[0],d[d.length-1]],a.data.isOpenUShapeContour&&(a.data.openUShapeContourVectorToPeak=Du(c,n)),a.invalidated=!0,this.triggerAnnotationModified(a,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,na(r,i),this.deactivateOpenContourEdit(e)}function bv(e){this.completeOpenContourEdit(e)}var Cv=function(e){e.activateOpenContourEdit=vv.bind(e),e.deactivateOpenContourEdit=fv.bind(e),e.mouseDragOpenContourEditCallback=gv.bind(e),e.mouseUpOpenContourEditCallback=yv.bind(e),e.fuseEditPointsWithOpenContour=wv.bind(e),e.finishEditOpenOnSecondCrossing=Ev.bind(e),e.checkIfShouldOverwriteAnEnd=pv.bind(e),e.fuseEditPointsForOpenContourEndEdit=mv.bind(e),e.openContourEditOverwriteEnd=hv.bind(e),e.cancelOpenContourEdit=bv.bind(e),e.completeOpenContourEdit=Iv.bind(e)},Tv=Gd;function _v(e,t,n,r){this.isDrawing=!0;var o=e.detail.element,a=(0,K.getEnabledElement)(o).viewport,i=Tv(a,this.configuration.subPixelResolution),l=i.spacing,c=i.xDir,s=i.yDir,d=t.data.polyline.map(a.worldToCanvas);0===t.data.handles.activeHandleIndex&&d.reverse();var u=!1;r.worldPosition&&(u=!0),this.drawData={canvasPoints:d,polylineIndex:d.length-1},this.commonData={annotation:t,viewportIdsToRender:n,spacing:l,xDir:c,yDir:s,movingTextBox:u},Fe.isInteractingWithTool=!0,o.addEventListener(J.MOUSE_UP,this.mouseUpDrawCallback),o.addEventListener(J.MOUSE_DRAG,this.mouseDragDrawCallback),o.addEventListener(J.MOUSE_CLICK,this.mouseUpDrawCallback),o.addEventListener(J.TOUCH_END,this.mouseUpDrawCallback),o.addEventListener(J.TOUCH_DRAG,this.mouseDragDrawCallback),o.addEventListener(J.TOUCH_TAP,this.mouseUpDrawCallback),Kl(o)}var Dv=function(e){e.activateOpenContourEndEdit=_v.bind(e)},Ov=qd;function Sv(e,t){var n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id,annotationUID:t.annotationUID},r=this.getStyle("lineWidth",n,t),o=this.getStyle("lineDash",n,t),a=this.getStyle("color",n,t);return{color:void 0===a?void 0:a,width:void 0===r?void 0:r,lineDash:void 0===o?void 0:o,connectLastToFirst:!t.data.isOpenContour}}function xv(e,t,n){var r;null!=e&&null!==(r=e.viewport)&&void 0!==r&&r.getImageData()&&(n.data.isOpenContour?n.data.isOpenUShapeContour?(function(e,t){t.data.openUShapeContourVectorToPeak||(t.data.openUShapeContourVectorToPeak=function(e,t){var n=e.viewport;return Du(t.data.polyline.map(n.worldToCanvas),n)}(e,t))}(e,n),this.renderOpenUShapedContour(e,t,n)):this.renderOpenContour(e,t,n):this.renderClosedContour(e,t,n))}function Mv(e,t,n){var r=e.viewport,o=this._getRenderingOptions(e,n),a=n.data.polyline.map((function(e){return r.worldToCanvas(e)}));Mc(t,n.annotationUID,"1",a,o)}function kv(e,t,n){var r,o=e.viewport,a=this._getRenderingOptions(e,n),i=n.data.polyline.map((function(e){return o.worldToCanvas(e)}));Mc(t,n.annotationUID,"1",i,a);var l=n.data.handles.activeHandleIndex;if(!0===(null===(r=this.configuration.alwaysRenderOpenContourHandles)||void 0===r?void 0:r.enabled)){var c=this.configuration.alwaysRenderOpenContourHandles.radius,s=[i[0],i[i.length-1]];0===l?s.shift():1===l&&s.pop(),Oc(t,n.annotationUID,"0",s,{color:a.color,handleRadius:c})}if(null!==l){var d=i[0===l?0:i.length-1];Oc(t,n.annotationUID,"1",[d],{color:a.color})}}function Rv(e,t,n){var r=e.viewport,o=n.data,a=o.polyline,i=o.openUShapeContourVectorToPeak;if(this.renderOpenContour(e,t,n),i){var l=r.worldToCanvas(a[0]),c=r.worldToCanvas(a[a.length-1]),s=[r.worldToCanvas(i[0]),r.worldToCanvas(i[1])],d=this._getRenderingOptions(e,n);Mc(t,n.annotationUID,"first-to-last",[l,c],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"}),Mc(t,n.annotationUID,"midpoint-to-open-contour",[s[0],s[1]],{color:d.color,width:d.width,connectLastToFirst:!1,lineDash:"2,2"})}}function Pv(e,t,n){var r=this._getRenderingOptions(e,n),o=this.configuration.allowOpenContours,a=this.drawData.canvasPoints;if(r.connectLastToFirst=!1,Mc(t,n.annotationUID,"1",a,r),o){var i=a[0],l=a[a.length-1];Ov(i,l,this.configuration.closeContourProximity)?Mc(t,n.annotationUID,"2",[l,i],r):Oc(t,n.annotationUID,"0",[i],{color:r.color,handleRadius:2})}}function Nv(e,t,n){var r=this.editData.fusedCanvasPoints;if(void 0!==r){var o=this._getRenderingOptions(e,n);Mc(t,n.annotationUID,"preview-1",r,o)}else this.renderClosedContour(e,t,n)}function Av(e,t,n){var r=this.editData.fusedCanvasPoints;if(void 0!==r){var o=this._getRenderingOptions(e,n);Mc(t,n.annotationUID,"preview-1",r,o)}else this.renderOpenContour(e,t,n)}var Lv=function(e){e.renderContour=xv.bind(e),e.renderClosedContour=Mv.bind(e),e.renderOpenContour=kv.bind(e),e.renderOpenUShapedContour=Rv.bind(e),e.renderContourBeingDrawn=Pv.bind(e),e.renderClosedContourBeingEdited=Nv.bind(e),e.renderOpenContourBeingEdited=Av.bind(e),e._getRenderingOptions=Sv.bind(e)};function Uv(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Vv=Kd,Bv=1-K.CONSTANTS.EPSILON,jv=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,alwaysRenderOpenContourHandles:{enabled:!1,radius:2},allowOpenContours:!0,closeContourProximity:10,checkCanvasEditFallbackProximity:6,subPixelResolution:4,interpolation:{interpolateOnAdd:!1,interpolateOnEdit:!1,knotsRatioPercentageOnAdd:40,knotsRatioPercentageOnEdit:40},calculateStats:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"commonData",void 0),te(la(e),"isDrawing",!1),te(la(e),"isEditingClosed",!1),te(la(e),"isEditingOpen",!1),te(la(e),"activateDraw",void 0),te(la(e),"activateClosedContourEdit",void 0),te(la(e),"activateOpenContourEdit",void 0),te(la(e),"activateOpenContourEndEdit",void 0),te(la(e),"cancelDrawing",void 0),te(la(e),"cancelClosedContourEdit",void 0),te(la(e),"cancelOpenContourEdit",void 0),te(la(e),"renderContour",void 0),te(la(e),"renderContourBeingDrawn",void 0),te(la(e),"renderClosedContourBeingEdited",void 0),te(la(e),"renderOpenContourBeingEdited",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine,s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=Ps(o,e.getToolName()),g=l.getFrameOfReferenceUID(),h={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:g,referencedImageId:v,toolName:e.getToolName()},data:{handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},polyline:[kr(a)],label:"",cachedStats:{}}};return Qe(h,o),e.activateDraw(t,h,f),t.preventDefault(),na(c,f),h})),te(la(e),"handleSelectedCallback",(function(t,n,r){var o=Ps(t.detail.element,e.getToolName());e.activateOpenContourEndEdit(t,n,o,r)})),te(la(e),"toolSelectedCallback",(function(t,n){var r=Ps(t.detail.element,e.getToolName());n.data.isOpenContour?e.activateOpenContourEdit(t,n,r):e.activateClosedContourEdit(t,n,r)})),te(la(e),"isPointNearTool",(function(e,t,n,r){for(var o=(0,K.getEnabledElement)(e).viewport,a=t.data.polyline,i=o.worldToCanvas(a[0]),l=1;l<a.length;l++){var c=i,s=o.worldToCanvas(a[l]);if(!0===Vv(n,c,s,r))return!0;i=s}if(t.data.isOpenContour)return!1;var d=o.worldToCanvas(a[0]),u=o.worldToCanvas(a[a.length-1]);return!0===Vv(n,d,u,r)})),te(la(e),"cancel",(function(t){var n=e.isDrawing,r=e.isEditingOpen,o=e.isEditingClosed;n?e.cancelDrawing(t):r?e.cancelOpenContourEdit(t):o&&e.cancelClosedContourEdit(t)})),te(la(e),"triggerAnnotationModified",(function(e,t){var n=t.viewportId,r=t.renderingEngineId,o=J.ANNOTATION_MODIFIED,a={annotation:e,viewportId:n,renderingEngineId:r};(0,K.triggerEvent)(K.eventTarget,o,a)})),te(la(e),"triggerAnnotationCompleted",(function(e){var t=J.ANNOTATION_COMPLETED,n={annotation:e};(0,K.triggerEvent)(K.eventTarget,t,n)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=t.renderingEngine,c=i.element,s=e.getTargetId(i),d=Xe(e.getToolName(),c);if(null===(r=d)||void 0===r||!r.length)return a;if(null===(o=d=e.filterInteractableAnnotationsForElement(c,d))||void 0===o||!o.length)return a;var u=e.isDrawing,v=e.isEditingOpen,f=e.isEditingClosed;if(u||v||f){var g=e.commonData.annotation.annotationUID;d.forEach((function(r){if(r.annotationUID===g)if(u)e.renderContourBeingDrawn(t,n,r);else if(f)e.renderClosedContourBeingEdited(t,n,r);else{if(!v)throw new Error("Unknown ".concat(e.getToolName()," annotation rendering state"));e.renderOpenContourBeingEdited(t,n,r)}else e.renderContour(t,n,r)})),a=!0}else d.forEach((function(r){e.renderContour(t,n,r)}));return e.configuration.calculateStats?(d.forEach((function(r){var o,a,c,d=null===(o=e.commonData)||void 0===o?void 0:o.annotation.annotationUID;if(r.annotationUID!==d||null!==(a=e.commonData)&&void 0!==a&&a.movingTextBox){var u={isPreScaled:nd(i,s),isSuvScaled:e.isSuvScaled(i,s,r.metadata.referencedImageId)};if(null===(c=e.commonData)||void 0===c||!c.movingTextBox){var v=r.data;v.cachedStats[s]&&void 0!==v.cachedStats[s].areaUnit?r.invalidated&&e._throttledCalculateCachedStats(r,i,l,t,u):(v.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},e._calculateCachedStats(r,i,l,t,u))}e._renderStats(r,i,t,n)}})),a):void 0})),te(la(e),"_calculateCachedStats",(function(t,n,r,o,a){for(var i=t.data,l=i.cachedStats,c=i.polyline,s=Object.keys(l),d=function(){var o=s[u],i=e.getTargetIdImage(o,r);if(!i)return"continue";var d=i.imageData,v=i.metadata,f=c.map((function(e){return n.worldToCanvas(e)})),g=Ys(i),h=Yd(f)/g/g,p=K.utilities.transformWorldToIndex(d,c[0]);p[0]=Math.floor(p[0]),p[1]=Math.floor(p[1]),p[2]=Math.floor(p[2]);for(var m=p[0],w=p[0],E=p[1],y=p[1],I=p[2],b=p[2],C=1;C<c.length;C++){var T=K.utilities.transformWorldToIndex(d,c[C]);T[0]=Math.floor(T[0]),T[1]=Math.floor(T[1]),T[2]=Math.floor(T[2]),m=Math.min(m,T[0]),w=Math.max(w,T[0]),E=Math.min(E,T[1]),y=Math.max(y,T[1]),I=Math.min(I,T[2]),b=Math.max(b,T[2])}var _=.01*(w-m),D=.01*(y-E),O=.01*(b-I),S=[[m=Math.floor(m-_),w=Math.ceil(w+_)],[E=Math.floor(E-D),y=Math.ceil(y+D)],[I=Math.floor(I-O),b=Math.ceil(b+O)]],x=d.indexToWorld([w,y,b]),M=n.worldToCanvas(x),k=0,R=0,P=0,N=-1/0,A=0,L=[],U=0;Kc(d,(function(e,t){var r=!0,o=n.worldToCanvas(e);return o[1]!=A&&(U=0,A=o[1],(L=function(e,t,n){for(var r=[],o=function(e,t,n){var r,o,a=[];arguments.length>3&&void 0!==arguments[3]&&!arguments[3]?(o=0,r=1):(o=e.length-1,r=0);for(var i=r;i<e.length;i++)Bd(t,n,e[o],e[i])&&a.push([o,i]),o=i;return a}(e,t,n,!(arguments.length>3&&void 0!==arguments[3])||arguments[3]),a=0;a<o.length;a++){var i=Wd(t,n,e[o[a][0]],e[o[a][1]]);r.push(i)}return r}(f,o,[M[0],o[1]])).sort((function(e,t){return e[0]===t[0]?0:e[0]<t[0]?-1:1}))),L.length&&o[0]>L[0][0]&&(L.shift(),U++),U%2==0&&(r=!1),r}),(function(e){var t=e.value;t>N&&(N=t),R+=t,P+=Math.pow(t,2),k+=1}),S);var V=R/k,B=P/k-Math.pow(V,2);B=Math.sqrt(B);var j=td(v.Modality,t.metadata.referencedImageId,a);l[o]={Modality:v.Modality,area:h,mean:V,max:N,stdDev:B,areaUnit:Ks(0,i),modalityUnit:j}},u=0;u<s.length;u++)d();return e.triggerAnnotationModified(t,o),t.invalidated=!1,l})),te(la(e),"_renderStats",(function(t,n,r,o){var a,i=t.data,l=e.getTargetId(n),c=e._getTextLines(i,l);if(c&&0!==c.length){var s=i.polyline.map((function(e){return n.worldToCanvas(e)}));if(!i.handles.textBox.hasMoved){var d=Qs(s);i.handles.textBox.worldPosition=n.canvasToWorld(d)}var u=n.worldToCanvas(i.handles.textBox.worldPosition),v={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:r.viewport.id},f=Ac(o,null!==(a=t.annotationUID)&&void 0!==a?a:"","1",c,u,s,{},e.getLinkedTextBoxStyle(v,t)),g=f.x,h=f.y,p=f.width,m=f.height;i.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([g,h]),topRight:n.canvasToWorld([g+p,h]),bottomLeft:n.canvasToWorld([g,h+m]),bottomRight:n.canvasToWorld([g+p,h+m])}}})),te(la(e),"_getTextLines",(function(e,t){var n=e.cachedStats[t],r=n.area,o=n.mean,a=n.stdDev,i=n.max,l=n.isEmptyArea,c=n.areaUnit,s=n.modalityUnit,d=[];if(r){var u=l?"Area: Oblique not supported":"Area: ".concat(Zc(r)," ").concat(c);d.push(u)}return o&&d.push("Mean: ".concat(Zc(o)," ").concat(s)),i&&d.push("Max: ".concat(Zc(i)," ").concat(s)),a&&d.push("Std Dev: ".concat(Zc(a)," ").concat(s)),d})),Wu(la(e)),Zu(la(e)),sv(la(e)),Cv(la(e)),Dv(la(e)),Lv(la(e)),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o,[{key:"filterInteractableAnnotationsForElement",value:function(e,t){if(t&&t.length){var n,r=(0,K.getEnabledElement)(e).viewport;if(r instanceof K.StackViewport)n=Us(r,t);else{if(!(r instanceof K.VolumeViewport))throw new Error("Viewport Type ".concat(r.type," not supported"));var o=r.getCamera(),a=K.utilities.getTargetVolumeAndSpacingInNormalDir(r,o).spacingInNormalDirection;n=this.filterAnnotationsWithinSlice(t,o,a)}return n}}},{key:"filterAnnotationsWithinSlice",value:function(e,t,n){var r=t.viewPlaneNormal,o=e.filter((function(e){var t=e.metadata.viewPlaneNormal,n=Math.abs(dc.vec3.dot(r,t))>Bv;return t&&n}));if(!o.length)return[];var a,i=n/2,l=t.focalPoint,c=[],s=function(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return Uv(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Uv(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){l=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(l)throw a}}}}(o);try{for(s.s();!(a=s.n()).done;){var d=a.value,u=d.data.polyline[0];if(d.isVisible){var v=dc.vec3.create();dc.vec3.sub(v,l,u);var f=dc.vec3.dot(v,r);Math.abs(f)<i&&c.push(d)}}}catch(e){s.e(e)}finally{s.f()}return c}}]),o}(Fs);te(jv,"toolName",void 0),jv.toolName="PlanarFreehandROI";var Hv=jv;function Wv(e,t,n){if(function(e,t,n){var r;if(null==t||null===(r=t.data)||void 0===r||!r.polyline||n<=0)return!0;if(!e.viewport)return!0;var o=e.renderingEngineId,a=e.viewportId,i=e.FrameOfReferenceUID,l=Ur(a,o);if(t.metadata.FrameOfReferenceUID!==i)return!0;if(!l)return!0;var c=l.getToolInstance(t.metadata.toolName);return!(c instanceof Hv)||c.isDrawing||c.isEditingOpen||c.isEditingClosed}(e,t,n))return!1;var r=e.viewport,o=t.data.polyline.map(r.worldToCanvas),a=Iu(o,0,o.length,n);return a!==o&&(t.data.polyline=a.map(r.canvasToWorld),!0)}var Fv={interpolateAnnotation:Wv},Gv={};function qv(e){var t=(0,K.getEnabledElement)(e).viewportId;return Gv[t]}var zv,Kv=K.Enums.RequestType.Prefetch,Yv=0,Jv={maxImagesToPrefetch:1/0,preserveExistingPool:!1},$v=10;function Zv(e,t){e=Math.round(e)||0;var n=[],r=(t=Math.round(t)||0)-e+1;if(r<=0)return n;for(;r--;)n[r]=t--;return n}function Xv(e){var t=(0,K.getEnabledElement)(e);if(!t)throw new Error("stackPrefetch: element must be a valid Cornerstone enabled element");var n=t.viewport;if(!(n instanceof K.StackViewport))throw new Error("stackPrefetch: element must be a StackViewport, VolumeViewport stackPrefetch not yet implemented");return{currentImageIdIndex:n.getCurrentImageIdIndex(),imageIds:n.getImageIds()}}function Qv(e){var t=qv(e);if(t){var n=t||{},r=Xv(e);if(r&&r.imageIds&&0!==r.imageIds.length){if(n.indicesToRequest&&n.indicesToRequest.length||(n.enabled=!1),!1!==n.enabled&&(t.indicesToRequest.sort((function(e,t){return e-t})),n.indicesToRequest.slice().forEach((function(e){var t=r.imageIds[e];t&&K.cache.getImageLoadObject(t)&&function(e){var t=n.indicesToRequest.indexOf(e);t>-1&&n.indicesToRequest.splice(t,1)}(e)})),n.indicesToRequest.length)){Jv.preserveExistingPool||K.imageLoadPoolManager.clearRequestStack(Kv);for(var o,a,i,l,c,s,d=(o=n.indicesToRequest,a=r.currentImageIdIndex,i=0,l=o.length-1,o.forEach((function(e,t){e<a?i=Math.max(t,i):e>a&&(l=Math.min(t,l))})),{low:i,high:l}),u=d.low,v=d.high,f=[];u>=0||v<n.indicesToRequest.length;){var g=r.currentImageIdIndex,h=!(g-n.indicesToRequest[u]>Jv.maxImagesToPrefetch)&&u>=0,p=!(n.indicesToRequest[v]-g>Jv.maxImagesToPrefetch)&&v<n.indicesToRequest.length;if(!p&&!h)break;h&&(s=n.indicesToRequest[u--],c=r.imageIds[s],f.push(c)),p&&(s=n.indicesToRequest[v++],c=r.imageIds[s],f.push(c))}var m=function(e,t){return K.imageLoader.loadAndCacheImage(e,t)},w=(0,K.getConfiguration)().rendering.useNorm16Texture;f.forEach((function(e){var t={targetBuffer:{type:w?void 0:"Float32Array"},preScale:{enabled:!0},requestType:Kv};K.imageLoadPoolManager.addRequest(m.bind(null,e,t),Kv,{imageId:e},Yv)}))}}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.")}}function ef(e){return function(t){var n,r=t.detail;try{n=Xv(e)}catch(e){return}if(n&&n.imageIds&&0!==n.imageIds.length){var o=n.imageIds.indexOf(r.imageId);if(!(o<0)){var a=qv(e);a&&a.data&&a.data.length&&a.indicesToRequest.push(o)}}}}function tf(e){clearTimeout(zv),zv=setTimeout((function(){var t=e.target;try{Qv(t)}catch(e){return}}),$v)}function nf(e){var t=Xv(e);if(t&&t.imageIds&&0!==t.imageIds.length){var n={indicesToRequest:Zv(0,t.imageIds.length-1),enabled:!0,direction:1},r=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(r,1),function(e,t){var n=(0,K.getEnabledElement)(e).viewportId;Gv[n]=t}(e,n),Qv(e),e.removeEventListener(K.Enums.Events.STACK_NEW_IMAGE,tf),e.addEventListener(K.Enums.Events.STACK_NEW_IMAGE,tf);var o=ef(e);K.eventTarget.removeEventListener(K.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o),K.eventTarget.addEventListener(K.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,o)}else console.warn("CornerstoneTools.stackPrefetch: No images in stack.")}function rf(e){clearTimeout(zv),e.removeEventListener(K.Enums.Events.STACK_NEW_IMAGE,tf);var t=ef(e);K.eventTarget.removeEventListener(K.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);var n=qv(e);n&&n.data.length&&(n.enabled=!1,K.imageLoadPoolManager.clearRequestStack(Kv))}function of(){return Jv}function af(e){Jv=e}function lf(e,t){if(e instanceof K.VolumeViewport){var n=e.getCamera().focalPoint,r=[0,0,0];return dc.vec3.sub(r,t,n),function(e,t){var n=e.getCamera(),r=n.viewPlaneNormal,o=dc.vec3.dot(t,r),a=dc.vec3.fromValues(r[0],r[1],r[2]);if(dc.vec3.scale(a,a,o),Math.abs(a[0])>.001||Math.abs(a[1])>.001||Math.abs(a[2])>.001){var i=[0,0,0],l=[0,0,0];dc.vec3.add(i,n.focalPoint,a),dc.vec3.add(l,n.position,a),e.setCamera({focalPoint:i,position:l}),e.render()}}(e,r),!0}}var cf=function(e,t){var n=t.frameNumbers||kr(Array(e.numTimePoints).keys());if(!t.maskVolumeId&&!t.imageCoordinate)throw new Error("No ROI provided");if(t.maskVolumeId&&t.imageCoordinate)throw new Error("Please provide only one ROI");if(t.maskVolumeId){var r=K.cache.getVolume(t.maskVolumeId),o=function(e,t,n){for(var r=n.getScalarDataArrays(),o=[],a=function(n){var a=[];e.forEach((function(e){var o=r[e];a.push(o[t[n]])})),o.push(a)},i=0;i<t.length;i++)a(i);return o}(n,r.getScalarData().map((function(e,t){return t})).filter((function(e){return 0!==r.getScalarData()[e]})),e);return o}if(t.imageCoordinate){var a=function(e,t,n){var r=n.dimensions,o=n.imageData.worldToIndex(t);if(o[0]=Math.floor(o[0]),o[1]=Math.floor(o[1]),o[2]=Math.floor(o[2]),!K.utilities.indexWithinDimensions(o,r))throw new Error("outside bounds");var a=r[0],i=r[0]*r[1],l=n.getScalarDataArrays(),c=[];return e.forEach((function(e){var t=l[e],n=o[2]*i+o[1]*a+o[0];c.push(t[n])})),c}(n,t.imageCoordinate,e);return a}},sf=function(e,t,n){var r=n||kr(Array(e.numTimePoints).keys()),o=r.length;if(r.length<=1)throw new Error("Please provide two or more time points");var a=e.getScalarDataArrays(),i=a[0].length,l=new Float32Array(i);if(t===K.Enums.DynamicOperatorType.SUM){for(var c=0;c<o;c++)for(var s=a[r[c]],d=0;d<i;d++)l[d]+=s[d];return l}if(t===K.Enums.DynamicOperatorType.SUBTRACT){if(r.length>2)throw new Error("Please provide only 2 time points for subtraction.");for(var u=0;u<i;u++)l[u]+=a[r[0]][u]-a[r[1]][u];return l}if(t===K.Enums.DynamicOperatorType.AVERAGE){for(var v=0;v<o;v++)for(var f=a[r[v]],g=0;g<i;g++)l[g]+=f[g];for(var h=0;h<i;h++)l[h]=l[h]/o;return l}},df=function(e,t){var n=Vl.getDefinedCursor(t,!0);n||(n=gl.getDefinedCursor(t)),n||(console.log("Cursor ".concat(t," is not defined either as SVG or as a standard cursor.")),n=gl.getDefinedCursor(t)),ql(e,n)},uf=[].concat(kr(kl),kr(pl)),vf=function(e,t,n){var r=Al("textBoxFontSize",e,t,n),o=Al("textBoxFontFamily",e,t,n);return"".concat(r,"px ").concat(o)},ff=function(e){if(!e||!e.length)throw new Error("The segmentationInputArray is undefined or empty array");e.forEach((function(e){if(void 0===e.segmentationId)throw new Error("The segmentationInput.segmentationId is undefined, please provide a valid segmentationId");if(void 0===e.representation)throw new Error("The segmentationInput.representation is undefined, please provide a valid representation");e.representation.type===dt.Labelmap&&function(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");var t=e.representation.data;if(!t.volumeId)throw new Error("The segmentationInput.representationData.volumeId is undefined, please provide a valid representationData.volumeId");if(!K.cache.getVolume(t.volumeId))throw new Error("volumeId of ".concat(t.volumeId," not found in cache, you should load and cache volume before adding segmentation"))}(e)}))},gf=function(e){ff(e),e.map((function(e){kt(re()(e))}))};function hf(){return(hf=ka(Pa().mark((function e(t,n,r){var o,a;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(ia(t)){e.next=3;break}throw new Error("No tool group found for toolGroupId: ".concat(t));case 3:return o=n.map((function(e){return pf(t,e,r)})),e.next=6,Promise.all(o);case 6:return a=e.sent,e.abrupt("return",a);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function pf(e,t,n){return mf.apply(this,arguments)}function mf(){return(mf=ka(Pa().mark((function e(t,n,r){var o;return Pa().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.type!==dt.Labelmap){e.next=6;break}return e.next=3,Mi.addSegmentationRepresentation(t,n,r);case 3:case 9:o=e.sent,e.next=13;break;case 6:if(n.type!==dt.Contour){e.next=12;break}return e.next=9,si.addSegmentationRepresentation(t,n,r);case 12:throw new Error("The representation type ".concat(n.type," is not supported"));case 13:return e.abrupt("return",o);case 14:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var wf=function(e,t,n){return hf.apply(this,arguments)};var Ef=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return ee(this,o),r.call(this,e,t)}return Q(o,[{key:"touchDragCallback",value:function(e){this._dragCallback(e)}},{key:"mouseDragCallback",value:function(e){this._dragCallback(e)}},{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,r=t.deltaPoints,o=(0,K.getEnabledElement)(n),a=r.world,i=o.viewport.getCamera(),l=i.focalPoint,c=i.position,s=[c[0]-a[0],c[1]-a[1],c[2]-a[2]],d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]];o.viewport.setCamera({focalPoint:d,position:s}),o.viewport.render()}}]),o}(xa);te(Ef,"toolName",void 0),Ef.toolName="Pan";var yf=Ef;var If=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"rotateCamera",(function(e,t,n,r){var o=e.getVtkActiveCamera(),a=o.getViewUp(),i=o.getFocalPoint(),l=o.getPosition(),c=[0,0,0],s=[0,0,0],d=[0,0,0],u=dc.mat4.identity(new Float32Array(16));dc.mat4.translate(u,u,t),dc.mat4.rotate(u,u,r,n),dc.mat4.translate(u,u,[-t[0],-t[1],-t[2]]),dc.vec3.transformMat4(c,l,u),dc.vec3.transformMat4(s,i,u),dc.mat4.identity(u),dc.mat4.rotate(u,u,r,n),dc.vec3.transformMat4(d,a,u),e.setCamera({position:c,viewUp:d,focalPoint:s})})),e.touchDragCallback=e._dragCallback.bind(la(e)),e.mouseDragCallback=e._dragCallback.bind(la(e)),e}return Q(o,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints,o=t.lastPoints,a=r.canvas,i=o.canvas,l=this.configuration.rotateIncrementDegrees,c=(0,K.getEnabledElement)(n).viewport,s=c.getCamera(),d=n.clientWidth,u=n.clientHeight,v=[a[0]/d,a[1]/u],f=[i[0]/d,i[1]/u],g=[.5*d,.5*u],h=c.canvasToWorld(g),p=Math.pow(1+Math.abs(.5),2),m=[f[0],0,0],w=[v[0],0,0],E=Math.pow(m[0],2),y=Math.pow(w[0],2),I=E>p?0:Math.sqrt(p-E),b=y>p?0:Math.sqrt(p-y),C=[m[0],0,I];Zd().normalize(C);var T=[w[0],0,b];Zd().normalize(T);var _=Zd().dot(C,T);if(Math.abs(_)>1e-4){var D=-2*Math.acos(Zd().clampValue(_,-1,1))*Math.sign(v[0]-f[0])*l,O=s.viewUp,S=s.viewPlaneNormal,x=[0,0,0],M=[0,0,0];Zd().cross(O,S,x),Zd().normalize(x),Zd().cross(S,x,M),Zd().normalize(M),Zd().normalize(O),this.rotateCamera(c,h,M,D);var k=(f[1]-v[1])*l;this.rotateCamera(c,h,x,k),c.render()}}}]),o}(xa);te(If,"toolName",void 0),If.toolName="TrackballRotate";var bf=If;var Cf=K.utilities.transformWorldToIndex,Tf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"editData",void 0),te(la(e),"eventDispatchDetail",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={invalidated:!0,highlighted:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{points:[kr(a)]},cachedStats:{}}};Qe(g,o);var h=Ps(o,e.getToolName());return e.editData={annotation:g,newAnnotation:!0,viewportIdsToRender:h},e._activateModify(o),Kl(o),t.preventDefault(),na(c,h),g})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=(0,K.getEnabledElement)(n),c=l.renderingEngine,s=l.viewportId;if(e.eventDispatchDetail={viewportId:s,renderingEngineId:c.id},e._deactivateModify(n),zl(n),e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(c,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=e.editData,l=i.annotation,c=i.viewportIdsToRender;l.data.handles.points[0]=kr(a),l.invalidated=!0;var s=(0,K.getEnabledElement)(o).renderingEngine;na(s,c)})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=c[f],o=r.annotationUID,l=r.data,v=l.handles.points[0],g=i.worldToCanvas(v);u.annotationUID=o;var h=e.getStyle("color",u,r),p={isPreScaled:nd(i,s),isSuvScaled:e.isSuvScaled(i,s,r.metadata.referencedImageId)};if(l.cachedStats[s]){if(r.invalidated&&(e._calculateCachedStats(r,d,t,p),i instanceof K.VolumeViewport)){var m=r.metadata.referencedImageId;for(var w in l.cachedStats)w.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=K.utilities.imageIdToURI(m),n=e.hasImageURI(t),r=K.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[w]}}else l.cachedStats[s]={Modality:null,index:null,value:null},e._calculateCachedStats(r,d,t,p);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};Oc(n,o,"0",[g],{color:h}),a=!0;var E=e._getTextLines(l,s);if(E){var y=[g[0]+6,g[1]-6];Pc(n,o,"0",E,[y[0],y[1]],e.getLinkedTextBoxStyle(u,r))}},f=0;f<c.length;f++){var g=v();if("object"===$(g))return g.v}return a})),e}return Q(o,[{key:"isPointNearTool",value:function(){return!1}},{key:"toolSelectedCallback",value:function(){}},{key:"getHandleNearImagePoint",value:function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=t.data.handles.points[0],i=o.worldToCanvas(a);if(!0==dc.vec2.distance(n,i)<r)return a}},{key:"handleSelectedCallback",value:function(e,t){var n=e.detail.element;t.highlighted=!0;var r=Ps(n,this.getToolName());this.editData={annotation:t,viewportIdsToRender:r},this._activateModify(n),Kl(n);var o=(0,K.getEnabledElement)(n).renderingEngine;na(o,r),e.preventDefault()}},{key:"_getTextLines",value:function(e,t){var n=e.cachedStats[t],r=n.index,o=n.value,a=n.modalityUnit;if(void 0!==o){var i=[];return i.push("(".concat(r[0],", ").concat(r[1],", ").concat(r[2],")")),i.push("".concat(o.toFixed(2)," ").concat(a)),i}}},{key:"_calculateCachedStats",value:function(e,t,n,r){for(var o=e.data,a=n.viewportId,i=n.renderingEngineId,l=o.handles.points[0],c=o.cachedStats,s=Object.keys(c),d=0;d<s.length;d++){var u=s[d],v=this.getTargetIdImage(u,t);if(v){var f=v.dimensions,g=v.imageData,h=v.metadata,p="getScalarData"in v?v.getScalarData():v.scalarData,m=h.Modality,w=Cf(g,l);if(w[0]=Math.round(w[0]),w[1]=Math.round(w[1]),w[2]=Math.round(w[2]),K.utilities.indexWithinDimensions(w,f)){this.isHandleOutsideImage=!1;var E=f[0],y=f[0]*f[1],I=p[w[2]*y+w[1]*E+w[0]];if(u.startsWith("imageId:")){var b=u.split("imageId:")[1],C=K.utilities.imageIdToURI(b),T=K.utilities.getViewportsWithImageURI(C,i)[0];w[2]=T.getCurrentImageIdIndex()}var _=td(m,e.metadata.referencedImageId,r);c[u]={index:w,value:I,Modality:m,modalityUnit:_}}else this.isHandleOutsideImage=!0,c[u]={index:w,Modality:m};e.invalidated=!1;var D=J.ANNOTATION_MODIFIED,O={annotation:e,viewportId:a,renderingEngineId:i};(0,K.triggerEvent)(K.eventTarget,D,O)}}return c}}]),o}(Fs);te(Tf,"toolName",void 0),Tf.toolName="Probe";var _f=Tf;var Df=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"editData",void 0),te(la(e),"eventDispatchDetail",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"postMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:v},data:{label:"",handles:{points:[kr(a)]},cachedStats:{}}},g=Ps(o,e.getToolName());return e.editData={annotation:f,newAnnotation:!0,viewportIdsToRender:g},e._activateModify(o),Kl(o),t.preventDefault(),na(c,g),f})),te(la(e),"postTouchStartCallback",(function(t){return e.postMouseDownCallback(t)})),te(la(e),"renderAnnotation",(function(t,n){var r=!1,o=t.viewport;if(!e.editData)return r;var a=e.filterInteractableAnnotationsForElement(o.element,[e.editData.annotation]);if(null==a||!a.length)return r;var i=e.getTargetId(o),l=o.getRenderingEngine(),c={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},s=e.editData.annotation,d=s.annotationUID,u=s.data,v=u.handles.points[0],f=o.worldToCanvas(v);c.annotationUID=d;var g=e.getStyle("color",c,s),h={isPreScaled:nd(o,i),isSuvScaled:e.isSuvScaled(o,i,s.metadata.referencedImageId)};if(u.cachedStats[i]?s.invalidated&&e._calculateCachedStats(s,l,t,h):(u.cachedStats[i]={Modality:null,index:null,value:null},e._calculateCachedStats(s,l,t,h)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),r;Oc(n,d,"0",[f],{color:g}),r=!0;var p=e._getTextLines(u,i);if(p){var m=[f[0]+6,f[1]-6];Pc(n,d,"0",p,[m[0],m[1]],e.getLinkedTextBoxStyle(c,s))}return r})),e}return Q(o)}(_f);te(Df,"toolName",void 0),Df.toolName="DragProbe";var Of=Df;var Sf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return ee(this,o),te(la(e=r.call(this,t,n)),"_getImageDynamicRangeFromMiddleSlice",(function(t,n){var r,o,a=Math.floor(n[2]/2),i=n[0]*n[1];t instanceof Float32Array?(r=4,o=Float32Array):t instanceof Uint8Array?(r=1,o=Uint8Array):t instanceof Uint16Array?(r=2,o=Uint16Array):t instanceof Int16Array&&(r=2,o=Int16Array);var l=new o(t.buffer,a*i*r,i),c=e._getMinMax(l,i);return c.max-c.min})),e}return Q(o,[{key:"touchDragCallback",value:function(e){this.mouseDragCallback(e)}},{key:"mouseDragCallback",value:function(e){var t,n,r,o,a,i,l=e.detail,c=l.element,s=l.deltaPoints,d=(0,K.getEnabledElement)(c),u=d.renderingEngine,v=d.viewport,f=!1;if(v instanceof K.VolumeViewport){t=this.getTargetId(v).split("volumeId:")[1],i=K.utilities.getViewportsWithVolumeId(t,u.id);var g=v.getProperties().voiRange;n=g.lower,r=g.upper;var h=K.cache.getVolume(t);o=h.metadata.Modality,f=h.scaling&&Object.keys(h.scaling).length>0}else{if(!(v instanceof K.StackViewport))throw new Error("Viewport is not a valid type");var p,m=v.getProperties();o=v.modality;var w=m.voiRange;n=w.lower,r=w.upper;var E=v.getImageData().preScale;f=E.scaled&&void 0!==(null===(p=E.scalingParameters)||void 0===p?void 0:p.suvbw)}return a="PT"===o?this.getPTScaledNewRange({deltaPointsCanvas:s.canvas,lower:n,upper:r,clientHeight:c.clientHeight,isPreScaled:f,viewport:v,volumeId:t}):this.getNewRange({viewport:v,deltaPointsCanvas:s.canvas,volumeId:t,lower:n,upper:r}),v instanceof K.StackViewport?(v.setProperties({voiRange:a}),void v.render()):v instanceof K.VolumeViewport?(v.setProperties({voiRange:a}),void i.forEach((function(e){e.render()}))):void 0}},{key:"getPTScaledNewRange",value:function(e){var t,n=e.deltaPointsCanvas,r=e.lower,o=e.upper,a=e.clientHeight,i=e.viewport,l=e.volumeId,c=e.isPreScaled;return t=c?5/a:this._getMultiplierFromDynamicRange(i,l)||4,o-=n[1]*t,{lower:r,upper:o=c?Math.max(o,.1):o}}},{key:"getNewRange",value:function(e){var t=e.viewport,n=e.deltaPointsCanvas,r=e.volumeId,o=e.lower,a=e.upper,i=this._getMultiplierFromDynamicRange(t,r)||4,l=n[0]*i,c=n[1]*i,s=K.utilities.windowLevel.toWindowLevel(o,a),d=s.windowWidth,u=s.windowCenter;return d+=l,u+=c,d=Math.max(d,1),K.utilities.windowLevel.toLowHighRange(d,u)}},{key:"_getMultiplierFromDynamicRange",value:function(e,t){var n;if(t){var r,o=K.cache.getVolume(t),a=o.dimensions,i=o.getScalarData(),l=this._getImageDynamicRangeFromMiddleSlice(i,a),c=null==o||null===(r=o.metadata)||void 0===r?void 0:r.BitsStored,s=c?Math.pow(2,c):1/0;n=Math.min(l,s)}else n=this._getImageDynamicRangeFromViewport(e);var d=n/1024,u=4;return d>1&&(u=Math.round(d)),u}},{key:"_getImageDynamicRangeFromViewport",value:function(e){var t,n,r=e.getImageData().imageData,o=r.getDimensions();if(t=r.getScalarData?r.getScalarData():r.getPointData().getScalars(),1!==o[2])return this._getImageDynamicRangeFromMiddleSlice(t,o);if(t.getRange)n=t.getRange();else{var a=this._getMinMax(t,t.length);n=[a.min,a.max]}return n[1]-n[0]}},{key:"_getMinMax",value:function(e,t){for(var n=1/0,r=-1/0,o=0;o<t;o++){var a=e[o];a<n&&(n=a),a>r&&(r=a)}return{max:r,min:n}}}]),o}(xa);te(Sf,"toolName",void 0),Sf.toolName="WindowLevel";var xf=Sf;var Mf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.1,maxZoomScale:30,pinchToZoom:!0,pan:!0,invert:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"initialMousePosWorld",void 0),te(la(e),"dirVec",void 0),te(la(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.element,o=n.currentPoints.world,a=(0,K.getEnabledElement)(r).viewport.getCamera().focalPoint;e.initialMousePosWorld=o;var i=dc.vec3.fromValues(a[0]-o[0],a[1]-o[1],a[2]-o[2]);return i=dc.vec3.normalize(dc.vec3.create(),i),e.dirVec=i,!1})),te(la(e),"preTouchStartCallback",(function(t){if(!e.configuration.pinchToZoom)return e.preMouseDownCallback(t)})),te(la(e),"_dragParallelProjection",(function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=t.detail,i=a.element,l=a.deltaPoints,c=o?t.detail.deltaDistance.canvas:l.canvas[1],s=[i.clientWidth,i.clientHeight],d=r.parallelScale,u=r.focalPoint,v=r.position,f=(1-c*(1.5/s[1])*(e.configuration.invert?-1:1))*d,g=u,h=v;if(!e.configuration.zoomToCenter){var p=dc.vec3.distance(u,e.initialMousePosWorld),m=c*(5/s[1])*(e.configuration.invert?-1:1);f=(1-m)*d,h=dc.vec3.scaleAndAdd(dc.vec3.create(),v,e.dirVec,-p*m),g=dc.vec3.scaleAndAdd(dc.vec3.create(),u,e.dirVec,-p*m)}var w=n.getImageData(),E=[1,1,1];w&&(E=w.spacing);var y=e.configuration,I=y.minZoomScale,b=y.maxZoomScale,C=i.clientHeight*E[1]*.5,T=C/f,_=f,D=!1;w&&(T<I?(_=C/I,D=!0):T>=b&&(_=C/b,D=!0)),n.setCamera({parallelScale:_,focalPoint:D?u:g,position:D?v:h})})),te(la(e),"_dragPerspectiveProjection",(function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=t.detail,i=a.element,l=a.deltaPoints,c=o?t.detail.deltaDistance.canvas:l.canvas[1],s=[i.clientWidth,i.clientHeight],d=r.position,u=r.focalPoint,v=r.viewPlaneNormal,f=Zd().distance2BetweenPoints(d,u),g=Math.sqrt(f)/s[1],h=[-v[0],-v[1],-v[2]],p=e.configuration.invert?c/g:c*g,m=p*h[0];d[0]+=m,u[0]+=m,m=p*h[1],d[1]+=m,u[1]+=m,m=p*h[2],d[2]+=m,u[2]+=m,n.setCamera({position:d,focalPoint:u})})),e.initialMousePosWorld=[0,0,0],e.dirVec=[0,0,0],e.configuration.pinchToZoom?e.touchDragCallback=e._pinchCallback.bind(la(e)):e.touchDragCallback=e._dragCallback.bind(la(e)),e.mouseDragCallback=e._dragCallback.bind(la(e)),e}return Q(o,[{key:"_pinchCallback",value:function(e){if(e.detail.currentPointsList.length>1){var t=e.detail,n=t.element,r=t.currentPoints,o=(0,K.getEnabledElement)(n).viewport,a=o.getCamera(),i=r.world,l=a.focalPoint;this.initialMousePosWorld=i;var c=dc.vec3.fromValues(l[0]-i[0],l[1]-i[1],l[2]-i[2]);c=dc.vec3.normalize(dc.vec3.create(),c),this.dirVec=c,a.parallelProjection?this._dragParallelProjection(e,o,a,!0):this._dragPerspectiveProjection(e,o,a,!0),o.render()}this.configuration.pan&&this._panCallback(e)}},{key:"_dragCallback",value:function(e){var t=e.detail.element,n=(0,K.getEnabledElement)(t).viewport,r=n.getCamera();r.parallelProjection?this._dragParallelProjection(e,n,r):this._dragPerspectiveProjection(e,n,r),n.render()}},{key:"_panCallback",value:function(e){var t=e.detail,n=t.element,r=t.deltaPoints,o=(0,K.getEnabledElement)(n),a=r.world,i=o.viewport.getCamera(),l=i.focalPoint,c=i.position,s=[c[0]-a[0],c[1]-a[1],c[2]-a[2]],d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]];o.viewport.setCamera({focalPoint:d,position:s}),o.viewport.render()}}]),o}(xa);te(Mf,"toolName",void 0),Mf.toolName="Zoom";var kf=Mf;var Rf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"deltaY",void 0),e.deltaY=1,e}return Q(o,[{key:"mouseDragCallback",value:function(e){this._dragCallback(e)}},{key:"touchDragCallback",value:function(e){this._dragCallback(e)}},{key:"_dragCallback",value:function(e){var t,n=e.detail,r=n.deltaPoints,o=n.viewportId,a=n.renderingEngineId,i=(0,K.getEnabledElementByIds)(o,a).viewport,l=this.getTargetId(i),c=this.configuration,s=c.debounceIfNotLoaded,d=c.invert,u=c.loop,v=r.canvas[1];i instanceof K.VolumeViewport&&(t=l.split("volumeId:")[1]);var f=this._getPixelPerImage(i),g=v+this.deltaY;if(f)if(Math.abs(g)>=f){var h=Math.round(g/f);vc(i,{delta:d?-h:h,volumeId:t,debounceLoading:s,loop:u}),this.deltaY=g%f}else this.deltaY=g}},{key:"_getPixelPerImage",value:function(e){var t=e.element,n=this._getNumberOfSlices(e);return Math.max(2,t.offsetHeight/Math.max(n,8))}},{key:"_getNumberOfSlices",value:function(e){return e instanceof K.VolumeViewport?K.utilities.getImageSliceDataForVolumeViewport(e).numberOfSlices:e instanceof K.StackViewport?e.getImageIds().length:void 0}}]),o}(xa);te(Rf,"toolName",void 0),Rf.toolName="StackScroll";var Pf=Rf;function Nf(e,t){var n=it(e,2),r=n[0],o=n[1],a=it(t,2),i=a[0],l=a[1],c=dc.vec3.sub(dc.vec3.create(),o,r),s=dc.vec3.sub(dc.vec3.create(),i,l),d=dc.vec3.dot(c,s)/(dc.vec3.length(c)*dc.vec3.length(s));return 180*Math.acos(d)/Math.PI}var Af=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),e.touchDragCallback=e._dragCallback.bind(la(e)),e.mouseDragCallback=e._dragCallback.bind(la(e)),e}return Q(o,[{key:"_dragCallback",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints,o=t.startPoints,a=r.world,i=o.world,l=(0,K.getEnabledElement)(n).viewport,c=l.getCamera(),s=[.5*n.clientWidth,.5*n.clientHeight],d=l.canvasToWorld(s),u=Nf([i,d],[d,a]),v=c.viewPlaneNormal,f=c.viewUp,g=dc.vec3.sub(dc.vec3.create(),d,i),h=dc.vec3.sub(dc.vec3.create(),d,a),p=dc.vec3.cross(dc.vec3.create(),g,h);if(dc.vec3.dot(v,p)>0&&(u=-u),!Number.isNaN(u)){if(l instanceof K.BaseVolumeViewport){var m=u*Math.PI/180,w=dc.mat4.identity(new Float32Array(16));dc.mat4.rotate(w,w,m,v);var E=dc.vec3.transformMat4(dc.vec3.create(),f,w);l.setCamera({viewUp:E})}else{var y=l.getProperties().rotation;l.setProperties({rotation:y+u})}l.render()}}}]),o}(xa);te(Af,"toolName",void 0),Af.toolName="PlanarRotate";var Lf=Af;var Uf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"_configuration",void 0),e}return Q(o,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.wheel,r=t.element,o=n.direction,a=this.configuration.invert,i=(0,K.getEnabledElement)(r).viewport,l=o*(a?-1:1),c=this.getTargetId(i).split("volumeId:")[1];vc(i,{delta:l,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:c})}}]),o}(xa);te(Uf,"toolName",void 0),Uf.toolName="StackScrollMouseWheel";var Vf=Uf;var Bf={X:[1,0,0],Y:[0,1,0],Z:[0,0,1],CUSTOM:[]},jf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:Bf.Z,rotateIncrementDegrees:.5}};return ee(this,o),te(la(e=r.call(this,t,n)),"_configuration",void 0),e}return Q(o,[{key:"mouseWheelCallback",value:function(e){var t=e.detail,n=t.element,r=t.wheel,o=(0,K.getEnabledElement)(n).viewport,a=this.configuration,i=a.direction,l=a.rotateIncrementDegrees,c=o.getCamera(),s=c.viewUp,d=c.position,u=c.focalPoint,v=r.direction,f=it(u,3),g=f[0],h=f[1],p=f[2],m=it(i,3),w=m[0],E=m[1],y=m[2],I=v*l,b=[0,0,0],C=[0,0,0],T=[0,0,0],_=dc.mat4.identity(new Float32Array(16));dc.mat4.translate(_,_,[g,h,p]),dc.mat4.rotate(_,_,I,[w,E,y]),dc.mat4.translate(_,_,[-g,-h,-p]),dc.vec3.transformMat4(b,d,_),dc.vec3.transformMat4(C,u,_),dc.mat4.identity(_),dc.mat4.rotate(_,_,I,[w,E,y]),dc.vec3.transformMat4(T,s,_),o.setCamera({position:b,viewUp:T,focalPoint:C}),o.render()}}]),o}(xa);te(jf,"toolName",void 0),jf.toolName="VolumeRotateMouseWheel";var Hf=jf;var Wf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}};return ee(this,o),te(la(e=r.call(this,t,n)),"_bounds",void 0),e}return Q(o,[{key:"mouseClickCallback",value:function(e){var t=e.detail,n=t.element,r=t.currentPoints,o=(0,K.getEnabledElement)(n),a=o.viewport,i=o.renderingEngine,l=this.getTargetId(a);if(!l.startsWith("volumeId"))throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");var c=l.split("volumeId:")[1],s=-1/0,d=Xd(a,r.world,c,(function(e,t){if(e>s)return s=e,t}));if(d&&d.length){var u=this.configuration,v=u.targetViewportIds,f=u.toolGroupId;i.getViewports().filter((function(e){if((null==v?void 0:v.indexOf(e.id))>=0)return!0;var t=Ur(e.id,i.id);return!(!f||f!==(null==t?void 0:t.id))})).forEach((function(e){e instanceof K.VolumeViewport?lf(e,d):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")}))}}}]),o}(xa);te(Wf,"toolName",void 0),Wf.toolName="MIPJumpToClickTool";var Ff=Wf;var Gf=K.utilities.transformWorldToIndex,qf=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;Kl(o),e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{handles:{points:[kr(a),kr(a)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Qe(g,o);var h=Ps(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),na(c,h),g})),te(la(e),"isPointNearTool",(function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=it(t.data.handles.points,2),i=a[0],l=a[1],c=o.worldToCanvas(i),s=o.worldToCanvas(l),d={start:{x:c[0],y:c[1]},end:{x:s[0],y:s[1]}};return Zs([d.start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]])<=r})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),Kl(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}e.editData=null,e.isDrawing=!1}})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;s.handles.points[l]=kr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,K.getEnabledElement)(r).renderingEngine;na(h,i)})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_MOVE,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<c.length;v++){var f=c[v],g=f.annotationUID,h=f.data,p=h.handles,m=p.points,w=p.activeHandleIndex;u.annotationUID=g;var E=e.getStyle("lineWidth",u,f),y=e.getStyle("lineDash",u,f),I=e.getStyle("color",u,f),b=e.getStyle("shadow",u,f),C=m.map((function(e){return i.worldToCanvas(e)})),T=void 0;if(h.cachedStats[s]&&void 0!==h.cachedStats[s].unit?f.invalidated&&e._throttledCalculateCachedStats(f,d,t):(h.cachedStats[s]={length:null,unit:null},e._calculateCachedStats(f,d,t)),xe(g)){ce(f)||e.editData||null===w||(T=[C[w]]),T&&Oc(n,g,"0",C,{color:I,lineDash:y,lineWidth:E});var _="".concat(g,"-line");if(Sc(n,g,"1",C[0],C[1],{color:I,width:E,lineDash:y,shadow:b},_),a=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;var D=e._getTextLines(h,s);if(!h.handles.textBox.hasMoved){var O=Qs(C);h.handles.textBox.worldPosition=i.canvasToWorld(O)}var S=i.worldToCanvas(h.handles.textBox.worldPosition),x=Ac(n,g,"1",D,S,C,{},e.getLinkedTextBoxStyle(u,f)),M=x.x,k=x.y,R=x.width,P=x.height;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,k]),topRight:i.canvasToWorld([M+R,k]),bottomLeft:i.canvasToWorld([M,k+P]),bottomRight:i.canvasToWorld([M+R,k+P])}}}return a})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=Ps(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),Kl(r);var c=(0,K.getEnabledElement)(r).renderingEngine;na(c,l),e.preventDefault()}},{key:"_getTextLines",value:function(e,t){var n=e.cachedStats[t],r=n.length,o=n.unit;if(null!=r&&!isNaN(r))return["".concat(Zc(r)," ").concat(o)]}},{key:"_calculateLength",value:function(e,t){var n=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+r*r+o*o)}},{key:"_calculateCachedStats",value:function(e,t,n){for(var r=e.data,o=n.viewportId,a=n.renderingEngineId,i=r.handles.points[0],l=r.handles.points[1],c=r.cachedStats,s=Object.keys(c),d=0;d<s.length;d++){var u=s[d],v=this.getTargetIdImage(u,t);if(v){var f=v.imageData,g=v.dimensions,h=Ys(v),p=this._calculateLength(i,l)/h,m=Gf(f,i),w=Gf(f,l);this._isInsideVolume(m,w,g)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[u]={length:p,unit:zs(0,v)}}}e.invalidated=!1;var E=J.ANNOTATION_MODIFIED,y={annotation:e,viewportId:o,renderingEngineId:a};return(0,K.triggerEvent)(K.eventTarget,E,y),c}},{key:"_isInsideVolume",value:function(e,t,n){return K.utilities.indexWithinDimensions(e,n)&&K.utilities.indexWithinDimensions(t,n)}}]),o}(Fs);te(qf,"toolName",void 0),qf.toolName="Length";var zf=qf,Kf=h(847),Yf=h.n(Kf);var Jf=K.CONSTANTS.RENDERING_DEFAULTS;function $f(){return"rgb(0, 200, 0)"}function Zf(){return!0}function Xf(){return!0}function Qf(){return!0}var eg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t,n,a,i,l=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!0,autoPan:{enabled:!1,panSize:10},referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:K.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}};return ee(this,o),te(la(i=r.call(this,l,c)),"toolCenter",[0,0,0]),te(la(i),"_getReferenceLineColor",void 0),te(la(i),"_getReferenceLineControllable",void 0),te(la(i),"_getReferenceLineDraggableRotatable",void 0),te(la(i),"_getReferenceLineSlabThicknessControlsOn",void 0),te(la(i),"editData",void 0),te(la(i),"initializeViewport",(function(e){var t=e.renderingEngineId,n=e.viewportId,r=(0,K.getEnabledElementByIds)(n,t),o=r.FrameOfReferenceUID,a=r.viewport,l=a.element,c=a.getCamera(),s=c.position,d=c.focalPoint,u=c.viewPlaneNormal,v=i._getAnnotations(r);return(v=i.filterInteractableAnnotationsForElement(l,v)).length&&tt(v[0].annotationUID),Qe({highlighted:!1,metadata:{cameraPosition:kr(s),cameraFocalPoint:kr(d),FrameOfReferenceUID:o,toolName:i.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:i.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:n}},l),{normal:u,point:a.canvasToWorld([a.canvas.clientWidth/2,a.canvas.clientHeight/2])}})),te(la(i),"_getViewportsInfo",(function(){return ia(i.toolGroupId).viewportsInfo})),te(la(i),"computeToolCenter",(function(e){if(!e.length||1===e.length)throw new Error("For crosshairs to operate, at least two viewports must be given.");var t=it(e,3),n=t[0],r=t[1],o=t[2],a=i.initializeViewport(n),l=a.normal,c=a.point,s=i.initializeViewport(r),d=s.normal,u=s.point,v=[0,0,0],f=dc.vec3.create();if(o){var g=i.initializeViewport(o);v=g.normal,f=g.point}else dc.vec3.add(f,c,u),dc.vec3.scale(f,f,.5),dc.vec3.cross(v,l,d);var h=K.utilities.planar.planeEquation(l,c),p=K.utilities.planar.planeEquation(d,u),m=K.utilities.planar.planeEquation(v,f);i.toolCenter=K.utilities.planar.threePlaneIntersection(h,p,m);var w=(0,K.getEnabledElementByIds)(e[0].viewportId,e[0].renderingEngineId).renderingEngine;na(w,e.map((function(e){return e.viewportId})))})),te(la(i),"addNewAnnotation",(function(e){var t=e.detail,n=t.element,r=t.currentPoints.world,o=(0,K.getEnabledElement)(n),a=o.viewport;i._jump(o,r);for(var l=i._getAnnotations(o),c=i.filterInteractableAnnotationsForElement(a.element,l),s=c[0].data,d=s.handles.rotationPoints,u=[],v=0;v<d.length-1;++v){var f=d[v][1],g=i._getReferenceLineControllable(f.id),h=i._getReferenceLineDraggableRotatable(f.id);g&&h&&(u.push(f.id),v++)}return s.activeViewportIds=[].concat(u),s.handles.activeOperation=1,e.preventDefault(),Kl(n),i._activateModify(n),c[0]})),te(la(i),"cancel",(function(){console.log("Not implemented yet")})),te(la(i),"handleSelectedCallback",(function(e,t){var n=e.detail.element;t.highlighted=!0,i._activateModify(n),Kl(n),e.preventDefault()})),te(la(i),"isPointNearTool",(function(e,t,n,r){return!!i._pointNearTool(e,t,n,6)})),te(la(i),"toolSelectedCallback",(function(e,t,n){var r=e.detail.element;t.highlighted=!0,i._activateModify(r),Kl(r),e.preventDefault()})),te(la(i),"onCameraModified",(function(e){var t,n=e.detail.element,r=(0,K.getEnabledElement)(n),o=r.renderingEngine,a=r.viewport,l=i._getAnnotations(r),c=i.filterInteractableAnnotationsForElement(n,l)[0];if(c){var s=a.getCamera(),d=c.metadata.cameraPosition,u=[0,0,0];Zd().subtract(s.position,d,u);var v=c.metadata.cameraFocalPoint,f=[0,0,0];Zd().subtract(s.focalPoint,v,f),c.metadata.cameraPosition=kr(s.position),c.metadata.cameraFocalPoint=kr(s.focalPoint);var g=i._getReferenceLineControllable(a.id),h=i._getReferenceLineDraggableRotatable(a.id);if(!K.utilities.isEqual(s.position,d,.001)&&g&&h){var p=!1;K.utilities.isEqual(u,f,.001)||(p=!0);var m=Math.abs(Zd().dot(u,s.viewPlaneNormal))<.01;p||m||(i.toolCenter[0]+=u[0],i.toolCenter[1]+=u[1],i.toolCenter[2]+=u[2])}null!==(t=i.configuration.autoPan)&&void 0!==t&&t.enabled&&Ur(a.id,o.id).getViewportIds().filter((function(e){return e!==a.id})).forEach((function(e){i._autoPanViewportIfNecessary(e,o)}));var w=Ps(n,i.getToolName(),!1);na(o,w)}})),te(la(i),"mouseMoveCallback",(function(e,t){for(var n=e.detail,r=n.element,o=n.currentPoints.canvas,a=!1,l=0;l<t.length;l++){var c=t[l];if(!ce(c)){var s=c.data,d=c.highlighted;if(s.handles){var u=s.handles.activeOperation,v=s.activeViewportIds&&s.activeViewportIds.length>0?kr(s.activeViewportIds):[];s.activeViewportIds=[],s.handles.activeOperation=null;var f;(f=!!i.getHandleNearImagePoint(r,c,o,6)||i._pointNearTool(r,c,o,6))&&!d||!f&&d?(c.highlighted=!d,a=!0):s.handles.activeOperation===u&&i._areViewportIdArraysEqual(s.activeViewportIds,v)||(a=!0)}}}return a})),te(la(i),"filterInteractableAnnotationsForElement",(function(e,t){if(!t||!t.length)return[];var n=(0,K.getEnabledElement)(e).viewportId;return t.filter((function(e){return e.data.viewportId===n}))})),te(la(i),"renderAnnotation",(function(e,t){var n=!1,r=e.viewport,o=e.renderingEngine,a=r.element,l=i._getAnnotations(e),c=r.getCamera(),s=i.filterInteractableAnnotationsForElement(a,l)[0];if(null==l||!l.length||null==s||!s.data)return n;var d=s.annotationUID,u=r.canvas,v=u.clientWidth,f=u.clientHeight,g=Math.sqrt(v*v+f*f),h=Math.min(v,f),p=s.data,m=r.worldToCanvas(i.toolCenter),w=i._filterAnnotationsByUniqueViewportOrientations(e,l),E=[],y=[0,0,v,f];w.forEach((function(e){var t=e.data;t.handles.toolCenter=i.toolCenter;var n=o.getViewport(t.viewportId),a=n.getCamera(),l=i._getReferenceLineControllable(n.id),s=i._getReferenceLineDraggableRotatable(n.id),d=i._getReferenceLineSlabThicknessControlsOn(n.id),u=n.canvas,v=u.clientWidth,f=u.clientHeight,p=Math.sqrt(v*v+f*f),I=[.5*v,.5*f],b=n.canvasToWorld(I),C=[0,0,0];Zd().cross(c.viewPlaneNormal,a.viewPlaneNormal,C),Zd().normalize(C),Zd().multiplyScalar(C,p);var T=[0,0,0];Zd().add(b,C,T);var _=[0,0,0];Zd().subtract(b,C,_);var D=r.worldToCanvas(T),O=r.worldToCanvas(b),S=dc.vec2.create();dc.vec2.subtract(S,D,O),dc.vec2.normalize(S,S);var x=dc.vec2.create();dc.vec2.scale(x,S,100*g);var M=dc.vec2.create();dc.vec2.scale(M,S,.4*h);var k=dc.vec2.create();dc.vec2.scale(k,S,.2*h);var R=dc.vec2.create(),P=i.configuration.referenceLinesCenterGapRadius;dc.vec2.scale(R,S,2===w.length?P:0);var N=dc.vec2.create(),A=dc.vec2.create(),L=dc.vec2.create(),U=dc.vec2.create(),V=dc.vec2.clone(m);s&&l||(V=dc.vec2.clone(O)),dc.vec2.add(N,V,R),dc.vec2.add(A,V,x),dc.vec2.subtract(L,V,R),dc.vec2.subtract(U,V,x),Nd(N,A,y),Nd(L,U,y);var B=dc.vec2.create();dc.vec2.subtract(B,m,M);var j=dc.vec2.create();dc.vec2.add(j,m,M);var H=dc.vec2.clone(m);!s&&d&&(H=dc.vec2.clone(O));var W=kr(i.toolCenter);!s&&d&&(W=kr(b));var F=[0,0,0];Zd().subtract(T,_,F),Zd().normalize(F);var G=c.viewPlaneNormal,q=Yf().buildFromDegree().rotate(90,G).matrix,z=[0,0,0];dc.vec3.transformMat4(z,F,q);var K=n.getSlabThickness(),Y=[].concat(z);Zd().multiplyScalar(Y,K);var J=[0,0,0];Zd().add(W,Y,J);var $=r.worldToCanvas(J),Z=dc.vec2.create();dc.vec2.subtract(Z,H,$);var X=dc.vec2.create();dc.vec2.subtract(X,H,x),dc.vec2.add(X,X,Z);var Q=dc.vec2.create();dc.vec2.add(Q,H,x),dc.vec2.add(Q,Q,Z),Nd(X,Q,y);var ee=dc.vec2.create();dc.vec2.add(ee,H,x),dc.vec2.subtract(ee,ee,Z);var te=dc.vec2.create();dc.vec2.subtract(te,H,x),dc.vec2.subtract(te,te,Z),Nd(ee,te,y);var ne=dc.vec2.create(),re=dc.vec2.create(),oe=dc.vec2.create(),ae=dc.vec2.create();dc.vec2.subtract(ne,H,k),dc.vec2.add(ne,ne,Z),dc.vec2.add(re,H,k),dc.vec2.add(re,re,Z),dc.vec2.subtract(oe,H,k),dc.vec2.subtract(oe,oe,Z),dc.vec2.add(ae,H,k),dc.vec2.subtract(ae,ae,Z),E.push([n,N,A,L,U,X,Q,ee,te,B,j,ne,re,oe,ae])}));var I=[],b=[],C=i._getReferenceLineColor(r.id),T=void 0!==C?C:"rgb(200, 200, 200)";return E.forEach((function(e,n){var o,a,l=e[0],c=i._getReferenceLineColor(l.id),s=i._getReferenceLineControllable(l.id),u=i._getReferenceLineDraggableRotatable(l.id)||(null===(o=i.configuration.mobile)||void 0===o?void 0:o.enabled),v=i._getReferenceLineSlabThicknessControlsOn(l.id)||(null===(a=i.configuration.mobile)||void 0===a?void 0:a.enabled),f=p.activeViewportIds.find((function(e){return e===l.id})),g=void 0!==c?c:"rgb(200, 200, 200)",h=1,m=null!==p.handles.activeOperation&&1===p.handles.activeOperation&&f;m&&(h=2.5);var w="".concat(n);if(s&&u?(w="".concat(n,"One"),Sc(t,d,w,e[1],e[2],{color:g,lineWidth:h}),w="".concat(n,"Two"),Sc(t,d,w,e[3],e[4],{color:g,lineWidth:h})):Sc(t,d,w,e[2],e[4],{color:g,lineWidth:h}),s){var E;g=void 0!==c?c:"rgb(200, 200, 200)";var y=2===p.handles.activeOperation,C=[e[9],e[10]],T=[r.canvasToWorld(e[9]),l,e[1],e[2]],_=[r.canvasToWorld(e[10]),l,e[3],e[4]];I.push(T,_);var D=3===p.handles.activeOperation,O=[e[11],e[12],e[13],e[14]],S=[r.canvasToWorld(e[11]),l,e[5],e[6]],x=[r.canvasToWorld(e[12]),l,e[5],e[6]],M=[r.canvasToWorld(e[13]),l,e[7],e[8]],k=[r.canvasToWorld(e[14]),l,e[7],e[8]];if(b.push(S,x,M,k),(m||null!==(E=i.configuration.mobile)&&void 0!==E&&E.enabled)&&!y&&!D&&u&&v){var R,P,N,A,L,U,V,B,j="".concat(n,"One");Oc(t,d,j,C,{color:g,handleRadius:null!==(R=i.configuration.mobile)&&void 0!==R&&R.enabled?null===(P=i.configuration.mobile)||void 0===P?void 0:P.handleRadius:3,opacity:null!==(N=i.configuration.mobile)&&void 0!==N&&N.enabled?null===(A=i.configuration.mobile)||void 0===A?void 0:A.opacity:1,type:"circle"}),j="".concat(n,"Two"),Oc(t,d,j,O,{color:g,handleRadius:null!==(L=i.configuration.mobile)&&void 0!==L&&L.enabled?null===(U=i.configuration.mobile)||void 0===U?void 0:U.handleRadius:3,opacity:null!==(V=i.configuration.mobile)&&void 0!==V&&V.enabled?null===(B=i.configuration.mobile)||void 0===B?void 0:B.opacity:1,type:"rect"})}else if(m&&!y&&!D&&u){var H,W,F,G,q="".concat(n);Oc(t,d,q,C,{color:g,handleRadius:null!==(H=i.configuration.mobile)&&void 0!==H&&H.enabled?null===(W=i.configuration.mobile)||void 0===W?void 0:W.handleRadius:3,opacity:null!==(F=i.configuration.mobile)&&void 0!==F&&F.enabled?null===(G=i.configuration.mobile)||void 0===G?void 0:G.opacity:1,type:"circle"})}else if(f&&!y&&!D&&v){var z,K,Y,J,$="".concat(n);Oc(t,d,$,O,{color:g,handleRadius:null!==(z=i.configuration.mobile)&&void 0!==z&&z.enabled?null===(K=i.configuration.mobile)||void 0===K?void 0:K.handleRadius:3,opacity:null!==(Y=i.configuration.mobile)&&void 0!==Y&&Y.enabled?null===(J=i.configuration.mobile)||void 0===J?void 0:J.opacity:1,type:"rect"})}else if(y&&u){var Z="".concat(n);Oc(t,d,Z,C,{color:g,handleRadius:2,fill:g,type:"circle"})}else D&&f&&v&&Oc(t,d,w,O,{color:g,handleRadius:2,fill:g,type:"rect"});l.getSlabThickness()>.5&&v&&(w="".concat(n,"STOne"),Sc(t,d,w,e[5],e[6],{color:g,width:1,lineDash:[2,3]}),w="".concat(n,"STTwo"),Sc(t,d,w,e[7],e[8],{color:g,width:e,lineDash:[2,3]}))}})),n=!0,p.handles.rotationPoints=I,p.handles.slabThicknessPoints=b,i.configuration.viewportIndicators&&_c(t,d,"0",[.95*v,.05*f],.01*g,{color:T,fill:T}),n})),te(la(i),"_getAnnotations",(function(e){var t=e.viewport;return Xe(i.getToolName(),t.element)})),te(la(i),"_onNewVolume",(function(e){var t=i._getViewportsInfo();i.computeToolCenter(t)})),te(la(i),"_areViewportIdArraysEqual",(function(e,t){return e.length===t.length&&(e.forEach((function(e){for(var n=!1,r=0;r<t.length;++r)if(e===t[r]){n=!0;break}if(!1===n)return!1})),!0)})),te(la(i),"_getAnnotationsForViewportsWithDifferentCameras",(function(e,t){var n=e.viewportId,r=e.renderingEngine,o=e.viewport,a=t.filter((function(e){return e.data.viewportId!==n}));if(!a||!a.length)return[];var i=o.getCamera(),l=i.viewPlaneNormal,c=i.position,s=a.filter((function(e){var t=e.data.viewportId,n=r.getViewport(t).getCamera();return!(K.utilities.isEqual(n.viewPlaneNormal,l,.01)&&K.utilities.isEqual(n.position,c,1))}));return s})),te(la(i),"_filterViewportWithSameOrientation",(function(e,t,n){var r=e.renderingEngine,o=t.data,a=r.getViewport(o.viewportId),l=n.filter((function(e){var t=e.data,n=r.getViewport(t.viewportId);return!0===i._getReferenceLineControllable(n.id)}));if(!l||!l.length)return[];var c=a.getCamera(),s=c.viewPlaneNormal;return Zd().normalize(s),l.filter((function(e){var t=e.data.viewportId,n=r.getViewport(t).getCamera(),o=n.viewPlaneNormal;return Zd().normalize(o),K.utilities.isEqual(s,o,.01)&&K.utilities.isEqual(c.viewUp,n.viewUp,.01)}))})),te(la(i),"_filterAnnotationsByUniqueViewportOrientations",(function(e,t){var n=e.renderingEngine,r=e.viewport,o=r.getCamera().viewPlaneNormal;Zd().normalize(o);for(var a=t.filter((function(e){var t=e.data,o=n.getViewport(t.viewportId),a=i._getReferenceLineControllable(o.id);return r!==o&&!0===a})),l=[],c=0;c<a.length;++c){var s=a[c],d=s.data.viewportId,u=n.getViewport(d).getCamera(),v=u.viewPlaneNormal;if(Zd().normalize(v),!K.utilities.isEqual(o,v,.01)&&!K.utilities.isOpposite(o,v,.01)){for(var f=!1,g=0;g<l.length;++g){var h=l[g].data.viewportId,p=n.getViewport(h).getCamera();K.utilities.isEqual(p.viewPlaneNormal,u.viewPlaneNormal,.01)&&K.utilities.isEqual(p.position,u.position,1)&&(f=!0)}f||l.push(s)}}for(var m=t.filter((function(e){var t=e.data,o=n.getViewport(t.viewportId),a=i._getReferenceLineControllable(o.id);return r!==o&&!0!==a})),w=0;w<m.length;++w){var E=m[w],y=E.data.viewportId,I=n.getViewport(y).getCamera(),b=I.viewPlaneNormal;if(Zd().normalize(b),!K.utilities.isEqual(o,b,.01)&&!K.utilities.isOpposite(o,b,.01)){for(var C=!1,T=0;T<l.length;++T){var _=l[T].data.viewportId,D=n.getViewport(_).getCamera();K.utilities.isEqual(D.viewPlaneNormal,I.viewPlaneNormal,.01)&&K.utilities.isEqual(D.position,I.position,1)&&(C=!0)}C||l.push(E)}}for(var O=i._getAnnotationsForViewportsWithDifferentCameras(e,t),S=function(){var e=O[x];if(l.some((function(t){return t===e})))return"continue";var t=e.data.viewportId,r=n.getViewport(t).getCamera(),a=r.viewPlaneNormal;if(Zd().normalize(a),K.utilities.isEqual(o,a,.01)||K.utilities.isOpposite(o,a,.01))return"continue";for(var i=!1,c=0;c<l.length;++c){var s=l[c].data.viewportId,d=n.getViewport(s).getCamera();K.utilities.isEqual(d.viewPlaneNormal,r.viewPlaneNormal,.01)&&K.utilities.isEqual(d.position,r.position,1)&&(i=!0)}i||l.push(e)},x=0;x<O.length;++x)S();return l})),te(la(i),"_checkIfViewportsRenderingSameScene",(function(e,t){var n=e.getActors(),r=t.getActors(),o=!0;return n.forEach((function(e){n.length===r.length&&void 0!==r.find((function(t){return t.uid===e.uid}))||(o=!1)})),o})),te(la(i),"_jump",(function(e,t){Fe.isInteractingWithTool=!0;var n=e.viewport,r=e.renderingEngine,o=i._getAnnotations(e),a=[0,0,0];Zd().subtract(t,i.toolCenter,a);var l=i._getAnnotationsForViewportsWithDifferentCameras(e,o).filter((function(e){var t=e.data,o=r.getViewport(t.viewportId),a=i._checkIfViewportsRenderingSameScene(n,o);return i._getReferenceLineControllable(o.id)&&i._getReferenceLineDraggableRotatable(o.id)&&a}));return 0===l.length?(Fe.isInteractingWithTool=!1,!1):(i._applyDeltaShiftToSelectedViewportCameras(r,l,a),Fe.isInteractingWithTool=!1,!0)})),te(la(i),"_activateModify",(function(e){var t;Fe.isInteractingWithTool=!(null!==(t=i.configuration.mobile)&&void 0!==t&&t.enabled),e.addEventListener(J.MOUSE_UP,i._endCallback),e.addEventListener(J.MOUSE_DRAG,i._dragCallback),e.addEventListener(J.MOUSE_CLICK,i._endCallback),e.addEventListener(J.TOUCH_END,i._endCallback),e.addEventListener(J.TOUCH_DRAG,i._dragCallback),e.addEventListener(J.TOUCH_TAP,i._endCallback)})),te(la(i),"_deactivateModify",(function(e){Fe.isInteractingWithTool=!1,e.removeEventListener(J.MOUSE_UP,i._endCallback),e.removeEventListener(J.MOUSE_DRAG,i._dragCallback),e.removeEventListener(J.MOUSE_CLICK,i._endCallback),e.removeEventListener(J.TOUCH_END,i._endCallback),e.removeEventListener(J.TOUCH_DRAG,i._dragCallback),e.removeEventListener(J.TOUCH_TAP,i._endCallback)})),te(la(i),"_endCallback",(function(e){var t=e.detail.element;i.editData.annotation.data.handles.activeOperation=null,i.editData.annotation.data.activeViewportIds=[],i._deactivateModify(t),zl(t),i.editData=null;var n=(0,K.getEnabledElement)(t).renderingEngine,r=Ps(t,i.getToolName(),!1);na(n,r)})),te(la(i),"_dragCallback",(function(e){var t=e.detail,n=t.deltaPoints.world;if(!(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)){var r=t.element,o=(0,K.getEnabledElement)(r),a=o.renderingEngine,l=o.viewport,c=i._getAnnotations(o),s=i.filterInteractableAnnotationsForElement(r,c)[0];if(s){var d=s.data.handles,u=e.detail.currentPoints.canvas;if(1===d.activeOperation){var v=i._getAnnotationsForViewportsWithDifferentCameras(o,c).filter((function(e){var t=e.data,n=a.getViewport(t.viewportId),r=i._getReferenceLineControllable(n.id),o=i._getReferenceLineDraggableRotatable(n.id);return!0===r&&!0===o&&s.data.activeViewportIds.find((function(e){return e===n.id}))}));i._applyDeltaShiftToSelectedViewportCameras(a,v,n)}else if(2===d.activeOperation){var f=i._getAnnotationsForViewportsWithDifferentCameras(o,c).filter((function(e){var t=e.data,n=a.getViewport(t.viewportId),r=i._getReferenceLineControllable(n.id),o=i._getReferenceLineDraggableRotatable(n.id);return!0===r&&!0===o})),g=dc.vec2.create(),h=dc.vec2.create(),p=[i.toolCenter[0],i.toolCenter[1],i.toolCenter[2]],m=l.worldToCanvas(p),w=t.currentPoints.canvas,E=dc.vec2.create();dc.vec2.sub(E,w,t.deltaPoints.canvas),dc.vec2.sub(g,E,m),dc.vec2.sub(h,w,m);var y=dc.vec2.angle(g,h);i._isClockWise(m,E,w)&&(y*=-1),y=Math.round(100*y)/100;var I=l.getCamera().viewPlaneNormal,b=Yf().buildFromRadian().translate(p[0],p[1],p[2]).rotate(y,I).translate(-p[0],-p[1],-p[2]).matrix,C=[];f.forEach((function(e){var t=e.data;t.handles.toolCenter=p;var n=a.getViewport(t.viewportId),r=n.getCamera(),o=r.viewUp,i=r.position,l=r.focalPoint;o[0]+=i[0],o[1]+=i[1],o[2]+=i[2],dc.vec3.transformMat4(l,l,b),dc.vec3.transformMat4(i,i,b),dc.vec3.transformMat4(o,o,b),o[0]-=i[0],o[1]-=i[1],o[2]-=i[2],n.setCamera({position:i,viewUp:o,focalPoint:l}),C.push(n.id)})),a.renderViewports(C)}else if(3===d.activeOperation){var T=i._getAnnotationsForViewportsWithDifferentCameras(o,c).filter((function(e){var t=e.data,n=a.getViewport(t.viewportId),r=i._getReferenceLineControllable(n.id),o=i._getReferenceLineSlabThicknessControlsOn(n.id);return!0===r&&!0===o&&s.data.activeViewportIds.find((function(e){return e===n.id}))}));if(0===T.length)return;var _=i._filterViewportWithSameOrientation(o,T[0],c),D=[];D.push(l.id),_.forEach((function(e){var r=e.data,o=a.getViewport(r.viewportId),c=o.getCamera().viewPlaneNormal,d=Zd().dot(n,c),v=kr(c);if(Zd().multiplyScalar(v,d),Math.abs(v[0])>.001||Math.abs(v[1])>.001||Math.abs(v[2])>.001){var f=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),g=t.lastPoints.world,h=[0,0,0],p=[i.toolCenter[0],i.toolCenter[1],i.toolCenter[2]];if(!i._getReferenceLineDraggableRotatable(o.id)){var m=i.editData.annotation.data.handles.rotationPoints.filter((function(e){return e[1].uid===o.id}));if(2===m.length){var w=l.canvasToWorld(m[0][3]),E=l.canvasToWorld(m[1][3]);Zd().add(w,E,p),Zd().multiplyScalar(p,.5)}}Zd().subtract(g,p,h);var y=Zd().dot(h,c),I=kr(c);Zd().multiplyScalar(I,y);var b=[I[0],I[1],I[2]];dc.vec3.normalize(b,b);var C=[v[0],v[1],v[2]];dc.vec3.normalize(C,C);var T=o.getSlabThickness();K.utilities.isOpposite(b,C,.001)?T-=f:T+=f,T=Math.abs(T),T=Math.max(Jf.MINIMUM_SLAB_THICKNESS,T),i._pointNearReferenceLine(s,u,6,o)&&(T=Jf.MINIMUM_SLAB_THICKNESS),Ur(o.id,a.id).getToolInstance(i.getToolName()).setSlabThickness(o,T),D.push(o.id)}})),a.renderViewports(D)}}}})),te(la(i),"_pointNearReferenceLine",(function(e,t,n,r){for(var o=e.data.handles.rotationPoints,a=0;a<o.length-1;++a){var l=o[a][1];if(l.id===r.id&&i._getReferenceLineControllable(l.id)){var c={start:{x:o[a][2][0],y:o[a][2][1]},end:{x:o[a][3][0],y:o[a][3][1]}},s=Zs([c.start.x,c.start.y],[c.end.x,c.end.y],[t[0],t[1]]),d={start:{x:o[a+1][2][0],y:o[a+1][2][1]},end:{x:o[a+1][3][0],y:o[a+1][3][1]}},u=Zs([d.start.x,d.start.y],[d.end.x,d.end.y],[t[0],t[1]]);if(s<=n||u<=n)return!0;a++}}return!1})),i._getReferenceLineColor=(null===(e=l.configuration)||void 0===e?void 0:e.getReferenceLineColor)||$f,i._getReferenceLineControllable=(null===(t=l.configuration)||void 0===t?void 0:t.getReferenceLineControllable)||Zf,i._getReferenceLineDraggableRotatable=(null===(n=l.configuration)||void 0===n?void 0:n.getReferenceLineDraggableRotatable)||Xf,i._getReferenceLineSlabThicknessControlsOn=(null===(a=l.configuration)||void 0===a?void 0:a.getReferenceLineSlabThicknessControlsOn)||Qf,i}return Q(o,[{key:"onSetToolActive",value:function(){var e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this.computeToolCenter(e)}},{key:"onSetToolPassive",value:function(){var e=this._getViewportsInfo();this.computeToolCenter(e)}},{key:"onSetToolEnabled",value:function(){var e=this._getViewportsInfo();this.computeToolCenter(e)}},{key:"onSetToolDisabled",value:function(){var e=this,t=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(t),t.forEach((function(t){var n=t.renderingEngineId,r=t.viewportId,o=(0,K.getEnabledElementByIds)(r,n);if(o){var a=e._getAnnotations(o);null!=a&&a.length&&a.forEach((function(e){tt(e.annotationUID)}))}}))}},{key:"getHandleNearImagePoint",value:function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=this._getRotationHandleNearImagePoint(o,t,n,r);return null!==a||null!==(a=this._getSlabThicknessHandleNearImagePoint(o,t,n,r))?a:void 0}},{key:"_unsubscribeToViewportNewVolumeSet",value:function(e){var t=this;e.forEach((function(e){var n=e.viewportId,r=e.renderingEngineId;(0,K.getEnabledElementByIds)(n,r).viewport.element.removeEventListener(K.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,t._onNewVolume)}))}},{key:"_subscribeToViewportNewVolumeSet",value:function(e){var t=this;e.forEach((function(e){var n=e.viewportId,r=e.renderingEngineId;(0,K.getEnabledElementByIds)(n,r).viewport.element.addEventListener(K.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,t._onNewVolume)}))}},{key:"_autoPanViewportIfNecessary",value:function(e,t){var n=t.getViewport(e),r=n.canvas,o=r.clientWidth,a=r.clientHeight,i=n.worldToCanvas(this.toolCenter),l=this.configuration.autoPan.panSize,c=[i[0],i[1]];if(i[0]<0?c[0]=l:i[0]>o&&(c[0]=o-l),i[1]<0?c[1]=l:i[1]>a&&(c[1]=a-l),c[0]!==i[0]||c[1]!==i[1]){var s=n.canvasToWorld(c),d=[s[0]-this.toolCenter[0],s[1]-this.toolCenter[1],s[2]-this.toolCenter[2]],u=n.getCamera(),v=u.focalPoint,f=u.position,g=[f[0]-d[0],f[1]-d[1],f[2]-d[2]],h=[v[0]-d[0],v[1]-d[1],v[2]-d[2]];n.setCamera({focalPoint:h,position:g}),n.render()}}},{key:"setSlabThickness",value:function(e,t){var n,r=this.configuration.filterActorUIDsToSetSlabThickness;r&&r.length>0&&(n=r);var o=this.configuration.slabThicknessBlendMode;t===Jf.MINIMUM_SLAB_THICKNESS&&(o=K.Enums.BlendModes.COMPOSITE),e.setBlendMode(o,n,!1),e.setSlabThickness(t,n)}},{key:"_isClockWise",value:function(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}},{key:"_applyDeltaShiftToSelectedViewportCameras",value:function(e,t,n){var r=this;t.forEach((function(t){r._applyDeltaShiftToViewportCamera(e,t,n)}))}},{key:"_applyDeltaShiftToViewportCamera",value:function(e,t,n){var r=t.data,o=e.getViewport(r.viewportId),a=o.getCamera(),i=a.viewPlaneNormal,l=Zd().dot(n,i),c=kr(i);if(Zd().multiplyScalar(c,l),Math.abs(c[0])>.001||Math.abs(c[1])>.001||Math.abs(c[2])>.001){var s=[0,0,0],d=[0,0,0];Zd().add(a.focalPoint,c,s),Zd().add(a.position,c,d),o.setCamera({focalPoint:s,position:d}),o.render()}}},{key:"_getRotationHandleNearImagePoint",value:function(e,t,n,r){for(var o=t.data,a=o.handles.rotationPoints,i=0;i<a.length;i++){var l=a[i][0],c=a[i][1];if(this._getReferenceLineControllable(c.id)&&this._getReferenceLineDraggableRotatable(c.id)){var s=e.worldToCanvas(l);if(dc.vec2.distance(n,s)<r)return o.handles.activeOperation=2,this.editData={annotation:t},l}}return null}},{key:"_getSlabThicknessHandleNearImagePoint",value:function(e,t,n,r){for(var o=t.data,a=o.handles.slabThicknessPoints,i=0;i<a.length;i++){var l=a[i][0],c=a[i][1];if(this._getReferenceLineControllable(c.id)&&this._getReferenceLineSlabThicknessControlsOn(c.id)){var s=e.worldToCanvas(l);if(dc.vec2.distance(n,s)<r)return o.handles.activeOperation=3,o.activeViewportIds=[c.id],this.editData={annotation:t},l}}return null}},{key:"_pointNearTool",value:function(e,t,n,r){for(var o=this,a=(0,K.getEnabledElement)(e).viewport.canvas,i=a.clientWidth,l=a.clientHeight,c=Math.sqrt(i*i+l*l),s=t.data,d=s.handles.rotationPoints,u=s.handles.slabThicknessPoints,v=[],f=0;f<d.length-1;++f){var g=d[f][1],h=this._getReferenceLineControllable(g.id),p=this._getReferenceLineDraggableRotatable(g.id);if(h&&p){var m={start:{x:d[f][2][0],y:d[f][2][1]},end:{x:d[f][3][0],y:d[f][3][1]}},w=Zs([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]),E={start:{x:d[f+1][2][0],y:d[f+1][2][1]},end:{x:d[f+1][3][0],y:d[f+1][3][1]}},y=Zs([E.start.x,E.start.y],[E.end.x,E.end.y],[n[0],n[1]]);(w<=r||y<=r)&&(v.push(g.id),s.handles.activeOperation=1),f++}}for(var I=function(e){var t=u[e][1];if(v.find((function(e){return e===t.id})))return b=e,"continue";var a=o._getReferenceLineControllable(t.id),i=o._getReferenceLineSlabThicknessControlsOn(t.id);if(!a||!i)return b=e,"continue";var l=u[e][2],d=u[e][3],f=dc.vec2.create();dc.vec2.add(f,l,d),dc.vec2.scale(f,f,.5);var g=dc.vec2.create();dc.vec2.subtract(g,l,f),dc.vec2.normalize(g,g);var h=dc.vec2.create();dc.vec2.scale(h,g,.05*c);var p=dc.vec2.create(),m=dc.vec2.create();dc.vec2.add(p,f,h),dc.vec2.subtract(m,f,h);var w={start:{x:p[0],y:p[1]},end:{x:l[0],y:l[1]}},E=Zs([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]),y={start:{x:m[0],y:m[1]},end:{x:d[0],y:d[1]}},I=Zs([y.start.x,y.start.y],[y.end.x,y.end.y],[n[0],n[1]]);(E<=r||I<=r)&&(v.push(t.id),s.handles.activeOperation=null),e++,b=e},b=0;b<u.length-1;++b)I(b);return s.activeViewportIds=[].concat(v),this.editData={annotation:t},1===s.handles.activeOperation}}]),o}(Fs);te(eg,"toolName",void 0),eg.toolName="Crosshairs";var tg=eg;var ng=K.CONSTANTS.EPSILON,rg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:""}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",{}),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"_init",(function(){var t=(0,K.getRenderingEngines)()[0];if(t){var n=t.getViewports();n=Ms(n,e.getToolName());var r=t.getViewport(e.configuration.sourceViewportId);if(r&&r.getImageData()){var o=r.element,a=r.getCamera(),i=a.viewUp,l=a.viewPlaneNormal,c=K.utilities.getViewportImageCornersInWorld(r),s=e.editData.annotation,d=r.getFrameOfReferenceUID();if(s)e.editData.annotation.data.handles.points=c;else{var u={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(l),viewUp:kr(i),FrameOfReferenceUID:d,referencedImageId:null},data:{handles:{points:c}}};Qe(u,o),s=u}e.editData={sourceViewport:r,renderingEngine:t,annotation:s},na(t,n.filter((function(e){return e.id!==r.id})).map((function(e){return e.id})))}}})),te(la(e),"onSetToolEnabled",(function(){e._init()})),te(la(e),"onCameraModified",(function(t){e._init()})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=t.viewport,i=e.editData,l=i.annotation,c=i.sourceViewport,s=!1;if(!c)return s;if(c.id===a.id)return s;if(!l||null==l||null===(r=l.data)||void 0===r||null===(o=r.handles)||void 0===o||!o.points)return s;var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=l.data.handles.points[0],v=l.data.handles.points[1],f=l.data.handles.points[2],g=l.data.handles.points[3],h=a.getCamera(),p=h.focalPoint,m=h.viewPlaneNormal,w=c.getCamera().viewPlaneNormal;if(e.isParallel(m,w))return s;var E=K.utilities.planar.planeEquation(m,p),y=[u,f,v,g],I=[u,v,f,g],b=y,C=dc.vec3.subtract(dc.vec3.create(),y[0],y[1]);C=dc.vec3.normalize(dc.vec3.create(),C);var T=dc.vec3.subtract(dc.vec3.create(),y[2],y[0]);T=dc.vec3.normalize(dc.vec3.create(),T);var _=dc.vec3.cross(dc.vec3.create(),C,T);if(e.isParallel(_,m))return s;e.isPerpendicular(C,m)&&(b=I);var D=K.utilities.planar.linePlaneIntersection(b[0],b[1],E),O=K.utilities.planar.linePlaneIntersection(b[2],b[3],E),S=l.annotationUID;d.annotationUID=S;var x=e.getStyle("lineWidth",d,l),M=e.getStyle("lineDash",d,l),k=e.getStyle("color",d,l),R=e.getStyle("shadow",d,l),P=[D,O].map((function(e){return a.worldToCanvas(e)})),N="".concat(S,"-line");return Sc(n,S,"1",P[0],P[1],{color:k,width:x,lineDash:M,shadow:R},N),!0})),te(la(e),"isPerpendicular",(function(e,t){var n=dc.vec3.dot(e,t);return Math.abs(n)<ng})),e}return Q(o,[{key:"isParallel",value:function(e,t){return Math.abs(dc.vec3.dot(e,t))>1-ng}}]),o}(js);te(rg,"toolName",void 0),rg.toolName="ReferenceLines";var og=rg;function ag(e,t,n,r){var o=dc.vec3.create();dc.vec3.cross(o,t,e);var a=dc.vec3.fromValues.apply(dc.vec3,kr(n)),i=dc.vec3.fromValues.apply(dc.vec3,kr(r)),l=dc.vec3.create();dc.vec3.subtract(l,a,i);var c=dc.vec3.length(l);if(c<1e-4)return{worldWidth:0,worldHeight:0};var s=dc.vec3.dot(l,o)/(c*dc.vec3.length(o));return{worldWidth:Math.sqrt(1-s*s)*c,worldHeight:s*c}}var ig=K.utilities.transformWorldToIndex,lg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",!1),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=r.canvas,l=(0,K.getEnabledElement)(o),c=l.viewport,s=l.renderingEngine;e.isDrawing=!0;var d=c.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=e.getReferencedImageId(c,a,u,v),g=c.getFrameOfReferenceUID(),h={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(u),viewUp:kr(v),FrameOfReferenceUID:g,referencedImageId:f},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[kr(a),kr(a),kr(a),kr(a)],activeHandleIndex:null},cachedStats:{},initialRotation:c.getRotation()}};Qe(h,o);var p=Ps(o,e.getToolName());return e.editData={annotation:h,viewportIdsToRender:p,centerCanvas:i,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(s,p),h})),te(la(e),"isPointNearTool",(function(t,n,r,o){var a=(0,K.getEnabledElement)(t).viewport,i=it(es(n.data.handles.points.map((function(e){return a.worldToCanvas(e)}))),2),l=i[0],c=i[1],s={left:Math.min(l[0],c[0])+o/2,top:Math.min(l[1],c[1])+o/2,width:Math.abs(l[0]-c[0])-o,height:Math.abs(l[1]-c[1])-o},d={left:Math.min(l[0],c[0])-o/2,top:Math.min(l[1],c[1])-o/2,width:Math.abs(l[0]-c[0])+o,height:Math.abs(l[1]-c[1])+o},u=e._pointInEllipseCanvas(s,r);return!(!e._pointInEllipseCanvas(d,r)||u)})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},Kl(r),e._activateModify(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),t.preventDefault()})),te(la(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l,c,s,d,u=!1;if(r.worldPosition)u=!0;else{var v=a.handles.points,f=(0,K.getEnabledElement)(o).viewport.worldToCanvas;i=v.findIndex((function(e){return e===r}));var g=v.map(f);d=g[i],c=Math.abs(g[2][0]-g[3][0]),s=Math.abs(g[0][1]-g[1][1]),l=[(g[2][0]+g[3][0])/2,(g[0][1]+g[1][1])/2]}var h=Ps(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:h,handleIndex:i,canvasWidth:c,canvasHeight:s,centerCanvas:l,originalHandleCanvas:d,movingTextBox:u},e._activateModify(o),Kl(o);var p=(0,K.getEnabledElement)(o).renderingEngine;na(p,h),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){o.highlighted=!1,c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}}})),te(la(e),"_dragDrawCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,K.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,c=e.editData,s=c.annotation,d=c.viewportIdsToRender,u=c.centerCanvas,v=s.data,f=Math.abs(o[0]-u[0]),g=Math.abs(o[1]-u[1]),h=[u[0],u[1]-g],p=[u[0],u[1]+g],m=[u[0]-f,u[1]],w=[u[0]+f,u[1]];v.handles.points=[l(h),l(p),l(m),l(w)],s.invalidated=!0,e.editData.hasMoved=!0,na(i,d)})),te(la(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else e._dragHandle(t),a.invalidated=!0;var g=(0,K.getEnabledElement)(r).renderingEngine;na(g,i)})),te(la(e),"_dragHandle",(function(t){var n=t.detail,r=n.element,o=(0,K.getEnabledElement)(r).viewport.canvasToWorld,a=e.editData,i=a.annotation,l=a.canvasWidth,c=a.canvasHeight,s=a.handleIndex,d=a.centerCanvas,u=a.originalHandleCanvas,v=i.data.handles.points,f=n.currentPoints.canvas;if(0===s||1===s){var g=Math.abs(f[1]-d[1]),h=[d[0],d[1]-g],p=[d[0],d[1]+g];v[0]=o(h),v[1]=o(p);var m=l/2+(f[0]-u[0]),w=[d[0]-m,d[1]],E=[d[0]+m,d[1]];v[2]=o(w),v[3]=o(E)}else{var y=Math.abs(f[0]-d[0]),I=[d[0]-y,d[1]],b=[d[0]+y,d[1]];v[2]=o(I),v[3]=o(b);var C=c/2+(f[1]-u[1]),T=[d[0],d[1]-C],_=[d[0],d[1]+C];v[0]=o(T),v[1]=o(_)}})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragDrawCallback),t.addEventListener(J.MOUSE_MOVE,e._dragDrawCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragDrawCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragDrawCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragDrawCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragDrawCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=c[f],o=r.annotationUID,l=r.data,v=l.handles,g=v.points,h=v.activeHandleIndex;u.annotationUID=o;var p,m=e.getStyle("lineWidth",u,r),w=e.getStyle("lineDash",u,r),E=e.getStyle("color",u,r),y=g.map((function(e){return i.worldToCanvas(e)})),I=Math.abs(i.getRotation()-(l.initialRotation||0));p=es(90==I||270==I?[y[2],y[3],y[0],y[1]]:y);var b,C=e.configuration.centerPointRadius,T={isPreScaled:nd(i,s),isSuvScaled:e.isSuvScaled(i,s,r.metadata.referencedImageId)};if(l.cachedStats[s]&&void 0!==l.cachedStats[s].areaUnit){if(r.invalidated&&(e._throttledCalculateCachedStats(r,i,d,t,T),i instanceof K.VolumeViewport)){var _=r.metadata.referencedImageId;for(var D in l.cachedStats)D.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=K.utilities.imageIdToURI(_),n=e.hasImageURI(t),r=K.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[D]}}else l.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},e._calculateCachedStats(r,i,d,t,T);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};if(!xe(o))return"continue";ce(r)||e.editData||null===h||(b=[y[h]]),b&&Oc(n,o,"0",b,{color:E});var O="".concat(o,"-ellipse");if(Dc(n,o,"0",p[0],p[1],{color:E,lineDash:w,lineWidth:m},O),C>0&&Math.min(Math.abs(p[0][0]-p[1][0])/2,Math.abs(p[0][1]-p[1][1])/2)>3*C){var S=e._getCanvasEllipseCenter(y);_c(n,o,"".concat("0","-center"),S,C,{color:E,lineDash:w,lineWidth:m})}a=!0;var x,M=e._getTextLines(l,s);if(!M||0===M.length)return"continue";l.handles.textBox.hasMoved||(x=Qs(p),l.handles.textBox.worldPosition=i.canvasToWorld(x));var k=i.worldToCanvas(l.handles.textBox.worldPosition),R=Ac(n,o,"1",M,k,y,{},e.getLinkedTextBoxStyle(u,r)),P=R.x,N=R.y,A=R.width,L=R.height;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,N]),topRight:i.canvasToWorld([P+A,N]),bottomLeft:i.canvasToWorld([P,N+L]),bottomRight:i.canvasToWorld([P+A,N+L])}},f=0;f<c.length;f++){var g=v();if("continue"!==g&&"object"===$(g))return g.v}return a})),te(la(e),"_getTextLines",(function(e,t){var n=e.cachedStats[t],r=n.area,o=n.mean,a=n.stdDev,i=n.max,l=n.isEmptyArea,c=n.areaUnit,s=n.modalityUnit,d=[];if(r){var u=l?"Area: Oblique not supported":"Area: ".concat(Zc(r)," ").concat(c);d.push(u)}return o&&d.push("Mean: ".concat(Zc(o)," ").concat(s)),i&&d.push("Max: ".concat(Zc(i)," ").concat(s)),a&&d.push("Std Dev: ".concat(Zc(a)," ").concat(s)),d})),te(la(e),"_calculateCachedStats",(function(t,n,r,o,a){for(var i=t.data,l=o.viewportId,c=o.renderingEngineId,s=i.handles.points.map((function(e){return n.worldToCanvas(e)})),d=n.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=it(es(s),2),g=f[0],h=f[1],p=n.canvasToWorld(g),m=n.canvasToWorld(h),w=i.cachedStats,E=Object.keys(w),y=p,I=m,b=function(){var n=E[C],o=e.getTargetIdImage(n,r);if(!o)return"continue";var i=o.dimensions,l=o.imageData,c=o.metadata,s=(o.hasPixelSpacing,ig(l,y));s[0]=Math.floor(s[0]),s[1]=Math.floor(s[1]),s[2]=Math.floor(s[2]);var d=ig(l,I);if(d[0]=Math.floor(d[0]),d[1]=Math.floor(d[1]),d[2]=Math.floor(d[2]),e._isInsideVolume(s,d,i)){var f=[[Math.min(s[0],d[0]),Math.max(s[0],d[0])],[Math.min(s[1],d[1]),Math.max(s[1],d[1])],[Math.min(s[2],d[2]),Math.max(s[2],d[2])]],g={center:[(p[0]+m[0])/2,(p[1]+m[1])/2,(p[2]+m[2])/2],xRadius:Math.abs(p[0]-m[0])/2,yRadius:Math.abs(p[1]-m[1])/2,zRadius:Math.abs(p[2]-m[2])/2},h=ag(u,v,y,I),b=h.worldWidth,T=h.worldHeight,_=0===b&&0===T,D=Ys(o),O=Math.abs(Math.PI*(b/2)*(T/2))/D/D,S=0,x=0,M=0,k=-1/0;Kc(l,(function(e,t){return ts(g,e)}),(function(e){var t=e.value;t>k&&(k=t),x+=t,S+=1}),f),x/=S,Kc(l,(function(e,t){return ts(g,e)}),(function(e){var t=e.value-x;M+=t*t}),f),M/=S,M=Math.sqrt(M);var R=td(c.Modality,t.metadata.referencedImageId,a);w[n]={Modality:c.Modality,area:O,mean:x,max:k,stdDev:M,isEmptyArea:_,areaUnit:Ks(0,o),modalityUnit:R}}else e.isHandleOutsideImage=!0,w[n]={Modality:c.Modality}},C=0;C<E.length;C++)b();t.invalidated=!1;var T=J.ANNOTATION_MODIFIED,_={annotation:t,viewportId:l,renderingEngineId:c};return(0,K.triggerEvent)(K.eventTarget,T,_),w})),te(la(e),"_isInsideVolume",(function(e,t,n){return K.utilities.indexWithinDimensions(e,n)&&K.utilities.indexWithinDimensions(t,n)})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o,[{key:"_pointInEllipseCanvas",value:function(e,t){var n=e.width/2,r=e.height/2;if(n<=0||r<=0)return!1;var o=[e.left+n,e.top+r],a=[t[0]-o[0],t[1]-o[1]];return a[0]*a[0]/(n*n)+a[1]*a[1]/(r*r)<=1}},{key:"_getCanvasEllipseCenter",value:function(e){var t=it(e,4),n=t[0],r=t[1],o=t[2],a=t[3],i=[o[0],r[1]],l=[a[0],n[1]];return[(i[0]+l[0])/2,(i[1]+l[1])/2]}}]),o}(Fs);te(lg,"toolName",void 0),lg.toolName="EllipticalROI";var cg=lg;function sg(e){var t=it(e,2);return Jd(t[0],t[1])}function dg(e){var t=it(e,2),n=t[0],r=Jd(n,t[1]);return[[n[0]-r,n[1]-r],[n[0]+r,n[1]+r]]}var ug=K.utilities.transformWorldToIndex,vg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,centerPointRadius:0}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",!1),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(r.canvas,(0,K.getEnabledElement)(o)),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[kr(a),kr(a)],activeHandleIndex:null},cachedStats:{}}};Qe(g,o);var h=Ps(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(c,h),g})),te(la(e),"isPointNearTool",(function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=t.data.handles.points.map((function(e){return o.worldToCanvas(e)})),i=sg(a),l=sg([a[0],n]);return Math.abs(l-i)<r/2})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},Kl(r),e._activateModify(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),t.preventDefault()})),te(la(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l=!1;r.worldPosition?l=!0:i=a.handles.points.findIndex((function(e){return e===r}));var c=Ps(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:c,handleIndex:i,movingTextBox:l},e._activateModify(o),Kl(o);var s=(0,K.getEnabledElement)(o).renderingEngine;na(s,c),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){o.highlighted=!1,c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(e.editData=null,e.isDrawing=!1,e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}}})),te(la(e),"_dragDrawCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,K.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,c=e.editData,s=c.annotation,d=c.viewportIdsToRender,u=s.data;u.handles.points=[u.handles.points[0],l(o)],s.invalidated=!0,e.editData.hasMoved=!0,na(i,d)})),te(la(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else e._dragHandle(t),a.invalidated=!0;var g=(0,K.getEnabledElement)(r).renderingEngine;na(g,i)})),te(la(e),"_dragHandle",(function(t){var n=t.detail,r=n.element,o=(0,K.getEnabledElement)(r).viewport,a=o.canvasToWorld,i=o.worldToCanvas,l=e.editData,c=l.annotation,s=l.handleIndex,d=c.data.handles.points,u=d.map((function(e){return i(e)})),v=n.currentPoints.canvas;if(0===s){var f=v[0]-u[0][0],g=v[1]-u[0][1],h=v,p=[u[1][0]+f,u[1][1]+g];d[0]=a(h),d[1]=a(p)}else d[1]=a(v)})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragDrawCallback),t.addEventListener(J.MOUSE_MOVE,e._dragDrawCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragDrawCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragDrawCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragDrawCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragDrawCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=function(){var r=c[f],o=r.annotationUID,l=r.data,v=l.handles,g=v.points,h=v.activeHandleIndex;u.annotationUID=o;var p,m=e.getStyle("lineWidth",u,r),w=e.getStyle("lineDash",u,r),E=e.getStyle("color",u,r),y=g.map((function(e){return i.worldToCanvas(e)})),I=y[0],b=sg(y),C=dg(y),T=e.configuration.centerPointRadius,_={isPreScaled:nd(i,s),isSuvScaled:e.isSuvScaled(i,s,r.metadata.referencedImageId)};if(l.cachedStats[s]&&void 0!==l.cachedStats[s].areaUnit){if(r.invalidated&&(e._throttledCalculateCachedStats(r,i,d,t,_),i instanceof K.VolumeViewport)){var D=r.metadata.referencedImageId;for(var O in l.cachedStats)O.startsWith("imageId")&&d.getStackViewports().find((function(e){var t=K.utilities.imageIdToURI(D),n=e.hasImageURI(t),r=K.utilities.imageIdToURI(e.getCurrentImageId());return n&&r!==t}))&&delete l.cachedStats[O]}}else l.cachedStats[s]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},e._calculateCachedStats(r,i,d,t,_);if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),{v:a};if(!xe(o))return"continue";ce(r)||e.editData||null===h||(p=[y[h]]),p&&Oc(n,o,"0",p,{color:E});var S="".concat(o,"-circle");_c(n,o,"0",I,b,{color:E,lineDash:w,lineWidth:m},S),T>0&&b>3*T&&_c(n,o,"".concat("0","-center"),I,T,{color:E,lineDash:w,lineWidth:m}),a=!0;var x,M=e._getTextLines(l,s);if(!M||0===M.length)return"continue";l.handles.textBox.hasMoved||(x=Qs(C),l.handles.textBox.worldPosition=i.canvasToWorld(x));var k=i.worldToCanvas(l.handles.textBox.worldPosition),R=Ac(n,o,"1",M,k,y,{},e.getLinkedTextBoxStyle(u,r)),P=R.x,N=R.y,A=R.width,L=R.height;l.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([P,N]),topRight:i.canvasToWorld([P+A,N]),bottomLeft:i.canvasToWorld([P,N+L]),bottomRight:i.canvasToWorld([P+A,N+L])}},f=0;f<c.length;f++){var g=v();if("continue"!==g&&"object"===$(g))return g.v}return a})),te(la(e),"_getTextLines",(function(e,t){var n=e.cachedStats[t],r=n.radius,o=n.radiusUnit,a=n.area,i=n.mean,l=n.stdDev,c=n.max,s=n.isEmptyArea,d=(n.Modality,n.areaUnit),u=n.modalityUnit,v=[];if(r){var f=s?"Radius: Oblique not supported":"Radius: ".concat(Zc(r)," ").concat(o);v.push(f)}if(a){var g=s?"Area: Oblique not supported":"Area: ".concat(Zc(a)," ").concat(d);v.push(g)}return i&&v.push("Mean: ".concat(Zc(i)," ").concat(u)),c&&v.push("Max: ".concat(Zc(c)," ").concat(u)),l&&v.push("Std Dev: ".concat(Zc(l)," ").concat(u)),v})),te(la(e),"_calculateCachedStats",(function(t,n,r,o,a){for(var i=t.data,l=o.viewportId,c=o.renderingEngineId,s=i.handles.points.map((function(e){return n.worldToCanvas(e)})),d=n.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=it(dg(s),2),g=f[0],h=f[1],p=n.canvasToWorld(g),m=n.canvasToWorld(h),w=i.cachedStats,E=Object.keys(w),y=p,I=m,b=function(){var n=E[C],o=e.getTargetIdImage(n,r);if(!o)return"continue";var i=o.dimensions,l=o.imageData,c=o.metadata,s=(o.hasPixelSpacing,ug(l,y));s[0]=Math.floor(s[0]),s[1]=Math.floor(s[1]),s[2]=Math.floor(s[2]);var d=ug(l,I);if(d[0]=Math.floor(d[0]),d[1]=Math.floor(d[1]),d[2]=Math.floor(d[2]),e._isInsideVolume(s,d,i)){var f=[[Math.min(s[0],d[0]),Math.max(s[0],d[0])],[Math.min(s[1],d[1]),Math.max(s[1],d[1])],[Math.min(s[2],d[2]),Math.max(s[2],d[2])]],g={center:[(p[0]+m[0])/2,(p[1]+m[1])/2,(p[2]+m[2])/2],xRadius:Math.abs(p[0]-m[0])/2,yRadius:Math.abs(p[1]-m[1])/2,zRadius:Math.abs(p[2]-m[2])/2},h=ag(u,v,y,I),b=h.worldWidth,T=h.worldHeight,_=0===b&&0===T,D=Ys(o),O=function(e){var t;return(null===(t=e.calibration)||void 0===t?void 0:t.aspect)||1}(o),S=Math.abs(Math.PI*(b/D/2)*(T/O/D/2)),x=0,M=0,k=0,R=-1/0;Kc(l,(function(e,t){return ts(g,e)}),(function(e){var t=e.value;t>R&&(R=t),M+=t,x+=1}),f),M/=x,Kc(l,(function(e,t){return ts(g,e)}),(function(e){var t=e.value-M;k+=t*t}),f),k/=x,k=Math.sqrt(k);var P=td(c.Modality,t.metadata.referencedImageId,a);w[n]={Modality:c.Modality,area:S,mean:M,max:R,stdDev:k,isEmptyArea:_,areaUnit:Ks(0,o),radius:b/2/D,radiusUnit:zs(0,o),perimeter:2*Math.PI*(b/2)/D,modalityUnit:P}}else e.isHandleOutsideImage=!0,w[n]={Modality:c.Modality}},C=0;C<E.length;C++)b();t.invalidated=!1;var T=J.ANNOTATION_MODIFIED,_={annotation:t,viewportId:l,renderingEngineId:c};return(0,K.triggerEvent)(K.eventTarget,T,_),w})),te(la(e),"_isInsideVolume",(function(e,t,n){return K.utilities.indexWithinDimensions(e,n)&&K.utilities.indexWithinDimensions(t,n)})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o)}(Fs);te(vg,"toolName",void 0),vg.toolName="CircleROI";var fg=vg;var gg=K.utilities.transformWorldToIndex,hg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"preventHandleOutsideImage",void 0),te(la(e),"isPointNearTool",(function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=t.data.handles.points,i=o.worldToCanvas(a[0]),l=o.worldToCanvas(a[1]),c={start:{x:i[0],y:i[1]},end:{x:l[0],y:l[1]}},s=Zs([c.start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]);return s<=r||(i=o.worldToCanvas(a[2]),l=o.worldToCanvas(a[3]),(s=Zs([(c={start:{x:i[0],y:i[1]},end:{x:l[0],y:l[1]}}).start.x,c.start.y],[c.end.x,c.end.y],[n[0],n[1]]))<=r)})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),Kl(r),t.preventDefault()})),te(la(e),"handleSelectedCallback",(function(t,n,r){var o=t.detail.element,a=n.data;n.highlighted=!0;var i,l=!1;r.worldPosition?l=!0:i=a.handles.points.findIndex((function(e){return e===r}));var c=Ps(o,e.getToolName());Kl(o),e.editData={annotation:n,viewportIdsToRender:c,handleIndex:i,movingTextBox:l},e._activateModify(o);var s=(0,K.getEnabledElement)(o).renderingEngine;na(s,c),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(void 0!==e.editData.handleIndex){var d=c.handles.points,u=dc.vec3.distance(d[0],d[1]);if(dc.vec3.distance(d[2],d[3])>u){var v=[kr(d[2]),kr(d[3])],f=kr(d[0]),g=kr(d[1]),h=dc.vec2.create();dc.vec2.set(h,v[1][0]-v[0][0],v[1][1]-v[1][0]);var p=dc.vec2.create();dc.vec2.set(p,-h[1],h[0]);var m,w=dc.vec2.create();dc.vec2.set(w,g[0]-f[0],g[1]-f[0]),m=dc.vec2.dot(w,p)>0?[f,g]:[g,f],c.handles.points=[v[0],v[1],m[0],m[1]]}}if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var E=J.ANNOTATION_COMPLETED,y={annotation:o};(0,K.triggerEvent)(K.eventTarget,E,y)}e.editData=null,e.isDrawing=!1}})),te(la(e),"_dragDrawCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=(0,K.getEnabledElement)(o),i=a.renderingEngine,l=a.viewport,c=l.worldToCanvas,s=e.editData,d=s.annotation,u=s.viewportIdsToRender,v=s.handleIndex,f=d.data,g=r.world;f.handles.points[v]=kr(g);var h=f.handles.points.map(c),p={x:h[0][0],y:h[0][1]},m={x:h[1][0],y:h[1][1]},w=(h[2][0],h[2][1],h[3][0],h[3][1],dc.vec2.distance(h[0],h[1])/3),E=p.x-m.x,y=p.y-m.y,I=Math.sqrt(E*E+y*y),b=E/I,C=y/I,T=(p.x+m.x)/2,_=(p.y+m.y)/2,D=T+w*C,O=_-w*b,S=T-w*C,x=_+w*b;f.handles.points[2]=l.canvasToWorld([D,O]),f.handles.points[3]=l.canvasToWorld([S,x]),d.invalidated=!0,na(i,u),e.editData.hasMoved=!0})),te(la(e),"_dragModifyCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=(0,K.getEnabledElement)(r).renderingEngine,a=e.editData,i=a.annotation,l=a.viewportIdsToRender,c=a.handleIndex,s=a.movingTextBox,d=i.data;if(s){var u=n.deltaPoints.world,v=d.handles.textBox,f=v.worldPosition;f[0]+=u[0],f[1]+=u[1],f[2]+=u[2],v.hasMoved=!0}else if(void 0===c){var g=n.deltaPoints.world;d.handles.points.forEach((function(e){e[0]+=g[0],e[1]+=g[1],e[2]+=g[2]})),i.invalidated=!0}else e._dragModifyHandle(t),i.invalidated=!0;na(o,l)})),te(la(e),"_dragModifyHandle",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=(0,K.getEnabledElement)(o).viewport,i=e.editData,l=i.annotation,c=i.handleIndex,s=l.data,d=r.world,u=[a.worldToCanvas(s.handles.points[0]),a.worldToCanvas(s.handles.points[1]),a.worldToCanvas(s.handles.points[2]),a.worldToCanvas(s.handles.points[3])],v={start:{x:u[0][0],y:u[0][1]},end:{x:u[1][0],y:u[1][1]}},f={start:{x:u[2][0],y:u[2][1]},end:{x:u[3][0],y:u[3][1]}},g=kr(d),h=a.worldToCanvas(g);if(0===c||1===c){var p=u[0===c?1:0],m=dc.vec2.set(dc.vec2.create(),h[0]-p[0],h[1]-p[1]),w=dc.vec2.set(dc.vec2.create(),u[c][0]-p[0],u[c][1]-p[1]);dc.vec2.normalize(m,m),dc.vec2.normalize(w,w);var E={start:{x:p[0],y:p[1]},end:{x:h[0],y:h[1]}};if(e._movingLongAxisWouldPutItThroughShortAxis(E,f))return;var y=p,I=e._getSignedAngle(w,m),b=u[2][0],C=u[2][1],T=u[3][0],_=u[3][1];b-=y[0],C-=y[1],T-=y[0],_-=y[1];var D=b*Math.cos(I)-C*Math.sin(I),O=b*Math.sin(I)+C*Math.cos(I),S=T*Math.cos(I)-_*Math.sin(I),x=T*Math.sin(I)+_*Math.cos(I);b=D+y[0],C=O+y[1],T=S+y[0],_=x+y[1];var M=a.canvasToWorld([b,C]),k=a.canvasToWorld([T,_]);s.handles.points[c]=g,s.handles.points[2]=M,s.handles.points[3]=k}else{var R=2===c?3:2,P={longLineSegment:{start:v.start,end:v.end},shortLineSegment:{start:f.start,end:f.end}},N=dc.vec2.subtract(dc.vec2.create(),[P.longLineSegment.end.x,P.longLineSegment.end.y],[P.longLineSegment.start.x,P.longLineSegment.start.y]),A=dc.vec2.normalize(dc.vec2.create(),N),L=dc.vec2.subtract(dc.vec2.create(),[h[0],h[1]],[u[c][0],u[c][1]]),U=dc.vec2.length(L),V=e._getSignedAngle(A,L),B=Math.cos(V)*U,j=dc.vec2.scaleAndAdd(dc.vec2.create(),[u[R][0],u[R][1]],A,B);if(e._movingLongAxisWouldPutItThroughShortAxis({start:{x:h[0],y:h[1]},end:{x:j[0],y:j[1]}},{start:{x:P.longLineSegment.start.x,y:P.longLineSegment.start.y},end:{x:P.longLineSegment.end.x,y:P.longLineSegment.end.y}}))return;if(!Ld([h[0],h[1]],[j[0],j[1]],[v.start.x,v.start.y],[v.end.x,v.end.y]))return;s.handles.points[R]=a.canvasToWorld(j),s.handles.points[c]=g}})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragDrawCallback),t.addEventListener(J.MOUSE_MOVE,e._dragDrawCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragDrawCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragDrawCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragDrawCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragDrawCallback)})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragModifyCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragModifyCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragModifyCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragModifyCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!0,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<c.length;v++){var f=c[v],g=f.annotationUID,h=f.data,p=h.handles,m=p.points,w=p.activeHandleIndex,E=m.map((function(e){return i.worldToCanvas(e)}));u.annotationUID=g;var y=e.getStyle("lineWidth",u,f),I=e.getStyle("lineDash",u,f),b=e.getStyle("color",u,f),C=e.getStyle("shadow",u,f);if(h.cachedStats[s]&&void 0!==h.cachedStats[s].unit?f.invalidated&&e._throttledCalculateCachedStats(f,d,t):(h.cachedStats[s]={length:null,width:null,unit:null},e._calculateCachedStats(f,d,t)),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;var T=void 0;if(xe(g)){ce(f)||e.editData||null===w||(T=[E[w]]),T&&Oc(n,g,"0",T,{color:b});var _="".concat(g,"-line-1"),D="".concat(g,"-line-2");Sc(n,g,"0",E[0],E[1],{color:b,lineDash:I,lineWidth:y,shadow:C},_),Sc(n,g,"1",E[2],E[3],{color:b,lineDash:I,lineWidth:y,shadow:C},D),a=!0;var O=e._getTextLines(h,s);if(O&&0!==O.length){var S=void 0;h.handles.textBox.hasMoved||(S=Qs(E),h.handles.textBox.worldPosition=i.canvasToWorld(S));var x=i.worldToCanvas(h.handles.textBox.worldPosition),M=Ac(n,g,"1",O,x,E,{},e.getLinkedTextBoxStyle(u,f)),k=M.x,R=M.y,P=M.width,N=M.height;h.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([k,R]),topRight:i.canvasToWorld([k+P,R]),bottomLeft:i.canvasToWorld([k,R+N]),bottomRight:i.canvasToWorld([k+P,R+N])}}}}return a})),te(la(e),"_movingLongAxisWouldPutItThroughShortAxis",(function(e,t){var n=dc.vec2.create();dc.vec2.set(n,t.end.x-t.start.x,t.end.y-t.start.y),dc.vec2.normalize(n,n);var r={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!Ld([r.start.x,r.start.y],[r.end.x,r.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])})),te(la(e),"_getTextLines",(function(e,t){var n=e.cachedStats[t],r=n.length,o=n.width,a=n.unit;if(void 0!==r)return["L: ".concat(Zc(r)," ").concat(a),"W: ".concat(Zc(o)," ").concat(a)]})),te(la(e),"_calculateCachedStats",(function(t,n,r){for(var o=t.data,a=r.viewportId,i=r.renderingEngineId,l=o.handles.points[0],c=o.handles.points[1],s=o.handles.points[2],d=o.handles.points[3],u=o.cachedStats,v=Object.keys(u),f=0;f<v.length;f++){var g=v[f],h=e.getTargetIdImage(g,n);if(h){var p=h.imageData,m=h.dimensions,w=Ys(h),E=e._calculateLength(l,c)/w,y=e._calculateLength(s,d)/w,I=E>y?E:y,b=E>y?y:E,C=gg(p,l),T=gg(p,c),_=gg(p,s),D=gg(p,d);e._isInsideVolume(C,T,_,D,m)?e.isHandleOutsideImage=!1:e.isHandleOutsideImage=!0,u[g]={length:I,width:b,unit:zs(0,h)}}}t.invalidated=!1;var O=J.ANNOTATION_MODIFIED,S={annotation:t,viewportId:a,renderingEngineId:i};return(0,K.triggerEvent)(K.eventTarget,O,S),u})),te(la(e),"_isInsideVolume",(function(e,t,n,r,o){return K.utilities.indexWithinDimensions(e,o)&&K.utilities.indexWithinDimensions(t,o)&&K.utilities.indexWithinDimensions(n,o)&&K.utilities.indexWithinDimensions(r,o)})),te(la(e),"_getSignedAngle",(function(e,t){return Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1])})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o,[{key:"addNewAnnotation",value:function(e){var t=e.detail,n=t.currentPoints,r=t.element,o=n.world,a=(0,K.getEnabledElement)(r),i=a.viewport,l=a.renderingEngine;this.isDrawing=!0;var c=i.getCamera(),s=c.viewPlaneNormal,d=c.viewUp,u=this.getReferencedImageId(i,o,s,d),v=i.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:kr(s),viewUp:kr(d),FrameOfReferenceUID:v,referencedImageId:u},data:{handles:{points:[kr(o),kr(o),kr(o),kr(o)],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};Qe(f,r);var g=Ps(r,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:g,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(r),Kl(r),e.preventDefault(),na(l,g),f}},{key:"_calculateLength",value:function(e,t){var n=e[0]-t[0],r=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+r*r+o*o)}}]),o}(Fs);te(hg,"toolName",void 0),hg.toolName="Bidirectional";var pg=hg;var mg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:wg,changeTextCallback:Eg,preventHandleOutsideImage:!1,arrowFirst:!0}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;Kl(o),e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=e.configuration.arrowFirst,g=l.getFrameOfReferenceUID(),h={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:g,referencedImageId:v},data:{text:"",handles:{points:[kr(a),kr(a)],activeHandleIndex:null,arrowFirst:f,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};Qe(h,o);var p=Ps(o,e.getToolName());return e.editData={annotation:h,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),na(c,p),h})),te(la(e),"isPointNearTool",(function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=it(t.data.handles.points,2),i=a[0],l=a[1],c=o.worldToCanvas(i),s=o.worldToCanvas(l),d={start:{x:c[0],y:c[1]},end:{x:s[0],y:s[1]}};return Zs([d.start.x,d.start.y],[d.end.x,d.end.y],[n[0],n[1]])<=r})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),Kl(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n),d=s.viewportId,u=s.renderingEngineId,v=s.renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),i)e.configuration.getTextCallback((function(t){if(!t)return tt(o.annotationUID),na(v,a),e.editData=null,void(e.isDrawing=!1);o.data.text=t;var n=J.ANNOTATION_COMPLETED,r={annotation:o};(0,K.triggerEvent)(K.eventTarget,n,r),na(v,a)}));else{var f=J.ANNOTATION_MODIFIED,g={annotation:o,viewportId:d,renderingEngineId:u};(0,K.triggerEvent)(K.eventTarget,f,g)}e.editData=null,e.isDrawing=!1}})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;s.handles.points[l]=kr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,K.getEnabledElement)(r).renderingEngine;na(h,i)})),te(la(e),"touchTapCallback",(function(t){2==t.detail.taps&&e.doubleClickCallback(t)})),te(la(e),"doubleClickCallback",(function(t){var n,r=t.detail,o=r.element,a=Xe(e.getToolName(),o);if(null!==(n=a=e.filterInteractableAnnotationsForElement(o,a))&&void 0!==n&&n.length){var i=a.find((function(t){return e.isPointNearTool(o,t,r.currentPoints.canvas,6)}));if(i){var l=i;e.configuration.changeTextCallback(i,t.detail,e._doneChangingTextCallback.bind(la(e),o,l)),e.editData=null,e.isDrawing=!1,t.stopImmediatePropagation(),t.preventDefault()}}})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_END,e._endCallback)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_MOVE,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},d=0;d<c.length;d++){var u=c[d],v=u.annotationUID,f=u.data,g=f.handles,h=f.text,p=g.points,m=g.activeHandleIndex;s.annotationUID=v;var w=e.getStyle("lineWidth",s,u),E=e.getStyle("lineDash",s,u),y=e.getStyle("color",s,u),I=p.map((function(e){return i.worldToCanvas(e)})),b=void 0;if(ce(u)||e.editData||null===m||(b=[I[m]]),b&&Oc(n,v,"0",I,{color:y,lineWidth:w}),e.configuration.arrowFirst?Uc(n,v,"1",I[1],I[0],{color:y,width:w,lineDash:E}):Uc(n,v,"1",I[0],I[1],{color:y,width:w,lineDash:E}),a=!0,!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(h){if(!f.handles.textBox.hasMoved){var C=I[1];f.handles.textBox.worldPosition=i.canvasToWorld(C)}var T=i.worldToCanvas(f.handles.textBox.worldPosition),_=Ac(n,v,"1",[h],T,I,{},e.getLinkedTextBoxStyle(s,u)),D=_.x,O=_.y,S=_.width,x=_.height;f.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([D,O]),topRight:i.canvasToWorld([D+S,O]),bottomLeft:i.canvasToWorld([D,O+x]),bottomRight:i.canvasToWorld([D+S,O+x])}}}return a})),e}return Q(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=Ps(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),Kl(r);var c=(0,K.getEnabledElement)(r).renderingEngine;na(c,l),e.preventDefault()}},{key:"_doneChangingTextCallback",value:function(e,t,n){t.data.text=n;var r=(0,K.getEnabledElement)(e),o=r.renderingEngine,a=r.viewportId,i=r.renderingEngineId,l=Ps(e,this.getToolName());na(o,l);var c=J.ANNOTATION_MODIFIED;(0,K.triggerEvent)(K.eventTarget,c,{annotation:t,viewportId:a,renderingEngineId:i})}},{key:"_isInsideVolume",value:function(e,t,n){return K.utilities.indexWithinDimensions(e,n)&&K.utilities.indexWithinDimensions(t,n)}}]),o}(Fs);function wg(e){return e(prompt("Enter your annotation:"))}function Eg(e,t,n){return n(prompt("Enter your annotation:"))}te(mg,"toolName",void 0),mg.toolName="ArrowAnnotate";var yg=mg;var Ig=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"angleStartedNotYetCompleted",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){if(!e.angleStartedNotYetCompleted){e.angleStartedNotYetCompleted=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;Kl(o),e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{handles:{points:[kr(a),kr(a)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Qe(g,o);var h=Ps(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),na(c,h),g}})),te(la(e),"isPointNearTool",(function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=it(t.data.handles.points,3),i=a[0],l=a[1],c=a[2],s=o.worldToCanvas(i),d=o.worldToCanvas(l),u={start:{x:s[0],y:s[1]},end:{x:d[0],y:d[1]}};if(Zs([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=r)return!0;if(!c)return!1;var v=o.worldToCanvas(c),f={start:{x:d[0],y:d[1]},end:{x:v[0],y:v[1]}};return Zs([f.start.x,f.start.y],[f.end.x,f.end.y],[n[0],n[1]])<=r})),te(la(e),"toolSelectedCallback",(function(t,n){var r=t.detail.element;n.highlighted=!0;var o=Ps(r,e.getToolName());e.editData={annotation:n,viewportIdsToRender:o,movingTextBox:!1},e._activateModify(r),Kl(r);var a=(0,K.getEnabledElement)(r).renderingEngine;na(a,o),t.preventDefault()})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l)if(e.angleStartedNotYetCompleted&&2===c.handles.points.length)e.editData.handleIndex=2;else{e.angleStartedNotYetCompleted=!1,c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}e.editData=null,e.isDrawing=!1}})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;s.handles.points[l]=kr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,K.getEnabledElement)(r).renderingEngine;na(h,i)})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,e.angleStartedNotYetCompleted=!1,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_MOVE,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_MOVE,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<c.length;v++){var f,g=c[v],h=g.annotationUID,p=g.data,m=p.handles,w=m.points,E=m.activeHandleIndex;u.annotationUID=h;var y=e.getStyle("lineWidth",u,g),I=e.getStyle("lineDash",u,g),b=e.getStyle("color",u,g),C=w.map((function(e){return i.worldToCanvas(e)}));p.cachedStats[s]?g.invalidated&&e._throttledCalculateCachedStats(g,d,t):(p.cachedStats[s]={angle:null},e._calculateCachedStats(g,d,t));var T=void 0;if(ce(g)||e.editData||null===E||(T=[C[E]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;T&&Oc(n,h,"0",C,{color:b,lineDash:I,lineWidth:y});var _="1";if(Sc(n,h,_,C[0],C[1],{color:b,width:y,lineDash:I}),a=!0,3!==C.length)return a;if(Sc(n,h,_="2",C[1],C[2],{color:b,width:y,lineDash:I}),null!==(f=p.cachedStats[s])&&void 0!==f&&f.angle){var D=e._getTextLines(p,s);if(!p.handles.textBox.hasMoved){var O=C[1];p.handles.textBox.worldPosition=i.canvasToWorld(O)}var S=i.worldToCanvas(p.handles.textBox.worldPosition),x=Ac(n,h,"1",D,S,C,{},e.getLinkedTextBoxStyle(u,g)),M=x.x,k=x.y,R=x.width,P=x.height;p.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,k]),topRight:i.canvasToWorld([M+R,k]),bottomLeft:i.canvasToWorld([M,k+P]),bottomRight:i.canvasToWorld([M+R,k+P])}}}return a})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=Ps(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),Kl(r);var c=(0,K.getEnabledElement)(r).renderingEngine;na(c,l),e.preventDefault()}},{key:"_getTextLines",value:function(e,t){var n=e.cachedStats[t].angle;if(void 0!==n)return["".concat(Zc(n)," ").concat(String.fromCharCode(176))]}},{key:"_calculateCachedStats",value:function(e,t,n){var r=e.data,o=n.viewportId,a=n.renderingEngineId;if(3===r.handles.points.length){for(var i=r.handles.points[0],l=r.handles.points[1],c=r.handles.points[2],s=r.cachedStats,d=Object.keys(s),u=0;u<d.length;u++){var v=d[u],f=Nf([i,l],[l,c]);s[v]={angle:f}}e.invalidated=!1;var g=J.ANNOTATION_MODIFIED,h={annotation:e,viewportId:o,renderingEngineId:a};return(0,K.triggerEvent)(K.eventTarget,g,h),s}}}]),o}(Fs);te(Ig,"toolName",void 0),Ig.toolName="Angle";var bg=Ig,Cg=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var r=2===t[0].length?[0,0]:[0,0,0],o=t.length,a=0,i=t;a<i.length;a++){var l=i[a];r[0]+=l[0]/o,r[1]+=l[1]/o,3===r.length&&(r[2]+=l[2]/o)}return r};var Tg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"angleStartedNotYetCompleted",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"addNewAnnotation",(function(t){if(!e.angleStartedNotYetCompleted){e.angleStartedNotYetCompleted=!0;var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;Kl(o),e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.getReferencedImageId(l,a,d,u),f=l.getFrameOfReferenceUID(),g={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:f,referencedImageId:v},data:{handles:{points:[kr(a),kr(a)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};Qe(g,o);var h=Ps(o,e.getToolName());return e.editData={annotation:g,viewportIdsToRender:h,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),t.preventDefault(),na(c,h),g}})),te(la(e),"isPointNearTool",(function(e,t,n,r){var o=(0,K.getEnabledElement)(e).viewport,a=it(t.data.handles.points,4),i=a[0],l=a[1],c=a[2],s=a[3],d=o.worldToCanvas(i),u=o.worldToCanvas(l),v=o.worldToCanvas(c),f=o.worldToCanvas(s),g={start:{x:d[0],y:d[1]},end:{x:u[0],y:u[1]}},h={start:{x:v[0],y:v[1]},end:{x:f[0],y:f[1]}},p=Zs([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]]),m=Zs([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]);return p<=r||m<=r})),te(la(e),"toolSelectedCallback",(function(t,n,r){var o=t.detail.element;n.highlighted=!0;var a=Ps(o,e.getToolName());e.editData={annotation:n,viewportIdsToRender:a,movingTextBox:!1},e._activateModify(o),Kl(o);var i=(0,K.getEnabledElement)(o).renderingEngine;na(i,a),t.preventDefault()})),te(la(e),"_mouseUpCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.viewportIdsToRender,i=r.newAnnotation,l=r.hasMoved,c=o.data;if(!i||l){if(e.angleStartedNotYetCompleted&&c.handles.points.length<4)return zl(n),void(e.editData.handleIndex=c.handles.points.length);e.angleStartedNotYetCompleted=!1,c.handles.activeHandleIndex=null,e._deactivateModify(n),e._deactivateDraw(n),zl(n);var s=(0,K.getEnabledElement)(n).renderingEngine;if(e.isHandleOutsideImage&&e.configuration.preventHandleOutsideImage&&tt(o.annotationUID),na(s,a),i){var d=J.ANNOTATION_COMPLETED,u={annotation:o};(0,K.triggerEvent)(K.eventTarget,d,u)}e.editData=null,e.isDrawing=!1}})),te(la(e),"_mouseDownCallback",(function(t){var n=e.editData,r=n.annotation,o=n.handleIndex,a=t.detail,i=a.element,l=a.currentPoints.world,c=r.data;return 1===o?(c.handles.points[1]=l,void(e.editData.hasMoved=c.handles.points[1][0]!==c.handles.points[0][0]||c.handles.points[1][1]!==c.handles.points[0][0])):3===o?(c.handles.points[3]=l,e.editData.hasMoved=c.handles.points[3][0]!==c.handles.points[2][0]||c.handles.points[3][1]!==c.handles.points[2][0],void(e.angleStartedNotYetCompleted=!1)):(e.editData.hasMoved=!1,Kl(i),c.handles.points[2]=c.handles.points[3]=l,void(e.editData.handleIndex=c.handles.points.length-1))})),te(la(e),"_mouseDragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=e.editData,a=o.annotation,i=o.viewportIdsToRender,l=o.handleIndex,c=o.movingTextBox,s=a.data;if(c){var d=n.deltaPoints.world,u=s.handles.textBox,v=u.worldPosition;v[0]+=d[0],v[1]+=d[1],v[2]+=d[2],u.hasMoved=!0}else if(void 0===l){var f=n.deltaPoints.world;s.handles.points.forEach((function(e){e[0]+=f[0],e[1]+=f[1],e[2]+=f[2]})),a.invalidated=!0}else{var g=n.currentPoints.world;s.handles.points[l]=kr(g),a.invalidated=!0}e.editData.hasMoved=!0;var h=(0,K.getEnabledElement)(r).renderingEngine;na(h,i)})),te(la(e),"cancel",(function(t){if(e.isDrawing){e.isDrawing=!1,e._deactivateDraw(t),e._deactivateModify(t),zl(t);var n=e.editData,r=n.annotation,o=n.viewportIdsToRender,a=n.newAnnotation,i=r.data;r.highlighted=!1,i.handles.activeHandleIndex=null;var l=(0,K.getEnabledElement)(t).renderingEngine;if(na(l,o),a){var c=J.ANNOTATION_COMPLETED,s={annotation:r};(0,K.triggerEvent)(K.eventTarget,c,s)}return e.editData=null,e.angleStartedNotYetCompleted=!1,r.annotationUID}})),te(la(e),"_activateModify",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._mouseUpCallback),t.addEventListener(J.MOUSE_DRAG,e._mouseDragCallback),t.addEventListener(J.MOUSE_CLICK,e._mouseUpCallback)})),te(la(e),"_deactivateModify",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._mouseUpCallback),t.removeEventListener(J.MOUSE_DRAG,e._mouseDragCallback),t.removeEventListener(J.MOUSE_CLICK,e._mouseUpCallback)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._mouseUpCallback),t.addEventListener(J.MOUSE_DRAG,e._mouseDragCallback),t.addEventListener(J.MOUSE_MOVE,e._mouseDragCallback),t.addEventListener(J.MOUSE_CLICK,e._mouseUpCallback),t.addEventListener(J.MOUSE_DOWN,e._mouseDownCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._mouseUpCallback),t.removeEventListener(J.MOUSE_DRAG,e._mouseDragCallback),t.removeEventListener(J.MOUSE_MOVE,e._mouseDragCallback),t.removeEventListener(J.MOUSE_CLICK,e._mouseUpCallback),t.removeEventListener(J.MOUSE_DOWN,e._mouseDownCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=i.element,c=Xe(e.getToolName(),l);if(null===(r=c)||void 0===r||!r.length)return a;if(null===(o=c=e.filterInteractableAnnotationsForElement(l,c))||void 0===o||!o.length)return a;for(var s=e.getTargetId(i),d=i.getRenderingEngine(),u={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},v=0;v<c.length;v++){var f,g=c[v],h=g.annotationUID,p=g.data,m=p.handles,w=m.points,E=m.activeHandleIndex;u.annotationUID=h;var y=e.getStyle("lineWidth",u,g),I=e.getStyle("lineDash",u,g),b=e.getStyle("color",u,g),C=w.map((function(e){return i.worldToCanvas(e)}));p.cachedStats[s]?g.invalidated&&e._throttledCalculateCachedStats(g,d,t):(p.cachedStats[s]={angle:null},e._calculateCachedStats(g,d,t));var T=void 0;if(ce(g)||e.editData||null===E||(T=[C[E]]),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;T&&Oc(n,h,"0",C,{color:b,lineDash:I,lineWidth:y});var _="1";if(Sc(n,h,_,C[0],C[1],{color:b,width:y,lineDash:I}),a=!0,C.length<4)return a;if(Sc(n,h,_="2",C[2],C[3],{color:b,width:y,lineDash:I}),Sc(n,h,_="3",Cg(C[0],C[1]),Cg(C[2],C[3]),{color:b,lineWidth:"1",lineDash:"1,4"}),null!==(f=p.cachedStats[s])&&void 0!==f&&f.angle){var D=e._getTextLines(p,s);if(!p.handles.textBox.hasMoved){var O=Qs(C);p.handles.textBox.worldPosition=i.canvasToWorld(O)}var S=i.worldToCanvas(p.handles.textBox.worldPosition),x=Ac(n,h,"1",D,S,C,{},e.getLinkedTextBoxStyle(u,g)),M=x.x,k=x.y,R=x.width,P=x.height;p.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([M,k]),topRight:i.canvasToWorld([M+R,k]),bottomLeft:i.canvasToWorld([M,k+P]),bottomRight:i.canvasToWorld([M+R,k+P])}}}return a})),e._throttledCalculateCachedStats=Gc(e._calculateCachedStats,100,{trailing:!0}),e}return Q(o,[{key:"handleSelectedCallback",value:function(e,t,n){var r=e.detail.element,o=t.data;t.highlighted=!0;var a,i=!1;n.worldPosition?i=!0:a=o.handles.points.findIndex((function(e){return e===n}));var l=Ps(r,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:a,movingTextBox:i},this._activateModify(r),Kl(r);var c=(0,K.getEnabledElement)(r).renderingEngine;na(c,l),e.preventDefault()}},{key:"_getTextLines",value:function(e,t){var n=e.cachedStats[t].angle;if(void 0!==n)return["".concat(n.toFixed(2)," ").concat(String.fromCharCode(176))]}},{key:"_calculateCachedStats",value:function(e,t,n){var r=e.data,o=n.viewportId,a=n.renderingEngineId;if(4===r.handles.points.length){for(var i=[null,null],l=[null,null],c=Number.MAX_VALUE,s=0;s<2;s+=1)for(var d=2;d<4;d+=1){var u=dc.vec3.distance(r.handles.points[s],r.handles.points[d]);u<c&&(c=u,i[1]=r.handles.points[s],i[0]=r.handles.points[(s+1)%2],l[0]=r.handles.points[d],l[1]=r.handles.points[2+(d-1)%2])}for(var v=r.cachedStats,f=Object.keys(v),g=0;g<f.length;g++){var h=f[g],p=Nf(i,l);v[h]={angle:p}}e.invalidated=!1;var m=J.ANNOTATION_MODIFIED,w={annotation:e,viewportId:o,renderingEngineId:a};return(0,K.triggerEvent)(K.eventTarget,m,w),v}}}]),o}(Fs);te(Tg,"toolName",void 0),Tg.toolName="CobbAngle";var _g=Tg;var Dg="magnify-viewport",Og=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}};return ee(this,o),te(la(e=r.call(this,t,n)),"_bounds",void 0),te(la(e),"editData",void 0),te(la(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.element,o=n.currentPoints,a=(0,K.getEnabledElement)(r),i=a.viewport,l=a.renderingEngine;if(!(i instanceof K.StackViewport))throw new Error("MagnifyTool only works on StackViewports");var c=e._getReferencedImageId(i);if(!c)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");var s=Ps(r,e.getToolName());return e.editData={referencedImageId:c,viewportIdsToRender:s,enabledElement:a,renderingEngine:l,currentPoints:o},e._createMagnificationViewport(),e._activateDraw(r),Kl(r),t.preventDefault(),na(l,s),!0})),te(la(e),"preTouchStartCallback",(function(t){e.preMouseDownCallback(t)})),te(la(e),"_createMagnificationViewport",(function(){var t,n=e.editData,r=n.enabledElement,o=n.referencedImageId,a=n.viewportIdsToRender,i=n.renderingEngine,l=n.currentPoints,c=r.viewport,s=c.element,d=c.getProperties().voiRange,u=l.canvas,v=l.world;if(null===(t=s.querySelector(".magnifyTool"))){var f=document.createElement("div");f.classList.add("magnifyTool"),f.style.display="block",f.style.width="".concat(e.configuration.magnifyWidth,"px"),f.style.height="".concat(e.configuration.magnifyHeight,"px"),f.style.position="absolute",t=f,s.querySelector(".viewport-element").appendChild(f);var g={viewportId:Dg,type:K.Enums.ViewportType.STACK,element:t};i.enableElement(g)}t.style.top="".concat(u[1]-e.configuration.magnifyHeight/2,"px"),t.style.left="".concat(u[0]-e.configuration.magnifyWidth/2,"px");var h=i.getViewport(Dg);h.setStack([o]).then((function(){h.setProperties({voiRange:d});var t=c.getCamera().parallelScale,n=h.getCamera(),r=n.focalPoint,o=n.position,a=n.viewPlaneNormal,i=Math.sqrt(Math.pow(r[0]-o[0],2)+Math.pow(r[1]-o[1],2)+Math.pow(r[2]-o[2],2)),l=[v[0],v[1],v[2]],s=[l[0]+i*a[0],l[1]+i*a[1],l[2]+i*a[2]];h.setCamera({parallelScale:t*(1/e.configuration.magnifySize),focalPoint:l,position:s}),h.render()})),t.style.display="block",na(i,a)})),te(la(e),"_dragCallback",(function(t){var n=t.detail,r=n.deltaPoints,o=n.element,a=n.currentPoints,i=r.world,l=a.canvas,c=(0,K.getEnabledElement)(o).renderingEngine.getViewport(Dg),s=o.querySelector(".magnifyTool");if(s){s.style.top="".concat(l[1]-e.configuration.magnifyHeight/2,"px"),s.style.left="".concat(l[0]-e.configuration.magnifyWidth/2,"px");var d=c.getCamera(),u=d.focalPoint,v=d.position,f=[v[0]+i[0],v[1]+i[1],v[2]+i[2]],g=[u[0]+i[0],u[1]+i[1],u[2]+i[2]];c.setCamera({focalPoint:g,position:f}),c.render()}})),te(la(e),"_dragEndCallback",(function(t){var n=t.detail.element;(0,K.getEnabledElement)(n).renderingEngine.disableElement(Dg);var r=n.querySelector(".viewport-element"),o=r.querySelector(".magnifyTool");r.removeChild(o),e._deactivateDraw(n),zl(n)})),te(la(e),"_activateDraw",(function(t){Fe.isInteractingWithTool=!0,t.addEventListener(J.MOUSE_UP,e._dragEndCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._dragEndCallback),t.addEventListener(J.TOUCH_END,e._dragEndCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_deactivateDraw",(function(t){Fe.isInteractingWithTool=!1,t.removeEventListener(J.MOUSE_UP,e._dragEndCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._dragEndCallback),t.removeEventListener(J.TOUCH_END,e._dragEndCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback)})),e}return Q(o,[{key:"_getReferencedImageId",value:function(e){var t,n=this.getTargetId(e);return e instanceof K.StackViewport&&(t=n.split("imageId:")[1]),t}}]),o}(xa);te(Og,"toolName",void 0),Og.toolName="Magnify";var Sg=Og;var xg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"isDrawing",!1),te(la(e),"isHandleOutsideImage",!1),te(la(e),"_elementWithCursor",null),te(la(e),"_currentCursorWorldPosition",null),te(la(e),"_currentCanvasPosition",null),te(la(e),"_disableCursorEnabled",!1),te(la(e),"mouseMoveCallback",(function(t){var n=t.detail,r=n.element,o=n.currentPoints;e._currentCursorWorldPosition=o.world,e._currentCanvasPosition=o.canvas,e._elementWithCursor=r;var a=e.getActiveAnnotation(r);return null===a?(e.createInitialAnnotation(o.world,r),!1):(e.updateAnnotationPosition(r,a),!1)})),te(la(e),"createInitialAnnotation",(function(t,n){var r=(0,K.getEnabledElement)(n);if(!r)throw new Error("No enabled element found");var o=r.viewport,a=r.renderingEngine;e.isDrawing=!0;var i=o.getCamera(),l=i.viewPlaneNormal,c=i.viewUp;if(!l||!c)throw new Error("Camera not found");var s=e.getReferencedImageId(o,t,l,c),d=o.getFrameOfReferenceUID(),u={highlighted:!0,invalidated:!0,metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(l),viewUp:kr(c),FrameOfReferenceUID:d,referencedImageId:s},data:{label:"",handles:{points:[kr(t)],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if(Xe(e.getToolName(),n).length>0)return null;if(null!==Qe(u,n)){var v=Ps(n,e.getToolName(),!1);na(a,v)}})),te(la(e),"onCameraModified",(function(t){var n=t.detail,r=n.element,o=n.previousCamera,a=n.camera,i=(0,K.getEnabledElement)(r).viewport;if(r===e._elementWithCursor){var l=o.focalPoint,c=a.viewPlaneNormal,s=a.focalPoint,d=[0,0,0];if(Zd().subtract(s,l,d),0!==d.reduce((function(e,t){return e+t}),0)){var u=Zd().dot(d,c);if(!(Math.abs(u)<.01)&&e._currentCanvasPosition){var v=i.canvasToWorld(e._currentCanvasPosition);e._currentCursorWorldPosition=v,e.updateAnnotationPosition(r,e.getActiveAnnotation(r))}}}})),te(la(e),"renderAnnotation",(function(t,n){var r,o,a=!1,i=t.viewport,l=(t.FrameOfReferenceUID,e._elementWithCursor===i.element);e.configuration.positionSync&&!l&&e.updateViewportImage(i);var c=i.element,s=Xe(e.getToolName(),c);if(null===(r=s)||void 0===r||!r.length)return a;if(null===(o=s=e.filterInteractableAnnotationsForElement(c,s))||void 0===o||!o.length)return a;for(var d={toolGroupId:e.toolGroupId,toolName:e.getToolName(),viewportId:t.viewport.id},u=0;u<s.length;u++){var v=s[u],f=v.annotationUID,g=v.data.handles.points;if(!f)return a;d.annotationUID=f;var h=parseFloat(e.getStyle("lineWidth",d,v)),p=e.getStyle("lineDash",d,v),m=e.getStyle("color",d,v);if(g[0].some((function(e){return isNaN(e)})))return a;var w=g.map((function(e){return i.worldToCanvas(e)}));if(!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),a;if(xe(f)){var E={upper:"upper",right:"right",lower:"lower",left:"left"},y=it(w[0],2),I=y[0],b=y[1],C=l?20:7,T=l?5:7;Sc(n,f,E.upper,[I,b-(C/2+T)],[I,b-C/2],{color:m,lineDash:p,lineWidth:h}),Sc(n,f,E.lower,[I,b+(C/2+T)],[I,b+C/2],{color:m,lineDash:p,lineWidth:h}),Sc(n,f,E.right,[I+(C/2+T),b],[I+C/2,b],{color:m,lineDash:p,lineWidth:h}),Sc(n,f,E.left,[I-(C/2+T),b],[I-C/2,b],{color:m,lineDash:p,lineWidth:h}),a=!0}}return a})),e._disableCursorEnabled=e.configuration.disableCursor,e}return Q(o,[{key:"onSetToolActive",value:function(){if(this._disableCursorEnabled=this.configuration.disableCursor,this._disableCursorEnabled){var e=ia(this.toolGroupId).viewportsInfo;e&&e.map((function(e){return(0,K.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)})).forEach((function(e){e&&Kl(e.viewport.element)}))}}},{key:"onSetToolDisabled",value:function(){if(this._disableCursorEnabled){var e=ia(this.toolGroupId).viewportsInfo;e&&e.map((function(e){return(0,K.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)})).forEach((function(e){e&&zl(e.viewport.element)}))}}},{key:"getActiveAnnotation",value:function(e){var t=Xe(this.getToolName(),e);return t.length?t[0]:null}},{key:"updateAnnotationPosition",value:function(e,t){var n,r,o=this._currentCursorWorldPosition;if(o&&null!==(n=t.data)&&void 0!==n&&null!==(r=n.handles)&&void 0!==r&&r.points){t.data.handles.points=[kr(o)],t.invalidated=!0;var a=Ps(e,this.getToolName(),!1),i=(0,K.getEnabledElement)(e);if(i){var l=i.renderingEngine;na(l,a)}}}},{key:"filterInteractableAnnotationsForElement",value:function(e,t){var n,r,o;if(!(t instanceof Array)||0===t.length)return[];var a=t[0],i=null===(n=(0,K.getEnabledElement)(e))||void 0===n?void 0:n.viewport;if(!i)return[];var l=i.getCamera(),c=l.viewPlaneNormal,s=l.focalPoint;if(!c||!s)return[];var d=null===(r=a.data)||void 0===r||null===(o=r.handles)||void 0===o?void 0:o.points;if(!(d instanceof Array)||1!==d.length)return[];var u=d[0],v=K.utilities.planar.planeEquation(c,s);return K.utilities.planar.planeDistanceToPoint(v,u)<this.configuration.displayThreshold?[a]:[]}},{key:"updateViewportImage",value:function(e){var t=this._currentCursorWorldPosition;if(t&&!t.some((function(e){return isNaN(e)})))if(e instanceof K.StackViewport){var n=K.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof K.VolumeViewport){var r=e.getCamera(),o=r.focalPoint,a=r.viewPlaneNormal;if(!o||!a)return;var i=K.utilities.planar.planeEquation(a,o),l=K.utilities.planar.planeDistanceToPoint(i,t,!0);if(Math.abs(l)<.5)return;var c=dc.vec3.normalize(dc.vec3.create(),dc.vec3.fromValues.apply(dc.vec3,kr(a))),s=dc.vec3.scale(dc.vec3.create(),c,l),d=dc.vec3.add(dc.vec3.create(),dc.vec3.fromValues.apply(dc.vec3,kr(o)),s);e.setCamera({focalPoint:d});var u=e.getRenderingEngine();u&&u.renderViewport(e.id)}}}]),o}(js);te(xg,"toolName",void 0),xg.toolName="ReferenceCursors";var Mg=xg;var kg=[],Rg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{configuration:{viewportId:"",scaleLocation:"bottom"}};return ee(this,o),te(la(e=r.call(this,t,n)),"touchDragCallback",void 0),te(la(e),"mouseDragCallback",void 0),te(la(e),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",{}),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"_init",(function(){var t=(0,K.getRenderingEngines)()[0];if(t){var n=ia(e.toolGroupId).viewportsInfo;if(n){var r=n.map((function(e){return(0,K.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)})),o=r[0].viewport,a=r[0].FrameOfReferenceUID;if(e.configuration.viewportId&&r.forEach((function(t){t.viewport.id==e.configuration.viewportId&&(o=t.viewport)})),o){var i=o.getCamera(),l=i.viewUp,c=i.viewPlaneNormal,s=K.utilities.getViewportImageCornersInWorld(o),d=e.editData.annotation,u=Xe(e.getToolName(),o.element);if(u.length&&(d=u.filter((function(e){return e.data.viewportId==o.id}))[0]),kg.includes(o.id))e.editData.annotation.data.viewportId==o.id&&(e.editData.annotation.data.handles.points=s,e.editData.annotation.data.viewportId=o.id);else{var v={metadata:{toolName:e.getToolName(),viewPlaneNormal:kr(c),viewUp:kr(l),FrameOfReferenceUID:a,referencedImageId:null},data:{handles:{points:s},viewportId:o.id}};kg.push(o.id),Qe(v,o.element),d=v}e.editData={viewport:o,renderingEngine:t,annotation:d}}}}})),te(la(e),"onSetToolEnabled",(function(){e._init()})),te(la(e),"onCameraModified",(function(t){e.configuration.viewportId=t.detail.viewportId,e._init()})),te(la(e),"computeScaleSize",(function(e,t,n){var r=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];return("top"==n||"bottom"==n?r.filter((function(t){return t<.6*e&&t>.2*e})):r.filter((function(e){return e<.6*t&&e>.2*t})))[0]})),te(la(e),"computeEndScaleTicks",(function(e,t){var n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}})),te(la(e),"computeInnerScaleTicks",(function(e,t,n,r,o){var a;"bottom"==t||"top"==t?a=o[0][0]-r[0][0]:"left"!=t&&"right"!=t||(a=o[0][1]-r[0][1]);var i=[],l=[],c=[],s=e;e>=50&&(s=e/10);for(var d=a/s,u=0;u<s-1;u++){var v={bottom:[[d*(u+1),0],[d*(u+1),5]],top:[[d*(u+1),0],[d*(u+1),-5]],left:[[0,d*(u+1)],[-5,d*(u+1)]],right:[[0,d*(u+1)],[5,d*(u+1)]]};i.push("".concat(n,"-tick").concat(u)),l.push("tick".concat(u)),(u+1)%5==0?c.push([[r[0][0]+v[t][0][0],r[0][1]+v[t][0][1]],[r[1][0]+v[t][0][0],r[1][1]+v[t][0][1]]]):c.push([[r[0][0]+v[t][0][0],r[0][1]+v[t][0][1]],[r[1][0]+v[t][1][0],r[1][1]+v[t][1][1]]])}return{tickIds:i,tickUIDs:l,tickCoordinates:c}})),te(la(e),"computeWorldScaleCoordinates",(function(e,t,n){var r,o=dc.vec3.subtract(dc.vec3.create(),n[0],n[1]);o=dc.vec3.normalize(dc.vec3.create(),o);var a=dc.vec3.subtract(dc.vec3.create(),n[2],n[0]);a=dc.vec3.normalize(dc.vec3.create(),a);var i={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},l=dc.vec3.add(dc.vec3.create(),i[t][0],i[t][0]).map((function(e){return e/2})),c=e/2/Math.sqrt(Math.pow(o[0],2)+Math.pow(o[1],2)+Math.pow(o[2],2));return"top"==t||"bottom"==t?r=[dc.vec3.subtract(dc.vec3.create(),l,a.map((function(e){return e*c}))),dc.vec3.add(dc.vec3.create(),l,a.map((function(e){return e*c})))]:"left"!=t&&"right"!=t||(r=[dc.vec3.add(dc.vec3.create(),l,o.map((function(e){return e*c}))),dc.vec3.subtract(dc.vec3.create(),l,o.map((function(e){return e*c})))]),r})),te(la(e),"computeCanvasScaleCoordinates",(function(e,t,n,r,o){var a;if("top"==o||"bottom"==o){var i=t[0][0]-t[1][0];a=[[e.width/2-i/2,n.height],[e.width/2+i/2,n.height]]}else if("left"==o||"right"==o){var l=t[0][1]-t[1][1];a=[[r.width,e.height/2-l/2],[r.width,e.height/2+l/2]]}return a})),te(la(e),"computeScaleBounds",(function(e,t,n,r){var o=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),i={bottom:[-a,-o],top:[a,o],left:[a,o],right:[-a,-o]},l={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:l[r][0]+i[r][0],width:l[r][1]+i[r][1]}})),e}return Q(o,[{key:"renderAnnotation",value:function(e,t){if(this.editData.viewport){var n=this.configuration.scaleLocation,r=e.viewport,o=Xe(this.getToolName(),r.element).filter((function(e){return e.data.viewportId==r.id}))[0],a=e.viewport.canvas;if(!r)return!1;var i={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},l={width:a.width,height:a.height},c=o.data.handles.points[0],s=o.data.handles.points[1],d=o.data.handles.points[2],u=o.data.handles.points[3],v=[c,d,s,u],f=dc.vec3.distance(d,u),g=dc.vec3.distance(c,d),h=this.computeScaleBounds(l,.05,.05,n),p=this.computeScaleBounds(l,.05,.05,n),m=this.computeScaleSize(f,g,n),w=this.computeWorldScaleCoordinates(m,n,v).map((function(e){return r.worldToCanvas(e)})),E=this.computeCanvasScaleCoordinates(l,w,p,h,n),y=this.computeEndScaleTicks(E,n),I=o.annotationUID;i.annotationUID=I;var b=this.getStyle("lineWidth",i,o),C=this.getStyle("lineDash",i,o),T=this.getStyle("color",i,o),_=this.getStyle("shadow",i,o),D="".concat(I,"-scaleline");Sc(t,I,"1",E[0],E[1],{color:T,width:b,lineDash:C,shadow:_},D);var O="".concat(I,"-left");Sc(t,I,"2",y.endTick1[0],y.endTick1[1],{color:T,width:b,lineDash:C,shadow:_},O);var S="".concat(I,"-right");Sc(t,I,"3",y.endTick2[0],y.endTick2[1],{color:T,width:b,lineDash:C,shadow:_},S);for(var x={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},M=[E[0][0]+x[n][0],E[0][1]+x[n][1]],k=this._getTextLines(m),R=this.computeInnerScaleTicks(m,n,I,y.endTick1,y.endTick2),P=R.tickIds,N=R.tickUIDs,A=R.tickCoordinates,L=0;L<N.length;L++)Sc(t,I,N[L],A[L][0],A[L][1],{color:T,width:b,lineDash:C,shadow:_},P[L]);return Pc(t,I,"text0",k,[M[0],M[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:T}),!1}}},{key:"_getTextLines",value:function(e){var t,n;return e>=50?(t=e/10,n=" cm"):(t=e,n=" mm"),[t.toString().concat(n)]}}]),o}(js);te(Rg,"toolName",void 0),Rg.toolName="ScaleOverlay";var Pg=Rg,Ng=K.utilities.transformWorldToIndex;function Ag(e,t){!function(e,t){var n=t.volume,r=t.points,o=t.segmentsLocked,a=t.segmentIndex,i=t.segmentationId,l=t.constraintFn,c=n.imageData,s=n.dimensions,d=n.getScalarData(),u=r.map((function(e){return Ng(c,e)}));u=u.map((function(e){return e.map((function(e){return Math.round(e)}))}));var v=Yc(u,s);Kc(c,(function(){return!0}),(function(e){var t=e.value,n=e.index,r=e.pointIJK;o.includes(t)||(l?l(r)&&(d[n]=a):d[n]=a)}),v),Tt(i)}(0,t)}var Lg=K.utilities.transformWorldToIndex;function Ug(e,t){!function(e,t){var n=t.volume,r=t.points,o=t.segmentsLocked,a=t.segmentationId,i=n.imageData,l=n.dimensions,c=n.getScalarData(),s=r.map((function(e){return Lg(i,e)})),d=Yc(s,l);Kc(i,(function(){return!0}),(function(e){var t=e.value,n=e.index;o.includes(t)||(c[n]=0)}),d),Tt(a)}(0,t)}var Vg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Ag,ERASE_INSIDE:Ug},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}};return ee(this,o),te(la(e=r.call(this,t,n)),"_throttledCalculateCachedStats",void 0),te(la(e),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o),l=i.viewport,c=i.renderingEngine;e.isDrawing=!0;var s=l.getCamera(),d=s.viewPlaneNormal,u=s.viewUp,v=e.toolGroupId,f=ss(v);if(!f)throw new Error("No active segmentation detected, create one before using scissors tool");var g=f.segmentationRepresentationUID,h=f.segmentationId,p=f.type,m=hs(h),w=fs(h),E=ws(v,g,m),y=xt(h).representationData[p].volumeId,I=K.cache.getVolume(y),b={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:kr(d),viewUp:kr(u),FrameOfReferenceUID:l.getFrameOfReferenceUID(),referencedImageId:"",toolName:e.getToolName(),segmentColor:E},data:{handles:{points:[kr(a),kr(a),kr(a),kr(a)],activeHandleIndex:null}}},C=Ps(o,e.getToolName());return e.editData={annotation:b,segmentation:I,segmentIndex:m,segmentsLocked:w,segmentColor:E,segmentationId:h,viewportIdsToRender:C,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(c,C),!0})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n,r,o,a,i,l,c,s,d=t.detail,u=d.element,v=e.editData,f=v.annotation,g=v.viewportIdsToRender,h=v.handleIndex,p=f.data,m=d.currentPoints,w=(0,K.getEnabledElement)(u),E=w.viewport,y=E.worldToCanvas,I=E.canvasToWorld,b=m.world,C=p.handles.points;switch(C[h]=kr(b),h){case 0:case 3:n=y(C[0]),r=[(a=y(C[3]))[0],n[1]],o=[n[0],a[1]],l=I(r),c=I(o),C[1]=l,C[2]=c;break;case 1:case 2:r=y(C[1]),n=[(o=y(C[2]))[0],r[1]],a=[r[0],o[1]],i=I(n),s=I(a),C[0]=i,C[3]=s}f.invalidated=!0,e.editData.hasMoved=!0;var T=w.renderingEngine;na(T,g)})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.newAnnotation,i=r.hasMoved,l=r.segmentation,c=r.segmentationId,s=r.segmentIndex,d=r.segmentsLocked,u=o.data;if(!a||i){u.handles.activeHandleIndex=null,e._deactivateDraw(n),zl(n);var v=(0,K.getEnabledElement)(n),f=v.viewport;if(e.editData=null,e.isDrawing=!1,f instanceof K.StackViewport)throw new Error("Not implemented yet");var g={points:u.handles.points,volume:l,segmentationId:c,segmentIndex:s,segmentsLocked:d};e.applyActiveStrategy(v,g)}})),te(la(e),"_activateDraw",(function(t){t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r=!1;if(!e.editData)return r;var o=t.viewport,a=e.editData.annotation,i=a.metadata,l=a.annotationUID,c=a.data.handles.points.map((function(e){return o.worldToCanvas(e)})),s="rgb(".concat(i.segmentColor.slice(0,3),")");return o.getRenderingEngine()?(Lc(n,l,"0",c[0],c[3],{color:s}),!0):(console.warn("Rendering Engine has been destroyed"),r)})),e}return Q(o)}(xa);te(Vg,"toolName",void 0),Vg.toolName="RectangleScissor";var Bg=Vg;var jg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:os},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}};return ee(this,o),te(la(e=r.call(this,t,n)),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=r.canvas,l=(0,K.getEnabledElement)(o),c=l.viewport,s=l.renderingEngine;e.isDrawing=!0;var d=c.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=e.toolGroupId,g=ss(f);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");var h=g.segmentationRepresentationUID,p=g.segmentationId,m=g.type,w=hs(p),E=fs(p),y=ws(f,h,w),I=xt(p).representationData[m].volumeId,b=K.cache.getVolume(I),C={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:kr(u),viewUp:kr(v),FrameOfReferenceUID:c.getFrameOfReferenceUID(),referencedImageId:"",toolName:e.getToolName(),segmentColor:y},data:{handles:{points:[kr(a),kr(a),kr(a),kr(a)],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},T=[c.id];return e.editData={annotation:C,segmentation:b,centerCanvas:i,segmentIndex:w,segmentationId:p,segmentsLocked:E,segmentColor:y,viewportIdsToRender:T,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(s,T),!0})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,K.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,c=e.editData,s=c.annotation,d=c.viewportIdsToRender,u=c.centerCanvas,v=s.data,f=Math.abs(o[0]-u[0]),g=Math.abs(o[1]-u[1]),h=Math.sqrt(f*f+g*g),p=[u[0],u[1]+h],m=[u[0],u[1]-h],w=[u[0]-h,u[1]],E=[u[0]+h,u[1]];v.handles.points=[l(p),l(m),l(w),l(E)],s.invalidated=!0,e.editData.hasMoved=!0,na(i,d)})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.newAnnotation,i=r.hasMoved,l=r.segmentation,c=r.segmentIndex,s=r.segmentsLocked,d=r.segmentationId,u=o.data,v=o.metadata,f=v.viewPlaneNormal,g=v.viewUp;if(!a||i){u.handles.activeHandleIndex=null,e._deactivateDraw(n),zl(n);var h=(0,K.getEnabledElement)(n),p=h.viewport;if(e.editData=null,e.isDrawing=!1,p instanceof K.StackViewport)throw new Error("Not implemented yet");var m={points:u.handles.points,volume:l,segmentIndex:c,segmentsLocked:s,viewPlaneNormal:f,segmentationId:d,viewUp:g};e.applyActiveStrategy(h,m)}})),te(la(e),"_activateDraw",(function(t){t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback),t.addEventListener(J.TOUCH_END,e._endCallback)})),te(la(e),"_deactivateDraw",(function(t){t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r=!1;if(!e.editData)return r;var o=t.viewport;if(!e.editData.viewportIdsToRender.includes(o.id))return r;var a=e.editData.annotation,i=a.metadata,l=a.annotationUID,c=a.data.handles.points.map((function(e){return o.worldToCanvas(e)})),s=c[0],d=c[1],u=[Math.floor((s[0]+d[0])/2),Math.floor((s[1]+d[1])/2)],v=Math.abs(s[1]-Math.floor((s[1]+d[1])/2)),f="rgb(".concat(i.segmentColor.slice(0,3),")");return o.getRenderingEngine()?(_c(n,l,"0",u,v,{color:f}),!0):(console.warn("Rendering Engine has been destroyed"),r)})),e}return Q(o)}(xa);te(jg,"toolName",void 0),jg.toolName="CircleScissor";var Hg=jg;var Wg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:Xc},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}};return ee(this,o),te(la(e=r.call(this,t,n)),"editData",void 0),te(la(e),"isDrawing",void 0),te(la(e),"isHandleOutsideImage",void 0),te(la(e),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=r.canvas,l=(0,K.getEnabledElement)(o),c=l.viewport,s=l.renderingEngine;e.isDrawing=!0;var d=c.getCamera(),u=d.viewPlaneNormal,v=d.viewUp,f=e.toolGroupId,g=ss(f);if(!g)throw new Error("No active segmentation detected, create one before using scissors tool");var h=g.segmentationRepresentationUID,p=g.segmentationId,m=g.type,w=hs(p),E=fs(p),y=ws(f,h,w),I=xt(p).representationData[m].volumeId,b=K.cache.getVolume(I);e.isDrawing=!0;var C={metadata:{viewPlaneNormal:kr(u),viewUp:kr(v),FrameOfReferenceUID:c.getFrameOfReferenceUID(),referencedImageId:"",toolName:e.getToolName(),segmentColor:y},data:{invalidated:!0,handles:{points:[kr(a),kr(a),kr(a),kr(a)],activeHandleIndex:null},cachedStats:{},highlighted:!0}},T=[c.id];return e.editData={annotation:C,segmentation:b,centerCanvas:i,segmentIndex:w,segmentsLocked:E,segmentColor:y,segmentationId:p,toolGroupId:f,viewportIdsToRender:T,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},e._activateDraw(o),Kl(o),t.preventDefault(),na(s,T),!0})),te(la(e),"_dragCallback",(function(t){e.isDrawing=!0;var n=t.detail,r=n.element,o=n.currentPoints.canvas,a=(0,K.getEnabledElement)(r),i=a.renderingEngine,l=a.viewport.canvasToWorld,c=e.editData,s=c.annotation,d=c.viewportIdsToRender,u=c.centerCanvas,v=s.data,f=Math.abs(o[0]-u[0]),g=Math.abs(o[1]-u[1]),h=Math.sqrt(f*f+g*g),p=[u[0],u[1]+h],m=[u[0],u[1]-h],w=[u[0]-h,u[1]],E=[u[0]+h,u[1]];v.handles.points=[l(p),l(m),l(w),l(E)],s.invalidated=!0,e.editData.hasMoved=!0,na(i,d)})),te(la(e),"_endCallback",(function(t){var n=t.detail.element,r=e.editData,o=r.annotation,a=r.newAnnotation,i=r.hasMoved,l=r.segmentation,c=r.segmentIndex,s=r.segmentsLocked,d=r.segmentationId,u=o.data,v=o.metadata,f=v.viewPlaneNormal,g=v.viewUp;if(!a||i){o.highlighted=!1,u.handles.activeHandleIndex=null,e._deactivateDraw(n),zl(n);var h=(0,K.getEnabledElement)(n),p=h.viewport;if(e.editData=null,e.isDrawing=!1,p instanceof K.StackViewport)throw new Error("Not implemented yet");var m={points:u.handles.points,volume:l,segmentIndex:c,segmentsLocked:s,segmentationId:d,viewPlaneNormal:f,viewUp:g};e.applyActiveStrategy(h,m)}})),te(la(e),"_activateDraw",(function(t){t.addEventListener(J.MOUSE_UP,e._endCallback),t.addEventListener(J.MOUSE_DRAG,e._dragCallback),t.addEventListener(J.MOUSE_CLICK,e._endCallback),t.addEventListener(J.TOUCH_END,e._endCallback),t.addEventListener(J.TOUCH_TAP,e._endCallback),t.addEventListener(J.TOUCH_DRAG,e._dragCallback)})),te(la(e),"_deactivateDraw",(function(t){t.removeEventListener(J.MOUSE_UP,e._endCallback),t.removeEventListener(J.MOUSE_DRAG,e._dragCallback),t.removeEventListener(J.MOUSE_CLICK,e._endCallback),t.removeEventListener(J.TOUCH_END,e._endCallback),t.removeEventListener(J.TOUCH_DRAG,e._dragCallback),t.removeEventListener(J.TOUCH_TAP,e._endCallback)})),te(la(e),"renderAnnotation",(function(t,n){var r=!1;if(!e.editData)return r;var o=t.viewport;if(!e.editData.viewportIdsToRender.includes(o.id))return r;var a=e.editData.annotation,i=a.metadata,l=a.annotationUID,c=a.data.handles.points.map((function(e){return o.worldToCanvas(e)})),s=c[0],d=c[1],u=[Math.floor((s[0]+d[0])/2),Math.floor((s[1]+d[1])/2)],v=Math.abs(s[1]-Math.floor((s[1]+d[1])/2)),f="rgb(".concat(i.segmentColor.slice(0,3),")");return o.getRenderingEngine()?(_c(n,l,"0",u,v,{color:f}),!0):(console.warn("Rendering Engine has been destroyed"),r)})),e}return Q(o)}(xa);te(Wg,"toolName",void 0),Wg.toolName="SphereScissor";var Fg=Wg;var Gg=K.utilities.transformWorldToIndex,qg=K.utilities.isEqual,zg=function(e){sa(o,e);var t,n,r=(t=o,n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}(),function(){var e,r=ua(t);if(n){var o=ua(this).constructor;e=Reflect.construct(r,arguments,o)}else e=r.apply(this,arguments);return da(this,e)});function o(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{supportedInteractionTypes:["Mouse","Touch"]};return ee(this,o),te(la(e=r.call(this,t,n)),"preMouseDownCallback",(function(t){var n=t.detail,r=n.currentPoints,o=n.element,a=r.world,i=(0,K.getEnabledElement)(o).viewport.getCamera().viewPlaneNormal,l=ss(e.toolGroupId);if(!l)throw new Error("No active segmentation detected, create one before using scissors tool");var c=l.segmentationId,s=l.type,d=hs(c),u=fs(c),v=xt(c).representationData[s].volumeId,f=K.cache.getVolume(v),g=f.dimensions,h=f.direction,p=f.getScalarData(),m=Gg(f.imageData,a),w=e.getFixedDimension(i,h);if(void 0!==w){var E=e.generateHelpers(p,g,m,w),y=E.floodFillGetter,I=E.getLabelValue,b=E.getScalarDataPositionFromPlane,C=E.inPlaneSeedPoint,T=E.fixedDimensionValue;if(!(m[0]<0||m[0]>=g[0]||m[1]<0||m[1]>=g[1]||m[2]<0||m[2]>=g[2])){var _=I(m[0],m[1],m[2]);if(!u.includes(_)){var D=Td(y,C);return D.flooded.forEach((function(e){var t=b(e[0],e[1]);p[t]=d})),Tt(c,e.getFramesModified(w,T,D)),!0}}}else console.warn("Oblique paint fill not yet supported")})),te(la(e),"getFramesModified",(function(e,t,n){var r=n.boundaries;if(2===e)return[t];for(var o=1/0,a=-1/0,i=0;i<r.length;i++){var l=r[i][1];l<o&&(o=l),l>a&&(a=l)}for(var c=[],s=o;s<=a;s++)c.push(s);return c})),te(la(e),"generateHelpers",(function(t,n,r){var o,a,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;switch(i){case 0:o=r[0],a=[r[1],r[2]];break;case 1:o=r[1],a=[r[0],r[2]];break;case 2:o=r[2],a=[r[0],r[1]];break;default:throw new Error("Invalid fixedDimension: ".concat(i))}var l=function(e,t,r){return r*n[1]*n[0]+t*n[0]+e},c=function(e,n,r){return t[l(e,n,r)]},s=e.generateFloodFillGetter(n,i,o,c);return{getScalarDataPositionFromPlane:e.generateGetScalarDataPositionFromPlane(l,i,o),getLabelValue:c,floodFillGetter:s,inPlaneSeedPoint:a,fixedDimensionValue:o}})),te(la(e),"generateFloodFillGetter",(function(e,t,n,r){var o;switch(t){case 0:o=function(t,o){if(!(t>=e[1]||t<0||o>=e[2]||o<0))return r(n,t,o)};break;case 1:o=function(t,o){if(!(t>=e[0]||t<0||o>=e[2]||o<0))return r(t,n,o)};break;case 2:o=function(t,o){if(!(t>=e[0]||t<0||o>=e[1]||o<0))return r(t,o,n)};break;default:throw new Error("Invalid fixedDimension: ".concat(t))}return o})),te(la(e),"generateGetScalarDataPositionFromPlane",(function(e,t,n){var r;switch(t){case 0:r=function(t,r){return e(n,t,r)};break;case 1:r=function(t,r){return e(t,n,r)};break;case 2:r=function(t,r){return e(t,r,n)};break;default:throw new Error("Invalid fixedDimension: ".concat(t))}return r})),e}return Q(o,[{key:"getFixedDimension",value:function(e,t){var n=t.slice(0,3),r=t.slice(3,6),o=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],i=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(qg(a,i))return 0;var l=[Math.abs(r[0]),Math.abs(r[1]),Math.abs(r[2])];if(qg(a,l))return 1;var c=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];return qg(a,c)?2:void 0}}]),o}(xa);te(zg,"toolName",void 0),zg.toolName="PaintFill";var Kg=zg}(),p}()}));
//# sourceMappingURL=index.js.map